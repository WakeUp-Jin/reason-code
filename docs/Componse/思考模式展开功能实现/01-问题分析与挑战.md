# 01 - 问题分析与挑战

## 📐 功能需求

### 1️⃣ 用户需求

1. **默认折叠**：思考内容最多显示 2 行（含省略号）
2. **快捷键展开**：按 `ctrl+o` 查看完整思考内容
3. **界面变化**：展开时隐藏输入框，显示底部提示
4. **视觉区分**：思考文字使用斜体 + 专用灰色（`textThinking`）

### 2️⃣ 技术要求

```
切换时：屏幕完全刷新，不能有残留内容
切换后：消息内容保持不变，只是显示方式改变
```

---

## 🎯 核心挑战：Ink 的 Static 组件

### 什么是 Static 组件？

Ink 是 React 的终端渲染器，`Static` 组件用于渲染"固定"内容：

```tsx
<Static items={messages}>
  {(message) => <Message key={message.id} {...message} />}
</Static>
```

**特性**：
- ✅ 内容一旦输出，就变成终端历史（可以向上滚动查看）
- ✅ 不会因为 React 状态变化而重新渲染
- ✅ 性能好，适合显示已完成的消息

### 问题所在

```
┌─────────────────────────────────────────────────────┐
│  Static 组件输出的内容                               │
│  ↓                                                  │
│  变成终端历史文本                                    │
│  ↓                                                  │
│  React/Ink 无法再控制这些内容                        │
│  ↓                                                  │
│  切换状态时，旧内容还在，新内容追加在下面             │
└─────────────────────────────────────────────────────┘
```

**具体表现**：

```
按 ctrl+o 前：
┌────────────────────┐
│ Header             │  ← Static 输出
│ Message 1 (折叠)   │  ← Static 输出
│ Message 2 (折叠)   │  ← Static 输出
│ [输入框]           │  ← 动态区域
└────────────────────┘

按 ctrl+o 后（错误情况）：
┌────────────────────┐
│ Header             │  ← 旧 Static 内容（残留！）
│ Message 1 (折叠)   │  ← 旧 Static 内容（残留！）
│ Message 2 (折叠)   │  ← 旧 Static 内容（残留！）
│ Header             │  ← 新 Static 输出
│ Message 1 (展开)   │  ← 新 Static 输出
│ Message 2 (展开)   │  ← 新 Static 输出
│ [提示]             │  ← 动态区域
└────────────────────┘
```

---

## 🔍 问题根源分析

### 1️⃣ 终端 vs 浏览器

| 特性 | 浏览器 DOM | 终端 |
|------|-----------|------|
| 内容控制 | React 完全控制 | 输出后变成历史 |
| 清除内容 | `element.innerHTML = ''` | 需要 ANSI 转义序列 |
| 重新渲染 | 虚拟 DOM diff | 只能追加输出 |

### 2️⃣ Ink 的渲染模型

```
Ink 渲染流程：
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ React State │ ──→ │ Virtual DOM │ ──→ │ Terminal    │
│ 变化        │     │ Diff        │     │ 输出        │
└─────────────┘     └─────────────┘     └─────────────┘
                                              │
                                              ↓
                                        ┌─────────────┐
                                        │ Static 内容 │
                                        │ 变成历史    │
                                        │ 无法修改    │
                                        └─────────────┘
```

### 3️⃣ 为什么简单的状态切换不行？

```tsx
// ❌ 这样不行
const [isExpanded, setIsExpanded] = useState(false);

// 切换状态
setIsExpanded(!isExpanded);

// 问题：Static 组件已经输出的内容不会消失
// 新的 Static 内容会追加在后面
```

---

## 📊 挑战总结

| 挑战 | 描述 | 难度 |
|------|------|------|
| **Static 残留** | 旧内容无法被 React 清除 | ⭐⭐⭐⭐⭐ |
| **清屏不彻底** | ANSI 转义序列与 Ink 内部状态不同步 | ⭐⭐⭐⭐ |
| **状态持久化** | remount 后需要保持状态 | ⭐⭐⭐ |
| **消息保留** | 切换后消息内容不能丢失 | ⭐⭐⭐ |

---

## 🎯 解决方向

经过多次尝试，最终确定的解决方向：

```
┌─────────────────────────────────────────────────────┐
│  核心思路：既然无法修改 Static 内容，               │
│  那就彻底销毁整个 Ink 实例，清空终端，重新渲染       │
└─────────────────────────────────────────────────────┘
```

但这带来新的挑战：
1. 如何彻底清空终端（包括滚动缓冲区）？
2. 如何在 remount 后保持状态？
3. 如何避免重复初始化？

下一篇文档将详细分析尝试过的失败方案。

