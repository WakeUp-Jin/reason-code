# 05 - ç»éªŒæ€»ç»“

## ğŸ“ æ ¸å¿ƒç»éªŒ

### 1ï¸âƒ£ ç†è§£æ¡†æ¶çš„è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…³é”®è®¤çŸ¥ï¼šReact/Ink ä¸èƒ½æ§åˆ¶å·²è¾“å‡ºåˆ°ç»ˆç«¯çš„å†…å®¹      â”‚
â”‚                                                     â”‚
â”‚  - æµè§ˆå™¨ DOMï¼šReact å®Œå…¨æ§åˆ¶                        â”‚
â”‚  - ç»ˆç«¯è¾“å‡ºï¼šä¸€æ—¦è¾“å‡ºå°±å˜æˆå†å²                      â”‚
â”‚                                                     â”‚
â”‚  è¿™æ˜¯ç»ˆç«¯å’Œæµè§ˆå™¨çš„æ ¹æœ¬åŒºåˆ«                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•™è®­**ï¼šä¸è¦å‡è®¾æ‰€æœ‰ React æ¨¡å¼éƒ½é€‚ç”¨äºç»ˆç«¯åº”ç”¨ã€‚

### 2ï¸âƒ£ ç»ˆç«¯ ANSI è½¬ä¹‰åºåˆ—çš„å±€é™æ€§

| åºåˆ— | ä½œç”¨ | å±€é™æ€§ |
|------|------|--------|
| `\x1b[2J` | æ¸…å± | ä¸æ¸…é™¤æ»šåŠ¨ç¼“å†²åŒº |
| `\x1b[3J` | æ¸…é™¤æ»šåŠ¨ç¼“å†²åŒº | éƒ¨åˆ†ç»ˆç«¯ä¸æ”¯æŒ |
| `\x1bc` | é‡ç½®ç»ˆç«¯ | å‰¯ä½œç”¨å¤ªå¤§ |
| `\x1b[?1049h/l` | åˆ‡æ¢å±å¹•ç¼“å†²åŒº | âœ… æœ€å¯é  |

**æ•™è®­**ï¼šæ¸…å±ä¸å¦‚æ¢å±å¹•ã€‚

### 3ï¸âƒ£ çŠ¶æ€æŒä¹…åŒ–ç­–ç•¥

```typescript
// âŒ é”™è¯¯ï¼šReact çŠ¶æ€åœ¨ remount åä¸¢å¤±
const [state, setState] = useState(initialValue);

// âœ… æ­£ç¡®ï¼šæ¨¡å—çº§å˜é‡è·¨ remount æŒä¹…åŒ–
let moduleState = initialValue;
const [state, setState] = useState(moduleState);
```

**æ•™è®­**ï¼šéœ€è¦è·¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæŒä¹…åŒ–çš„çŠ¶æ€ï¼Œä¸è¦æ”¾åœ¨ React çŠ¶æ€é‡Œã€‚

---

## ğŸ¯ è®¾è®¡æ¨¡å¼

### æ¨¡å¼ 1ï¼šæ¨¡å—çº§çŠ¶æ€ + React çŠ¶æ€åŒæ­¥

```typescript
// æ¨¡å—çº§å˜é‡ï¼ˆæŒä¹…åŒ–ï¼‰
let persistedValue = false;

// è®¾ç½®å‡½æ•°ï¼ˆæ›´æ–°æŒä¹…åŒ–å€¼ï¼‰
export function setPersistedValue(value: boolean): void {
  persistedValue = value;
}

// React ç»„ä»¶
function Component() {
  // ä»æŒä¹…åŒ–å€¼åˆå§‹åŒ–
  const [value, setValue] = useState(persistedValue);
  
  const handleChange = () => {
    const newValue = !persistedValue;
    setPersistedValue(newValue);  // å…ˆæ›´æ–°æŒä¹…åŒ–
    // ç„¶åè§¦å‘é‡æ–°æ¸²æŸ“...
  };
}
```

### æ¨¡å¼ 2ï¼šå±å¹•ç¼“å†²åŒºåˆ‡æ¢æ¸…å±

```typescript
function clearScreenByBufferSwitch(): void {
  // é€€å‡ºå¤‡ç”¨å±å¹•ï¼ˆå¦‚æœåœ¨çš„è¯ï¼‰
  process.stdout.write('\x1b[?1049l');
  // è¿›å…¥å¤‡ç”¨å±å¹•ï¼ˆå¾—åˆ°å¹²å‡€å±å¹•ï¼‰
  process.stdout.write('\x1b[?1049h');
}
```

### æ¨¡å¼ 3ï¼šå¼‚æ­¥æ¸²æŸ“ç¡®ä¿é¡ºåº

```typescript
function remount(): void {
  instance.unmount();
  clearScreen();
  
  // ä½¿ç”¨ setImmediate ç¡®ä¿æ¸…å±å®Œæˆåå†æ¸²æŸ“
  setImmediate(() => {
    instance = render(<App />);
  });
}
```

---

## âš ï¸ å¸¸è§é™·é˜±

### é™·é˜± 1ï¼šInk å†…éƒ¨çŠ¶æ€ä¸åŒæ­¥

```
é—®é¢˜ï¼šç›´æ¥æ“ä½œç»ˆç«¯åï¼ŒInk ä¸çŸ¥é“å±å¹•å·²è¢«æ¸…ç©º
ç»“æœï¼šInk ç»§ç»­ä»"æ—§ä½ç½®"è¾“å‡ºï¼Œå†…å®¹å‡ºç°åœ¨å±å¹•å¤–

è§£å†³ï¼šunmount Ink â†’ æ¸…å± â†’ é‡æ–° render
```

### é™·é˜± 2ï¼šuseEffect åœ¨ remount åé‡å¤æ‰§è¡Œ

```typescript
// âŒ æ¯æ¬¡ remount éƒ½ä¼šæ‰§è¡Œ
useEffect(() => {
  initializeApp();
}, []);

// âœ… ä½¿ç”¨æ¨¡å—çº§æ ‡è®°é˜²æ­¢é‡å¤
let initialized = false;
useEffect(() => {
  if (!initialized) {
    initialized = true;
    initializeApp();
  }
}, []);
```

### é™·é˜± 3ï¼šZustand store vs React çŠ¶æ€

```
Zustand storeï¼š
- âœ… ç‹¬ç«‹äº React ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
- âœ… remount åæ•°æ®ä¿ç•™
- âœ… é€‚åˆå­˜å‚¨ä¸šåŠ¡æ•°æ®ï¼ˆæ¶ˆæ¯ã€ä¼šè¯ç­‰ï¼‰

React çŠ¶æ€ï¼š
- âŒ ç»„ä»¶å¸è½½åä¸¢å¤±
- âŒ remount åé‡ç½®
- âœ… é€‚åˆå­˜å‚¨ UI çŠ¶æ€ï¼ˆå¦‚æœä¸éœ€è¦è·¨ remountï¼‰
```

---

## ğŸ“Š è°ƒè¯•æŠ€å·§

### æŠ€å·§ 1ï¼šæ—¥å¿—è¿½è¸ªæ‰§è¡Œæµç¨‹

```typescript
export function remountApp(): void {
  logger.info('remountApp: start');
  
  inkInstance.unmount();
  logger.info('remountApp: unmounted');
  
  process.stdout.write('\x1b[?1049l\x1b[?1049h');
  logger.info('remountApp: screen switched');
  
  setImmediate(() => {
    logger.info('remountApp: rendering');
    inkInstance = render(<Root />);
  });
}
```

### æŠ€å·§ 2ï¼šéªŒè¯çŠ¶æ€æŒä¹…åŒ–

```typescript
export function setPersistedThinkingExpanded(value: boolean): void {
  console.log(`[DEBUG] persistedThinkingExpanded: ${persistedThinkingExpanded} â†’ ${value}`);
  persistedThinkingExpanded = value;
}
```

### æŠ€å·§ 3ï¼šç»ˆç«¯åºåˆ—å¯è§†åŒ–

```bash
# æŸ¥çœ‹å‘é€åˆ°ç»ˆç«¯çš„åŸå§‹å­—èŠ‚
cat -v
# ç„¶åè¿è¡Œä½ çš„ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°è½¬ä¹‰åºåˆ—
```

---

## ğŸ”„ å¯å¤ç”¨çš„è§£å†³æ–¹æ¡ˆ

### åœºæ™¯ï¼šéœ€è¦"åˆ·æ–°"æ•´ä¸ª TUI ç•Œé¢

```typescript
// 1. å¯¼å‡º Ink å®ä¾‹å’Œ remount å‡½æ•°
let inkInstance: Instance | null = null;

export function remountApp(): void {
  if (inkInstance) {
    inkInstance.unmount();
    process.stdout.write('\x1b[?1049l\x1b[?1049h');
    setImmediate(() => {
      inkInstance = render(<Root />);
    });
  }
}

// 2. åœ¨éœ€è¦åˆ·æ–°çš„åœ°æ–¹è°ƒç”¨
const handleRefresh = () => {
  remountApp();
};
```

### åœºæ™¯ï¼šéœ€è¦è·¨ remount æŒä¹…åŒ–çŠ¶æ€

```typescript
// 1. å®šä¹‰æ¨¡å—çº§å˜é‡å’Œè®¾ç½®å‡½æ•°
let persistedState = initialValue;

export function setPersistedState(value: typeof initialValue): void {
  persistedState = value;
}

// 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
function Component() {
  const [state, setState] = useState(persistedState);
  
  const updateState = (newValue: typeof initialValue) => {
    setPersistedState(newValue);  // æ›´æ–°æŒä¹…åŒ–
    setState(newValue);            // æ›´æ–° React çŠ¶æ€ï¼ˆå¦‚æœä¸ remountï¼‰
    // æˆ–è€… remountApp();         // å¦‚æœéœ€è¦åˆ·æ–°ç•Œé¢
  };
}
```

---

## ğŸ“ æœ€ç»ˆæ€»ç»“

### é—®é¢˜æœ¬è´¨

```
Static ç»„ä»¶ + ç»ˆç«¯å†å² = æ— æ³•é€šè¿‡ React çŠ¶æ€å˜åŒ–æ¸…é™¤æ—§å†…å®¹
```

### è§£å†³æ€è·¯

```
æ—¢ç„¶æ— æ³•"ä¿®æ”¹"å·²è¾“å‡ºçš„å†…å®¹ï¼Œé‚£å°±"æ¢ä¸€ä¸ªæ–°å±å¹•"
```

### æŠ€æœ¯æ–¹æ¡ˆ

```
Remount + å±å¹•ç¼“å†²åŒºåˆ‡æ¢ + æ¨¡å—çº§çŠ¶æ€æŒä¹…åŒ–
```

### æ ¸å¿ƒä»£ç 

```typescript
// åˆ‡æ¢çŠ¶æ€
setPersistedThinkingExpanded(!current);

// é‡æ–°æŒ‚è½½
inkInstance.unmount();
process.stdout.write('\x1b[?1049l\x1b[?1049h');
setImmediate(() => {
  inkInstance = render(<Root />);
});
```

---

## ğŸ“ å­¦ä¹ èµ„æº

1. **ANSI è½¬ä¹‰åºåˆ—**
   - [Wikipedia: ANSI escape code](https://en.wikipedia.org/wiki/ANSI_escape_code)
   - [XTerm Control Sequences](https://invisible-island.net/xterm/ctlseqs/ctlseqs.html)

2. **Ink æ¡†æ¶**
   - [Ink GitHub](https://github.com/vadimdemedes/ink)
   - [Ink Static ç»„ä»¶æ–‡æ¡£](https://github.com/vadimdemedes/ink#static)

3. **ç»ˆç«¯æ¨¡æ‹Ÿå™¨åŸç†**
   - [How terminals work](https://poor.dev/blog/terminal-anatomy/)
   - [Alternate Screen Buffer](https://invisible-island.net/xterm/xterm.faq.html#xterm_tite)

