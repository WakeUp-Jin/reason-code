# 04 - å…³é”®ä»£ç è§£æ

## ğŸ“ ä»£ç ç»“æ„æ¦‚è§ˆ

```
packages/cli/src/
â”œâ”€â”€ app.tsx                    # ğŸ”‘ Ink å®ä¾‹ç®¡ç†
â”œâ”€â”€ context/
â”‚   â””â”€â”€ execution.tsx          # ğŸ”‘ çŠ¶æ€ç®¡ç†
â”œâ”€â”€ routes/session/
â”‚   â””â”€â”€ index.tsx              # ğŸ”‘ UI æ¸²æŸ“
â””â”€â”€ component/message-area/
    â””â”€â”€ thinking-message.tsx   # æ€è€ƒæ¶ˆæ¯ç»„ä»¶
```

---

## 1ï¸âƒ£ app.tsx - Ink å®ä¾‹ç®¡ç†

### æ¨¡å—çº§å˜é‡å®šä¹‰

```typescript
// app.tsx:24-45

// ==================== æ¨¡å—çº§çŠ¶æ€æŒä¹…åŒ– ====================
// ç”¨äºåœ¨ remount æ—¶ä¿æŒçŠ¶æ€
let appInitialized = false;
let commandsRegistered = false;

/** æ€è€ƒå†…å®¹å±•å¼€çŠ¶æ€ï¼ˆè·¨ remount æŒä¹…åŒ–ï¼‰ */
export let persistedThinkingExpanded = false;

/** è®¾ç½®æ€è€ƒå±•å¼€çŠ¶æ€ */
export function setPersistedThinkingExpanded(value: boolean): void {
  persistedThinkingExpanded = value;
}

// ==================== Ink å®ä¾‹ç®¡ç† ====================

/** å½“å‰ Ink æ¸²æŸ“å®ä¾‹ */
let inkInstance: Instance | null = null;

/** å½“å‰æ˜¯å¦åœ¨å¤‡ç”¨å±å¹• */
let inAlternateScreen = false;
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨æ¨¡å—çº§å˜é‡ï¼ˆ`let`ï¼‰ï¼Œä¸æ˜¯ React çŠ¶æ€
- âœ… è¿™äº›å˜é‡åœ¨ remount æ—¶ä¸ä¼šè¢«é‡ç½®
- âœ… `export` å…è®¸å…¶ä»–æ¨¡å—è®¿é—®å’Œä¿®æ”¹

### remountApp å‡½æ•°

```typescript
// app.tsx:47-72

/**
 * é‡æ–°æŒ‚è½½æ•´ä¸ªåº”ç”¨
 * ä½¿ç”¨ alternate screen buffer åˆ‡æ¢æŠ€æœ¯å®ç°å½»åº•æ¸…å±
 */
export function remountApp(): void {
  if (inkInstance) {
    // 1. å¸è½½å½“å‰ Ink å®ä¾‹
    inkInstance.unmount();
    inkInstance = null;

    // 2. åˆ‡æ¢å±å¹•ç¼“å†²åŒºï¼ˆè¿™ä¼šå½»åº•æ¸…é™¤å½“å‰å±å¹•å†…å®¹ï¼‰
    // å¦‚æœå½“å‰åœ¨å¤‡ç”¨å±å¹•ï¼Œåˆ‡æ¢åˆ°ä¸»å±å¹•å†åˆ‡å›æ¥
    // å¦‚æœå½“å‰åœ¨ä¸»å±å¹•ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨å±å¹•å†åˆ‡å›æ¥
    // è¿™æ ·å¯ä»¥"é‡ç½®"å½“å‰å±å¹•
    if (inAlternateScreen) {
      // é€€å‡ºå¤‡ç”¨å±å¹•ï¼ˆæ¸…é™¤å¤‡ç”¨å±å¹•å†…å®¹ï¼‰å†è¿›å…¥
      process.stdout.write('\x1b[?1049l\x1b[?1049h');
    } else {
      // è¿›å…¥å¤‡ç”¨å±å¹•å†é€€å‡ºå†è¿›å…¥ï¼ˆç¡®ä¿æ¸…é™¤ï¼‰
      process.stdout.write('\x1b[?1049h\x1b[?1049l\x1b[2J\x1b[3J\x1b[H');
    }

    // 3. é‡æ–°æ¸²æŸ“
    setImmediate(() => {
      inkInstance = render(<Root />);
    });
  }
}
```

**é€è¡Œè§£æ**ï¼š

| è¡Œ | ä»£ç  | ä½œç”¨ |
|---|------|------|
| 1 | `inkInstance.unmount()` | é”€æ¯å½“å‰ Ink æ¸²æŸ“å®ä¾‹ |
| 2 | `inkInstance = null` | æ¸…ç©ºå¼•ç”¨ |
| 3 | `\x1b[?1049l` | é€€å‡ºå¤‡ç”¨å±å¹• |
| 4 | `\x1b[?1049h` | è¿›å…¥å¤‡ç”¨å±å¹• |
| 5 | `setImmediate()` | ç¡®ä¿å±å¹•åˆ‡æ¢å®Œæˆåå†æ¸²æŸ“ |

### ANSI è½¬ä¹‰åºåˆ—è¯¦è§£

```
\x1b[?1049h  - è¿›å…¥å¤‡ç”¨å±å¹•ç¼“å†²åŒº (smcup)
\x1b[?1049l  - é€€å‡ºå¤‡ç”¨å±å¹•ç¼“å†²åŒº (rmcup)
\x1b[2J      - æ¸…é™¤æ•´ä¸ªå±å¹•
\x1b[3J      - æ¸…é™¤æ»šåŠ¨ç¼“å†²åŒº
\x1b[H       - ç§»åŠ¨å…‰æ ‡åˆ°å·¦ä¸Šè§’ (0,0)
```

---

## 2ï¸âƒ£ execution.tsx - çŠ¶æ€ç®¡ç†

### å¯¼å…¥æŒä¹…åŒ–å‡½æ•°

```typescript
// execution.tsx:37-40

import {
  remountApp,
  persistedThinkingExpanded,
  setPersistedThinkingExpanded,
} from '../app.js';
```

### ä»æŒä¹…åŒ–å˜é‡åˆå§‹åŒ–çŠ¶æ€

```typescript
// execution.tsx:119

// âœ¨ ä»æŒä¹…åŒ–å˜é‡åˆå§‹åŒ–ï¼Œç¡®ä¿ remount åçŠ¶æ€ä¿æŒ
const [isThinkingExpanded, setIsThinkingExpanded] = useState(persistedThinkingExpanded);
```

**å…³é”®ç‚¹**ï¼š
- âœ… `useState` çš„åˆå§‹å€¼æ¥è‡ªæ¨¡å—çº§å˜é‡
- âœ… remount åï¼Œæ–°ç»„ä»¶ä¼šè¯»å–å·²æ›´æ–°çš„ `persistedThinkingExpanded`

### toggleThinkingExpanded å‡½æ•°

```typescript
// execution.tsx:153-162

// åˆ‡æ¢æ€è€ƒå†…å®¹å±•å¼€ï¼ˆctrl+oï¼‰
// âœ¨ ä½¿ç”¨ remountApp å½»åº•é‡æ–°æ¸²æŸ“ï¼Œè§£å†³ Static ç»„ä»¶æ®‹ç•™é—®é¢˜
const toggleThinkingExpanded = useCallback(() => {
  // 1. æ›´æ–°æŒä¹…åŒ–çŠ¶æ€ï¼ˆåœ¨ remount å‰ï¼‰
  const newValue = !persistedThinkingExpanded;
  setPersistedThinkingExpanded(newValue);

  // 2. é‡æ–°æŒ‚è½½æ•´ä¸ªåº”ç”¨ï¼ˆä¼šæ¸…å±å¹¶é‡æ–°æ¸²æŸ“ï¼‰
  remountApp();
}, []);
```

**æ‰§è¡Œé¡ºåº**ï¼š

```
toggleThinkingExpanded()
    â”‚
    â”œâ”€â†’ è¯»å–å½“å‰çŠ¶æ€: persistedThinkingExpanded = false
    â”‚
    â”œâ”€â†’ è®¡ç®—æ–°çŠ¶æ€: newValue = true
    â”‚
    â”œâ”€â†’ æ›´æ–°æŒä¹…åŒ–: setPersistedThinkingExpanded(true)
    â”‚       â””â”€â†’ persistedThinkingExpanded = true  â† æ¨¡å—å˜é‡å·²æ›´æ–°
    â”‚
    â””â”€â†’ è°ƒç”¨ remountApp()
            â”‚
            â”œâ”€â†’ unmount å½“å‰ Ink
            â”œâ”€â†’ åˆ‡æ¢å±å¹•ç¼“å†²åŒº
            â””â”€â†’ render(<Root />)
                    â”‚
                    â””â”€â†’ ExecutionProvider åˆå§‹åŒ–
                            â”‚
                            â””â”€â†’ useState(persistedThinkingExpanded)
                                    â”‚
                                    â””â”€â†’ isThinkingExpanded = true  âœ…
```

---

## 3ï¸âƒ£ session/index.tsx - UI æ¸²æŸ“

### ç›‘å¬å¿«æ·é”®

```typescript
// session/index.tsx:51-55

// ç›‘å¬ ctrl+o åˆ‡æ¢æ€è€ƒå†…å®¹å±•å¼€çŠ¶æ€
useInput((input, key) => {
  if (key.ctrl && input === 'o') {
    toggleThinkingExpanded();
  }
});
```

### æ„å»º Static items

```typescript
// session/index.tsx:99-116

// å±•å¼€æ¨¡å¼ä¸‹ä½¿ç”¨æ‰€æœ‰æ¶ˆæ¯ï¼ŒæŠ˜å æ¨¡å¼ä¸‹ä½¿ç”¨ static/dynamic åˆ†ç¦»
const allMessages = useCurrentMessages();

// æ„å»º Static åŒºåŸŸçš„ items - Header ä½œä¸ºç¬¬ä¸€ä¸ª item
const staticItems: StaticItem[] = useMemo(() => {
  // å±•å¼€æ¨¡å¼ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½ä½œä¸º static items
  const messages = isThinkingExpanded ? allMessages : staticMessages;
  return [
    { id: 'header', type: 'header' },
    ...messages
      .filter((m) => m.role !== 'assistant' || m.content)
      .map((m) => ({
        id: m.id,
        type: 'message' as const,
        message: m,
      })),
  ];
}, [isThinkingExpanded, allMessages, staticMessages]);
```

**å…³é”®ç‚¹**ï¼š
- âœ… `isThinkingExpanded` å†³å®šä½¿ç”¨å“ªäº›æ¶ˆæ¯
- âœ… å±•å¼€æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬å®Œæ•´æ€è€ƒå†…å®¹ï¼‰
- âœ… æŠ˜å æ¨¡å¼ï¼šåªæ˜¾ç¤º static æ¶ˆæ¯

### æ¡ä»¶æ¸²æŸ“è¾“å…¥åŒºåŸŸ

```typescript
// session/index.tsx:153-170

{/* è¾“å…¥åŒºåŸŸå’Œ Footer - æ€è€ƒå±•å¼€æ—¶éšè—ï¼Œä½†ç­‰å¾…ç¡®è®¤æ—¶å§‹ç»ˆæ˜¾ç¤º */}
{(!isThinkingExpanded || isPendingConfirm) && (
  <Box
    flexDirection="column"
    paddingLeft={2}
    paddingRight={2}
    paddingBottom={1}
    borderStyle="single"
    borderTop={true}
    borderBottom={false}
    borderLeft={false}
    borderRight={false}
    borderColor={colors.border || 'gray'}
  >
    <InputArea onCommandPanelChange={setIsCommandPanelVisible} />
    {!isCommandPanelVisible && <Footer />}
  </Box>
)}
```

**æ¡ä»¶é€»è¾‘**ï¼š

| isThinkingExpanded | isPendingConfirm | æ˜¾ç¤ºè¾“å…¥æ¡† |
|-------------------|------------------|-----------|
| false | false | âœ… |
| false | true | âœ… |
| true | false | âŒ |
| true | true | âœ… |

---

## 4ï¸âƒ£ thinking-message.tsx - æ€è€ƒæ¶ˆæ¯ç»„ä»¶

### æŠ˜å é€»è¾‘

```typescript
// thinking-message.tsx

const PREVIEW_LINES = 2;  // æœ€å¤šæ˜¾ç¤º 2 è¡Œ

// è®¡ç®—é¢„è§ˆå†…å®¹ï¼ˆåŒ…å«çœç•¥å·åœ¨ç¬¬ 2 è¡Œæœ«å°¾ï¼‰
const previewContent = useMemo(() => {
  const lines = content.split('\n');
  if (lines.length <= PREVIEW_LINES) {
    return content;
  }
  // å–å‰ 2 è¡Œï¼Œåœ¨ç¬¬ 2 è¡Œæœ«å°¾åŠ çœç•¥å·
  const preview = lines.slice(0, PREVIEW_LINES);
  preview[PREVIEW_LINES - 1] = preview[PREVIEW_LINES - 1] + '...';
  return preview.join('\n');
}, [content]);
```

### å±•å¼€/æŠ˜å æç¤º

```typescript
// thinking-message.tsx

{/* å±•å¼€/æŠ˜å æç¤º */}
<Text color={colors.textMuted} dimColor>
  {' '}[ctrl+o to {isThinkingExpanded ? 'collapse' : 'expand'}]
</Text>
```

---

## ğŸ“Š ä»£ç æµç¨‹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®Œæ•´æ‰§è¡Œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·æŒ‰ ctrl+o                                                  â”‚
â”‚       â”‚                                                         â”‚
â”‚       â†“                                                         â”‚
â”‚  useInput æ•è· â†’ toggleThinkingExpanded()                       â”‚
â”‚       â”‚                                                         â”‚
â”‚       â†“                                                         â”‚
â”‚  setPersistedThinkingExpanded(true)  â† æ›´æ–°æ¨¡å—å˜é‡             â”‚
â”‚       â”‚                                                         â”‚
â”‚       â†“                                                         â”‚
â”‚  remountApp()                                                   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ inkInstance.unmount()                                 â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ process.stdout.write('\x1b[?1049l\x1b[?1049h')        â”‚
â”‚       â”‚       â””â”€â†’ å±å¹•å˜ç©ºç™½                                    â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â†’ setImmediate(() => render(<Root />))                  â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           <Root />                                              â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           <ExecutionProvider>                                   â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           useState(persistedThinkingExpanded)  â† è¯»å– true      â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           <Session />                                           â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           staticItems = allMessages  â† å±•å¼€æ¨¡å¼                 â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           <Static items={staticItems}>                          â”‚
â”‚               â”‚                                                 â”‚
â”‚               â†“                                                 â”‚
â”‚           æ¸²æŸ“å®Œæ•´æ€è€ƒå†…å®¹ âœ…                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

