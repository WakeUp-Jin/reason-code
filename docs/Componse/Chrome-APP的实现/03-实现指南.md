# Chrome App Mode å®ç°æŒ‡å—

## é¡¹ç›®ç»“æ„

```
your-cli/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ desktop.js       # æ¡Œé¢ç«¯ç®¡ç†å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ list.js          # åˆ—è¡¨å‘½ä»¤ï¼ˆé›†æˆæ¡Œé¢ç«¯ï¼‰
â”‚   â”‚   â””â”€â”€ show.js          # æ˜¾ç¤ºå‘½ä»¤ï¼ˆé›†æˆæ¡Œé¢ç«¯ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ desktop/
â”‚   â”‚   â”œâ”€â”€ manager.js       # æ¡Œé¢ç«¯ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ server.js        # Express æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ public/          # å‰ç«¯èµ„æº
â”‚   â”‚       â”œâ”€â”€ index.html   # ä¸»é¡µé¢
â”‚   â”‚       â”œâ”€â”€ style.css    # æ ·å¼
â”‚   â”‚       â””â”€â”€ app.js       # å‰ç«¯é€»è¾‘
â”‚   â”‚
â”‚   â””â”€â”€ index.js             # CLI å…¥å£
â”‚
â””â”€â”€ package.json
```

---

## æ ¸å¿ƒæ¨¡å—å®ç°

### 1. Desktop Managerï¼ˆç®¡ç†å™¨ï¼‰

**èŒè´£ï¼š**
- å¯åŠ¨/åœæ­¢ Express æœåŠ¡å™¨
- ç®¡ç† Chrome çª—å£
- æä¾›æ•°æ®æ›´æ–°æ¥å£

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```javascript
class DesktopManager {
  constructor() {
    this.server = null;
    this.port = 9527;
    this.currentView = { type: null, data: null };
    this.isRunning = false;
  }

  // å¯åŠ¨æœåŠ¡
  start() {
    // 1. åˆ›å»º Express åº”ç”¨
    // 2. è®¾ç½®è·¯ç”±
    // 3. å¯åŠ¨æœåŠ¡å™¨
    // 4. æ‰“å¼€ Chrome çª—å£
  }

  // åœæ­¢æœåŠ¡
  stop() {
    // å…³é—­æœåŠ¡å™¨
  }

  // æ˜¾ç¤º TODO
  showTodo(tasks) {
    this.currentView = { type: 'todo', data: { tasks } };
  }

  // æ˜¾ç¤ºå›¾ç‰‡
  showImage(path) {
    this.currentView = { type: 'image', data: { url: path } };
  }

  // æ˜¾ç¤ºä»£ç å¯¹æ¯”
  showDiff(before, after) {
    this.currentView = { type: 'diff', data: { before, after } };
  }
}

// å•ä¾‹æ¨¡å¼
export const desktopManager = new DesktopManager();
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹
- é€šè¿‡ `currentView` å­˜å‚¨å½“å‰è¦æ˜¾ç¤ºçš„å†…å®¹
- æä¾›ç®€å•çš„ API ä¾› CLI å‘½ä»¤è°ƒç”¨

---

### 2. Express æœåŠ¡å™¨

**è·¯ç”±è®¾è®¡ï¼š**

```javascript
// GET /api/view - è·å–å½“å‰è§†å›¾
app.get('/api/view', (req, res) => {
  res.json(currentView);
});

// POST /api/view - æ›´æ–°è§†å›¾ï¼ˆå¯é€‰ï¼‰
app.post('/api/view', (req, res) => {
  currentView = req.body;
  res.json({ success: true });
});

// GET /api/health - å¥åº·æ£€æŸ¥
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok' });
});

// é™æ€æ–‡ä»¶æœåŠ¡
app.use(express.static('./public'));
```

**å¯åŠ¨é€»è¾‘ï¼š**

```javascript
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
  
  // æ‰“å¼€ Chrome App çª—å£
  openChromeApp(`http://localhost:${port}`);
});
```

---

### 3. Chrome çª—å£å¯åŠ¨

**è·¨å¹³å°å®ç°ï¼š**

```javascript
function openChromeApp(url) {
  const commands = {
    darwin: `/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome --app=${url} --window-size=800,600`,
    win32: `start chrome --app=${url} --window-size=800,600`,
    linux: `google-chrome --app=${url} --window-size=800,600`
  };
  
  const command = commands[process.platform];
  
  exec(command, (err) => {
    if (err) {
      console.log('âš ï¸  æ— æ³•è‡ªåŠ¨æ‰“å¼€ Chrome');
      console.log('è¯·æ‰‹åŠ¨è®¿é—®:', url);
    }
  });
}
```

**å¸¸ç”¨å‚æ•°ï¼š**
- `--app=URL` - App æ¨¡å¼
- `--window-size=å®½,é«˜` - çª—å£å¤§å°
- `--window-position=X,Y` - çª—å£ä½ç½®
- `--start-fullscreen` - å…¨å±å¯åŠ¨
- `--kiosk` - Kiosk æ¨¡å¼ï¼ˆå®Œå…¨å…¨å±ï¼Œæ— æ³•é€€å‡ºï¼‰

---

### 4. å‰ç«¯å®ç°

**HTML ç»“æ„ï¼š**

```html
<div id="app">
  <!-- å¤šä¸ªè§†å›¾å®¹å™¨ -->
  <div id="todo-view" class="view"></div>
  <div id="image-view" class="view"></div>
  <div id="diff-view" class="view"></div>
  <div id="empty-view" class="view active"></div>
</div>
```

**æ ¸å¿ƒé€»è¾‘ï¼š**

```javascript
class DesktopApp {
  constructor() {
    this.currentType = null;
    this.startPolling();
  }

  // è½®è¯¢è·å–æ•°æ®
  async startPolling() {
    setInterval(async () => {
      const { type, data } = await fetch('/api/view').then(r => r.json());
      
      if (type !== this.currentType) {
        this.currentType = type;
        this.switchView(type, data);
      }
    }, 500);
  }

  // åˆ‡æ¢è§†å›¾
  switchView(type, data) {
    // 1. éšè—æ‰€æœ‰è§†å›¾
    document.querySelectorAll('.view').forEach(el => {
      el.classList.remove('active');
    });

    // 2. æ˜¾ç¤ºç›®æ ‡è§†å›¾
    const view = document.getElementById(`${type}-view`);
    view.classList.add('active');

    // 3. æ¸²æŸ“æ•°æ®
    this.render(type, data);
  }

  // æ¸²æŸ“æ•°æ®
  render(type, data) {
    switch (type) {
      case 'todo': this.renderTodo(data); break;
      case 'image': this.renderImage(data); break;
      case 'diff': this.renderDiff(data); break;
    }
  }
}

new DesktopApp();
```

---

## CLI å‘½ä»¤é›†æˆ

### 1. æ¡Œé¢ç«¯ç®¡ç†å‘½ä»¤

```javascript
// tm desktop start
export function desktopCommand(program) {
  const desktop = program.command('desktop');

  desktop
    .command('start')
    .action(() => {
      desktopManager.start();
    });

  desktop
    .command('stop')
    .action(() => {
      desktopManager.stop();
    });
}
```

### 2. é›†æˆåˆ°ç°æœ‰å‘½ä»¤

```javascript
// tm list --board
export function listCommand(program) {
  program
    .command('list')
    .option('--board', 'åœ¨æ¡Œé¢ç«¯æ˜¾ç¤º')
    .action(async (options) => {
      const tasks = await getTasks();

      if (options.board) {
        // ç¡®ä¿æ¡Œé¢ç«¯å·²å¯åŠ¨
        await ensureDesktopRunning();
        
        // æ˜¾ç¤ºåœ¨æ¡Œé¢ç«¯
        desktopManager.showTodo(tasks);
        console.log('âœ… å·²åœ¨æ¡Œé¢ç«¯æ˜¾ç¤º');
      } else {
        // ç»ˆç«¯æ˜¾ç¤º
        console.table(tasks);
      }
    });
}

// è¾…åŠ©å‡½æ•°ï¼šç¡®ä¿æ¡Œé¢ç«¯è¿è¡Œ
async function ensureDesktopRunning() {
  if (!desktopManager.isRunning) {
    console.log('ğŸš€ å¯åŠ¨æ¡Œé¢ç«¯...');
    desktopManager.start();
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
}
```

---

## ç»„ä»¶å¼€å‘

### 1. TODO åˆ—è¡¨ç»„ä»¶

**æ•°æ®æ ¼å¼ï¼š**
```javascript
{
  type: 'todo',
  data: {
    tasks: [
      { id: 1, title: 'ä»»åŠ¡æ ‡é¢˜', done: false, priority: 'high' },
      { id: 2, title: 'ä»»åŠ¡æ ‡é¢˜', done: true, priority: 'medium' }
    ]
  }
}
```

**æ¸²æŸ“é€»è¾‘ï¼š**
```javascript
function renderTodo(data) {
  const html = data.tasks.map(task => `
    <div class="task ${task.done ? 'done' : ''}">
      <input type="checkbox" ${task.done ? 'checked' : ''} disabled>
      <span class="task-title">${escapeHtml(task.title)}</span>
      <span class="priority priority-${task.priority}">${task.priority}</span>
    </div>
  `).join('');
  
  document.getElementById('todo-content').innerHTML = html;
}
```

### 2. å›¾ç‰‡é¢„è§ˆç»„ä»¶

**æ•°æ®æ ¼å¼ï¼š**
```javascript
{
  type: 'image',
  data: {
    url: '/images/screenshot.png',
    title: 'æˆªå›¾é¢„è§ˆ'
  }
}
```

**æ¸²æŸ“é€»è¾‘ï¼š**
```javascript
function renderImage(data) {
  document.getElementById('image-title').textContent = data.title;
  document.getElementById('image-content').src = data.url;
}
```

### 3. ä»£ç å¯¹æ¯”ç»„ä»¶

**æ•°æ®æ ¼å¼ï¼š**
```javascript
{
  type: 'diff',
  data: {
    before: 'function hello() {...}',
    after: 'function hello(name) {...}',
    filename: 'main.js'
  }
}
```

**æ¸²æŸ“é€»è¾‘ï¼š**
```javascript
function renderDiff(data) {
  document.getElementById('diff-filename').textContent = data.filename;
  document.getElementById('diff-before').textContent = data.before;
  document.getElementById('diff-after').textContent = data.after;
}
```

**è¿›é˜¶ï¼šä½¿ç”¨ diff2html åº“**
```javascript
import { html } from 'diff2html';
import { createPatch } from 'diff';

function renderDiff(data) {
  const patch = createPatch('file', data.before, data.after);
  const diffHtml = html(patch, { drawFileList: false });
  document.getElementById('diff-content').innerHTML = diffHtml;
}
```

---

## è¿›é˜¶åŠŸèƒ½

### 1. è‡ªåŠ¨å¯åŠ¨æ¡Œé¢ç«¯

```javascript
// åœ¨ä»»ä½•éœ€è¦æ˜¾ç¤ºçš„å‘½ä»¤ä¸­
async function ensureDesktopRunning() {
  if (!desktopManager.isRunning) {
    desktopManager.start();
    // ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
}
```

### 2. çª—å£å°ºå¯¸æ§åˆ¶

```javascript
// æ ¹æ®å†…å®¹ç±»å‹è°ƒæ•´çª—å£å¤§å°
function openWindow(type) {
  const sizes = {
    todo: '800,600',
    image: '1000,800',
    diff: '1200,800'
  };
  
  const size = sizes[type] || '800,600';
  exec(`chrome --app=${url} --window-size=${size}`);
}
```

### 3. å¤šçª—å£æ”¯æŒ

```javascript
// åŒæ—¶æ‰“å¼€å¤šä¸ªçª—å£
class DesktopManager {
  constructor() {
    this.windows = new Map(); // çª—å£ç®¡ç†
  }

  openWindow(id, type, data) {
    const port = 9527 + this.windows.size;
    // å¯åŠ¨æ–°çš„æœåŠ¡å™¨å®ä¾‹...
    this.windows.set(id, { port, type, data });
  }
}
```

### 4. WebSocket å®æ—¶é€šä¿¡

```javascript
// åç«¯
import { Server } from 'socket.io';

const io = new Server(server);

io.on('connection', (socket) => {
  console.log('Client connected');
  
  // å‘é€å½“å‰è§†å›¾
  socket.emit('view-update', currentView);
});

// å½“è§†å›¾æ›´æ–°æ—¶
function updateView(type, data) {
  currentView = { type, data };
  io.emit('view-update', currentView);
}

// å‰ç«¯
import io from 'socket.io-client';

const socket = io('http://localhost:9527');

socket.on('view-update', ({ type, data }) => {
  switchView(type, data);
});
```

---

## æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†

```javascript
// æ£€æŸ¥ Chrome æ˜¯å¦å®‰è£…
function isChromeInstalled() {
  const paths = {
    darwin: '/Applications/Google Chrome.app',
    win32: 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
    linux: '/usr/bin/google-chrome'
  };
  
  return fs.existsSync(paths[process.platform]);
}

// é™çº§æ–¹æ¡ˆ
if (!isChromeInstalled()) {
  console.log('Chrome æœªå®‰è£…ï¼Œä½¿ç”¨é»˜è®¤æµè§ˆå™¨');
  import('open').then(open => open.default(url));
}
```

### 2. ç«¯å£å†²çªå¤„ç†

```javascript
async function findAvailablePort(startPort) {
  let port = startPort;
  
  while (!(await isPortAvailable(port))) {
    port++;
  }
  
  return port;
}

// ä½¿ç”¨
const port = await findAvailablePort(9527);
```

### 3. ä¼˜é›…å…³é—­

```javascript
// ç›‘å¬è¿›ç¨‹é€€å‡º
process.on('SIGINT', () => {
  console.log('æ­£åœ¨å…³é—­æœåŠ¡å™¨...');
  desktopManager.stop();
  process.exit(0);
});

// ç›‘å¬ Chrome çª—å£å…³é—­
chromeProcess.on('exit', () => {
  console.log('Chrome çª—å£å·²å…³é—­');
  // å¯é€‰ï¼šè‡ªåŠ¨åœæ­¢æœåŠ¡å™¨
  desktopManager.stop();
});
```

### 4. æ€§èƒ½ä¼˜åŒ–

```javascript
// å‰ç«¯ï¼šæ™ºèƒ½è½®è¯¢
let pollInterval = 500;

async function poll() {
  const { type, data } = await fetch('/api/view').then(r => r.json());
  
  if (type !== currentType) {
    // æœ‰å˜åŒ–ï¼ŒåŠ å¿«è½®è¯¢
    pollInterval = 200;
  } else {
    // æ— å˜åŒ–ï¼Œå‡æ…¢è½®è¯¢
    pollInterval = Math.min(pollInterval + 100, 2000);
  }
  
  setTimeout(poll, pollInterval);
}
```

---

## è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨ Chrome DevTools

```javascript
// å³é”® â†’ æ£€æŸ¥ â†’ æ‰“å¼€ DevTools
// æˆ–è€…åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰“å¼€
exec(`chrome --app=${url} --auto-open-devtools-for-tabs`);
```

### 2. æ—¥å¿—è¾“å‡º

```javascript
// åç«¯æ—¥å¿—
console.log('[Desktop]', 'View updated:', currentView.type);

// å‰ç«¯æ—¥å¿—
console.log('[App]', 'Switched to:', type);
```

### 3. ç½‘ç»œç›‘æ§

```javascript
// åœ¨ DevTools çš„ Network æ ‡ç­¾ä¸­æŸ¥çœ‹
// æ‰€æœ‰ /api/view è¯·æ±‚
```

---

## éƒ¨ç½²å»ºè®®

### 1. æ‰“åŒ…å‘å¸ƒ

```json
{
  "bin": {
    "your-cli": "./dist/index.js"
  },
  "files": [
    "dist/",
    "src/desktop/public/"
  ]
}
```

### 2. ä¾èµ–ç®¡ç†

```json
{
  "dependencies": {
    "express": "^4.18.2"
  },
  "devDependencies": {
    "@types/express": "^4.17.17"
  }
}
```

### 3. ç”¨æˆ·å®‰è£…

```bash
npm install -g your-cli

# ç”¨æˆ·ä½¿ç”¨
your-cli desktop start
your-cli list --board
```

---

## æ€»ç»“

å®ç° Chrome App Mode çš„å…³é”®æ­¥éª¤ï¼š

1. **åˆ›å»º Express æœåŠ¡å™¨** - æä¾› API å’Œé™æ€æ–‡ä»¶
2. **å®ç° Desktop Manager** - ç®¡ç†æœåŠ¡å™¨å’Œçª—å£
3. **å¯åŠ¨ Chrome App** - ä½¿ç”¨ `--app` å‚æ•°
4. **å‰ç«¯è½®è¯¢** - å®šæ—¶è·å–æœ€æ–°æ•°æ®
5. **ç»„ä»¶æ¸²æŸ“** - æ ¹æ®æ•°æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”è§†å›¾
6. **CLI é›†æˆ** - åœ¨å‘½ä»¤ä¸­è°ƒç”¨ Desktop Manager

æ•´ä¸ªå®ç°éå¸¸ç®€å•ï¼Œæ ¸å¿ƒä»£ç ä¸è¶…è¿‡ 300 è¡Œã€‚
