# 02 - æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†

> Zustand çŠ¶æ€ç®¡ç† + äº‹ä»¶æ€»çº¿ï¼ˆBusï¼‰+ JSON æŒä¹…åŒ–
>
> æ—¥æœŸï¼š2025-12-23

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [Zustand çŠ¶æ€ç®¡ç†](#zustand-çŠ¶æ€ç®¡ç†)
3. [äº‹ä»¶æ€»çº¿ç³»ç»Ÿ](#äº‹ä»¶æ€»çº¿ç³»ç»Ÿ)
4. [æ•°æ®æµå‘](#æ•°æ®æµå‘)
5. [æŒä¹…åŒ–ç­–ç•¥](#æŒä¹…åŒ–ç­–ç•¥)
6. [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 çŠ¶æ€ç®¡ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          UI ç»„ä»¶å±‚                    â”‚
â”‚   useStore() è®¢é˜…çŠ¶æ€                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Zustand â”‚     â”‚   Bus    â”‚
â”‚  Store  â”‚     â”‚ äº‹ä»¶æ€»çº¿ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Storage å±‚            â”‚
â”‚   JSON æ–‡ä»¶æŒä¹…åŒ–           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å•å‘æ•°æ®æµ** | UI â†’ Action â†’ Store â†’ UI |
| **äº‹ä»¶é©±åŠ¨** | Agent é€šè¿‡ Bus å‘å¸ƒäº‹ä»¶ |
| **å³æ—¶æŒä¹…åŒ–** | é‡è¦çŠ¶æ€ç«‹å³å†™å…¥æ–‡ä»¶ |
| **æœ€å°è®¢é˜…** | ç»„ä»¶åªè®¢é˜…éœ€è¦çš„çŠ¶æ€ |

---

## äºŒã€Zustand çŠ¶æ€ç®¡ç†

### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹© Zustandï¼Ÿ

ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”ï¼š

| ç‰¹æ€§ | Zustand | Redux | MobX |
|------|---------|-------|------|
| å­¦ä¹ æ›²çº¿ | â­ æç®€ | â­â­â­ é™¡å³­ | â­â­ ä¸­ç­‰ |
| ä»£ç é‡ | âœ… æœ€å°‘ | âŒ æœ€å¤š | âš ï¸ ä¸­ç­‰ |
| TypeScript | âœ… å®Œç¾ | âš ï¸ å¤æ‚ | âœ… è‰¯å¥½ |
| ä½“ç§¯ | âœ… 1KB | âŒ 8KB | âš ï¸ 16KB |
| DevTools | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

### 2.2 Store å®šä¹‰

#### å®Œæ•´çš„ Store ç»“æ„

```typescript
// src/contexts/store.tsx
import { create } from 'zustand'
import type { Session, Message, Agent, Config } from '@/types'

interface AppState {
  // ===== Session ç›¸å…³ =====
  sessions: Session[]
  currentSessionId: string | null

  // ===== Message ç›¸å…³ =====
  messages: Record<string, Message[]>  // sessionId -> messages

  // ===== Agent ç›¸å…³ =====
  agents: Agent[]
  currentAgent: string
  currentModel: string

  // ===== TODO ç›¸å…³ =====
  todos: Record<string, Todo[]>  // sessionId -> todos

  // ===== Permission ç›¸å…³ =====
  permissions: Record<string, Permission[]>  // sessionId -> permissions

  // ===== Config =====
  config: Config

  // ===== Actions =====
  // Session
  createSession: (title: string) => Promise<Session>
  deleteSession: (id: string) => Promise<void>
  renameSession: (id: string, title: string) => Promise<void>
  switchSession: (id: string) => void

  // Message
  addMessage: (sessionId: string, message: Message) => void
  updateMessage: (sessionId: string, messageId: string, delta: Partial<Message>) => void

  // TODO
  addTodo: (sessionId: string, todo: Todo) => void
  updateTodo: (sessionId: string, todoId: string, update: Partial<Todo>) => void

  // Permission
  requestPermission: (sessionId: string, permission: Permission) => void
  approvePermission: (sessionId: string, permissionId: string) => void

  // Config
  updateConfig: (update: Partial<Config>) => void
}

export const useStore = create<AppState>((set, get) => ({
  // åˆå§‹çŠ¶æ€
  sessions: [],
  currentSessionId: null,
  messages: {},
  agents: [],
  currentAgent: 'default',
  currentModel: 'claude-sonnet-4',
  todos: {},
  permissions: {},
  config: {
    theme: 'kanagawa',
    mode: 'dark',
  },

  // Actions å®ç°
  createSession: async (title) => {
    const session: Session = {
      id: generateId(),
      title,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    }

    // æ›´æ–°çŠ¶æ€
    set(state => ({
      sessions: [...state.sessions, session],
      currentSessionId: session.id,
    }))

    // æŒä¹…åŒ–
    await Storage.saveSession(session)

    return session
  },

  deleteSession: async (id) => {
    set(state => ({
      sessions: state.sessions.filter(s => s.id !== id),
      currentSessionId: state.currentSessionId === id ? null : state.currentSessionId,
    }))

    await Storage.deleteSession(id)
  },

  renameSession: async (id, title) => {
    set(state => ({
      sessions: state.sessions.map(s =>
        s.id === id ? { ...s, title, updatedAt: Date.now() } : s
      ),
    }))

    await Storage.updateSession(id, { title })
  },

  switchSession: (id) => {
    set({ currentSessionId: id })
  },

  addMessage: (sessionId, message) => {
    set(state => ({
      messages: {
        ...state.messages,
        [sessionId]: [...(state.messages[sessionId] || []), message],
      },
    }))

    // å¼‚æ­¥æŒä¹…åŒ–ï¼ˆä¸é˜»å¡ UIï¼‰
    Storage.saveMessage(sessionId, message)
  },

  updateMessage: (sessionId, messageId, delta) => {
    set(state => ({
      messages: {
        ...state.messages,
        [sessionId]: state.messages[sessionId]?.map(m =>
          m.id === messageId ? { ...m, ...delta } : m
        ),
      },
    }))
  },

  // ... å…¶ä»– actions
}))
```

### 2.3 ä½¿ç”¨ Store

#### åŸºç¡€ç”¨æ³•

```typescript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
import { useStore } from '@/contexts/store'

function SessionList() {
  // åªè®¢é˜… sessions
  const sessions = useStore(state => state.sessions)
  const createSession = useStore(state => state.createSession)

  return (
    <Box>
      {sessions.map(session => (
        <Text key={session.id}>{session.title}</Text>
      ))}
    </Box>
  )
}
```

#### é«˜çº§ç”¨æ³•

```typescript
// ç»„åˆå¤šä¸ªçŠ¶æ€
function SessionHeader() {
  const { session, messages } = useStore(state => ({
    session: state.sessions.find(s => s.id === state.currentSessionId),
    messages: state.messages[state.currentSessionId!] || [],
  }))

  return (
    <Box>
      <Text>{session?.title}</Text>
      <Text>{messages.length} messages</Text>
    </Box>
  )
}

// ä½¿ç”¨ shallow æ¯”è¾ƒï¼ˆé¿å…ä¸å¿…è¦çš„ re-renderï¼‰
import { shallow } from 'zustand/shallow'

const { sessions, currentSessionId } = useStore(
  state => ({ sessions: state.sessions, currentSessionId: state.currentSessionId }),
  shallow
)
```

### 2.4 Store ä¼˜åŒ–

#### æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… å¥½çš„åšæ³•ï¼šåªè®¢é˜…éœ€è¦çš„ slice
const sessions = useStore(state => state.sessions)

// âŒ å·®çš„åšæ³•ï¼šè®¢é˜…æ•´ä¸ª store
const store = useStore()  // ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½ä¼šè§¦å‘ re-render
```

#### æ´¾ç”ŸçŠ¶æ€ï¼ˆDerived Stateï¼‰

```typescript
// ä½¿ç”¨ selector è®¡ç®—æ´¾ç”ŸçŠ¶æ€
function SessionCount() {
  const sessionCount = useStore(state => state.sessions.length)

  return <Text>Total: {sessionCount}</Text>
}

// å¤æ‚çš„æ´¾ç”ŸçŠ¶æ€ä½¿ç”¨ useMemo
function FilteredSessions() {
  const { sessions, searchQuery } = useStore(
    state => ({ sessions: state.sessions, searchQuery: state.searchQuery })
  )

  const filtered = useMemo(() =>
    sessions.filter(s => s.title.includes(searchQuery)),
    [sessions, searchQuery]
  )

  return <Box>{/* æ¸²æŸ“ filtered */}</Box>
}
```

---

## ä¸‰ã€äº‹ä»¶æ€»çº¿ç³»ç»Ÿ

### 3.1 Bus è®¾è®¡

#### ä¸ºä»€ä¹ˆéœ€è¦ Busï¼Ÿ

```
é—®é¢˜ï¼šAgent å±‚å¦‚ä½•é€šçŸ¥ UI å±‚ï¼Ÿ

âŒ ç›´æ¥è°ƒç”¨ï¼šè€¦åˆå¤ªå¼º
âœ… äº‹ä»¶æ€»çº¿ï¼šè§£è€¦ï¼Œçµæ´»
```

#### Bus æ¶æ„

```
Agent å±‚
   â†“ publish
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Bus     â”‚
â”‚  äº‹ä»¶æ€»çº¿   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ subscribe
UI å±‚ / Store å±‚
```

### 3.2 Bus å®ç°

```typescript
// src/bus/index.ts
type EventCallback = (event: any) => void

class EventBus {
  private subscribers = new Map<string, Set<EventCallback>>()

  // è®¢é˜…äº‹ä»¶
  subscribe(eventType: string, callback: EventCallback): () => void {
    if (!this.subscribers.has(eventType)) {
      this.subscribers.set(eventType, new Set())
    }

    this.subscribers.get(eventType)!.add(callback)

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.subscribers.get(eventType)?.delete(callback)
    }
  }

  // å‘å¸ƒäº‹ä»¶
  publish(eventType: string, event: any): void {
    const subscribers = this.subscribers.get(eventType)
    if (!subscribers) return

    subscribers.forEach(callback => {
      try {
        callback(event)
      } catch (error) {
        console.error(`Error in event handler for ${eventType}:`, error)
      }
    })
  }

  // è®¢é˜…æ‰€æœ‰äº‹ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
  subscribeAll(callback: EventCallback): () => void {
    const unsubscribers: Array<() => void> = []

    this.subscribers.forEach((_, eventType) => {
      unsubscribers.push(this.subscribe(eventType, callback))
    })

    return () => unsubscribers.forEach(unsub => unsub())
  }
}

export const Bus = new EventBus()
```

### 3.3 äº‹ä»¶å®šä¹‰

```typescript
// src/types/events.ts

// Message äº‹ä»¶
export namespace MessageEvent {
  export const PartUpdated = 'message.part.updated'
  export const MessageCreated = 'message.created'
  export const MessageCompleted = 'message.completed'

  export interface PartUpdatedEvent {
    sessionId: string
    messageId: string
    part: Part
    delta?: string  // æµå¼è¾“å‡ºçš„å¢é‡
  }
}

// Session äº‹ä»¶
export namespace SessionEvent {
  export const Created = 'session.created'
  export const Updated = 'session.updated'
  export const Deleted = 'session.deleted'
}

// Tool äº‹ä»¶
export namespace ToolEvent {
  export const Called = 'tool.called'
  export const Completed = 'tool.completed'
  export const Failed = 'tool.failed'
}

// TODO äº‹ä»¶
export namespace TodoEvent {
  export const Added = 'todo.added'
  export const Updated = 'todo.updated'
  export const Completed = 'todo.completed'
}
```

### 3.4 ä½¿ç”¨ Bus

#### Agent å±‚å‘å¸ƒäº‹ä»¶

```typescript
// src/agent/stream.ts
import { Bus } from '@/bus'
import { MessageEvent } from '@/types/events'

async function* streamChat(prompt: string) {
  for await (const chunk of aiStream) {
    if (chunk.type === 'text-delta') {
      // å‘å¸ƒæ–‡æœ¬å¢é‡äº‹ä»¶
      Bus.publish(MessageEvent.PartUpdated, {
        sessionId,
        messageId,
        part: { type: 'text', text: '' },
        delta: chunk.delta,
      })
    }

    if (chunk.type === 'tool-call') {
      // å‘å¸ƒå·¥å…·è°ƒç”¨äº‹ä»¶
      Bus.publish(ToolEvent.Called, {
        tool: chunk.tool,
        input: chunk.input,
      })
    }
  }
}
```

#### Store å±‚è®¢é˜…äº‹ä»¶

```typescript
// src/contexts/store.tsx
import { Bus } from '@/bus'
import { MessageEvent } from '@/types/events'

// åœ¨ Store åˆå§‹åŒ–æ—¶è®¢é˜…äº‹ä»¶
export const useStore = create<AppState>((set, get) => {
  // è®¢é˜… Message äº‹ä»¶
  Bus.subscribe(MessageEvent.PartUpdated, (event) => {
    const { sessionId, messageId, delta } = event

    // æ›´æ–° Store
    set(state => ({
      messages: {
        ...state.messages,
        [sessionId]: state.messages[sessionId]?.map(m =>
          m.id === messageId
            ? { ...m, content: m.content + (delta || '') }
            : m
        ),
      },
    }))
  })

  return {
    // ... state and actions
  }
})
```

#### UI å±‚ç›´æ¥è®¢é˜…ï¼ˆå¯é€‰ï¼‰

```typescript
// ç»„ä»¶å†…è®¢é˜…ï¼ˆç”¨äºç‰¹æ®Šåœºæ™¯ï¼‰
import { Bus } from '@/bus'
import { ToolEvent } from '@/types/events'
import { useEffect } from 'react'

function ToolMonitor() {
  useEffect(() => {
    const unsubscribe = Bus.subscribe(ToolEvent.Called, (event) => {
      console.log('Tool called:', event.tool)
    })

    return () => unsubscribe()
  }, [])

  return <Text>Monitoring tools...</Text>
}
```

---

## å››ã€æ•°æ®æµå‘

### 4.1 å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥     â”‚
â”‚  (Prompt)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI ç»„ä»¶         â”‚
â”‚  onSubmit()      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store Action    â”‚
â”‚  sendMessage()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent å±‚        â”‚
â”‚  chat()          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (æµå¼è¾“å‡º)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bus.publish()   â”‚
â”‚  PartUpdated     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚
       â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store      â”‚  â”‚  Storage   â”‚
â”‚  è®¢é˜…äº‹ä»¶   â”‚  â”‚  æŒä¹…åŒ–    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Re-render    â”‚
â”‚  æ˜¾ç¤ºæ–°å†…å®¹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…³é”®æµç¨‹

#### å‘é€æ¶ˆæ¯æµç¨‹

```typescript
// 1. ç”¨æˆ·æäº¤
<Prompt onSubmit={handleSubmit} />

// 2. è§¦å‘ Store Action
function handleSubmit(text: string) {
  const { currentSessionId, sendMessage } = useStore.getState()
  sendMessage(currentSessionId, text)
}

// 3. Store Action
sendMessage: async (sessionId, text) => {
  // 3.1 åˆ›å»º User Message
  const userMessage = {
    id: generateId(),
    role: 'user',
    content: text,
    timestamp: Date.now(),
  }

  // 3.2 æ›´æ–° Store
  set(state => ({
    messages: {
      ...state.messages,
      [sessionId]: [...state.messages[sessionId], userMessage],
    },
  }))

  // 3.3 æŒä¹…åŒ–
  await Storage.saveMessage(sessionId, userMessage)

  // 3.4 è°ƒç”¨ Agent
  await Agent.chat(sessionId, text)
}

// 4. Agent æµå¼è¾“å‡º
async function chat(sessionId: string, prompt: string) {
  const assistantMessage = {
    id: generateId(),
    role: 'assistant',
    content: '',
    timestamp: Date.now(),
  }

  // 4.1 åˆ›å»º Assistant Message
  Bus.publish(MessageEvent.MessageCreated, { sessionId, message: assistantMessage })

  // 4.2 æµå¼è¾“å‡º
  for await (const chunk of streamAI(prompt)) {
    if (chunk.delta) {
      Bus.publish(MessageEvent.PartUpdated, {
        sessionId,
        messageId: assistantMessage.id,
        delta: chunk.delta,
      })
    }
  }

  // 4.3 å®Œæˆ
  Bus.publish(MessageEvent.MessageCompleted, { sessionId, messageId: assistantMessage.id })
}

// 5. Store è®¢é˜…äº‹ä»¶æ›´æ–°çŠ¶æ€
Bus.subscribe(MessageEvent.PartUpdated, (event) => {
  set(state => ({
    messages: {
      ...state.messages,
      [event.sessionId]: state.messages[event.sessionId].map(m =>
        m.id === event.messageId
          ? { ...m, content: m.content + event.delta }
          : m
      ),
    },
  }))
})

// 6. UI è‡ªåŠ¨ Re-renderï¼ˆZustand è§¦å‘ï¼‰
```

---

## äº”ã€æŒä¹…åŒ–ç­–ç•¥

### 5.1 å­˜å‚¨ç»“æ„

```
~/.myapp/
â”œâ”€â”€ config.json                    # å…¨å±€é…ç½®
â”œâ”€â”€ sessions/
â”‚   â”œâ”€â”€ session-1.json            # Session å…ƒæ•°æ®
â”‚   â”œâ”€â”€ session-2.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ messages/
â”‚   â”œâ”€â”€ session-1/
â”‚   â”‚   â”œâ”€â”€ message-1.json
â”‚   â”‚   â”œâ”€â”€ message-2.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ session-2/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ todos/
â”‚   â”œâ”€â”€ session-1.json
â”‚   â””â”€â”€ ...
â””â”€â”€ permissions/
    â”œâ”€â”€ session-1.json
    â””â”€â”€ ...
```

### 5.2 Storage å®ç°

```typescript
// src/storage/index.ts
import fs from 'fs/promises'
import path from 'path'
import os from 'os'

const DATA_DIR = path.join(os.homedir(), '.myapp')

export class Storage {
  // åˆå§‹åŒ–ç›®å½•
  static async init() {
    await fs.mkdir(DATA_DIR, { recursive: true })
    await fs.mkdir(path.join(DATA_DIR, 'sessions'), { recursive: true })
    await fs.mkdir(path.join(DATA_DIR, 'messages'), { recursive: true })
    await fs.mkdir(path.join(DATA_DIR, 'todos'), { recursive: true })
    await fs.mkdir(path.join(DATA_DIR, 'permissions'), { recursive: true })
  }

  // ===== Session =====
  static async saveSession(session: Session) {
    const filePath = path.join(DATA_DIR, 'sessions', `${session.id}.json`)
    await fs.writeFile(filePath, JSON.stringify(session, null, 2))
  }

  static async loadSession(id: string): Promise<Session | null> {
    try {
      const filePath = path.join(DATA_DIR, 'sessions', `${id}.json`)
      const data = await fs.readFile(filePath, 'utf-8')
      return JSON.parse(data)
    } catch {
      return null
    }
  }

  static async loadAllSessions(): Promise<Session[]> {
    const files = await fs.readdir(path.join(DATA_DIR, 'sessions'))
    const sessions = await Promise.all(
      files
        .filter(f => f.endsWith('.json'))
        .map(f => this.loadSession(f.replace('.json', '')))
    )
    return sessions.filter(s => s !== null) as Session[]
  }

  static async deleteSession(id: string) {
    await fs.unlink(path.join(DATA_DIR, 'sessions', `${id}.json`))
    await fs.rm(path.join(DATA_DIR, 'messages', id), { recursive: true, force: true })
  }

  // ===== Message =====
  static async saveMessage(sessionId: string, message: Message) {
    const dirPath = path.join(DATA_DIR, 'messages', sessionId)
    await fs.mkdir(dirPath, { recursive: true })

    const filePath = path.join(dirPath, `${message.id}.json`)
    await fs.writeFile(filePath, JSON.stringify(message, null, 2))
  }

  static async loadMessages(sessionId: string): Promise<Message[]> {
    try {
      const dirPath = path.join(DATA_DIR, 'messages', sessionId)
      const files = await fs.readdir(dirPath)

      const messages = await Promise.all(
        files
          .filter(f => f.endsWith('.json'))
          .map(async f => {
            const data = await fs.readFile(path.join(dirPath, f), 'utf-8')
            return JSON.parse(data)
          })
      )

      return messages.sort((a, b) => a.timestamp - b.timestamp)
    } catch {
      return []
    }
  }

  // ===== Config =====
  static async saveConfig(config: Config) {
    const filePath = path.join(DATA_DIR, 'config.json')
    await fs.writeFile(filePath, JSON.stringify(config, null, 2))
  }

  static async loadConfig(): Promise<Config> {
    try {
      const filePath = path.join(DATA_DIR, 'config.json')
      const data = await fs.readFile(filePath, 'utf-8')
      return JSON.parse(data)
    } catch {
      return {
        theme: 'kanagawa',
        mode: 'dark',
      }
    }
  }
}
```

### 5.3 æŒä¹…åŒ–æ—¶æœº

| æ“ä½œ | æ—¶æœº | ç­–ç•¥ |
|------|------|------|
| **åˆ›å»º Session** | ç«‹å³ | åŒæ­¥å†™å…¥ |
| **é‡å‘½å Session** | ç«‹å³ | åŒæ­¥å†™å…¥ |
| **åˆ é™¤ Session** | ç«‹å³ | åŒæ­¥åˆ é™¤ |
| **æ·»åŠ  Message** | å»¶è¿Ÿ | å¼‚æ­¥å†™å…¥ |
| **æ›´æ–° Config** | å»¶è¿Ÿ | é˜²æŠ–å†™å…¥ |
| **TODO/Permission** | ç«‹å³ | åŒæ­¥å†™å…¥ |

### 5.4 åˆå§‹åŒ–åŠ è½½

```typescript
// src/contexts/store.tsx
export const useStore = create<AppState>((set, get) => {
  // åˆå§‹åŒ–æ—¶åŠ è½½æ•°æ®
  Storage.init().then(async () => {
    const [sessions, config] = await Promise.all([
      Storage.loadAllSessions(),
      Storage.loadConfig(),
    ])

    set({
      sessions,
      config,
    })

    // å¦‚æœæœ‰å½“å‰ Sessionï¼ŒåŠ è½½å…¶ Messages
    if (sessions.length > 0) {
      const sessionId = sessions[0].id
      const messages = await Storage.loadMessages(sessionId)

      set(state => ({
        currentSessionId: sessionId,
        messages: { ...state.messages, [sessionId]: messages },
      }))
    }
  })

  return {
    // ... state and actions
  }
})
```

---

## å…­ã€å®æˆ˜ç¤ºä¾‹

### 6.1 å®Œæ•´çš„å‘é€æ¶ˆæ¯ç¤ºä¾‹

```typescript
// components/prompt/index.tsx
import { useStore } from '@/contexts/store'
import { TextInput } from 'ink'
import { useState } from 'react'

export function Prompt() {
  const [input, setInput] = useState('')
  const { currentSessionId, sendMessage } = useStore(state => ({
    currentSessionId: state.currentSessionId,
    sendMessage: state.sendMessage,
  }))

  const handleSubmit = async () => {
    if (!input.trim() || !currentSessionId) return

    await sendMessage(currentSessionId, input)
    setInput('')
  }

  return (
    <TextInput
      value={input}
      onChange={setInput}
      onSubmit={handleSubmit}
    />
  )
}
```

### 6.2 æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨

```typescript
// routes/session/index.tsx
import { useStore } from '@/contexts/store'
import { Box, Text } from 'ink'

export function Session() {
  const { currentSessionId, messages } = useStore(state => ({
    currentSessionId: state.currentSessionId,
    messages: state.messages[state.currentSessionId!] || [],
  }))

  return (
    <Box flexDirection="column">
      {messages.map(message => (
        <Box key={message.id}>
          <Text bold>{message.role}: </Text>
          <Text>{message.content}</Text>
        </Box>
      ))}
    </Box>
  )
}
```

### 6.3 ç›‘å¬æµå¼è¾“å‡º

```typescript
// routes/session/index.tsx
import { useEffect, useRef } from 'react'
import { Bus } from '@/bus'
import { MessageEvent } from '@/types/events'

export function Session() {
  const scrollRef = useRef<any>()

  useEffect(() => {
    // ç›‘å¬æ¶ˆæ¯æ›´æ–°ï¼Œè‡ªåŠ¨æ»šåŠ¨
    const unsubscribe = Bus.subscribe(MessageEvent.PartUpdated, () => {
      scrollRef.current?.scrollToBottom()
    })

    return () => unsubscribe()
  }, [])

  return (
    <ScrollBox ref={scrollRef}>
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
    </ScrollBox>
  )
}
```

---

## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 çŠ¶æ€åˆ†ç‰‡

```typescript
// âœ… å¥½çš„åšæ³•ï¼šåˆ†ç¦»ä¸åŒçš„çŠ¶æ€
interface SessionState {
  sessions: Session[]
  currentSessionId: string | null
  createSession: () => Promise<void>
  // ...
}

interface MessageState {
  messages: Record<string, Message[]>
  addMessage: () => void
  // ...
}

// åˆå¹¶
type AppState = SessionState & MessageState
```

### 7.2 å¼‚æ­¥ Action

```typescript
// âœ… å¥½çš„åšæ³•ï¼šå¼‚æ­¥æ“ä½œè¿”å› Promise
createSession: async (title) => {
  const session = { /* ... */ }
  set(/* update state */)
  await Storage.saveSession(session)  // ç­‰å¾…æŒä¹…åŒ–å®Œæˆ
  return session
}

// âŒ å·®çš„åšæ³•ï¼šä¸ç­‰å¾…æŒä¹…åŒ–
createSession: (title) => {
  const session = { /* ... */ }
  set(/* update state */)
  Storage.saveSession(session)  // fire and forget
}
```

### 7.3 é”™è¯¯å¤„ç†

```typescript
// Store Action ä¸­çš„é”™è¯¯å¤„ç†
createSession: async (title) => {
  try {
    const session = { /* ... */ }
    set(/* update state */)
    await Storage.saveSession(session)
    return session
  } catch (error) {
    // å‘å¸ƒé”™è¯¯äº‹ä»¶
    Bus.publish('error', { message: 'Failed to create session', error })
    throw error
  }
}

// UI å±‚å¤„ç†é”™è¯¯
const createSession = useStore(state => state.createSession)

async function handleCreate() {
  try {
    await createSession('New Session')
    toast.success('Session created')
  } catch (error) {
    toast.error('Failed to create session')
  }
}
```

---

## å…«ã€æ€»ç»“

### 8.1 æ•°æ®æµæ€»ç»“

```
ç”¨æˆ·è¾“å…¥ â†’ Store Action â†’ Agent å±‚ â†’ Bus äº‹ä»¶
  â†’ Store æ›´æ–° â†’ Storage æŒä¹…åŒ– â†’ UI Re-render
```

### 8.2 å…³é”®ç‚¹

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **Zustand** | è½»é‡çº§çŠ¶æ€ç®¡ç† |
| **Bus** | è§£è€¦ Agent å’Œ UI |
| **JSON** | ç®€å•å¯é çš„æŒä¹…åŒ– |
| **å•å‘æµ** | æ•°æ®æµæ¸…æ™° |
| **äº‹ä»¶é©±åŠ¨** | å®æ—¶åé¦ˆ |

### 8.3 ä¸‹ä¸€æ­¥

1. âœ… é˜…è¯» [æ ¸å¿ƒUIç»„ä»¶å®ç°æŒ‡å—](./03-æ ¸å¿ƒUIç»„ä»¶å®ç°æŒ‡å—.md)
2. âœ… é˜…è¯» [ä¸»é¢˜ç³»ç»Ÿè®¾è®¡](./04-ä¸»é¢˜ç³»ç»Ÿè®¾è®¡.md)
3. âœ… å¼€å§‹ç¼–ç å®ç°

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-12-23
