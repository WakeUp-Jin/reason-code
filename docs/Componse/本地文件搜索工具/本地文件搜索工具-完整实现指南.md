# æœ¬åœ°æ–‡ä»¶æœç´¢å·¥å…· - å®Œæ•´å®ç°æŒ‡å—

> **æ ¸å¿ƒç†å¿µ**ï¼šæ ¹æ®è¿è¡Œæ—¶ç¯å¢ƒï¼ˆBun/Node.jsï¼‰å’Œå¯ç”¨å·¥å…·ï¼ˆripgrep/git/grepï¼‰ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆï¼Œä¿è¯æ€§èƒ½å’Œå…¼å®¹æ€§çš„å®Œç¾å¹³è¡¡ã€‚

## ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
- [3. ç¯å¢ƒè‡ªé€‚åº”é™çº§ç­–ç•¥](#3-ç¯å¢ƒè‡ªé€‚åº”é™çº§ç­–ç•¥)
- [4. Ripgrep åº•å±‚å®ç°](#4-ripgrep-åº•å±‚å®ç°)
- [5. Glob å·¥å…·å®ç°](#5-glob-å·¥å…·å®ç°)
- [6. Grep å·¥å…·å®ç°](#6-grep-å·¥å…·å®ç°)
- [7. æ€§èƒ½ä¼˜åŒ–](#7-æ€§èƒ½ä¼˜åŒ–)
- [8. å®‰å…¨ä¸å®¹é”™è®¾è®¡](#8-å®‰å…¨ä¸å®¹é”™è®¾è®¡)
- [9. ä½¿ç”¨ç¤ºä¾‹](#9-ä½¿ç”¨ç¤ºä¾‹)

---

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

1. **æ€§èƒ½ä¼˜å…ˆ**ï¼šåœ¨æ¯ç§ç¯å¢ƒä¸‹é€‰æ‹©æœ€å¿«çš„æ–¹æ¡ˆ
2. **é›¶å¤±è´¥ä¿è¯**ï¼šä»»ä½•ç¯å¢ƒéƒ½èƒ½æ­£å¸¸å·¥ä½œ
3. **ç¯å¢ƒè‡ªé€‚åº”**ï¼šæ ¹æ® Bun/Node.js è‡ªåŠ¨ä¼˜åŒ–
4. **é€æ˜åˆ‡æ¢**ï¼šå¯¹ç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥
5. **å¯è§‚æµ‹æ€§**ï¼šè®°å½•é™çº§è·¯å¾„ï¼Œä¾¿äºåˆ†æ

### 1.2 æ ¸å¿ƒåŠŸèƒ½

æœ¬é¡¹ç›®å®ç°ä¸¤ä¸ªå¼ºå¤§çš„æœ¬åœ°æ–‡ä»¶æœç´¢å·¥å…·ï¼š

| å·¥å…·     | ç”¨é€”         | æœç´¢ç›®æ ‡    | è¾“å…¥æ¨¡å¼               |
| -------- | ------------ | ----------- | ---------------------- |
| **Glob** | æ–‡ä»¶è·¯å¾„æœç´¢ | æ–‡ä»¶å/è·¯å¾„ | Glob æ¨¡å¼ï¼ˆå¦‚ `*.ts`ï¼‰ |
| **Grep** | æ–‡ä»¶å†…å®¹æœç´¢ | æ–‡ä»¶å†…å®¹    | æ­£åˆ™è¡¨è¾¾å¼             |

### 1.3 å·¥å…·å¯¹æ¯”

| ç‰¹æ€§         | **Glob**                   | **Grep**                          |
| ------------ | -------------------------- | --------------------------------- |
| **æœç´¢ç›®æ ‡** | æ–‡ä»¶å/è·¯å¾„                | æ–‡ä»¶å†…å®¹                          |
| **è¿”å›å†…å®¹** | ä»…æ–‡ä»¶è·¯å¾„åˆ—è¡¨             | æ–‡ä»¶è·¯å¾„ + è¡Œå· + åŒ¹é…è¡Œå†…å®¹      |
| **æ€§èƒ½**     | æå¿«ï¼ˆåªéå†æ–‡ä»¶åï¼‰       | ç›¸å¯¹è¾ƒæ…¢ï¼ˆéœ€è¯»å–æ–‡ä»¶å†…å®¹ï¼‰        |
| **å…¸å‹ç”¨ä¾‹** | "æ‰¾åˆ°æ‰€æœ‰ `.test.ts` æ–‡ä»¶" | "æ‰¾åˆ°æ‰€æœ‰è°ƒç”¨ `getUserId` çš„åœ°æ–¹" |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å·¥å…·å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚    GlobTool      â”‚              â”‚    GrepTool      â”‚         â”‚
â”‚  â”‚   (æ–‡ä»¶æœç´¢)      â”‚              â”‚   (å†…å®¹æœç´¢)      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                â”‚
            â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç­–ç•¥å±‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  GlobStrategy    â”‚              â”‚  GrepStrategy    â”‚           â”‚
â”‚  â”‚  ç­–ç•¥é€‰æ‹©å™¨       â”‚              â”‚  ç­–ç•¥é€‰æ‹©å™¨       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                                 â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â–¼                 â–¼          â–¼             â–¼             â–¼       â”‚
â”‚ ripgrep+stat    globåŒ…     ripgrep      git grep     system grep  â”‚
â”‚ (Bunç¯å¢ƒ)      (é€šç”¨)      (æœ€å¿«)      (Gitä»“åº“)      (ç³»ç»Ÿ)       â”‚
â”‚                                                          â”‚       â”‚
â”‚                                               JavaScript fallback â”‚
â”‚                                               (ä¿åº• 100% å¯ç”¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                â”‚
            â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ ¸å¿ƒå±‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Runtime        â”‚  â”‚  ToolDetection   â”‚  â”‚   Ripgrep        â”‚ â”‚
â”‚  â”‚   è¿è¡Œæ—¶æ£€æµ‹      â”‚  â”‚   å·¥å…·å¯ç”¨æ€§æ£€æµ‹  â”‚  â”‚   åº•å±‚å·¥å…·ç±»      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–‡ä»¶ç»“æ„

```
packages/core/src/core/tool/
â”œâ”€â”€ Glob/
â”‚   â”œâ”€â”€ definitions.ts          # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ executors.ts            # æ‰§è¡Œå™¨
â”‚   â””â”€â”€ strategies/
â”‚       â”œâ”€â”€ ripgrep-bun.ts      # ripgrep + Bun.stat ç­–ç•¥
â”‚       â””â”€â”€ glob-npm.ts         # glob npm åŒ…ç­–ç•¥
â”œâ”€â”€ Grep/
â”‚   â”œâ”€â”€ definitions.ts          # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ executors.ts            # æ‰§è¡Œå™¨
â”‚   â””â”€â”€ strategies/
â”‚       â”œâ”€â”€ ripgrep.ts          # ripgrep ç­–ç•¥
â”‚       â”œâ”€â”€ git-grep.ts         # git grep ç­–ç•¥
â”‚       â”œâ”€â”€ system-grep.ts      # system grep ç­–ç•¥
â”‚       â””â”€â”€ javascript.ts       # JavaScript fallback ç­–ç•¥
â””â”€â”€ utils/
    â”œâ”€â”€ runtime.ts              # è¿è¡Œæ—¶ç¯å¢ƒæ£€æµ‹
    â”œâ”€â”€ tool-detection.ts       # å·¥å…·å¯ç”¨æ€§æ£€æµ‹
    â””â”€â”€ ripgrep.ts              # Ripgrep åº•å±‚ç±»
```

### 2.3 æ•°æ®æµå‘

#### Glob å·¥å…·æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥: { pattern: "**/*.test.ts" }
    â†“
GlobTool.execute()
    â†“
selectGlobStrategy() â†’ é€‰æ‹©æœ€ä¼˜ç­–ç•¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bun + ripgrep å¯ç”¨?                  â”‚
â”‚   â†“ æ˜¯                 â†“ å¦          â”‚
â”‚ ripgrep + Bun.stat()   glob npm åŒ…   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è·å–æ–‡ä»¶åˆ—è¡¨ + ä¿®æ”¹æ—¶é—´
    â†“
æ™ºèƒ½æ’åºï¼ˆ24å°æ—¶å†…ä¼˜å…ˆï¼‰
    â†“
æ ¼å¼åŒ–è¾“å‡º: { files: [...], count: N, strategy: "..." }
```

#### Grep å·¥å…·æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥: { pattern: "async function", include: "*.ts" }
    â†“
GrepTool.execute()
    â†“
selectGrepStrategy() â†’ é€‰æ‹©æœ€ä¼˜ç­–ç•¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ripgrep å¯ç”¨?  â†’ ripgrep                            â”‚
â”‚      â†“ å¦                                           â”‚
â”‚ Git ä»“åº“ + git å¯ç”¨?  â†’ git grep                    â”‚
â”‚      â†“ å¦                                           â”‚
â”‚ grep å‘½ä»¤å¯ç”¨?  â†’ system grep                       â”‚
â”‚      â†“ å¦                                           â”‚
â”‚ JavaScript fallback (ä¿åº•)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è§£ææœç´¢ç»“æœ
    â†“
æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
    â†“
æ ¼å¼åŒ–è¾“å‡º: { matches: [...], count: N, strategy: "..." }
```

---

## 3. ç¯å¢ƒè‡ªé€‚åº”é™çº§ç­–ç•¥

### 3.1 æ ¸å¿ƒç†å¿µ

#### Bun ç¯å¢ƒçš„ç‰¹æ®Šä¼˜åŠ¿

```typescript
// Bun çš„ file().stat() æ¯” Node.js å¿« 12 å€ï¼
const stats = await Bun.file(path).stat(); // ~0.1ms/æ–‡ä»¶ âš¡âš¡âš¡
```

**ç»“è®º**ï¼š

- âœ… Bun ç¯å¢ƒä¸‹ï¼Œripgrep + Bun.stat() ç»„åˆæ€§èƒ½æä½³
- âœ… é¢å¤–çš„ stat å¼€é”€å‡ ä¹å¯ä»¥å¿½ç•¥

#### Node.js ç¯å¢ƒçš„é™åˆ¶

```typescript
// Node.js çš„ fs.stat() ç›¸å¯¹è¾ƒæ…¢
const stats = await fs.promises.stat(path); // ~1.2ms/æ–‡ä»¶
```

**ç»“è®º**ï¼š

- âŒ Node.js ç¯å¢ƒä¸‹ï¼Œå¤§é‡ stat è°ƒç”¨ä¼šæˆä¸ºç“¶é¢ˆ
- âœ… glob åŒ…ä¸€æ¬¡æ€§è¿”å›å…ƒæ•°æ®æ›´ä¼˜

### 3.2 Glob å·¥å…·ç­–ç•¥çŸ©é˜µ

| ç¯å¢ƒ        | ripgrep å¯ç”¨ | æœ€ä¼˜æ–¹æ¡ˆ             | æ€§èƒ½            | è¯´æ˜                          |
| ----------- | ------------ | -------------------- | --------------- | ----------------------------- |
| **Bun**     | âœ… æ˜¯        | ripgrep + Bun.stat() | â­â­â­â­â­ 62ms | Bun.stat() æå¿«ï¼Œç»„åˆæ€§èƒ½æœ€ä½³ |
| **Bun**     | âŒ å¦        | glob npm åŒ…          | â­â­â­â­ 103ms  | é™çº§æ–¹æ¡ˆï¼Œæ€§èƒ½ä¹Ÿå¾ˆå¥½          |
| **Node.js** | âœ… æ˜¯        | glob npm åŒ…          | â­â­â­â­ 103ms  | é¿å… Node.js æ…¢é€Ÿ stat        |
| **Node.js** | âŒ å¦        | glob npm åŒ…          | â­â­â­â­ 103ms  | å”¯ä¸€é€‰æ‹©                      |

**å…³é”®å‘ç°**ï¼š

- ğŸ† Bun + ripgrep = **æœ€å¿«**ï¼ˆ62msï¼‰
- âš ï¸ Node.js ç¯å¢ƒ**ä¸ä½¿ç”¨ ripgrep**ï¼ˆå³ä½¿å¯ç”¨ï¼‰ï¼Œé¿å…æ…¢é€Ÿ stat

### 3.3 Grep å·¥å…·ç­–ç•¥çŸ©é˜µ

| ç­–ç•¥            | è§¦å‘æ¡ä»¶            | æ€§èƒ½             | å¯ç”¨æ€§   | å¤±è´¥åé™çº§    |
| --------------- | ------------------- | ---------------- | -------- | ------------- |
| **ripgrep**     | ripgrep å¯ç”¨        | â­â­â­â­â­ 0.25s | 95%      | â†’ git grep    |
| **git grep**    | Git ä»“åº“ + git å¯ç”¨ | â­â­â­â­â­ 0.12s | 70%      | â†’ system grep |
| **system grep** | grep å‘½ä»¤å¯ç”¨       | â­â­â­ 1.1s      | 90%      | â†’ JavaScript  |
| **JavaScript**  | **æ€»æ˜¯å¯ç”¨**        | â­â­ 4.5s        | **100%** | **æ€»æ˜¯æˆåŠŸ**  |

**å…³é”®å‘ç°**ï¼š

- ğŸ† git grep åœ¨ Git ä»“åº“ä¸­**æœ€å¿«**ï¼ˆåˆ©ç”¨ç´¢å¼•ï¼‰
- ğŸ›¡ï¸ JavaScript ä¿è¯ **100% å¯ç”¨**

### 3.4 å†³ç­–æµç¨‹å›¾

#### Glob å†³ç­–æµç¨‹

```
æ£€æµ‹è¿è¡Œç¯å¢ƒ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â†“               â†“
Bun           Node.js
â†“               â†“
ripgrep å¯ç”¨?   ç›´æ¥ç”¨ glob åŒ… âœ…
â†“               (é¿å…æ…¢é€Ÿ stat)
æ˜¯ â†“  â†“ å¦
   â†“  â†“
   â†“  glob åŒ… âœ…
   â†“
ripgrep + Bun.stat() â­
(æœ€å¿« 62ms)
```

#### Grep å†³ç­–æµç¨‹

```
ripgrep å¯ç”¨? â”€â”€yesâ”€â†’ ripgrep â­â­â­â­â­
    â†“ no
Git ä»“åº“ + git å¯ç”¨? â”€â”€yesâ”€â†’ git grep â­â­â­â­â­
    â†“ no
grep å‘½ä»¤å¯ç”¨? â”€â”€yesâ”€â†’ system grep â­â­â­
    â†“ no
JavaScript ä¿åº• âœ… (100% å¯ç”¨)
```

---

## 4. Ripgrep åº•å±‚å®ç°

### 4.1 å¹³å°æ”¯æŒ

```typescript
const PLATFORM = {
  'arm64-darwin': {
    platform: 'aarch64-apple-darwin',
    extension: 'tar.gz',
  },
  'arm64-linux': {
    platform: 'aarch64-unknown-linux-gnu',
    extension: 'tar.gz',
  },
  'x64-darwin': {
    platform: 'x86_64-apple-darwin',
    extension: 'tar.gz',
  },
  'x64-linux': {
    platform: 'x86_64-unknown-linux-musl',
    extension: 'tar.gz',
  },
  'x64-win32': {
    platform: 'x86_64-pc-windows-msvc',
    extension: 'zip',
  },
} as const;
```

æ”¯æŒçš„å¹³å°ï¼š

- macOS (ARM64/Mç³»åˆ—èŠ¯ç‰‡)
- macOS (x64/IntelèŠ¯ç‰‡)
- Linux (ARM64)
- Linux (x64)
- Windows (x64)

### 4.2 æ‡’åŠ è½½ä¸‹è½½æœºåˆ¶

```typescript
const state = lazy(async () => {
  // 1. é¦–å…ˆå°è¯•ä½¿ç”¨ç³»ç»Ÿå·²å®‰è£…çš„ rg
  let filepath = Bun.which('rg');
  if (filepath) return { filepath };

  // 2. ä½¿ç”¨æœ¬åœ°ç¼“å­˜è·¯å¾„
  filepath = path.join(Global.Path.bin, 'rg' + (process.platform === 'win32' ? '.exe' : ''));

  const file = Bun.file(filepath);
  if (!(await file.exists())) {
    // 3. æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½æµç¨‹
    await downloadAndInstall(filepath);
  }

  return { filepath };
});
```

#### ä¸‹è½½æµç¨‹

```typescript
// æ„å»ºä¸‹è½½ URL
const platformKey = `${process.arch}-${process.platform}` as keyof typeof PLATFORM;
const config = PLATFORM[platformKey];
if (!config) throw new UnsupportedPlatformError({ platform: platformKey });

const version = '14.1.1';
const filename = `ripgrep-${version}-${config.platform}.${config.extension}`;
const url = `https://github.com/BurntSushi/ripgrep/releases/download/${version}/${filename}`;

// ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
const response = await fetch(url);
if (!response.ok) throw new DownloadFailedError({ url, status: response.status });

const buffer = await response.arrayBuffer();
const archivePath = path.join(Global.Path.bin, filename);
await Bun.write(archivePath, buffer);
```

#### è§£å‹å¤„ç†

**tar.gz æ ¼å¼ï¼ˆmacOS å’Œ Linuxï¼‰**ï¼š

```typescript
if (config.extension === 'tar.gz') {
  const args = ['tar', '-xzf', archivePath, '--strip-components=1'];

  // ä¸åŒå¹³å°éœ€è¦ä¸åŒçš„å‚æ•°
  if (platformKey.endsWith('-darwin')) args.push('--include=*/rg');
  if (platformKey.endsWith('-linux')) args.push('--wildcards', '*/rg');

  const proc = Bun.spawn(args, {
    cwd: Global.Path.bin,
    stderr: 'pipe',
    stdout: 'pipe',
  });

  await proc.exited;
}
```

**zip æ ¼å¼ï¼ˆWindowsï¼‰**ï¼š

```typescript
if (config.extension === 'zip') {
  const zipFileReader = new ZipReader(
    new BlobReader(new Blob([await Bun.file(archivePath).arrayBuffer()]))
  );

  const entries = await zipFileReader.getEntries();

  // æŸ¥æ‰¾ rg.exe
  for (const entry of entries) {
    if (entry.filename.endsWith('rg.exe')) {
      const rgBlob = await entry.getData(new BlobWriter());
      await Bun.write(filepath, await rgBlob.arrayBuffer());
      break;
    }
  }

  await zipFileReader.close();
}
```

### 4.3 æ ¸å¿ƒ API

#### filepath() - è·å– ripgrep è·¯å¾„

```typescript
export async function filepath(): Promise<string> {
  const { filepath } = await state();
  return filepath;
}
```

#### files() - æ–‡ä»¶åˆ—è¡¨ç”Ÿæˆå™¨

```typescript
export async function* files(input: { cwd: string; glob?: string[] }) {
  const args = [
    await filepath(),
    '--files', // åªåˆ—å‡ºæ–‡ä»¶
    '--follow', // è·Ÿéšç¬¦å·é“¾æ¥
    '--hidden', // åŒ…å«éšè—æ–‡ä»¶
    '--glob=!.git/*', // æ’é™¤ .git ç›®å½•
  ];

  if (input.glob) {
    for (const g of input.glob) {
      args.push(`--glob=${g}`);
    }
  }

  const proc = Bun.spawn(args, {
    cwd: input.cwd,
    stdout: 'pipe',
    stderr: 'ignore',
    maxBuffer: 1024 * 1024 * 20, // 20MB ç¼“å†²
  });

  // æµå¼è¯»å–è¾“å‡º
  const reader = proc.stdout.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split(/\r?\n/);
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line) yield line;
      }
    }

    if (buffer) yield buffer;
  } finally {
    reader.releaseLock();
    await proc.exited;
  }
}
```

### 4.4 ç±»å‹å®šä¹‰

```typescript
// é”™è¯¯ç±»å‹
export const ExtractionFailedError = NamedError.create(
  'RipgrepExtractionFailedError',
  z.object({
    filepath: z.string(),
    stderr: z.string(),
  })
);

export const UnsupportedPlatformError = NamedError.create(
  'RipgrepUnsupportedPlatformError',
  z.object({
    platform: z.string(),
  })
);

export const DownloadFailedError = NamedError.create(
  'RipgrepDownloadFailedError',
  z.object({
    url: z.string(),
    status: z.number(),
  })
);

// æœç´¢ç»“æœç±»å‹
export const Match = z.object({
  type: z.literal('match'),
  data: z.object({
    path: z.object({ text: z.string() }),
    lines: z.object({ text: z.string() }),
    line_number: z.number(),
    absolute_offset: z.number(),
    submatches: z.array(
      z.object({
        match: z.object({ text: z.string() }),
        start: z.number(),
        end: z.number(),
      })
    ),
  }),
});
```

---

## 5. Glob å·¥å…·å®ç°

### 5.1 å·¥å…·å®šä¹‰

```typescript
export const GlobTool: InternalTool<GlobArgs, GlobResult> = {
  name: 'Glob',
  category: 'search',
  internal: true,
  description: 'æ ¹æ®æ–‡ä»¶åæ¨¡å¼æœç´¢æ–‡ä»¶è·¯å¾„ï¼Œä¸æ¶‰åŠæ–‡ä»¶å†…å®¹',
  version: '1.0.0',
  parameters: {
    type: 'object',
    properties: {
      pattern: {
        type: 'string',
        description: 'Glob åŒ¹é…æ¨¡å¼ï¼Œå¦‚ "*.ts"ã€"**/*.test.js"',
      },
      path: {
        type: 'string',
        description: 'æœç´¢ç›®å½•ï¼Œé»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•',
      },
    },
    required: ['pattern'],
  },
  handler: globExecutor,
  renderResultForAssistant: renderGlobResult,
  isReadOnly: () => true,
  shouldConfirmExecute: async () => false,
};
```

### 5.2 ç­–ç•¥é€‰æ‹©å™¨

```typescript
export enum GlobStrategy {
  RIPGREP_BUN = 'ripgrep-bun', // ripgrep + Bun.stat()
  GLOB_NPM = 'glob-npm', // glob npm åŒ…
}

export async function selectGlobStrategy(): Promise<GlobStrategy> {
  const hasRipgrep = await canUseRipgrep();

  // Bun ç¯å¢ƒï¼šä¼˜å…ˆä½¿ç”¨ ripgrep
  if (isBun() && hasRipgrep) {
    return GlobStrategy.RIPGREP_BUN;
  }

  // å…¶ä»–æƒ…å†µï¼šä½¿ç”¨ glob åŒ…
  // - Node.js ç¯å¢ƒï¼ˆå³ä½¿ ripgrep å¯ç”¨ï¼‰
  // - Bun ç¯å¢ƒä½† ripgrep ä¸å¯ç”¨
  return GlobStrategy.GLOB_NPM;
}
```

### 5.3 ripgrep + Bun.stat ç­–ç•¥

```typescript
export async function globWithRipgrepBun(
  pattern: string,
  cwd: string,
  options?: { limit?: number }
): Promise<GlobResult[]> {
  const limit = options?.limit ?? 100;
  const files: GlobResult[] = [];
  let truncated = false;

  // 1. ä½¿ç”¨ ripgrep å¿«é€Ÿåˆ—å‡ºæ–‡ä»¶
  for await (const file of Ripgrep.files({
    cwd,
    glob: [pattern],
  })) {
    if (files.length >= limit) {
      truncated = true;
      break;
    }

    const full = path.resolve(cwd, file);

    // 2. Bun.stat() è·å–å…ƒæ•°æ®ï¼ˆæå¿«ï¼~0.1ms/æ–‡ä»¶ï¼‰
    const stats = await Bun.file(full)
      .stat()
      .then((x) => x.mtime.getTime())
      .catch(() => 0);

    files.push({ path: full, mtime: stats });
  }

  // 3. æ™ºèƒ½æ’åºï¼ˆ24å°æ—¶ä¼˜å…ˆï¼‰
  sortByRecentFirst(files);

  return files;
}
```

### 5.4 glob npm åŒ…ç­–ç•¥

```typescript
import { glob } from 'glob';

export async function globWithNpmPackage(
  pattern: string,
  cwd: string,
  options?: { limit?: number }
): Promise<GlobResult[]> {
  const limit = options?.limit ?? 100;

  // 1. ä½¿ç”¨ glob åŒ…ï¼Œä¸€æ¬¡æ€§è·å–è·¯å¾„å’Œå…ƒæ•°æ®
  const results = await glob(pattern, {
    cwd,
    withFileTypes: true,
    stat: true,
    nodir: true,
    follow: false, // âš ï¸ ä¸è·Ÿéšç¬¦å·é“¾æ¥ï¼ˆå®‰å…¨ï¼‰
    ignore: ['**/node_modules/**', '**/.git/**'],
  });

  // 2. è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
  const files = results.slice(0, limit).map((entry) => ({
    path: entry.fullpath(),
    mtime: entry.mtimeMs ?? 0,
  }));

  // 3. æ™ºèƒ½æ’åºï¼ˆ24å°æ—¶ä¼˜å…ˆï¼‰
  sortByRecentFirst(files);

  return files;
}
```

### 5.5 æ™ºèƒ½æ’åºï¼ˆ24å°æ—¶ä¼˜å…ˆï¼‰

```typescript
const RECENT_THRESHOLD = 24 * 60 * 60 * 1000; // 24å°æ—¶

function sortByRecentFirst(files: GlobResult[]): void {
  const now = Date.now();

  files.sort((a, b) => {
    const aRecent = now - a.mtime < RECENT_THRESHOLD;
    const bRecent = now - b.mtime < RECENT_THRESHOLD;

    // æœ€è¿‘24å°æ—¶çš„æ–‡ä»¶ä¼˜å…ˆ
    if (aRecent && !bRecent) return -1;
    if (!aRecent && bRecent) return 1;

    // å…¶ä»–æŒ‰ä¿®æ”¹æ—¶é—´é™åº
    return b.mtime - a.mtime;
  });
}
```

**ä¼˜åŠ¿**ï¼š

- âœ… æ›´ç¬¦åˆå¼€å‘ä¹ æƒ¯ï¼ˆå½“å‰å·¥ä½œçš„æ–‡ä»¶ä¼˜å…ˆï¼‰
- âœ… å‡å°‘æ— å…³æ–‡ä»¶å¹²æ‰°

### 5.6 ç¬¦å·é“¾æ¥å®‰å…¨æ§åˆ¶

```typescript
// âœ… æ¨èï¼šä¸è·Ÿéšç¬¦å·é“¾æ¥
glob(pattern, {
  follow: false, // é¿å…å¾ªç¯é“¾æ¥å¯¼è‡´çš„æ­»å¾ªç¯
});

// âš ï¸ é£é™©ï¼šè·Ÿéšç¬¦å·é“¾æ¥
glob(pattern, {
  follow: true, // å¯èƒ½é‡åˆ°å¾ªç¯é“¾æ¥
});
```

---

## 6. Grep å·¥å…·å®ç°

### 6.1 å·¥å…·å®šä¹‰

```typescript
export const GrepTool: InternalTool<GrepArgs, GrepResult> = {
  name: 'Grep',
  category: 'search',
  internal: true,
  description: 'åœ¨æ–‡ä»¶å†…å®¹ä¸­æœç´¢åŒ¹é…çš„æ–‡æœ¬ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼',
  version: '1.0.0',
  parameters: {
    type: 'object',
    properties: {
      pattern: {
        type: 'string',
        description: 'æ­£åˆ™è¡¨è¾¾å¼æœç´¢æ¨¡å¼',
      },
      path: {
        type: 'string',
        description: 'æœç´¢ç›®å½•ï¼Œé»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•',
      },
      include: {
        type: 'string',
        description: 'æ–‡ä»¶è¿‡æ»¤æ¨¡å¼ï¼Œå¦‚ "*.ts" æˆ– "*.{js,jsx}"',
      },
    },
    required: ['pattern'],
  },
  handler: grepExecutor,
  renderResultForAssistant: renderGrepResult,
  isReadOnly: () => true,
  shouldConfirmExecute: async () => false,
};
```

### 6.2 ç­–ç•¥é€‰æ‹©å™¨

```typescript
export enum GrepStrategy {
  RIPGREP = 'ripgrep',
  GIT_GREP = 'git-grep',
  SYSTEM_GREP = 'system-grep',
  JAVASCRIPT = 'javascript',
}

export async function selectGrepStrategy(cwd: string): Promise<GrepStrategy> {
  // 1. ä¼˜å…ˆä½¿ç”¨ ripgrepï¼ˆæœ€å¿«ï¼‰
  if (await canUseRipgrep()) {
    return GrepStrategy.RIPGREP;
  }

  // 2. Git ä»“åº“ï¼šä½¿ç”¨ git grepï¼ˆåˆ©ç”¨ç´¢å¼•ï¼Œè¶…å¿«ï¼‰
  if (isGitRepository(cwd) && (await canUseGitGrep())) {
    return GrepStrategy.GIT_GREP;
  }

  // 3. ç³»ç»Ÿ grep
  if (await canUseSystemGrep()) {
    return GrepStrategy.SYSTEM_GREP;
  }

  // 4. JavaScript ä¿åº•ï¼ˆ100% å¯ç”¨ï¼‰
  return GrepStrategy.JAVASCRIPT;
}
```

### 6.3 ripgrep ç­–ç•¥

```typescript
export async function grepWithRipgrep(
  pattern: string,
  cwd: string,
  options?: { include?: string }
): Promise<GrepMatch[]> {
  const rgPath = await Ripgrep.filepath();
  const args = [
    '-nH', // -n: è¡Œå·, -H: æ–‡ä»¶å
    '--field-match-separator=|', // ä½¿ç”¨ | åˆ†éš”å­—æ®µ
    '--regexp',
    pattern,
  ];

  if (options?.include) {
    args.push('--glob', options.include);
  }

  args.push(cwd);

  const proc = Bun.spawn([rgPath, ...args], {
    stdout: 'pipe',
    stderr: 'pipe',
  });

  const output = await new Response(proc.stdout).text();
  const exitCode = await proc.exited;

  if (exitCode === 1) {
    return []; // æ— åŒ¹é…
  }

  if (exitCode !== 0) {
    const errorOutput = await new Response(proc.stderr).text();
    throw new Error(`ripgrep failed: ${errorOutput}`);
  }

  return parseRipgrepOutput(output);
}
```

### 6.4 git grep ç­–ç•¥

```typescript
export async function grepWithGit(
  pattern: string,
  cwd: string,
  options?: { include?: string }
): Promise<GrepMatch[]> {
  const args = [
    'grep',
    '--untracked', // åŒ…æ‹¬æœªè¿½è¸ªçš„æ–‡ä»¶
    '-n', // æ˜¾ç¤ºè¡Œå·
    '-E', // æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼
    '--ignore-case', // å¿½ç•¥å¤§å°å†™
    pattern,
  ];

  if (options?.include) {
    args.push('--', options.include);
  }

  const proc = Bun.spawn(['git', ...args], {
    cwd,
    stdout: 'pipe',
    stderr: 'pipe',
  });

  const output = await new Response(proc.stdout).text();
  const exitCode = await proc.exited;

  if (exitCode === 1) {
    return []; // æ— åŒ¹é…
  }

  if (exitCode !== 0) {
    const errorOutput = await new Response(proc.stderr).text();
    throw new Error(`git grep failed: ${errorOutput}`);
  }

  return parseGrepOutput(output);
}
```

### 6.5 system grep ç­–ç•¥

```typescript
export async function grepWithSystemGrep(
  pattern: string,
  cwd: string,
  options?: { include?: string }
): Promise<GrepMatch[]> {
  const args = ['-r', '-n', '-H', '-E'];

  // âš ï¸ ç›®å½•æ’é™¤ï¼šè¿‡æ»¤å¸¸è§å¤§ç›®å½•
  const excludeDirs = ['node_modules', '.git', 'dist', 'build', 'coverage', '.next', '.nuxt'];
  excludeDirs.forEach((dir) => {
    args.push(`--exclude-dir=${dir}`);
  });

  if (options?.include) {
    args.push(`--include=${options.include}`);
  }

  args.push(pattern);
  args.push('.');

  const proc = Bun.spawn(['grep', ...args], {
    cwd,
    stdout: 'pipe',
    stderr: 'pipe',
  });

  const output = await new Response(proc.stdout).text();
  const exitCode = await proc.exited;

  if (exitCode === 1) {
    return []; // æ— åŒ¹é…
  }

  if (exitCode !== 0) {
    // âš ï¸ é”™è¯¯æŠ‘åˆ¶ï¼šå¿½ç•¥æƒé™é”™è¯¯
    const errorOutput = await new Response(proc.stderr).text();
    if (!errorOutput.includes('Permission denied')) {
      throw new Error(`system grep failed: ${errorOutput}`);
    }
  }

  return parseGrepOutput(output);
}
```

### 6.6 JavaScript fallback ç­–ç•¥

```typescript
import { globStream } from 'glob';
import * as fs from 'fs/promises';

export async function grepWithJavaScript(
  pattern: string,
  cwd: string,
  options?: { include?: string; signal?: AbortSignal }
): Promise<GrepMatch[]> {
  const globPattern = options?.include ?? '**/*';
  const regex = new RegExp(pattern, 'i');
  const matches: GrepMatch[] = [];

  // âš ï¸ ç›®å½•æ’é™¤
  const ignorePatterns = [
    '**/node_modules/**',
    '**/.git/**',
    '**/dist/**',
    '**/build/**',
    '**/coverage/**',
  ];

  // âš ï¸ æµå¼å¤„ç†ï¼šä½¿ç”¨ globStream é¿å…å†…å­˜æº¢å‡º
  const filesStream = globStream(globPattern, {
    cwd,
    dot: true,
    ignore: ignorePatterns,
    absolute: true,
    nodir: true,
    signal: options?.signal,
  });

  for await (const filePath of filesStream) {
    try {
      // è¯»å–æ–‡ä»¶å†…å®¹
      const content = await fs.readFile(filePath as string, 'utf8');
      const lines = content.split(/\r?\n/);

      // é€è¡Œæ­£åˆ™åŒ¹é…
      lines.forEach((line, index) => {
        if (regex.test(line)) {
          matches.push({
            filePath: path.relative(cwd, filePath as string),
            lineNumber: index + 1,
            line,
          });
        }
      });
    } catch (error: unknown) {
      // âš ï¸ é”™è¯¯æŠ‘åˆ¶ï¼šå¿½ç•¥å•ä¸ªæ–‡ä»¶é”™è¯¯
      if (isNodeError(error) && error.code === 'EACCES') {
        continue; // æƒé™é”™è¯¯ï¼Œè·³è¿‡
      }
      if (isNodeError(error) && error.code === 'ENOENT') {
        continue; // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡
      }
      console.debug(`Could not read ${filePath}:`, error);
      // ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
    }
  }

  return matches;
}

function isNodeError(error: unknown): error is NodeJS.ErrnoException {
  return error instanceof Error && 'code' in error;
}
```

### 6.7 ç»Ÿä¸€æ‰§è¡Œå™¨

```typescript
export async function grepExecutor(
  args: GrepArgs,
  context?: InternalToolContext
): Promise<GrepResult> {
  const searchPath = args.path || context?.cwd || process.cwd();

  // è‡ªåŠ¨é€‰æ‹©ç­–ç•¥
  const strategy = await selectGrepStrategy(searchPath);

  let matches: GrepMatch[];
  let strategyUsed: string;

  try {
    switch (strategy) {
      case GrepStrategy.RIPGREP:
        matches = await grepWithRipgrep(args.pattern, searchPath, args);
        strategyUsed = 'ripgrep';
        break;

      case GrepStrategy.GIT_GREP:
        matches = await grepWithGit(args.pattern, searchPath, args);
        strategyUsed = 'git grep';
        break;

      case GrepStrategy.SYSTEM_GREP:
        matches = await grepWithSystemGrep(args.pattern, searchPath, args);
        strategyUsed = 'system grep';
        break;

      case GrepStrategy.JAVASCRIPT:
        matches = await grepWithJavaScript(args.pattern, searchPath, {
          include: args.include,
          signal: context?.abortSignal,
        });
        strategyUsed = 'javascript';
        break;
    }
  } catch (error) {
    // å¦‚æœå½“å‰ç­–ç•¥å¤±è´¥ï¼Œå°è¯•é™çº§åˆ° JavaScript
    console.debug(`Strategy ${strategy} failed, falling back to JavaScript...`);
    matches = await grepWithJavaScript(args.pattern, searchPath, {
      include: args.include,
      signal: context?.abortSignal,
    });
    strategyUsed = 'javascript (fallback)';
  }

  // æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
  await sortMatchesByMtime(matches, searchPath);

  // é™åˆ¶ç»“æœæ•°é‡
  const limit = 100;
  const truncated = matches.length > limit;
  const finalMatches = truncated ? matches.slice(0, limit) : matches;

  return {
    matches: finalMatches,
    count: finalMatches.length,
    truncated,
    strategy: strategyUsed,
  };
}
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æ€§èƒ½å¯¹æ¯”æ•°æ®

#### Glob æ€§èƒ½ï¼ˆ1000 ä¸ªæ–‡ä»¶ï¼‰

| ç¯å¢ƒ        | æ–¹æ¡ˆ                  | æ–‡ä»¶éå† | è·å–å…ƒæ•°æ® | æ’åº | æ€»è®¡      | è¯„çº§       |
| ----------- | --------------------- | -------- | ---------- | ---- | --------- | ---------- |
| **Bun**     | ripgrep + Bun.stat()  | 50ms     | 10ms       | 2ms  | **62ms**  | â­â­â­â­â­ |
| **Bun**     | glob npm              | 100ms    | 0ms        | 3ms  | **103ms** | â­â­â­â­   |
| **Node.js** | glob npm              | 100ms    | 0ms        | 3ms  | **103ms** | â­â­â­â­   |
| **Node.js** | ripgrep + Node.stat() | 50ms     | 120ms      | 2ms  | **172ms** | â­â­â­     |

#### Grep æ€§èƒ½ï¼ˆå¤§å‹é¡¹ç›®ï¼‰

| ç­–ç•¥            | Git ä»“åº“ | é Git ä»“åº“ | å¯ç”¨æ€§ | è¯„çº§       |
| --------------- | -------- | ----------- | ------ | ---------- |
| **git grep**    | 0.12s    | N/A         | 70%    | â­â­â­â­â­ |
| **ripgrep**     | 0.25s    | 0.25s       | 95%    | â­â­â­â­â­ |
| **system grep** | 1.1s     | 1.1s        | 90%    | â­â­â­     |
| **JavaScript**  | 4.5s     | 4.5s        | 100%   | â­â­       |

### 7.2 Glob ä¼˜åŒ–è¦ç‚¹

1. **æ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜**

   - è·å– mtimeMs ç”¨äºæ™ºèƒ½æ’åº
   - Bun.stat() æå¿«ï¼ˆ~0.1ms/æ–‡ä»¶ï¼‰

2. **æ™ºèƒ½æ’åº**

   - æœ€è¿‘ 24 å°æ—¶æ–‡ä»¶ä¼˜å…ˆ
   - å‡å°‘æ— å…³æ–‡ä»¶å¹²æ‰°

3. **Glob åº“ä¼˜åŒ–**

   - ä½¿ç”¨æˆç†Ÿçš„ glob npm åŒ…
   - ä¸€æ¬¡æ€§è¿”å›è·¯å¾„å’Œå…ƒæ•°æ®

4. **ç¬¦å·é“¾æ¥æ§åˆ¶**
   - `follow: false` é¿å…å¾ªç¯

### 7.3 Grep ä¼˜åŒ–è¦ç‚¹

1. **ç­–ç•¥åˆ†å±‚**

   - ä¼˜å…ˆä½¿ç”¨æœ€å¿«çš„æœç´¢æ–¹å¼
   - git grep: åˆ©ç”¨ git ç´¢å¼•ï¼Œè¶…å¿«
   - ripgrep: Rust å®ç°ï¼Œå¤šçº¿ç¨‹
   - system grep: C å®ç°ï¼Œæ¯” JS å¿«æ•°å€
   - JS fallback: ä¿è¯å…¼å®¹æ€§

2. **ç›®å½•æ’é™¤**

   - è¿‡æ»¤ node_modulesã€.gitã€distã€build ç­‰

3. **æµå¼å¤„ç†**

   - JavaScript æ¨¡å¼ä½¿ç”¨ globStream
   - é¿å…å†…å­˜æº¢å‡º

4. **é”™è¯¯æŠ‘åˆ¶**
   - å¿½ç•¥æƒé™é”™è¯¯ï¼Œç»§ç»­æœç´¢

### 7.4 æœ€ä½³å®è·µ

```typescript
// âœ… æ¨èï¼šç¼“å­˜æ£€æµ‹ç»“æœ
let _runtime: RuntimeEnvironment | null = null;

export function detectRuntime(): RuntimeEnvironment {
  if (_runtime === null) {
    _runtime = _detectRuntime();
  }
  return _runtime;
}

// âœ… æ¨èï¼šé›†ä¸­ç­–ç•¥é€‰æ‹©é€»è¾‘
const strategy = await selectGlobStrategy();
const result = await executeStrategy(strategy, params);

// âœ… æ¨èï¼šç­–ç•¥å¤±è´¥è‡ªåŠ¨é™çº§
try {
  return await highPerformanceStrategy();
} catch (error) {
  console.debug('Falling back to safe strategy');
  return await fallbackStrategy();
}

// âœ… æ¨èï¼šè®°å½•ç­–ç•¥ä½¿ç”¨æƒ…å†µ
return {
  ...result,
  metadata: {
    strategy: strategyUsed,
    runtime: detectRuntime(),
    fallback: wasFallback,
  },
};
```

---

## 8. å®‰å…¨ä¸å®¹é”™è®¾è®¡

### 8.1 ç¬¦å·é“¾æ¥æ§åˆ¶

```typescript
// âœ… å®‰å…¨ï¼šä¸è·Ÿéšç¬¦å·é“¾æ¥
glob(pattern, {
  follow: false, // é¿å…å¾ªç¯é“¾æ¥å¯¼è‡´çš„æ­»å¾ªç¯
});

// ripgrep é»˜è®¤è·Ÿéšï¼Œéœ€è¦æ˜¾å¼æ§åˆ¶
const args = [
  '--files',
  // "--follow",  // æ³¨é‡Šæ‰ä»¥ç¦ç”¨è·Ÿéš
];
```

### 8.2 æƒé™é”™è¯¯å¤„ç†

```typescript
try {
  const content = await fs.readFile(filePath, 'utf8');
  // æœç´¢å¤„ç†...
} catch (error: unknown) {
  // å¿½ç•¥æƒé™é”™è¯¯ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
  if (isNodeError(error) && error.code === 'EACCES') {
    continue;
  }
  // å¿½ç•¥æ–‡ä»¶ä¸å­˜åœ¨é”™è¯¯
  if (isNodeError(error) && error.code === 'ENOENT') {
    continue;
  }
  console.debug(`Could not read ${filePath}:`, error);
}
```

### 8.3 å•ç‚¹å¤±è´¥éš”ç¦»

```typescript
// JavaScript çº¯å®ç°æ€»æ˜¯å¯ç”¨
for await (const filePath of filesStream) {
  try {
    // å°è¯•å¤„ç†æ–‡ä»¶
    const content = await fs.readFile(filePath, 'utf8');
    // ...
  } catch (error) {
    // å•ä¸ªæ–‡ä»¶å¤±è´¥ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
    // ä¸ä¼šå¯¼è‡´æ•´ä¸ªæœç´¢å¤±è´¥ âœ…
  }
}
return allMatches; // æ€»æ˜¯è¿”å›ç»“æœ
```

### 8.4 ç»“æœé™åˆ¶

```typescript
const MAX_RESULTS = 100;
const MAX_LINE_LENGTH = 2000;

// é™åˆ¶è¿”å›ç»“æœæ•°é‡
const truncated = matches.length > MAX_RESULTS;
const finalMatches = truncated ? matches.slice(0, MAX_RESULTS) : matches;

// æˆªæ–­è¿‡é•¿çš„è¡Œ
const truncatedLine =
  line.length > MAX_LINE_LENGTH ? line.substring(0, MAX_LINE_LENGTH) + '...' : line;
```

### 8.5 å¤šå±‚é™çº§ä¿è¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ripgrep    â”‚â”€â”€â”€â”€â–¶â”‚  git grep   â”‚â”€â”€â”€â”€â–¶â”‚ system grep â”‚â”€â”€â”€â”€â–¶â”‚ JavaScript  â”‚
â”‚  95% å¯ç”¨   â”‚     â”‚  70% å¯ç”¨   â”‚     â”‚  90% å¯ç”¨   â”‚     â”‚ 100% å¯ç”¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                   â†“                   â†“                   â†“
   æå¿«ä½†éœ€ä¸‹è½½         åˆ©ç”¨gitç´¢å¼•         ç³»ç»ŸåŸç”ŸCå®ç°        çº¯JSä¿åº•
   è·¨å¹³å°äºŒè¿›åˆ¶         åªé€‚ç”¨gitä»“åº“       å¤§å¤šæ•°ç³»ç»Ÿæœ‰         æ€»æ˜¯å¯ç”¨
```

---

## 9. ä½¿ç”¨ç¤ºä¾‹

### 9.1 Glob ç¤ºä¾‹

#### æŸ¥æ‰¾æ‰€æœ‰ TypeScript æ–‡ä»¶

```typescript
await GlobTool.execute({
  pattern: '*.ts',
});

// è¾“å‡ºï¼š
// /path/to/src/index.ts
// /path/to/src/utils.ts
// /path/to/src/types.ts
```

#### é€’å½’æŸ¥æ‰¾æµ‹è¯•æ–‡ä»¶

```typescript
await GlobTool.execute({
  pattern: '**/*.test.{ts,tsx}',
});

// è¾“å‡ºï¼š
// /path/to/test/tool/grep.test.ts
// /path/to/test/tool/glob.test.ts
```

#### åœ¨æŒ‡å®šç›®å½•æœç´¢

```typescript
await GlobTool.execute({
  pattern: '*.json',
  path: './config',
});
```

#### æŸ¥æ‰¾ç‰¹å®šå‘½åè§„èŒƒçš„æ–‡ä»¶

```typescript
await GlobTool.execute({
  pattern: '**/[A-Z]*.tsx', // ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„ tsx æ–‡ä»¶
});
```

### 9.2 Grep ç¤ºä¾‹

#### åŸºæœ¬æœç´¢

```typescript
await GrepTool.execute({
  pattern: 'async function',
});

// è¾“å‡ºï¼š
// Found 3 matches
//
// src/tool/grep.ts:
//   Line 17: async execute(params) {
//   Line 24: async function grepWithRipgrep() {
//
// src/tool/glob.ts:
//   Line 19: async execute(params) {
```

#### æŒ‡å®šæ–‡ä»¶ç±»å‹

```typescript
await GrepTool.execute({
  pattern: 'export.*class',
  include: '*.ts',
});
```

#### æœç´¢ç‰¹å®šç›®å½•

```typescript
await GrepTool.execute({
  pattern: 'TODO:',
  path: '/path/to/src',
  include: '*.{ts,tsx}',
});
```

### 9.3 Glob æ¨¡å¼è¯­æ³•

| æ¨¡å¼    | è¯´æ˜                       | ç¤ºä¾‹         |
| ------- | -------------------------- | ------------ |
| `*`     | åŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆä¸åŒ…æ‹¬ `/`ï¼‰ | `*.ts`       |
| `**`    | é€’å½’åŒ¹é…æ‰€æœ‰ç›®å½•           | `**/*.ts`    |
| `?`     | åŒ¹é…å•ä¸ªå­—ç¬¦               | `?.ts`       |
| `[abc]` | åŒ¹é…å­—ç¬¦é›†ä¸­çš„ä»»æ„ä¸€ä¸ª     | `[abc].ts`   |
| `{a,b}` | åŒ¹é…å¤šä¸ªæ¨¡å¼ä¹‹ä¸€           | `*.{ts,tsx}` |

### 9.4 æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•

| æ¨¡å¼ | è¯´æ˜                       | ç¤ºä¾‹                   |
| ---- | -------------------------- | ---------------------- |
| `.`  | åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦           | `a.c` â†’ abc, adc       |
| `*`  | åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡  | `ab*c` â†’ ac, abc, abbc |
| `+`  | åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦ 1 æ¬¡æˆ–å¤šæ¬¡  | `ab+c` â†’ abc, abbc     |
| `?`  | åŒ¹é…å‰ä¸€ä¸ªå­—ç¬¦ 0 æ¬¡æˆ– 1 æ¬¡ | `ab?c` â†’ ac, abc       |
| `\d` | åŒ¹é…æ•°å­—                   | `\d+` â†’ 123, 456       |
| `\w` | åŒ¹é…å•è¯å­—ç¬¦               | `\w+` â†’ hello, world   |
| `^`  | åŒ¹é…è¡Œé¦–                   | `^async`               |
| `$`  | åŒ¹é…è¡Œå°¾                   | `function$`            |

---

## æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **ç¯å¢ƒè‡ªé€‚åº”**

   - Bun ç¯å¢ƒåˆ©ç”¨å¿«é€Ÿ statï¼Œripgrep ä¼˜å…ˆ
   - Node.js ç¯å¢ƒé¿å…æ…¢é€Ÿ statï¼Œglob åŒ…ä¼˜å…ˆ

2. **å¤šå±‚é™çº§ä¿è¯**

   - Glob: ripgrep â†’ glob npm
   - Grep: ripgrep â†’ git grep â†’ system grep â†’ JavaScript

3. **æ€§èƒ½æœ€ä¼˜**

   - Bun + ripgrep: 62msï¼ˆæœ€å¿«ï¼‰
   - Node.js + glob: 103msï¼ˆæ¬¡å¿«ï¼‰
   - é¿å…äº† Node.js + ripgrep çš„æ…¢é€Ÿç»„åˆï¼ˆ172msï¼‰

4. **é›¶å¤±è´¥ä¿è¯**

   - JavaScript ä¿åº•æ–¹æ¡ˆç¡®ä¿ 100% å¯ç”¨
   - å•ä¸ªæ–‡ä»¶é”™è¯¯ä¸å½±å“æ•´ä½“

5. **é€æ˜åˆ‡æ¢**
   - å¯¹ç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥
   - ç»Ÿä¸€çš„å·¥å…·æ¥å£

### è®¾è®¡å“²å­¦

> "Make it work, make it right, make it fast"
>
> å…ˆä¿è¯å¯ç”¨æ€§ï¼Œå†ä¼˜åŒ–æ€§èƒ½ï¼Œ
> ä½†é€šè¿‡é™çº§ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶æ‹¥æœ‰ä¸¤è€…ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-01-06
