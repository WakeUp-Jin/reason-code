# 修改文件清单

## 新增文件

### 1. messageSanitizer.ts

**路径**：`packages/core/src/core/context/utils/messageSanitizer.ts`

**功能**：消息验证和清理工具

**导出**：
- `sanitizeMessages(messages)` - 清理消息列表
- `validateMessages(messages)` - 验证消息列表（不修改）
- `sanitizeCurrentTurn(messages)` - 清理当前轮次消息
- `SanitizeResult` - 清理结果类型

### 2. messageSanitizer.test.ts

**路径**：`packages/core/src/core/context/__tests__/messageSanitizer.test.ts`

**功能**：消息验证工具的单元测试

---

## 修改文件

### Core 层

#### 1. ContextManager.ts

**路径**：`packages/core/src/core/context/ContextManager.ts`

**修改内容**：
- 导入 `sanitizeMessages`
- `buildMessages()` 方法末尾添加消息验证和清理
- 新增 `sanitizeCurrentTurn()` 方法

```diff
+ import { sanitizeMessages } from './utils/messageSanitizer.js';

  private buildMessages(): Message[] {
    // ... 原有代码 ...

+   // 5. 验证并清理消息
+   const { messages: sanitizedMessages, sanitized, removedCount } = sanitizeMessages(messages);
+   if (sanitized) {
+     logger.warn(`消息列表已清理，移除了 ${removedCount} 条不完整的消息`);
+   }
+   return sanitizedMessages;
  }

+ sanitizeCurrentTurn(): void {
+   this.currentTurn.sanitize();
+ }
```

#### 2. CurrentTurnContext.ts

**路径**：`packages/core/src/core/context/modules/CurrentTurnContext.ts`

**修改内容**：
- 导入 `sanitizeMessages` 和 `SanitizeResult`
- 新增 `sanitize()` 方法

```diff
+ import { sanitizeMessages, SanitizeResult } from '../utils/messageSanitizer.js';

+ sanitize(): SanitizeResult {
+   const result = sanitizeMessages(this.items);
+   if (result.sanitized) {
+     this.replace(result.messages);
+   }
+   return result;
+ }
```

#### 3. Agent.ts

**路径**：`packages/core/src/core/agent/Agent.ts`

**修改内容**：
- 新增 `abortController` 和 `currentExecutor` 属性
- `run()` 方法中创建和传递 `AbortController`
- 新增 `abort()` 和 `isRunning()` 方法
- 中断时调用 `executionStream.cancel()`

```diff
+ private abortController: AbortController | null = null;
+ private currentExecutor: ToolLoopExecutor | null = null;

  async run(...) {
+   this.abortController = new AbortController();
    
    const executor = new ToolLoopExecutor(..., {
      ...
+     abortSignal: this.abortController.signal,
    });
    
+   this.currentExecutor = executor;
    const loopResult = await executor.run();
+   this.currentExecutor = null;

+   if (loopResult.cancelled) {
+     this.executionStream.cancel('用户取消执行');
+     return { success: false, error: '执行已暂停' };
+   }
    
    // ...
+   finally {
+     this.abortController = null;
+   }
  }

+ abort(): void {
+   if (this.abortController) {
+     this.abortController.abort();
+   }
+ }

+ isRunning(): boolean {
+   return this.abortController !== null;
+ }
```

#### 4. executeToolLoop.ts

**路径**：`packages/core/src/core/llm/utils/executeToolLoop.ts`

**修改内容**：
- 新增 `abortSignal` 属性
- 新增 `isAborted()` 方法
- `run()` 和 `executeIteration()` 中添加中断检测
- 新增 `buildCancelledResult()` 方法

```diff
+ private abortSignal?: AbortSignal;

  constructor(..., config) {
    ...
+   this.abortSignal = config?.abortSignal;
  }

+ private isAborted(): boolean {
+   return this.abortSignal?.aborted ?? false;
+ }

  async run() {
    while (...) {
+     if (this.isAborted()) {
+       return this.buildCancelledResult();
+     }
      ...
    }
  }

  private async executeIteration() {
+   if (this.isAborted()) return { done: true, value: this.buildCancelledResult() };
    // ... 多处中断检测 ...
  }

+ private buildCancelledResult(): ToolLoopResult {
+   this.contextManager.sanitizeCurrentTurn();
+   return { success: false, cancelled: true, error: '执行已暂停', loopCount: this.loopCount };
+ }
```

#### 5. types/index.ts

**路径**：`packages/core/src/core/llm/types/index.ts`

**修改内容**：
- `ToolLoopResult` 新增 `cancelled` 字段
- `ToolLoopConfig` 新增 `abortSignal` 字段

```diff
  interface ToolLoopResult {
    success: boolean;
    result?: string;
    error?: string;
    loopCount: number;
+   cancelled?: boolean;
  }

  interface ToolLoopConfig {
    // ...
+   abortSignal?: AbortSignal;
  }
```

#### 6. ExecutionStreamManager.ts

**路径**：`packages/core/src/core/execution/ExecutionStreamManager.ts`

**修改内容**：
- `cancel()` 方法新增可选的 `reason` 参数

```diff
- cancel(): void {
+ cancel(reason?: string): void {
    this.stopPhraseRotation();
    this.snapshot.state = ExecutionState.Cancelled;
-   this.emit({ type: 'execution:cancel' });
+   this.emit({ type: 'execution:cancel', reason });
  }
```

#### 7. events.ts

**路径**：`packages/core/src/core/execution/events.ts`

**修改内容**：
- `execution:cancel` 事件新增可选的 `reason` 字段

```diff
- | { type: 'execution:cancel' }
+ | { type: 'execution:cancel'; reason?: string }
```

#### 8. context/index.ts

**路径**：`packages/core/src/core/context/index.ts`

**修改内容**：
- 导出 `messageSanitizer` 相关内容

```diff
+ export {
+   sanitizeMessages,
+   validateMessages,
+   sanitizeCurrentTurn,
+   type SanitizeResult,
+ } from './utils/messageSanitizer.js';
```

---

### CLI 层

#### 1. useAgent.ts

**路径**：`packages/cli/src/hooks/useAgent.ts`

**修改内容**：
- `UseAgentReturn` 接口新增 `abort` 和 `isRunning`
- 实现 `abort()` 和 `isRunning()` 方法

```diff
  interface UseAgentReturn {
    // ...
+   abort: () => void;
+   isRunning: () => boolean;
  }

+ const abort = useCallback(() => {
+   if (agentInstance) {
+     agentInstance.abort();
+   }
+ }, []);

+ const isRunning = useCallback(() => {
+   if (!agentInstance) return false;
+   return agentInstance.isRunning();
+ }, []);

  return {
    // ...
+   abort,
+   isRunning,
  };
```

#### 2. inputArea.tsx

**路径**：`packages/cli/src/routes/session/inputArea.tsx`

**修改内容**：
- 导入 `useInput` 和 `useIsExecuting`
- 添加 ESC 按键监听

```diff
- import { Box } from 'ink';
+ import { Box, useInput } from 'ink';
+ import { useIsExecuting } from '../../context/execution.js';

  export function InputArea(...) {
+   const isExecuting = useIsExecuting();
-   const { isLoading, error, sendMessage } = useAgent();
+   const { isLoading, error, sendMessage, abort } = useAgent();

+   // ESC 按键监听
+   useInput(
+     (input, key) => {
+       if (key.escape && isExecuting) {
+         abort();
+       }
+     },
+     { isActive: isExecuting }
+   );

    // ...
  }
```

---

## 文件关系图

```
Core 层
├── context/
│   ├── utils/
│   │   └── messageSanitizer.ts  ← 新增：消息验证工具
│   ├── modules/
│   │   └── CurrentTurnContext.ts  ← 修改：添加 sanitize()
│   ├── ContextManager.ts  ← 修改：集成验证逻辑
│   └── index.ts  ← 修改：导出新工具
├── agent/
│   └── Agent.ts  ← 修改：添加 abort() 支持
├── llm/
│   ├── types/index.ts  ← 修改：添加类型定义
│   └── utils/
│       └── executeToolLoop.ts  ← 修改：添加中断检测
└── execution/
    ├── ExecutionStreamManager.ts  ← 修改：cancel(reason)
    └── events.ts  ← 修改：事件类型

CLI 层
├── hooks/
│   └── useAgent.ts  ← 修改：暴露 abort()
└── routes/session/
    └── inputArea.tsx  ← 修改：ESC 监听
```

