# 本地存储系统实现总览

## 📋 概述

为 reason-cli 项目实现了完整的本地存储系统，包括配置管理、会话持久化、自动保存和应用启动数据恢复功能。

## 🎯 核心目标

- ✅ **配置持久化**: 主题、模型、Agent、Provider 设置
- ✅ **会话自动保存**: 实时保存策略，关键时刻触发
- ✅ **应用启动恢复**: 自动加载历史数据
- ✅ **安全管理 API Keys**: 环境变量引用，不保存明文
- ✅ **错误降级**: 配置损坏时使用默认值
- ✅ **性能优化**: 使用 Valibot 替代 Zod，减少 89% 体积

## 🏗️ 架构设计

### 数据流

```
应用启动
  ↓
加载 config.json → 解析环境变量 → 验证配置 (Valibot)
  ↓
加载 sessions/*.json → 恢复会话和消息
  ↓
初始化 Zustand Store → 应用配置到 UI

运行时：
用户操作 → Store 更新 → 组件调用 Hook 方法 → 显式保存 → 写入磁盘
                                     ↓
                        (关键时机：发送消息、切换模型、切换主题等)

应用退出：
捕获信号 → 调用 saveAll() → 刷新日志 → 清理资源
```

### 目录结构

```
packages/cli/src/
├── config/                    # 配置系统
│   ├── schema.ts             # Valibot Schema 定义
│   ├── defaults.ts           # 默认配置和环境变量解析
│   └── manager.ts            # ConfigManager 类
├── hooks/
│   └── usePersistence.ts     # 持久化 Hook（核心）
├── persistence/
│   └── loader.ts             # 启动时数据加载
├── util/
│   └── storage.ts            # 存储 API
└── app.tsx                   # 启动时加载数据

~/.reason-cli/
├── config.json               # 配置文件
└── sessions/                 # 会话目录
    ├── {id1}.json
    ├── {id2}.json
    └── ...
```

## 📝 配置文件设计

### 配置结构

```json
{
  "model": {
    "current": "claude-sonnet-4",
    "fallback": "gpt-4o"
  },
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}",
      "baseUrl": "https://api.anthropic.com",
      "timeout": 60000
    },
    "openai": {
      "apiKey": "${OPENAI_API_KEY}",
      "baseUrl": "https://api.openai.com/v1",
      "timeout": 60000
    },
    "google": {
      "apiKey": "${GOOGLE_API_KEY}",
      "baseUrl": "https://generativelanguage.googleapis.com",
      "timeout": 60000
    }
  },
  "agent": {
    "current": "default"
  },
  "ui": {
    "theme": "kanagawa",
    "mode": "dark"
  },
  "session": {
    "lastSessionId": "...",
    "autoSave": true,
    "saveDebounce": 500
  }
}
```

### 环境变量处理

- 配置中使用 `${ENV_VAR}` 格式引用环境变量
- 加载时自动解析为实际值
- 保存时保留引用格式（不保存明文 API key）
- 如果环境变量未设置，解析为空字符串

## 🔧 核心组件

### 1. ConfigManager (配置管理器)

**职责：**
- 加载配置文件（合并默认值）
- 解析环境变量
- Valibot 验证配置
- 保存配置更新
- 配置损坏时降级到默认值

**关键方法：**
```typescript
loadConfig()      // 加载配置
saveConfig()      // 保存配置
updateConfig()    // 更新配置
getConfig()       // 获取当前配置
```

### 2. usePersistence Hook (持久化 Hook)

**设计理念：**
- ❌ 不使用自动保存中间件（会导致频繁保存）
- ✅ 使用 Hook 层显式控制保存时机
- ✅ 组件调用 Hook 方法来触发保存

**提供方法：**
```typescript
saveCurrentSession()  // 保存当前会话
saveAllSessions()     // 保存所有会话
saveConfig()          // 保存配置
saveAll()             // 保存所有数据（退出时）
```

**保存时机：**
1. 用户发送消息后 → `saveCurrentSession()`
2. 用户切换模型后 → `saveConfig({ model: { current } })`
3. 用户切换主题后 → `saveConfig({ ui: { theme, mode } })`
4. 用户创建/删除/重命名会话后 → `saveAllSessions()`
5. 应用退出时 → `saveAll()`

### 3. Valibot Schema (配置验证)

**为什么选择 Valibot：**

| 特性 | Zod | Valibot | 改善 |
|-----|-----|---------|------|
| Bundle Size | ~14KB | ~1.5KB | **-89%** ⚡ |
| 验证速度 | 基准 | 2-5x 更快 | **+200-500%** |
| Tree-shaking | 一般 | 优秀 | 更好 ✨ |
| 启动时间 | 基准 | 更快 | 明显提升 🚀 |

**Schema 定义：**
- `ProviderConfigSchema`: 单个 Provider 配置
- `ModelConfigSchema`: 模型配置
- `AgentConfigSchema`: Agent 配置
- `UIConfigSchema`: UI 配置（主题、模式）
- `SessionConfigSchema`: 会话配置
- `ReasonCliConfigSchema`: 完整配置

## 🎨 UI 改进

### 模型选择面板分组显示

**效果：**
```
Select Model
❯ Search...

Anthropic                          ← 分类标题（provider）
❯ Claude Sonnet 4 (current)        ← 绿色（当前使用）
  Claude 3 Opus                    ← 米色（普通选项）

OpenAI                             ← 分类标题
  GPT-4o                           ← 米色
  GPT-3.5 Turbo                    ← 米色

Google                             ← 分类标题
  Gemini Pro                       ← 米色
```

**颜色规则：**
- 🟣 **光标选中**: Primary 色（紫色）
- 🟢 **当前项**: Success 色（绿色）
- 📝 **普通项**: Text 色（米色）

**实现要点：**
- 按 `category` (provider) 分组
- 分类标题不可选
- 上下键只在可选项间移动
- 扁平化列表结构，便于导航

## 🔐 安全性

### API Key 管理

**存储格式：**
```json
{
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}"  // 环境变量引用
    }
  }
}
```

**使用：**
```bash
# .env 文件
ANTHROPIC_API_KEY=sk-ant-xxx
OPENAI_API_KEY=sk-xxx
GOOGLE_API_KEY=AIzaSy-xxx
```

**安全措施：**
- ✅ 不在配置文件中存储明文 API key
- ✅ 使用环境变量引用
- ✅ 保存时自动移除实际 key 值
- ✅ 加载时解析环境变量

## 🛡️ 错误处理

### 配置文件问题

| 问题 | 处理方式 |
|-----|---------|
| 配置文件不存在 | 使用默认配置，创建新配置文件 |
| JSON 格式错误 | 记录错误，使用默认配置 |
| Schema 验证失败 | 记录详细错误，使用默认配置 |
| 环境变量未设置 | 解析为空字符串，使用时提示用户 |

### 会话文件问题

| 问题 | 处理方式 |
|-----|---------|
| 单个会话损坏 | 跳过该会话，加载其他会话 |
| 所有会话损坏 | 创建新会话 |
| 磁盘写入失败 | 记录错误，继续运行（数据暂存内存） |

## 📊 性能考虑

### Valibot 优化

**Bundle Size 对比：**
```
Before (Zod):     14KB gzipped
After (Valibot):  1.5KB gzipped
减少:              -89% ⚡
```

**启动速度影响：**
- CLI 工具每次运行都要加载库
- 更小的体积 = 更快的启动
- 对用户体验提升明显

### 保存策略

**显式保存 vs 自动保存：**

| 方案 | 优点 | 缺点 |
|-----|------|------|
| 自动保存 | 不会遗漏 | 频繁写磁盘，性能差 |
| 显式保存 | 可控，性能好 | 需要手动调用 |

**选择：** 显式保存（Hook 层控制）

**保存时机：**
- 只在关键操作后保存
- 避免频繁写磁盘
- 退出时确保保存所有数据

## 🧪 测试清单

### 配置系统测试

- [x] 配置文件正常加载
- [x] 环境变量正确解析
- [x] 配置验证捕获错误
- [x] 配置更新正确保存
- [x] 默认配置正确应用

### 持久化测试

- [x] 会话创建后自动保存
- [x] 消息发送后自动保存
- [x] 模型切换后配置保存
- [x] 主题切换后配置保存

### 启动加载测试

- [x] 应用启动加载所有会话
- [x] 恢复上次打开的会话
- [x] 恢复用户选择的主题/模型
- [x] 没有历史数据时创建新会话

### UI 测试

- [x] 模型列表按 Provider 分组
- [x] 分类标题正确显示
- [x] 上下键只在选项间移动
- [x] 当前模型绿色高亮
- [x] 光标选中紫色高亮

## 📁 创建的文件

### 新增文件（5 个）

1. `config/schema.ts` (~90 行) - Valibot Schema 定义
2. `config/defaults.ts` (~80 行) - 默认配置和环境变量解析
3. `config/manager.ts` (~100 行) - ConfigManager 类
4. `hooks/usePersistence.ts` (~100 行) - 持久化 Hook
5. `persistence/loader.ts` (~50 行) - 数据加载器

### 修改文件（6 个）

6. `context/store.tsx` - 添加 `initializeFromDisk` 方法
7. `app.tsx` - 启动时加载数据，退出时保存
8. `routes/session/inputArea.tsx` - 发送消息后保存
9. `component/panel/panel-model.tsx` - 切换模型后保存
10. `ui/panel-select.tsx` - 恢复分组显示
11. `util/storage.ts` - 导出 `ensureStorageDir`

## 🎯 成功标准

实现完成后，满足以下标准：

1. ✅ 用户关闭应用后，所有配置和会话数据都已保存
2. ✅ 重新打开应用时，自动恢复到上次的状态
3. ✅ 配置文件损坏时，应用仍能正常启动（使用默认配置）
4. ✅ API Keys 通过环境变量管理，不泄露到配置文件
5. ✅ 保存不阻塞 UI，用户感知不到性能影响
6. ✅ 所有 IO 错误都有友好的日志记录
7. ✅ 启动速度快（使用 Valibot 优化）

## 🚀 使用示例

### 基本使用

```bash
# 运行应用
bun run dev

# 发送消息（自动保存）
> Hello!

# 切换模型（自动保存配置）
Ctrl+P → 选择模型

# 退出应用（自动保存所有数据）
Ctrl+C
```

### 查看存储数据

```bash
# 查看配置
cat ~/.reason-cli/config.json

# 查看所有会话
ls ~/.reason-cli/sessions/

# 查看特定会话
cat ~/.reason-cli/sessions/{sessionId}.json
```

### 环境变量配置

```bash
# .env 文件
ANTHROPIC_API_KEY=sk-ant-xxx
OPENAI_API_KEY=sk-xxx
GOOGLE_API_KEY=AIzaSy-xxx

# 运行应用
bun run dev
```

## 📚 参考资料

- **Valibot 文档**: https://valibot.dev/
- **Zustand 文档**: https://docs.pmnd.rs/zustand
- **参考项目**: gemini-cli, opencode

## 🔄 后续优化

### 短期
- [ ] 添加配置迁移机制（版本升级）
- [ ] 支持配置导入/导出
- [ ] 添加配置验证 CLI 命令

### 中期
- [ ] 支持多个配置 profile
- [ ] 云端同步（可选）
- [ ] 配置热重载

### 长期
- [ ] 数据库存储（SQLite）
- [ ] 全文搜索历史消息
- [ ] 数据分析和统计

---

**实现时间**: 2025-12-26
**版本**: v1.0
**状态**: ✅ 完成
