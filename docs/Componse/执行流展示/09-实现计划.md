# 实现计划

## 1. 实现阶段

### Phase 1: 基础架构 (P0)

**目标**：搭建执行流展示的基础架构

| 任务 | 文件位置 | 说明 |
|------|----------|------|
| 创建类型定义 | `packages/core/src/core/execution/types.ts` | 定义所有类型 |
| 创建事件定义 | `packages/core/src/core/execution/events.ts` | 定义事件类型 |
| 实现执行流管理器 | `packages/core/src/core/execution/ExecutionStreamManager.ts` | 状态管理 |
| 创建 CLI 常量 | `packages/cli/src/component/execution/constants.ts` | 图标、颜色映射 |
| 创建执行流 Context | `packages/cli/src/context/execution.tsx` | React Context |

**预计完成**：创建基础架构，可以手动测试状态变化

### Phase 2: 核心组件 (P0)

**目标**：实现核心展示组件

| 任务 | 文件位置 | 说明 |
|------|----------|------|
| 状态指示器 | `packages/cli/src/component/execution/StatusIndicator.tsx` | Spinner + 状态词 + 时间 |
| 工具调用展示 | `packages/cli/src/component/execution/ToolCallDisplay.tsx` | 单个工具调用 |
| 工具调用组 | `packages/cli/src/component/execution/ToolCallGroup.tsx` | 工具调用容器 |
| 执行流主组件 | `packages/cli/src/component/execution/ExecutionStream.tsx` | 组合所有组件 |

**预计完成**：可以展示基本的执行流程

### Phase 3: 思考展示 (P1)

**目标**：实现推理模型的思考过程展示

| 任务 | 文件位置 | 说明 |
|------|----------|------|
| 思考展示组件 | `packages/cli/src/component/execution/ThinkingDisplay.tsx` | 思考内容展示 |
| ctrl+t 快捷键 | `StatusIndicator.tsx` | 切换思考展示 |
| Tip 提示 | `StatusIndicator.tsx` | 操作提示轮播 |

**预计完成**：支持推理模型的思考展示，可切换

### Phase 4: Agent 集成 (P1)

**目标**：将执行流与 Agent 集成

| 任务 | 文件位置 | 说明 |
|------|----------|------|
| 修改 Agent 类 | `packages/core/src/core/agent/Agent.ts` | 集成 ExecutionStreamManager |
| 工具执行集成 | `packages/core/src/core/llm/utils/executeToolLoop.ts` | 发射工具事件 |
| 摘要生成器 | `packages/core/src/core/execution/summaryGenerators.ts` | 结果摘要生成 |

**预计完成**：Agent 执行时自动更新执行流状态

### Phase 5: Session 集成 (P1)

**目标**：将执行流展示集成到 Session 页面

| 任务 | 文件位置 | 说明 |
|------|----------|------|
| 添加 ExecutionProvider | `packages/cli/src/app.tsx` | 提供 Context |
| Session 页面集成 | `packages/cli/src/routes/session/index.tsx` | 添加 ExecutionStream |
| InputArea 联动 | `packages/cli/src/routes/session/inputArea.tsx` | 发送消息时启动执行流 |

**预计完成**：完整的端到端执行流展示

### Phase 6: 优化完善 (P2)

**目标**：性能优化和细节完善

| 任务 | 说明 |
|------|------|
| 性能优化 | 减少重渲染，debounce 处理 |
| 实时输出 | 长时间工具的 live output |
| 展开详情 | 可展开的工具详情 |
| 单元测试 | 组件和管理器测试 |

## 2. 文件结构

```
packages/
├── core/
│   └── src/
│       └── core/
│           ├── execution/           # 新增模块
│           │   ├── index.ts
│           │   ├── types.ts
│           │   ├── events.ts
│           │   ├── ExecutionStreamManager.ts
│           │   └── summaryGenerators.ts
│           └── agent/
│               └── Agent.ts         # 修改：集成执行流
│
└── cli/
    └── src/
        ├── context/
        │   └── execution.tsx        # 新增
        └── component/
            └── execution/           # 新增目录
                ├── index.ts
                ├── constants.ts
                ├── StatusIndicator.tsx
                ├── ToolCallDisplay.tsx
                ├── ToolCallGroup.tsx
                ├── ThinkingDisplay.tsx
                └── ExecutionStream.tsx
```

## 3. 依赖关系

```
                    ┌─────────────────────────┐
                    │   ExecutionStreamManager│ (Core)
                    │   - 状态管理             │
                    │   - 事件发射             │
                    └───────────┬─────────────┘
                                │
                                │ 事件
                                ▼
                    ┌─────────────────────────┐
                    │   ExecutionContext      │ (CLI)
                    │   - 订阅事件             │
                    │   - 提供状态             │
                    └───────────┬─────────────┘
                                │
              ┌─────────────────┼─────────────────┐
              │                 │                 │
              ▼                 ▼                 ▼
    ┌─────────────────┐ ┌─────────────┐ ┌─────────────────┐
    │ StatusIndicator │ │ToolCallGroup│ │ ThinkingDisplay │
    │ - Spinner       │ │ - 工具列表   │ │ - 思考内容      │
    │ - 状态词        │ │             │ │                 │
    │ - 时间/Token    │ │             │ │                 │
    └─────────────────┘ └─────────────┘ └─────────────────┘
```

## 4. 测试计划

### 4.1 单元测试

| 测试项 | 说明 |
|--------|------|
| ExecutionStreamManager | 状态转换、事件发射 |
| summaryGenerators | 各工具的摘要生成 |
| StatusIndicator | 时间格式化、状态展示 |
| ToolCallDisplay | 不同状态的图标和颜色 |

### 4.2 集成测试

| 测试项 | 说明 |
|--------|------|
| Agent 执行流程 | 完整执行流程的状态更新 |
| 工具调用展示 | 多个工具调用的展示 |
| 思考展示切换 | ctrl+t 快捷键功能 |

### 4.3 手动测试清单

- [ ] Spinner 动画流畅
- [ ] 状态短语轮换正常
- [ ] 工具调用颜色正确
- [ ] 思考展示切换正常
- [ ] Tip 提示轮换正常
- [ ] Token 统计准确
- [ ] 执行时间准确
- [ ] esc 中断功能正常

## 5. 注意事项

### 5.1 性能考虑

1. **避免频繁重渲染**
   - 使用 useMemo 缓存计算结果
   - 状态更新使用 batch

2. **大文本处理**
   - 思考内容限制最大行数
   - 实时输出只显示最后部分

3. **计时器管理**
   - 统一管理 interval
   - 组件卸载时清理

### 5.2 兼容性考虑

1. **终端兼容**
   - 使用通用字符（圆点、箭头）
   - 避免复杂 Unicode 符号

2. **颜色兼容**
   - 完全基于主题系统
   - 支持亮色/暗色模式

### 5.3 用户体验考虑

1. **信息层次**
   - 重要信息突出显示
   - 次要信息可选查看

2. **操作反馈**
   - 快捷键有明确提示
   - 状态变化有视觉反馈

## 6. 后续扩展

1. **更多工具类型**
   - MCP 工具
   - 自定义工具

2. **高级功能**
   - 工具执行历史
   - 执行统计面板
   - 导出执行日志

3. **可配置性**
   - 自定义状态短语
   - 自定义图标
   - 显示/隐藏特定信息
