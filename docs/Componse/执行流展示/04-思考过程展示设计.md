# 思考过程展示设计

## 1. 功能说明

思考过程展示用于显示推理模型（如 DeepSeek Reasoner、Claude thinking）的思考内容，让用户了解 AI 的推理过程。

## 2. 核心设计原则

### 2.1 默认收起

思考内容**默认收起**，原因：
1. 思考内容通常较长，占用大量屏幕空间
2. 大多数用户只关心最终结果
3. 避免信息过载

### 2.2 按需展开

用户可通过 `ctrl+t` 快捷键切换展示/隐藏。

## 3. 显示效果

### 3.1 收起状态（默认）

```
* Thinking... (esc to interrupt · 32s · ↓ 786 tokens)
  └ Tip: Press ctrl+t to show thinking process
```

### 3.2 展开状态（按 ctrl+t 后）

```
▼ Thinking
│ Let me analyze the codebase structure first...
│ I notice the project uses a monorepo architecture
│ with packages/core and packages/cli. The theme
│ system is well designed with support for multiple
│ themes...
└────────────────────────────────────────────────

* Thinking... (esc to interrupt · 45s · ↓ 1024 tokens)
```

### 3.3 流式更新中

```
▼ Thinking
│ Let me analyze the codebase structure first...
│ I notice the project uses a monorepo architecture
│ with packages/core and packages/cli...█
└────────────────────────────────────────────────
```

## 4. 数据结构

```typescript
export interface ThinkingContent {
  content: string;       // 思考内容
  isComplete: boolean;   // 是否完成
}
```

## 5. 交互设计

### 5.1 快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| `ctrl+t` | 切换展示 | Toggle thinking display |

### 5.2 状态管理

```typescript
interface ExecutionContextValue {
  // ... 其他字段
  showThinking: boolean;           // 是否显示思考
  toggleThinking: () => void;      // 切换显示状态
}
```

### 5.3 Tip 提示联动

当思考**收起**且**正在思考**时，显示提示：

```
└ Tip: Press ctrl+t to show thinking process
```

当思考**展开**后，不显示此 Tip。

## 6. 视觉设计

### 6.1 展开/收起图标

| 状态 | 图标 | 说明 |
|------|------|------|
| 展开 | `▼` | 向下箭头表示展开 |
| 收起 | `▶` | 向右箭头表示收起（实际不显示内容时隐藏） |

### 6.2 颜色方案

| 元素 | 主题颜色 | 说明 |
|------|----------|------|
| 标题 "Thinking" | `secondary` | 次要色，不抢眼 |
| 展开图标 | `secondary` | 与标题一致 |
| 内容文字 | `textMuted` | 灰色，作为辅助信息 |
| 边框线 | `borderSubtle` | 微妙的左边框 |

### 6.3 布局结构

```
┌─────────────────────────────────────────────────┐
│ [展开图标] [Thinking] [...] (可选的加载指示)     │
│ │ [思考内容行 1]                                │
│ │ [思考内容行 2]                                │
│ │ [思考内容行 3]                                │
│ └─────────────────────────────────────          │
└─────────────────────────────────────────────────┘
```

## 7. 组件实现

```tsx
// packages/cli/src/component/execution/ThinkingDisplay.tsx

import React, { useState } from 'react';
import { Box, Text, useInput } from 'ink';
import { useTheme } from '../../context/theme.js';
import type { ThinkingContent } from '@reason-cli/core';

interface ThinkingDisplayProps {
  thinking: ThinkingContent;
  isVisible: boolean;
  maxLines?: number;
}

export function ThinkingDisplay({
  thinking,
  isVisible,
  maxLines = 10
}: ThinkingDisplayProps) {
  const { colors } = useTheme();

  // 如果不显示，返回 null
  if (!isVisible || !thinking.content) {
    return null;
  }

  const lines = thinking.content.split('\n');
  const shouldTruncate = lines.length > maxLines;
  const displayLines = shouldTruncate ? lines.slice(0, maxLines) : lines;

  return (
    <Box flexDirection="column" paddingLeft={1}>
      {/* 标题行 */}
      <Box flexDirection="row" gap={1}>
        <Text color={colors.secondary}>▼</Text>
        <Text color={colors.secondary} bold>Thinking</Text>
        {!thinking.isComplete && (
          <Text color={colors.textMuted}>...</Text>
        )}
      </Box>

      {/* 内容区域 */}
      <Box
        flexDirection="column"
        paddingLeft={1}
        borderStyle="single"
        borderColor={colors.borderSubtle}
        borderLeft={true}
        borderRight={false}
        borderTop={false}
        borderBottom={false}
      >
        {displayLines.map((line, i) => (
          <Text key={i} color={colors.textMuted} wrap="wrap">
            {line}
          </Text>
        ))}

        {/* 截断提示 */}
        {shouldTruncate && (
          <Text color={colors.info}>
            ... ({lines.length - maxLines} more lines)
          </Text>
        )}
      </Box>

      {/* 底部分隔线 */}
      <Box paddingLeft={1}>
        <Text color={colors.borderSubtle}>
          └────────────────────────────────────────────────
        </Text>
      </Box>
    </Box>
  );
}
```

## 8. Context 集成

```tsx
// packages/cli/src/context/execution.tsx

import React, { createContext, useContext, useState, useCallback } from 'react';

interface ExecutionContextValue {
  snapshot: ExecutionSnapshot | null;
  isExecuting: boolean;
  showThinking: boolean;
  toggleThinking: () => void;
  // ... 其他字段
}

export function ExecutionProvider({ children }: { children: React.ReactNode }) {
  const [showThinking, setShowThinking] = useState(false);

  const toggleThinking = useCallback(() => {
    setShowThinking(prev => !prev);
  }, []);

  // 快捷键监听放在 StatusIndicator 中
  // 这里只提供状态和方法

  const value: ExecutionContextValue = {
    // ...
    showThinking,
    toggleThinking,
  };

  return (
    <ExecutionContext.Provider value={value}>
      {children}
    </ExecutionContext.Provider>
  );
}
```

## 9. 性能优化

### 9.1 大文本处理

- 限制最大显示行数（默认 10 行）
- 超出部分显示截断提示
- 考虑虚拟滚动（大量内容时）

### 9.2 流式更新

- 使用 debounce 减少渲染频率
- 内容追加时不重新渲染整个组件
- 只更新变化的部分

### 9.3 内存管理

- 思考完成后可选择清理内容
- 限制内容最大长度
- 用户关闭展示后考虑释放内存

## 10. 设计细节

### 10.1 光标指示

流式输出时，在内容末尾显示光标 `█` 表示正在接收：

```
│ Let me analyze the codebase...█
```

完成后光标消失。

### 10.2 行数限制

- 默认最多显示 10 行
- 超出部分显示 "... (N more lines)"
- 可配置最大行数

### 10.3 换行处理

- 使用 `wrap="wrap"` 自动换行
- 尊重原始换行符
- 长单词不截断

## 11. 与其他组件的关系

```
┌─────────────────────────────────────────────────────────────┐
│  ExecutionStream (主组件)                                    │
│  ├── ThinkingDisplay (思考展示) ← ctrl+t 控制               │
│  ├── ToolCallGroup (工具调用组)                              │
│  └── StatusIndicator (状态指示器) ← 包含 Tip 和快捷键监听    │
└─────────────────────────────────────────────────────────────┘
```

ThinkingDisplay 的显示状态由 ExecutionContext 管理，StatusIndicator 中监听 ctrl+t 快捷键来切换。
