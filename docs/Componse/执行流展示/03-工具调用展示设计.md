# 工具调用展示设计

## 1. 功能说明

工具调用展示用于显示 Agent 执行过程中调用的各种工具，包括工具名称、参数、执行状态和结果摘要。

## 2. 显示示例

```
● Read(src/context/theme.tsx)
  └ Read 231 lines from src/context/theme.tsx

● Glob(**/*.tsx)
  └ Found 26 files matching pattern

○ Grep(useTheme)
  └ Searching...
```

## 3. 图标设计

### 3.1 各项目图标对比

| 项目 | 成功 | 失败 | 执行中 | 等待 | 取消 |
|------|------|------|--------|------|------|
| **Claude Code** | `·` | `·` | `*` | - | - |
| **gemini-cli** | `✓` | `x` | `⊷` | `o` | `-` |
| **opencode** | SVG | SVG | SVG | - | - |

### 3.2 我们的图标方案

采用**圆点系统**，通过颜色区分状态：

```typescript
export const TOOL_ICONS = {
  PENDING: '○',      // 空心圆 - 等待执行
  EXECUTING: '●',    // 实心圆 - 执行中（灰色）
  SUCCESS: '●',      // 实心圆 - 成功（绿色）
  ERROR: '●',        // 实心圆 - 失败（红色）
  CANCELLED: '○',    // 空心圆 - 已取消（灰色）
} as const;
```

### 3.3 设计理由

1. **统一性** - 使用同一类图标（圆点），视觉一致
2. **颜色区分** - 通过颜色传达状态，更直观
3. **终端兼容** - 圆点字符在各终端显示一致
4. **简洁性** - 不使用复杂符号，保持界面干净

## 4. 颜色方案

### 4.1 状态颜色映射

```typescript
export const TOOL_STATUS_THEME_COLORS: Record<ToolCallStatus, keyof ThemeColors> = {
  pending: 'textMuted',      // 灰色 - 等待
  executing: 'textMuted',    // 灰色 - 执行中
  success: 'success',        // 绿色 - 成功
  error: 'error',            // 红色 - 失败
  cancelled: 'textMuted',    // 灰色 - 已取消
};
```

### 4.2 颜色设计理由

| 状态 | 颜色 | 理由 |
|------|------|------|
| **执行中** | 灰色 | 不抢眼，避免与成功/失败混淆 |
| **成功** | 绿色 | 通用的成功色，积极正面 |
| **失败** | 红色 | 通用的错误色，引起注意 |
| **等待/取消** | 灰色 | 次要状态，不需要突出 |

## 5. 工具调用状态

```typescript
export enum ToolCallStatus {
  Pending = 'pending',       // 等待执行
  Executing = 'executing',   // 执行中
  Success = 'success',       // 成功
  Error = 'error',           // 失败
  Cancelled = 'cancelled',   // 已取消
}
```

## 6. 数据结构

```typescript
export interface ToolCallRecord {
  id: string;                      // 调用 ID
  toolName: string;                // 工具名称
  toolCategory: string;            // 工具分类

  // 参数信息
  params: Record<string, any>;     // 完整参数
  paramsSummary: string;           // 参数摘要（用于显示）

  // 执行信息
  status: ToolCallStatus;
  startTime: number;               // 开始时间
  endTime?: number;                // 结束时间
  duration?: number;               // 执行耗时(ms)

  // 结果信息
  result?: any;                    // 完整结果
  resultSummary?: string;          // 结果摘要（用于显示）
  error?: string;                  // 错误信息

  // 实时输出
  liveOutput?: string;             // 长时间运行工具的实时输出
}
```

## 7. 结果摘要生成

### 7.1 摘要生成器

```typescript
export const defaultSummaryGenerators: Record<string, ToolResultSummaryGenerator> = {
  // 读取文件
  ReadFile: (_, params, result) => {
    const lines = result?.lines || result?.content?.split('\n').length || 0;
    return `Read ${lines} lines from ${params.file_path || params.path}`;
  },

  // Glob 搜索
  Glob: (_, params, result) => {
    const count = Array.isArray(result) ? result.length : 0;
    return `Found ${count} files matching ${params.pattern}`;
  },

  // Grep 搜索
  Grep: (_, params, result) => {
    const matches = result?.matches || result?.length || 0;
    return `Found ${matches} matches for "${params.pattern}"`;
  },

  // Bash 命令
  Bash: (_, params, result) => {
    const exitCode = result?.exitCode ?? 0;
    const status = exitCode === 0 ? 'completed' : `failed (exit ${exitCode})`;
    return `Command ${status}`;
  },

  // 写入文件
  WriteFile: (_, params) => {
    return `Wrote to ${params.file_path || params.path}`;
  },

  // 编辑文件
  Edit: (_, params) => {
    return `Edited ${params.file_path || params.path}`;
  },

  // 默认
  default: (toolName, _, result) => {
    if (result?.success === false) return `${toolName} failed`;
    return `${toolName} completed`;
  },
};
```

### 7.2 摘要示例

| 工具 | 参数摘要 | 结果摘要 |
|------|----------|----------|
| Read | `(src/app.tsx)` | `Read 156 lines from src/app.tsx` |
| Glob | `(**/*.tsx)` | `Found 23 files matching pattern` |
| Grep | `(useTheme)` | `Found 18 matches` |
| Bash | `(npm test)` | `Command completed` |
| Edit | `(src/utils.ts)` | `Edited src/utils.ts` |

## 8. 组件实现

```tsx
// packages/cli/src/component/execution/ToolCallDisplay.tsx

import React from 'react';
import { Box, Text } from 'ink';
import Spinner from 'ink-spinner';
import { useTheme } from '../../context/theme.js';
import { TOOL_ICONS, TOOL_STATUS_THEME_COLORS } from './constants.js';
import type { ToolCallRecord } from '@reason-cli/core';

interface ToolCallDisplayProps {
  toolCall: ToolCallRecord;
}

export function ToolCallDisplay({ toolCall }: ToolCallDisplayProps) {
  const { colors } = useTheme();

  // 获取状态对应的颜色
  const statusColorKey = TOOL_STATUS_THEME_COLORS[toolCall.status];
  const statusColor = colors[statusColorKey];

  // 状态图标
  const StatusIcon = () => {
    if (toolCall.status === 'executing') {
      // 执行中使用 spinner 动画
      return (
        <Text color={statusColor}>
          <Spinner type="dots" />
        </Text>
      );
    }

    const iconKey = toolCall.status.toUpperCase() as keyof typeof TOOL_ICONS;
    return (
      <Text color={statusColor}>
        {TOOL_ICONS[iconKey]}
      </Text>
    );
  };

  return (
    <Box flexDirection="column">
      {/* 主行：图标 + 工具名称 + 参数摘要 */}
      <Box flexDirection="row" gap={1}>
        <StatusIcon />
        <Text color={colors.primary} bold>
          {toolCall.toolName}
        </Text>
        <Text color={colors.textMuted}>
          ({toolCall.paramsSummary})
        </Text>
      </Box>

      {/* 结果摘要行 */}
      {toolCall.resultSummary && (
        <Box paddingLeft={2}>
          <Text color={colors.textMuted}>└ </Text>
          <Text color={colors.text}>{toolCall.resultSummary}</Text>
        </Box>
      )}

      {/* 错误信息 */}
      {toolCall.error && (
        <Box paddingLeft={2}>
          <Text color={colors.error}>└ Error: {toolCall.error}</Text>
        </Box>
      )}
    </Box>
  );
}
```

## 9. 工具调用组容器

```tsx
// packages/cli/src/component/execution/ToolCallGroup.tsx

import React from 'react';
import { Box } from 'ink';
import { useTheme } from '../../context/theme.js';
import { ToolCallDisplay } from './ToolCallDisplay.js';
import type { ToolCallRecord } from '@reason-cli/core';

interface ToolCallGroupProps {
  toolCalls: ToolCallRecord[];
  currentToolCall?: ToolCallRecord;
}

export function ToolCallGroup({ toolCalls, currentToolCall }: ToolCallGroupProps) {
  const { colors } = useTheme();

  // 合并历史和当前
  const allCalls = currentToolCall
    ? [...toolCalls, currentToolCall]
    : toolCalls;

  if (allCalls.length === 0) {
    return null;
  }

  // 判断是否有正在执行的工具
  const hasExecuting = allCalls.some(tc => tc.status === 'executing');

  return (
    <Box
      flexDirection="column"
      borderStyle="round"
      borderColor={hasExecuting ? colors.warning : colors.border}
      paddingX={1}
      gap={1}
    >
      {allCalls.map((toolCall) => (
        <ToolCallDisplay
          key={toolCall.id}
          toolCall={toolCall}
        />
      ))}
    </Box>
  );
}
```

## 10. 视觉效果示例

### 10.1 正常执行流程

```
╭──────────────────────────────────────────────────────────╮
│ ● Read(src/context/theme.tsx)                            │
│   └ Read 231 lines from src/context/theme.tsx           │
│                                                          │
│ ● Glob(**/*.tsx)                                         │
│   └ Found 26 files matching pattern                      │
│                                                          │
│ ⠋ Grep(useTheme)                                         │
│   └ Searching...                                         │
╰──────────────────────────────────────────────────────────╯
```

### 10.2 包含错误的执行

```
╭──────────────────────────────────────────────────────────╮
│ ● Read(src/app.tsx)                                      │
│   └ Read 89 lines from src/app.tsx                      │
│                                                          │
│ ● Bash(npm test)                                         │
│   └ Error: Command failed (exit 1)                       │
╰──────────────────────────────────────────────────────────╯
```

## 11. 设计细节

### 11.1 参数摘要规则

- 优先显示最重要的参数（如文件路径、搜索模式）
- 长路径截断显示：`src/.../components/app.tsx`
- 多参数时只显示主参数

### 11.2 结果摘要规则

- 简洁明了，一行以内
- 包含关键数字（行数、文件数、匹配数）
- 失败时显示错误原因

### 11.3 边框颜色

- 有工具执行中：`warning` 黄色
- 全部完成：`border` 默认边框色
