# 状态指示器设计

## 1. 功能说明

状态指示器是执行流展示的核心组件，在 Agent 执行过程中显示当前状态、执行时间、Token 消耗等关键信息。

## 2. 显示内容

```
* Thinking... (esc to interrupt · 32s · ↓ 786 tokens)
  └ Tip: Press ctrl+t to show thinking process
```

### 2.1 组成元素

| 元素 | 说明 | 示例 |
|------|------|------|
| **Spinner** | 旋转动画，表示正在处理 | `*`, `⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏` |
| **状态短语** | 随机的动作描述词 | `Thinking...`, `Analyzing...` |
| **中断提示** | 告知用户如何中断 | `(esc to interrupt)` |
| **执行时间** | 从开始计时 | `32s`, `1m 45s` |
| **Token 统计** | 累计消耗的 Token | `↓ 786 tokens` |
| **Tip 提示** | 操作小贴士（可选） | `Tip: Press ctrl+t to show thinking` |

### 2.2 状态短语池

```typescript
const STATUS_PHRASES = [
  'Thinking...',
  'Analyzing...',
  'Processing...',
  'Reasoning...',
  'Deciphering...',
  'Elucidating...',
  'Crunching...',
  'Computing...',
];
```

短语每 3-5 秒随机切换，增加动态感。

### 2.3 Tip 提示池

```typescript
const TIPS = [
  'Press ctrl+t to show thinking process',
  'Press esc to interrupt',
  'Hit shift+tab to cycle modes',
];
```

Tip 每 8 秒轮换，仅在思考状态且思考未展开时显示。

## 3. 状态类型

```typescript
export enum ExecutionState {
  Idle = 'idle',                     // 空闲
  Thinking = 'thinking',             // 思考中（等待 LLM 响应）
  ToolExecuting = 'tool_executing',  // 工具执行中
  Streaming = 'streaming',           // 流式输出中
  WaitingConfirm = 'waiting_confirm', // 等待用户确认
  Completed = 'completed',           // 完成
  Error = 'error',                   // 错误
  Cancelled = 'cancelled',           // 已取消
}
```

## 4. 视觉设计

### 4.1 颜色方案

| 元素 | 主题颜色 | 说明 |
|------|----------|------|
| Spinner | `warning` | 黄色，引起注意 |
| 状态短语 | `warning` | 与 Spinner 一致 |
| 元信息 | `textMuted` | 灰色，次要信息 |
| Tip 文字 | `textMuted` | 灰色，不抢眼 |

### 4.2 布局结构

```
┌─────────────────────────────────────────────────────────┐
│ [Spinner] [状态短语] [(元信息)]                          │
│   └ Tip: [提示内容]                                     │
└─────────────────────────────────────────────────────────┘
```

## 5. 交互行为

### 5.1 状态转换

```
Idle → Thinking → ToolExecuting → Thinking → Streaming → Completed
                ↓                                ↓
              Error                           Cancelled
```

### 5.2 快捷键

| 快捷键 | 功能 | 条件 |
|--------|------|------|
| `esc` | 中断执行 | 执行中 |
| `ctrl+t` | 切换思考展示 | 思考中 |

## 6. 组件实现

```tsx
// packages/cli/src/component/execution/StatusIndicator.tsx

import React, { useState, useEffect } from 'react';
import { Box, Text, useInput } from 'ink';
import Spinner from 'ink-spinner';
import { useTheme } from '../../context/theme.js';
import { useExecution } from '../../context/execution.js';

const STATUS_PHRASES = [
  'Thinking...',
  'Analyzing...',
  'Processing...',
  'Reasoning...',
  'Deciphering...',
  'Elucidating...',
  'Crunching...',
  'Computing...',
];

const TIPS = [
  'Press ctrl+t to show thinking process',
  'Press esc to interrupt',
  'Hit shift+tab to cycle modes',
];

export function StatusIndicator() {
  const { colors } = useTheme();
  const { snapshot, isExecuting, showThinking, toggleThinking } = useExecution();
  const [elapsedTime, setElapsedTime] = useState(0);
  const [tipIndex, setTipIndex] = useState(0);

  // 快捷键监听
  useInput((input, key) => {
    if (key.ctrl && input === 't') {
      toggleThinking();
    }
  });

  // 计时器
  useEffect(() => {
    if (!isExecuting) {
      setElapsedTime(0);
      return;
    }

    const interval = setInterval(() => {
      setElapsedTime(prev => prev + 1);
    }, 1000);

    return () => clearInterval(interval);
  }, [isExecuting]);

  // Tip 轮换
  useEffect(() => {
    if (!isExecuting) return;

    const interval = setInterval(() => {
      setTipIndex(prev => (prev + 1) % TIPS.length);
    }, 8000);

    return () => clearInterval(interval);
  }, [isExecuting]);

  if (!isExecuting || !snapshot) {
    return null;
  }

  const formatTime = (seconds: number): string => {
    if (seconds < 60) return `${seconds}s`;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
  };

  const { stats, statusPhrase, state } = snapshot;

  return (
    <Box flexDirection="column">
      {/* 主状态行 */}
      <Box flexDirection="row" gap={1}>
        <Text color={colors.warning}>
          <Spinner type="dots" />
        </Text>
        <Text color={colors.warning}>{statusPhrase}</Text>
        <Text color={colors.textMuted}>
          (esc to interrupt · {formatTime(elapsedTime)}
          {stats.totalTokens > 0 && ` · ↓ ${stats.totalTokens} tokens`})
        </Text>
      </Box>

      {/* Tip 行 */}
      {state === 'thinking' && !showThinking && (
        <Box paddingLeft={2}>
          <Text color={colors.textMuted}>
            └ Tip: {TIPS[tipIndex]}
          </Text>
        </Box>
      )}
    </Box>
  );
}
```

## 7. 设计细节

### 7.1 Spinner 类型

推荐使用 `dots` 类型，动画流畅且终端兼容性好：

```
⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏
```

### 7.2 时间格式化

- `< 60s`: 显示秒 `32s`
- `>= 60s`: 显示分秒 `1m 45s`
- `>= 60m`: 显示时分 `1h 23m`

### 7.3 Token 显示

- 使用 `↓` 箭头表示"消耗"
- 仅在 Token > 0 时显示
- 格式：`↓ 786 tokens`

## 8. 性能考虑

1. **计时器优化** - 使用单个 interval，避免多次重渲染
2. **条件渲染** - 非执行状态时不渲染组件
3. **状态去抖** - 状态短语切换添加适当间隔
