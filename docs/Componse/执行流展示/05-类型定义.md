# 类型定义

## 1. Core 层类型定义

### 1.1 执行状态枚举

```typescript
// packages/core/src/core/execution/types.ts

/**
 * 执行流状态
 */
export enum ExecutionState {
  Idle = 'idle',                     // 空闲
  Thinking = 'thinking',             // 思考中（等待 LLM 响应）
  ToolExecuting = 'tool_executing',  // 工具执行中
  Streaming = 'streaming',           // 流式输出中
  WaitingConfirm = 'waiting_confirm', // 等待用户确认
  Completed = 'completed',           // 完成
  Error = 'error',                   // 错误
  Cancelled = 'cancelled',           // 已取消
}

/**
 * 工具调用状态
 */
export enum ToolCallStatus {
  Pending = 'pending',       // 等待执行
  Executing = 'executing',   // 执行中
  Success = 'success',       // 成功
  Error = 'error',           // 失败
  Cancelled = 'cancelled',   // 已取消
}
```

### 1.2 工具调用记录

```typescript
/**
 * 工具调用记录
 */
export interface ToolCallRecord {
  id: string;                      // 调用 ID
  toolName: string;                // 工具名称
  toolCategory: string;            // 工具分类

  // 参数信息
  params: Record<string, any>;     // 完整参数
  paramsSummary: string;           // 参数摘要（用于显示）

  // 执行信息
  status: ToolCallStatus;
  startTime: number;               // 开始时间
  endTime?: number;                // 结束时间
  duration?: number;               // 执行耗时(ms)

  // 结果信息
  result?: any;                    // 完整结果
  resultSummary?: string;          // 结果摘要（用于显示）
  error?: string;                  // 错误信息

  // 实时输出（用于长时间运行的工具）
  liveOutput?: string;
}
```

### 1.3 思考内容

```typescript
/**
 * 思考内容（推理模型）
 */
export interface ThinkingContent {
  content: string;                 // 思考内容
  isComplete: boolean;             // 是否完成
}
```

### 1.4 执行统计

```typescript
/**
 * 执行统计
 */
export interface ExecutionStats {
  startTime: number;               // 开始时间
  elapsedTime: number;             // 已用时间(秒)

  // Token 统计
  inputTokens: number;             // 输入 token
  outputTokens: number;            // 输出 token
  totalTokens: number;             // 总 token

  // 工具统计
  toolCallCount: number;           // 工具调用次数
  loopCount: number;               // 循环次数
}
```

### 1.5 执行流快照

```typescript
/**
 * 执行流快照（完整状态）
 */
export interface ExecutionSnapshot {
  state: ExecutionState;           // 当前状态
  statusPhrase: string;            // 状态短语

  stats: ExecutionStats;           // 执行统计

  // 工具调用
  currentToolCall?: ToolCallRecord; // 当前正在执行的工具
  toolCallHistory: ToolCallRecord[]; // 工具调用历史

  // 思考内容
  thinking?: ThinkingContent;      // 推理模型的思考

  // 输出内容
  streamingContent: string;        // 流式输出内容

  // 错误信息
  error?: string;
}
```

## 2. 事件系统类型

### 2.1 事件类型定义

```typescript
// packages/core/src/core/execution/events.ts

import {
  ExecutionState,
  ToolCallRecord,
  ThinkingContent,
  ExecutionStats
} from './types.js';

/**
 * 执行流事件类型
 */
export type ExecutionEvent =
  // 生命周期事件
  | { type: 'execution:start'; timestamp: number }
  | { type: 'execution:complete'; stats: ExecutionStats }
  | { type: 'execution:error'; error: string }
  | { type: 'execution:cancel' }

  // 状态事件
  | { type: 'state:change'; state: ExecutionState; phrase: string }

  // 思考事件（推理模型）
  | { type: 'thinking:start' }
  | { type: 'thinking:delta'; delta: string }
  | { type: 'thinking:complete'; content: string }

  // 工具事件
  | { type: 'tool:start'; toolCall: ToolCallRecord }
  | { type: 'tool:output'; toolCallId: string; output: string }
  | { type: 'tool:complete'; toolCall: ToolCallRecord }
  | { type: 'tool:error'; toolCallId: string; error: string }

  // 流式输出事件
  | { type: 'content:delta'; delta: string }
  | { type: 'content:complete'; content: string }

  // Token 统计事件
  | { type: 'stats:update'; stats: Partial<ExecutionStats> };
```

### 2.2 事件发射器接口

```typescript
/**
 * 执行流事件发射器接口
 */
export interface ExecutionEventEmitter {
  on(handler: (event: ExecutionEvent) => void): () => void;
  emit(event: ExecutionEvent): void;
}
```

## 3. CLI 层类型定义

### 3.1 常量定义

```typescript
// packages/cli/src/component/execution/constants.ts

import type { ThemeColors } from '../../context/theme.js';
import type { ToolCallStatus } from '@reason-cli/core';

/**
 * 工具状态图标
 */
export const TOOL_ICONS = {
  PENDING: '○',      // 空心圆 - 等待执行
  EXECUTING: '●',    // 实心圆 - 执行中
  SUCCESS: '●',      // 实心圆 - 成功
  ERROR: '●',        // 实心圆 - 失败
  CANCELLED: '○',    // 空心圆 - 已取消
} as const;

/**
 * 状态对应主题颜色键
 */
export const TOOL_STATUS_THEME_COLORS: Record<ToolCallStatus, keyof ThemeColors> = {
  pending: 'textMuted',
  executing: 'textMuted',
  success: 'success',
  error: 'error',
  cancelled: 'textMuted',
};

/**
 * 状态短语池
 */
export const STATUS_PHRASES = [
  'Thinking...',
  'Analyzing...',
  'Processing...',
  'Reasoning...',
  'Deciphering...',
  'Elucidating...',
  'Crunching...',
  'Computing...',
] as const;

/**
 * Tip 提示池
 */
export const TIPS = [
  'Press ctrl+t to show thinking process',
  'Press esc to interrupt',
  'Hit shift+tab to cycle modes',
] as const;
```

### 3.2 Context 类型

```typescript
// packages/cli/src/context/execution.tsx

import type { ExecutionSnapshot, ExecutionEvent } from '@reason-cli/core';

/**
 * 执行流 Context 值类型
 */
export interface ExecutionContextValue {
  // 状态
  snapshot: ExecutionSnapshot | null;
  isExecuting: boolean;

  // 思考展示控制
  showThinking: boolean;
  toggleThinking: () => void;

  // 事件订阅
  subscribe: (handler: (event: ExecutionEvent) => void) => () => void;
}
```

### 3.3 组件 Props 类型

```typescript
// 状态指示器 Props
export interface StatusIndicatorProps {
  // 无需外部 props，从 Context 获取状态
}

// 工具调用展示 Props
export interface ToolCallDisplayProps {
  toolCall: ToolCallRecord;
}

// 工具调用组 Props
export interface ToolCallGroupProps {
  toolCalls: ToolCallRecord[];
  currentToolCall?: ToolCallRecord;
}

// 思考展示 Props
export interface ThinkingDisplayProps {
  thinking: ThinkingContent;
  isVisible: boolean;
  maxLines?: number;
}

// 执行流主组件 Props
export interface ExecutionStreamProps {
  // 无需外部 props，从 Context 获取状态
}
```

## 4. 工具结果摘要生成器类型

```typescript
/**
 * 工具结果摘要生成器
 */
export type ToolResultSummaryGenerator = (
  toolName: string,
  params: Record<string, any>,
  result: any
) => string;

/**
 * 摘要生成器注册表
 */
export type SummaryGeneratorRegistry = Record<string, ToolResultSummaryGenerator>;
```

## 5. 文件结构

```
packages/
├── core/
│   └── src/
│       └── core/
│           └── execution/
│               ├── index.ts              # 导出
│               ├── types.ts              # 类型定义
│               ├── events.ts             # 事件类型
│               ├── ExecutionStreamManager.ts  # 管理器
│               └── summaryGenerators.ts  # 摘要生成器
│
└── cli/
    └── src/
        ├── context/
        │   └── execution.tsx             # Context
        └── component/
            └── execution/
                ├── index.ts              # 导出
                ├── constants.ts          # 常量
                ├── StatusIndicator.tsx   # 状态指示器
                ├── ToolCallDisplay.tsx   # 工具调用展示
                ├── ToolCallGroup.tsx     # 工具调用组
                ├── ThinkingDisplay.tsx   # 思考展示
                └── ExecutionStream.tsx   # 主组件
```
