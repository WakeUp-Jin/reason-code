# OpenCode å­ä»£ç†å®ç° - å®Œæ•´æ–‡æ¡£ç´¢å¼•

æœ¬ç›®å½•åŒ…å« OpenCode å­ä»£ç†ç³»ç»Ÿçš„å®Œæ•´åˆ†æå’Œ Reason-Code çš„å®ç°æ–¹æ¡ˆã€‚

## ğŸ“š æ–‡æ¡£åˆ—è¡¨

### 1. [æ ¸å¿ƒæ¶æ„åˆ†æ](./01-æ ¸å¿ƒæ¶æ„åˆ†æ.md)
æ·±å…¥åˆ†æ OpenCode çš„å­ä»£ç†å®ç°ç»†èŠ‚ï¼š
- Agent ç±»å‹ç³»ç»Ÿï¼ˆprimary/subagent/allï¼‰
- Task Tool è°ƒç”¨æœºåˆ¶
- Session çˆ¶å­ä¼šè¯æ¨¡å‹
- æƒé™å’Œå·¥å…·éš”ç¦»
- äº‹ä»¶é©±åŠ¨è¿½è¸ª
- å…³é”®è®¾è®¡æ¨¡å¼

### 2. [Reason-Code å®ç°æ–¹æ¡ˆ](./02-reason-codeå®ç°æ–¹æ¡ˆ.md)
ç»“åˆ OpenCode ä¼˜ç§€è®¾è®¡çš„å®šåˆ¶æ–¹æ¡ˆï¼š
- è®¾è®¡ç›®æ ‡å’Œå·®å¼‚å¯¹æ¯”
- å®Œæ•´ç›®å½•ç»“æ„
- æ ¸å¿ƒç±»è®¾è®¡ï¼ˆAgentManager/AgentExecutor/AgentWrapperï¼‰
- é›†æˆåˆ° ToolManager
- ä¼šè¯ç®¡ç†æ‰©å±•
- å®ç°æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### OpenCode çš„ä¼˜åŠ¿
1. **ç®€æ´çš„ç±»å‹ç³»ç»Ÿ**: ä¸‰ç§æ¨¡å¼æ¸…æ™°å®šä¹‰ä»£ç†è§’è‰²
2. **è‡ªç„¶çš„å·¥å…·éš”ç¦»**: é€šè¿‡ç¦ç”¨ `task` å·¥å…·é˜²æ­¢é€’å½’
3. **æ¸…æ™°çš„ä¼šè¯å±‚çº§**: `parentID` å…³è”çˆ¶å­ä¼šè¯
4. **äº‹ä»¶é©±åŠ¨è¿½è¸ª**: å®æ—¶è·å–å­ä»£ç†æ‰§è¡ŒçŠ¶æ€
5. **çµæ´»çš„æƒé™æ§åˆ¶**: ç»†ç²’åº¦çš„å·¥å…·å’Œå‘½ä»¤æƒé™

### Reason-Code çš„é€‚é…
1. **ä¿æŒç®€æ´**: å€Ÿé‰´ OpenCode çš„ç®€æ´è®¾è®¡
2. **åˆ†å±‚ç®¡ç†**: åˆ©ç”¨ç°æœ‰çš„ Function/Agent åˆ†å±‚
3. **æœ¬åœ°ä¼˜å…ˆ**: ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ä¼šè¯
4. **æ¸è¿›å¢å¼º**: åˆ†é˜¶æ®µå®ç°ï¼Œå…ˆæ ¸å¿ƒåä¼˜åŒ–

---

## ğŸ”‘ å…³é”®å®ç°è¦ç‚¹

### 1. å·¥å…·éš”ç¦»
```typescript
// å­ä»£ç†ä¸èƒ½è®¿é—® task å·¥å…·
tools: {
  task: false,        // é˜²æ­¢é€’å½’
  todowrite: false,   // å¯é€‰ç¦ç”¨
  ...agent.tools
}
```

### 2. ä¼šè¯å…³è”
```typescript
// åˆ›å»ºå­ä¼šè¯æ—¶å…³è”çˆ¶ä¼šè¯
const session = await Session.create({
  parentID: ctx.sessionID,  // å…³é”®ï¼
  title: `${description} (@${agent.name})`
})
```

### 3. äº‹ä»¶è¿½è¸ª
```typescript
// è®¢é˜…å­ä¼šè¯äº‹ä»¶
Bus.subscribe(MessageV2.Event.PartUpdated, (evt) => {
  if (evt.properties.part.sessionID !== session.id) return
  // æ›´æ–°çˆ¶ä»£ç†å…ƒæ•°æ®
  ctx.metadata({ summary, sessionId })
})
```

### 4. èµ„æºæ¸…ç†
```typescript
// ç¡®ä¿æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
try {
  const result = await execute()
  return result
} finally {
  cleanup()
}
```

---

## ğŸ“Š æ¶æ„å¯¹æ¯”

| ç‰¹æ€§ | OpenCode | Reason-Code |
|------|----------|-------------|
| **å·¥å…·ç®¡ç†** | æ‰å¹³åŒ–æ³¨å†Œ | åˆ†å±‚ç®¡ç† |
| **ä¼šè¯å­˜å‚¨** | Storage æŠ½è±¡ | æ–‡ä»¶ç³»ç»Ÿ |
| **äº‹ä»¶ç³»ç»Ÿ** | Bus å…¨å±€æ€»çº¿ | EventEmitter |
| **æƒé™æ§åˆ¶** | ç»†ç²’åº¦é…ç½® | ç®€åŒ–ç‰ˆ |
| **å­ä»£ç†æ³¨å†Œ** | é…ç½®å¯¹è±¡ | AgentManager |
| **å·¥å…·åŒ…è£…** | TaskTool | AgentWrapper |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### é˜…è¯»é¡ºåº
1. å…ˆé˜…è¯» [æ ¸å¿ƒæ¶æ„åˆ†æ](./01-æ ¸å¿ƒæ¶æ„åˆ†æ.md) ç†è§£ OpenCode çš„è®¾è®¡
2. å†é˜…è¯» [Reason-Code å®ç°æ–¹æ¡ˆ](./02-reason-codeå®ç°æ–¹æ¡ˆ.md) äº†è§£å¦‚ä½•é€‚é…
3. å‚è€ƒå®ç°æ­¥éª¤é€æ­¥å¼€å‘

### å®ç°æ£€æŸ¥æ¸…å•
- [ ] åˆ›å»º `agent/` ç›®å½•ç»“æ„
- [ ] å®ç° `AgentManager` ç±»
- [ ] å®ç° `AgentExecutor` ç±»
- [ ] å®ç° `AgentWrapper` ç±»
- [ ] é›†æˆåˆ° `ToolManager`
- [ ] æ‰©å±• `SessionManager`
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

---

## ğŸ’¡ è®¾è®¡äº®ç‚¹

### 1. è‡ªç„¶éš”ç¦»
é€šè¿‡å·¥å…·é…ç½®è‡ªç„¶å®ç°éš”ç¦»ï¼Œæ— éœ€å¤æ‚çš„æƒé™æ£€æŸ¥ï¼š
```typescript
// å­ä»£ç†çš„å·¥å…·é›†è‡ªåŠ¨æ’é™¤ task
const tools = buildToolSet(agent)  // ä¸åŒ…å« task
```

### 2. ä¼šè¯å¤ç”¨
æ”¯æŒç»§ç»­ä¹‹å‰çš„å­ä»£ç†ä¼šè¯ï¼š
```typescript
{
  session_id: "previous_session_id"  // å¯é€‰å‚æ•°
}
```

### 3. å¹¶è¡Œæ‰§è¡Œ
ä¸»ä»£ç†å¯ä»¥å¹¶è¡Œè°ƒç”¨å¤šä¸ªå­ä»£ç†ï¼š
```typescript
// LLM è¿”å›å¤šä¸ª task å·¥å…·è°ƒç”¨
const results = await Promise.all(
  toolCalls.map(call => execute(call))
)
```

### 4. å®æ—¶è¿½è¸ª
çˆ¶ä»£ç†å®æ—¶è·å–å­ä»£ç†çš„å·¥å…·è°ƒç”¨çŠ¶æ€ï¼š
```typescript
ctx.metadata({
  summary: [
    { tool: 'read_file', status: 'completed' },
    { tool: 'grep', status: 'running' }
  ]
})
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [OpenCode GitHub](https://github.com/sst/opencode)
- [OpenCode æ–‡æ¡£](https://opencode.ai/docs)
- [Gemini CLI å­ä»£ç†å®ç°](../gemini-cliçš„å­ä»£ç†å®ç°/)
- [åŸå§‹è®¾è®¡æ–‡æ¡£](../ç»“åˆgemini-cliçš„å­ä»£ç†æ•´ç†çš„opencodeçš„å®ç°é€»è¾‘.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2026-01-14**: åˆ›å»ºæ–‡æ¡£ï¼Œå®Œæˆ OpenCode æ¶æ„åˆ†æå’Œ Reason-Code å®ç°æ–¹æ¡ˆ
