# 代理模式设计（Agent Mode）

## 概述

OpenCode 项目定义了三种代理模式，它们与 Task 工具的结合方式各不相同。代理模式通过 `mode` 字段定义，是整个子代理系统的基础。

## 一、mode: "primary" - 主代理

### 代表

- `build` - 默认主代理，拥有全部权限
- `plan` - 规划代理，受限权限（禁止 edit，bash 需 ask）

### 核心代码

```typescript
// packages/opencode/src/agent/agent.ts:118-135
build: {
  name: "build",
  tools: { ...defaultTools },
  permission: agentPermission,
  mode: "primary",
  native: true,
}

plan: {
  name: "plan",
  options: {},
  permission: planPermission,  // 受限权限
  tools: { ...defaultTools },
  mode: "primary",
  native: true,
}
```

### 特征

1. **用户直接交互**: 主代理是用户通过 Tab 键切换的对象
2. **完整的工具访问**: 可以访问所有工具（根据配置）
3. **不能被 Task 调用**: Task 工具初始化时会过滤掉主代理

```typescript
// packages/opencode/src/tool/task.ts:15
const agents = await Agent.list()
  .then((x) => x.filter((a) => a.mode !== "primary"))
```

### Plan 代理的权限限制

Plan 代理是特殊的主代理，有严格的权限限制：

```typescript
// packages/opencode/src/agent/agent.ts:71-115
const planPermission = mergeAgentPermissions(
  {
    edit: "deny",  // 禁止文件编辑
    bash: {
      // 白名单模式，只允许特定命令
      "git diff*": "allow",
      "git log*": "allow",
      "git status*": "allow",
      "ls*": "allow",
      "find *": "allow",
      "grep*": "allow",
      "*": "ask",  // 其他命令需要确认
    },
    webfetch: "allow",
  },
  cfg.permission ?? {},
)
```

## 二、mode: "subagent" - 子代理

### 代表

- `general` - 通用子代理，处理复杂多步骤任务
- `explore` - 探索子代理，快速代码库搜索

### 核心代码

```typescript
// packages/opencode/src/agent/agent.ts:136-165
general: {
  name: "general",
  description: "General-purpose agent for researching complex questions...",
  tools: {
    todoread: false,   // 禁用 todo 工具
    todowrite: false,
    ...defaultTools,
  },
  mode: "subagent",
  native: true,
  hidden: true,  // UI 中隐藏，不能 Tab 切换
}

explore: {
  name: "explore",
  tools: {
    todoread: false,
    todowrite: false,
    edit: false,    // 禁止编辑
    write: false,   // 禁止写入
    ...defaultTools,
  },
  description: "Fast agent specialized for exploring codebases...",
  prompt: PROMPT_EXPLORE,  // 专门的系统提示
  mode: "subagent",
  native: true,
}
```

### 特征

1. **专门设计用于被 Task 调用**: 不会被过滤掉
2. **UI 不可见**: 通过 `hidden: true` 在 UI 中不可见
3. **独立会话执行**: 在独立的子会话中运行
4. **工具受限**: 禁用 todo 工具，explore 还禁用文件修改

### 调用方式

子代理只能通过以下方式被调用：

1. **Task 工具调用**（主代理自动）
2. **@提及** (用户手动，如 `@general help me`)
3. **命令触发** (通过 SubtaskPart)

## 三、mode: "all" - 混合代理

### 定义

用户自定义代理的默认模式。

```typescript
// packages/opencode/src/agent/agent.ts:206-213
// 用户自定义代理创建时
item = result[key] = {
  name: key,
  mode: "all",  // 默认模式
  permission: agentPermission,
  options: {},
  tools: {},
  native: false,
}
```

### 特征

1. **双重角色**: 既可以作为主代理（用户直接交互），也可以作为子代理（被 Task 调用）
2. **灵活配置**: 用户可以通过配置文件完全自定义
3. **默认模式**: 如果用户没有指定 mode，默认为 "all"

### 配置示例

**JSON 配置**:
```json
{
  "agent": {
    "custom-reviewer": {
      "mode": "all",
      "description": "代码审查专家",
      "model": "anthropic/claude-sonnet-4",
      "prompt": "You are a code reviewer...",
      "tools": { "write": false, "edit": false },
      "permission": { "bash": { "*": "deny" } }
    }
  }
}
```

**Markdown 配置**:
```markdown
---
description: Code reviewer for best practices
mode: all
model: anthropic/claude-sonnet-4
temperature: 0.1
tools:
  write: false
  edit: false
---

You are an expert code reviewer...
```

## 四、代理模式对比表

| 特性 | Primary | Subagent | All |
|------|---------|----------|-----|
| 用户直接交互 | ✅ | ❌ | ✅ |
| Task 可调用 | ❌ | ✅ | ✅ |
| Tab 切换 | ✅ | ❌ | ✅ |
| UI 可见 | ✅ | ❌ (hidden) | ✅ |
| 创建子会话 | ❌ | ✅ | ✅ (作为子代理时) |
| 默认角色 | 主控制 | 任务执行 | 自定义 |
| 工具限制 | 可配置 | 严格限制 | 可配置 |

## 五、代理选择逻辑

### Task 工具的代理过滤

```typescript
// packages/opencode/src/tool/task.ts:14-21
export const TaskTool = Tool.define("task", async () => {
  // 过滤掉 primary 模式的代理
  const agents = await Agent.list()
    .then((x) => x.filter((a) => a.mode !== "primary"))

  // 生成可用代理列表的描述
  const description = DESCRIPTION.replace(
    "{agents}",
    agents
      .map((a) => `- ${a.name}: ${a.description ?? "..."}`)
      .join("\n"),
  )
  ...
})
```

这意味着：
- `build`, `plan` 等 primary 代理**不会**出现在 Task 工具的可用代理列表中
- `general`, `explore` 等 subagent 代理**会**出现
- 用户自定义的 `mode: "all"` 代理**也会**出现

### 默认代理选择

```typescript
// packages/opencode/src/agent/agent.ts:257-267
// 标记默认代理
const defaultName = cfg.default_agent ?? "build"
const defaultCandidate = result[defaultName]

if (defaultCandidate && defaultCandidate.mode !== "subagent") {
  defaultCandidate.default = true
} else {
  // 如果配置的默认代理无效，回退到 "build"
  if (result["build"]) {
    result["build"].default = true
  }
}
```

注意：默认代理**不能**是 subagent 模式。

## 六、权限系统

### Permission 结构

```typescript
// packages/opencode/src/agent/agent.ts:30-37
permission: z.object({
  edit: Config.Permission,                        // 文件编辑权限
  bash: z.record(z.string(), Config.Permission), // bash 命令权限（模式匹配）
  skill: z.record(z.string(), Config.Permission),// 技能权限
  webfetch: Config.Permission.optional(),        // 网络获取权限
  doom_loop: Config.Permission.optional(),       // 死循环检测
  external_directory: Config.Permission.optional() // 外部目录访问
})

// Permission = "allow" | "deny" | "ask"
```

### 权限合并逻辑

```typescript
// packages/opencode/src/agent/agent.ts:333-398
function mergeAgentPermissions(basePermission, overridePermission) {
  // 1. 将字符串权限转换为对象形式
  // 2. 深度合并两个权限对象
  // 3. 确保 bash 和 skill 权限有默认的 "*": "allow"

  const result = {
    edit: merged.edit ?? "allow",
    webfetch: merged.webfetch ?? "allow",
    bash: mergedBash ?? { "*": "allow" },
    skill: mergedSkill ?? { "*": "allow" },
    doom_loop: merged.doom_loop,
    external_directory: merged.external_directory,
  }

  return result
}
```

### Bash 权限的模式匹配

Plan 代理的 bash 权限配置展示了模式匹配的强大功能：

```typescript
bash: {
  "git diff*": "allow",      // 允许所有 git diff 变体
  "git log*": "allow",
  "find * -delete*": "ask",  // 危险操作需要确认
  "find * -exec*": "ask",
  "find *": "allow",         // 普通 find 允许
  "*": "ask",                // 其他所有命令需要确认
}
```

匹配顺序：**从具体到通用**，第一个匹配的规则生效。

## 七、内置代理列表

| 代理名称 | 模式 | 描述 | Hidden | 用途 |
|---------|------|------|--------|------|
| build | primary | 默认主代理 | false | 用户主交互 |
| plan | primary | 规划代理 | false | 任务规划（受限权限） |
| general | subagent | 通用子代理 | true | 复杂任务执行 |
| explore | subagent | 探索代理 | true | 代码库快速搜索 |
| compaction | primary | 压缩代理 | true | 上下文压缩 |
| title | primary | 标题生成 | true | 会话标题生成 |
| summary | primary | 摘要生成 | true | 会话摘要生成 |

注：hidden=true 的代理不会在 UI 的代理切换列表中显示。

## 八、关键文件位置

| 功能 | 文件路径 | 行号 |
|------|---------|------|
| 代理模式定义 | `packages/opencode/src/agent/agent.ts` | 23 |
| 内置代理配置 | `packages/opencode/src/agent/agent.ts` | 117-198 |
| 权限合并逻辑 | `packages/opencode/src/agent/agent.ts` | 333-398 |
| 代理列表过滤 | `packages/opencode/src/tool/task.ts` | 15 |
| 默认代理选择 | `packages/opencode/src/agent/agent.ts` | 257-267 |
