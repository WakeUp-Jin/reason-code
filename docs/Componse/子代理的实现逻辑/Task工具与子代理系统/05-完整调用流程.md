# 完整调用流程详解

## 概述

本文档详细描述 OpenCode 子代理系统的三种调用流程，从用户输入到子代理执行完成的每一步。

## 一、三种调用方式

| 调用方式 | 触发方式 | 决策者 | 场景 |
|---------|---------|--------|------|
| **命令触发 SubtaskPart** | `/command` | 命令系统 | 用户显式调用子代理 |
| **LLM 主动调用 Task** | 普通消息 | LLM 推理 | 主代理委派任务给子代理 |
| **@提及调用** | `@agent_name` | 用户 + LLM | 用户指定子代理，LLM 决定如何调用 |

## 二、流程 1: 命令触发 SubtaskPart

### 场景

用户输入命令，命令配置为使用子代理。

### 示例

```bash
/explore find all TypeScript test files
```

### 完整流程

```
┌────────────────────────────────────────────────────────────┐
│ 1. 用户输入                                                │
│    /explore find all TypeScript test files                │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. CLI 解析命令                                            │
│    packages/opencode/src/cli/cmd/tui/routes/session/     │
│    - 解析命令名称: "explore"                               │
│    - 解析参数: "find all TypeScript test files"           │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. SessionPrompt.command()                                 │
│    packages/opencode/src/session/prompt.ts:1282-1382      │
│                                                            │
│    a. 获取命令配置                                         │
│       const command = await Command.get("explore")        │
│       → {                                                  │
│           agent: "explore",                                │
│           description: "Explore codebase",                 │
│           template: "$1"                                   │
│         }                                                  │
│                                                            │
│    b. 获取代理配置                                         │
│       const agent = await Agent.get("explore")            │
│       → { name: "explore", mode: "subagent", ... }        │
│                                                            │
│    c. 处理模板                                             │
│       let template = "$1".replace("$1", "find all...")    │
│       → "find all TypeScript test files"                  │
│                                                            │
│    d. 判断是否创建 SubtaskPart                             │
│       条件: agent.mode === "subagent" &&                  │
│             command.subtask !== false                     │
│       → true，创建 SubtaskPart                            │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. 创建 SubtaskPart                                        │
│    packages/opencode/src/session/prompt.ts:1352-1364      │
│                                                            │
│    const parts = [{                                        │
│      type: "subtask",                                      │
│      agent: "explore",                                     │
│      description: "Explore codebase",                      │
│      command: "/explore",                                  │
│      prompt: "find all TypeScript test files"             │
│    }]                                                      │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 5. SessionPrompt.prompt()                                  │
│    packages/opencode/src/session/prompt.ts:140-152        │
│                                                            │
│    a. 创建用户消息                                         │
│       const message = await createUserMessage({           │
│         sessionID,                                         │
│         agent: "build",  // 当前主代理                    │
│         parts: [SubtaskPart]                               │
│       })                                                   │
│                                                            │
│    b. 调用 loop()                                          │
│       return loop(sessionID)                               │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 6. SessionPrompt.loop() - 主循环                           │
│    packages/opencode/src/session/prompt.ts:230-563        │
│                                                            │
│    while (true) {                                          │
│      a. 获取消息流                                         │
│         msgs = await MessageV2.stream(sessionID)          │
│                                                            │
│      b. 收集待处理的 tasks                                 │
│         tasks = msgs.flatMap(msg =>                        │
│           msg.parts.filter(p =>                            │
│             p.type === "subtask" || p.type === "compaction"│
│           )                                                │
│         )                                                  │
│                                                            │
│      c. 检测到 SubtaskPart                                 │
│         const task = tasks.pop()                           │
│         if (task?.type === "subtask") {                    │
│           // 执行 subtask...                               │
│         }                                                  │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 7. 执行 SubtaskPart                                        │
│    packages/opencode/src/session/prompt.ts:288-443        │
│                                                            │
│    a. 初始化 TaskTool                                      │
│       const taskTool = await TaskTool.init()              │
│                                                            │
│    b. 创建 Assistant 消息                                  │
│       const assistantMessage = await Session.updateMessage({│
│         role: "assistant",                                 │
│         agent: task.agent,  // "explore"                  │
│         ...                                                │
│       })                                                   │
│                                                            │
│    c. 创建 Tool Part                                       │
│       let part = await Session.updatePart({               │
│         type: "tool",                                      │
│         tool: "task",                                      │
│         state: {                                           │
│           status: "running",                               │
│           input: {                                         │
│             prompt: task.prompt,                           │
│             description: task.description,                 │
│             subagent_type: task.agent,                     │
│             command: task.command                          │
│           }                                                │
│         }                                                  │
│       })                                                   │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 8. TaskTool.execute()                                      │
│    packages/opencode/src/tool/task.ts:31-136              │
│                                                            │
│    a. 验证子代理                                           │
│       const agent = await Agent.get("explore")            │
│                                                            │
│    b. 创建子会话                                           │
│       const session = await Session.create({              │
│         parentID: ctx.sessionID,  // 父会话 ID            │
│         title: "Explore codebase (@explore subagent)"     │
│       })                                                   │
│                                                            │
│    c. 订阅事件                                             │
│       Bus.subscribe(MessageV2.Event.PartUpdated, ...)     │
│                                                            │
│    d. 配置工具                                             │
│       tools: {                                             │
│         todowrite: false,                                  │
│         todoread: false,                                   │
│         task: false,                                       │
│         ...agent.tools  // explore 的工具配置             │
│       }                                                    │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 9. 在子会话中执行子代理                                    │
│    packages/opencode/src/session/prompt.ts:140-152        │
│                                                            │
│    const result = await SessionPrompt.prompt({            │
│      sessionID: session.id,  // 子会话 ID                 │
│      agent: "explore",       // 子代理名称                 │
│      model,                   // 模型配置                  │
│      tools,                   // 受限的工具集               │
│      parts: [{                                             │
│        type: "text",                                       │
│        text: "find all TypeScript test files"             │
│      }]                                                    │
│    })                                                      │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 10. 子代理执行（在子会话的 loop 中）                       │
│                                                            │
│    a. 子会话的消息                                         │
│       User: "find all TypeScript test files"              │
│                                                            │
│    b. LLM 推理                                             │
│       → 决定调用 glob 工具                                 │
│                                                            │
│    c. 执行工具                                             │
│       glob({ pattern: "**/*.test.ts" })                   │
│       → 返回文件列表                                       │
│                                                            │
│    d. LLM 生成响应                                         │
│       "I found 15 TypeScript test files..."               │
│                                                            │
│    e. 完成                                                 │
│       finish: "stop"                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 11. TaskTool.execute() 返回结果                            │
│                                                            │
│    return {                                                │
│      title: "Explore codebase",                            │
│      metadata: {                                           │
│        summary: [                                          │
│          {                                                 │
│            id: "part_...",                                 │
│            tool: "glob",                                   │
│            state: { status: "completed", ... }             │
│          }                                                 │
│        ],                                                  │
│        sessionId: session.id                               │
│      },                                                    │
│      output: "I found 15 TypeScript test files...\n\n..." │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 12. 更新父会话的 Tool Part                                 │
│     packages/opencode/src/session/prompt.ts:386-417       │
│                                                            │
│     await Session.updatePart({                             │
│       ...part,                                             │
│       state: {                                             │
│         status: "completed",                               │
│         output: result.output,                             │
│         metadata: result.metadata,                         │
│         ...                                                │
│       }                                                    │
│     })                                                     │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 13. 添加合成用户消息                                       │
│     packages/opencode/src/session/prompt.ts:419-440       │
│                                                            │
│     await Session.updateMessage({                          │
│       role: "user",                                        │
│       ...                                                  │
│     })                                                     │
│     await Session.updatePart({                             │
│       type: "text",                                        │
│       text: "Summarize the task tool output above...",    │
│       synthetic: true                                      │
│     })                                                     │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 14. 继续主循环                                             │
│                                                            │
│     continue  // 回到 step 6                              │
│                                                            │
│     下一轮循环:                                            │
│     - 检测到合成用户消息                                   │
│     - 进入正常 LLM 处理流程                                │
│     - 主代理可以总结子代理的结果并继续任务                 │
└────────────────────────────────────────────────────────────┘
```

### 关键代码位置

| 步骤 | 文件 | 行号 |
|------|------|------|
| 2. CLI 解析 | `packages/opencode/src/cli/cmd/tui/routes/session/` | - |
| 3. command() | `packages/opencode/src/session/prompt.ts` | 1282-1382 |
| 4. 创建 SubtaskPart | `packages/opencode/src/session/prompt.ts` | 1352-1364 |
| 5. prompt() | `packages/opencode/src/session/prompt.ts` | 140-152 |
| 6. loop() | `packages/opencode/src/session/prompt.ts` | 230-563 |
| 7. 执行 SubtaskPart | `packages/opencode/src/session/prompt.ts` | 288-443 |
| 8. TaskTool.execute() | `packages/opencode/src/tool/task.ts` | 31-136 |

## 三、流程 2: LLM 主动调用 Task

### 场景

主代理在处理任务时，决定调用子代理。

### 示例

```
用户: "Please analyze the test coverage of this project"
主代理: 决定调用 explore 子代理来查找测试文件
```

### 完整流程

```
┌────────────────────────────────────────────────────────────┐
│ 1. 用户输入                                                │
│    "Please analyze the test coverage of this project"     │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. SessionPrompt.prompt()                                  │
│                                                            │
│    a. 创建用户消息                                         │
│       const message = await createUserMessage({           │
│         sessionID,                                         │
│         agent: "build",                                    │
│         parts: [{                                          │
│           type: "text",                                    │
│           text: "Please analyze..."                        │
│         }]                                                 │
│       })                                                   │
│                                                            │
│    b. 调用 loop()                                          │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. SessionPrompt.loop() - 正常 LLM 处理                    │
│                                                            │
│    a. 检测到普通用户消息（无 SubtaskPart）                 │
│                                                            │
│    b. 进入正常 LLM 处理流程                                │
│       const processor = SessionProcessor.create(...)      │
│                                                            │
│    c. 解析可用工具                                         │
│       const tools = await resolveTools({                  │
│         agent,                                             │
│         sessionID,                                         │
│         model,                                             │
│         processor                                          │
│       })                                                   │
│       → 包含 task 工具（build 代理可以调用）              │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. LLM.stream() - 发送给 LLM                               │
│    packages/opencode/src/session/llm.ts                   │
│                                                            │
│    a. 构建消息历史                                         │
│       messages: [                                          │
│         {                                                  │
│           role: "user",                                    │
│           content: "Please analyze..."                     │
│         }                                                  │
│       ]                                                    │
│                                                            │
│    b. 发送到 LLM                                           │
│       const stream = await streamText({                   │
│         model,                                             │
│         messages,                                          │
│         tools,  // 包含 task 工具                         │
│         ...                                                │
│       })                                                   │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 5. LLM 推理和决策                                          │
│                                                            │
│    LLM 分析任务，决定:                                     │
│    "我需要先找到所有测试文件，然后分析它们"                │
│                                                            │
│    → 决定调用 task 工具                                    │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 6. LLM 返回 tool_use                                       │
│                                                            │
│    {                                                       │
│      "tool_calls": [{                                      │
│        "id": "call_123",                                   │
│        "type": "function",                                 │
│        "function": {                                       │
│          "name": "task",                                   │
│          "arguments": {                                    │
│            "description": "Find test files",               │
│            "prompt": "Find all test files in the project...",│
│            "subagent_type": "explore"                      │
│          }                                                 │
│        }                                                   │
│      }]                                                    │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 7. SessionProcessor 处理 tool_use                          │
│    packages/opencode/src/session/processor.ts             │
│                                                            │
│    a. 解析 tool_use                                        │
│       for (const toolCall of toolCalls) {                 │
│         const tool = tools[toolCall.function.name]        │
│         const args = JSON.parse(toolCall.function.arguments)│
│       }                                                    │
│                                                            │
│    b. 创建 Tool Part                                       │
│       await Session.updatePart({                           │
│         type: "tool",                                      │
│         tool: "task",                                      │
│         state: {                                           │
│           status: "running",                               │
│           input: args                                      │
│         }                                                  │
│       })                                                   │
│                                                            │
│    c. 执行工具                                             │
│       const result = await tool.execute(args, ctx)        │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 8. TaskTool.execute()                                      │
│    （与流程 1 的步骤 8-11 相同）                           │
│                                                            │
│    a. 验证子代理                                           │
│    b. 创建子会话                                           │
│    c. 订阅事件                                             │
│    d. 配置工具                                             │
│    e. 在子会话中执行子代理                                 │
│    f. 返回结果                                             │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 9. SessionProcessor 更新 Tool Part                         │
│                                                            │
│    await Session.updatePart({                              │
│      ...part,                                              │
│      state: {                                              │
│        status: "completed",                                │
│        output: result.output,                              │
│        metadata: result.metadata                           │
│      }                                                     │
│    })                                                      │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 10. LLM.stream() 继续                                      │
│                                                            │
│     a. LLM 收到工具执行结果                                │
│        {                                                   │
│          "role": "tool",                                   │
│          "tool_call_id": "call_123",                       │
│          "content": "I found 15 test files..."            │
│        }                                                   │
│                                                            │
│     b. LLM 继续推理                                        │
│        "Based on the test files found, I will now..."     │
│                                                            │
│     c. LLM 可能继续调用其他工具，或生成最终响应            │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 11. LLM 完成，返回 finish_reason                           │
│                                                            │
│     finish_reason: "stop"                                  │
│                                                            │
│     主循环退出                                             │
└────────────────────────────────────────────────────────────┘
```

### 关键差异

与流程 1 的主要差异：

1. **没有 SubtaskPart**: 直接创建普通的 TextPart
2. **LLM 决策**: LLM 推理后决定是否调用 task 工具
3. **工具调用**: 通过 AI SDK 的 tool_use 机制调用
4. **执行位置**: 在 SessionProcessor 中执行工具，而不是在 loop 开头
5. **无合成消息**: 不需要添加合成用户消息，LLM 自然继续

## 四、流程 3: @提及调用

### 场景

用户通过 `@agent_name` 提及子代理。

### 示例

```
@explore find all test files in the project
```

### 完整流程

```
┌────────────────────────────────────────────────────────────┐
│ 1. 用户输入                                                │
│    @explore find all test files in the project            │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. CLI 解析 @提及                                          │
│                                                            │
│    a. 检测 @ 符号                                          │
│       pattern: /@([a-zA-Z0-9_-]+)/                        │
│                                                            │
│    b. 提取代理名称: "explore"                              │
│                                                            │
│    c. 提取剩余文本: "find all test files in the project"  │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. SessionPrompt.resolvePromptParts()                      │
│    packages/opencode/src/session/prompt.ts:154-203        │
│                                                            │
│    const files = ConfigMarkdown.files(template)           │
│    // 查找 [[...]] 引用，包括代理引用                      │
│                                                            │
│    if (stats) {                                            │
│      // 文件引用...                                        │
│    } else {                                                │
│      const agent = await Agent.get(name)                  │
│      if (agent) {                                          │
│        parts.push({                                        │
│          type: "agent",                                    │
│          name: agent.name                                  │
│        })                                                  │
│      }                                                     │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. 创建用户消息                                            │
│    packages/opencode/src/session/prompt.ts:717-1002       │
│                                                            │
│    parts.map(async (part) => {                             │
│      if (part.type === "agent") {                          │
│        return [                                            │
│          {                                                 │
│            id: Identifier.ascending("part"),               │
│            type: "agent",                                  │
│            name: part.name,  // "explore"                 │
│            messageID: info.id,                             │
│            sessionID: input.sessionID                      │
│          },                                                │
│          {                                                 │
│            id: Identifier.ascending("part"),               │
│            type: "text",                                   │
│            synthetic: true,                                │
│            text: "Use the above message and context to...",│
│            messageID: info.id,                             │
│            sessionID: input.sessionID                      │
│          }                                                 │
│        ]                                                   │
│      }                                                     │
│    })                                                      │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 5. 用户消息结构                                            │
│                                                            │
│    {                                                       │
│      info: {                                               │
│        role: "user",                                       │
│        agent: "build",  // 当前主代理                     │
│        ...                                                 │
│      },                                                    │
│      parts: [                                              │
│        {                                                   │
│          type: "text",                                     │
│          text: "find all test files in the project"       │
│        },                                                  │
│        {                                                   │
│          type: "agent",                                    │
│          name: "explore"                                   │
│        },                                                  │
│        {                                                   │
│          type: "text",                                     │
│          synthetic: true,                                  │
│          text: "Use the above message and context to...", │
│        }                                                   │
│      ]                                                     │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 6. MessageV2.toModelMessage()                              │
│    packages/opencode/src/session/message-v2.ts            │
│                                                            │
│    // AgentPart 转换为文本                                 │
│    if (part.type === "agent") {                            │
│      // 跳过，不发送给 LLM                                 │
│    }                                                       │
│                                                            │
│    // 合成文本提示 LLM                                     │
│    {                                                       │
│      role: "user",                                         │
│      content: [                                            │
│        "find all test files in the project",              │
│        "Use the above message and context to generate a...",│
│      ]                                                     │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 7. LLM 推理                                                │
│                                                            │
│    LLM 看到提示:                                           │
│    "Use the above message and context to generate a       │
│     prompt and call the task tool with subagent: explore" │
│                                                            │
│    → LLM 决定调用 task 工具                                │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 8. LLM 返回 tool_use                                       │
│                                                            │
│    {                                                       │
│      "tool_calls": [{                                      │
│        "function": {                                       │
│          "name": "task",                                   │
│          "arguments": {                                    │
│            "description": "Find test files",               │
│            "prompt": "Find all test files in the project",│
│            "subagent_type": "explore"  // 使用用户指定的   │
│          }                                                 │
│        }                                                   │
│      }]                                                    │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────┐
│ 9. 后续流程与流程 2 相同                                   │
│                                                            │
│    - SessionProcessor 处理 tool_use                        │
│    - 执行 TaskTool.execute()                               │
│    - 创建子会话                                            │
│    - 执行子代理                                            │
│    - 返回结果                                              │
│    - LLM 继续处理                                          │
└────────────────────────────────────────────────────────────┘
```

### 关键代码

**AgentPart 定义**:
```typescript
// packages/opencode/src/session/message-v2.ts
export const AgentPart = PartBase.extend({
  type: z.literal("agent"),
  name: z.string(),  // 代理名称
})
```

**AgentPart 转换**:
```typescript
// packages/opencode/src/session/prompt.ts:947-966
if (part.type === "agent") {
  return [
    {
      id: Identifier.ascending("part"),
      type: "agent",
      name: part.name,
      messageID: info.id,
      sessionID: input.sessionID,
    },
    {
      id: Identifier.ascending("part"),
      type: "text",
      synthetic: true,
      text: "Use the above message and context to generate a prompt " +
            "and call the task tool with subagent: " + part.name,
      messageID: info.id,
      sessionID: input.sessionID,
    },
  ]
}
```

## 五、三种流程的对比

| 维度 | 命令触发 | LLM 主动调用 | @提及调用 |
|------|---------|-------------|----------|
| **触发方式** | `/command` | 普通消息 | `@agent_name` |
| **创建的 Part** | SubtaskPart | TextPart | AgentPart + TextPart |
| **执行时机** | loop 开头 | LLM 推理后 | LLM 推理后 |
| **LLM 决策** | ❌ 直接执行 | ✅ 自主决策 | ✅ 受引导决策 |
| **合成消息** | ✅ 需要 | ❌ 不需要 | ❌ 不需要 |
| **速度** | 最快 | 较慢 | 较慢 |
| **灵活性** | 低 | 高 | 中 |
| **适用场景** | 用户明确知道要用哪个子代理 | 主代理自主决策 | 用户指定子代理，LLM 决定细节 |

## 六、消息流对比

### 命令触发

```
User: /explore find tests
  → SubtaskPart 创建
  → loop 检测
  → 直接执行 TaskTool
  → 子代理执行
  → 合成 User 消息
  → 主代理继续
```

### LLM 主动调用

```
User: analyze test coverage
  → TextPart 创建
  → loop 正常处理
  → LLM 推理
  → LLM 调用 task 工具
  → SessionProcessor 执行 TaskTool
  → 子代理执行
  → 结果返回 LLM
  → LLM 继续处理
```

### @提及调用

```
User: @explore find tests
  → AgentPart + TextPart 创建
  → loop 正常处理
  → LLM 看到合成提示
  → LLM 调用 task 工具（subagent: explore）
  → SessionProcessor 执行 TaskTool
  → 子代理执行
  → 结果返回 LLM
  → LLM 继续处理
```

## 七、关键设计要点

### 1. 统一的执行路径

所有三种调用方式最终都通过 `TaskTool.execute()` 执行，确保一致性。

### 2. 灵活的触发机制

- 命令触发：快速、确定性
- LLM 调用：智能、灵活
- @提及：用户控制 + LLM 智能

### 3. 上下文传递

通过不同的机制传递上下文：
- SubtaskPart: `prompt` 字段
- tool_use: `arguments` 字段
- AgentPart: 合成提示 + LLM 推理

### 4. 会话隔离

无论哪种调用方式，都创建独立的子会话，实现上下文隔离。

## 八、总结

OpenCode 的子代理系统提供了三种灵活的调用方式，满足不同的使用场景：

1. **命令触发**: 适合用户明确知道要用哪个子代理的情况，快速高效
2. **LLM 主动调用**: 适合复杂任务，让主代理智能决策
3. **@提及调用**: 结合用户控制和 LLM 智能，平衡灵活性和确定性

这三种方式共享相同的底层机制（TaskTool + 子会话），确保了系统的一致性和可维护性。
