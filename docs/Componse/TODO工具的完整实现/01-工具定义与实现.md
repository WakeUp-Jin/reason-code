# 01 - å·¥å…·å®šä¹‰ä¸å®ç°

> TODO å·¥å…·çš„å®Œæ•´ä»£ç å®ç°
>
> åŒ…å«ï¼šå·¥å…·å®šä¹‰ã€ä¸šåŠ¡é€»è¾‘ã€äº‹ä»¶æ€»çº¿ã€å­˜å‚¨å±‚

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [å·¥å…·å±‚å®ç°](#å·¥å…·å±‚å®ç°)
3. [ä¸šåŠ¡é€»è¾‘å±‚](#ä¸šåŠ¡é€»è¾‘å±‚)
4. [å­˜å‚¨å±‚å®ç°](#å­˜å‚¨å±‚å®ç°)
5. [äº‹ä»¶æ€»çº¿å±‚](#äº‹ä»¶æ€»çº¿å±‚)
6. [æ•°æ®æ¨¡å‹å®šä¹‰](#æ•°æ®æ¨¡å‹å®šä¹‰)

---

## ä¸€ã€æ¶æ„æ¦‚è§ˆ

### 1.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Tool å±‚ï¼ˆå·¥å…·å®šä¹‰ï¼‰                  â”‚
â”‚  TodoWriteTool | TodoReadTool           â”‚
â”‚  - å‚æ•°éªŒè¯                              â”‚
â”‚  - è°ƒç”¨ä¸šåŠ¡é€»è¾‘                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Business å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰              â”‚
â”‚  Todo.update() | Todo.get()             â”‚
â”‚  - æŒä¹…åŒ–æ•°æ®                            â”‚
â”‚  - å‘å¸ƒäº‹ä»¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Storage å±‚  â”‚  â”‚  Bus å±‚     â”‚
â”‚ - JSON å­˜å‚¨ â”‚  â”‚ - äº‹ä»¶å‘å¸ƒ  â”‚
â”‚ - æ–‡ä»¶é”    â”‚  â”‚ - äº‹ä»¶è®¢é˜…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ–‡ä»¶ä½ç½®

```
packages/opencode/src/
â”œâ”€â”€ tool/
â”‚   â”œâ”€â”€ todo.ts              # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ todowrite.txt        # TodoWrite æè¿°
â”‚   â””â”€â”€ todoread.txt         # TodoRead æè¿°
â”œâ”€â”€ session/
â”‚   â””â”€â”€ todo.ts              # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ storage/
â”‚   â””â”€â”€ storage.ts           # å­˜å‚¨å±‚
â””â”€â”€ bus/
    â”œâ”€â”€ index.ts             # äº‹ä»¶æ€»çº¿
    â””â”€â”€ bus-event.ts         # äº‹ä»¶å®šä¹‰è¾…åŠ©
```

---

## äºŒã€å·¥å…·å±‚å®ç°

### 2.1 TodoWriteTool å®Œæ•´ä»£ç 

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/tool/todo.ts:6-24`

```typescript
import z from "zod"
import { Tool } from "./tool"
import DESCRIPTION_WRITE from "./todowrite.txt"
import { Todo } from "../session/todo"

export const TodoWriteTool = Tool.define("todowrite", {
  // å·¥å…·æè¿°ï¼šä»å¤–éƒ¨æ–‡ä»¶å¯¼å…¥ï¼ˆ167 è¡Œçš„è¯¦ç»†è¯´æ˜ï¼‰
  description: DESCRIPTION_WRITE,

  // å‚æ•°å®šä¹‰ï¼šä½¿ç”¨ Zod éªŒè¯
  parameters: z.object({
    todos: z.array(z.object(Todo.Info.shape))
      .describe("The updated todo list"),
  }),

  // æ‰§è¡Œé€»è¾‘
  async execute(params, opts) {
    // 1. è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚ï¼ŒæŒä¹…åŒ–æ•°æ®å¹¶å‘å¸ƒäº‹ä»¶
    await Todo.update({
      sessionID: opts.sessionID,
      todos: params.todos,
    })

    // 2. è¿”å›ç»“æœï¼ˆä¼šæ˜¾ç¤ºåœ¨ UI ä¸­ï¼‰
    return {
      // æ ‡é¢˜ï¼šæ˜¾ç¤ºæœªå®Œæˆä»»åŠ¡æ•°é‡
      title: `${params.todos.filter((x) => x.status !== "completed").length} todos`,

      // è¾“å‡ºï¼šJSON æ ¼å¼çš„å®Œæ•´æ•°æ®ï¼ˆä¾› LLM æŸ¥çœ‹ï¼‰
      output: JSON.stringify(params.todos, null, 2),

      // å…ƒæ•°æ®ï¼šä¼ é€’ç»™ UI ç»„ä»¶æ¸²æŸ“
      metadata: {
        todos: params.todos,
      },
    }
  },
})
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

| éƒ¨åˆ† | ä½œç”¨ | è®¾è®¡æ€è·¯ |
|------|------|----------|
| `description` | å·¥å…·æè¿° | ä»å¤–éƒ¨æ–‡ä»¶å¯¼å…¥ï¼Œä¾¿äºç»´æŠ¤å’Œå›½é™…åŒ– |
| `parameters` | å‚æ•°éªŒè¯ | ä½¿ç”¨ Zod ç¡®ä¿ç±»å‹å®‰å…¨å’Œè¿è¡Œæ—¶éªŒè¯ |
| `title` | UI æ ‡é¢˜ | æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯ï¼ˆæœªå®Œæˆæ•°é‡ï¼‰ |
| `output` | LLM å¯è§ | JSON æ ¼å¼ï¼Œæ–¹ä¾¿ LLM è¯»å– |
| `metadata.todos` | UI æ•°æ® | ä¼ é€’ç»™ UI ç»„ä»¶è¿›è¡Œæ¸²æŸ“ |

### 2.2 TodoReadTool å®Œæ•´ä»£ç 

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/tool/todo.ts:26-39`

```typescript
export const TodoReadTool = Tool.define("todoread", {
  // ç®€çŸ­æè¿°ï¼šåªæœ‰ 15 è¡Œ
  description: "Use this tool to read your todo list",

  // å‚æ•°ï¼šç©ºå¯¹è±¡ï¼ˆä¸éœ€è¦ä»»ä½•å‚æ•°ï¼‰
  parameters: z.object({}),

  // æ‰§è¡Œé€»è¾‘
  async execute(_params, opts) {
    // ä»å­˜å‚¨ä¸­è¯»å–
    const todos = await Todo.get(opts.sessionID)

    // è¿”å›æ ¼å¼ä¸ TodoWriteTool ä¸€è‡´
    return {
      title: `${todos.filter((x) => x.status !== "completed").length} todos`,
      metadata: {
        todos,
      },
      output: JSON.stringify(todos, null, 2),
    }
  },
})
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **æ— å‚æ•°** | `z.object({})` - ä¸æ¥å—ä»»ä½•è¾“å…¥ |
| **åªè¯»æ“ä½œ** | åªè°ƒç”¨ `Todo.get()`ï¼Œä¸ä¿®æ”¹æ•°æ® |
| **UI éšè—** | å‰ç«¯ä¼šè¿‡æ»¤æ‰ `todoread` çš„æ˜¾ç¤º |
| **è¿”å›æ ¼å¼ä¸€è‡´** | ä¸ TodoWriteTool ä¿æŒç›¸åŒç»“æ„ |

---

## ä¸‰ã€ä¸šåŠ¡é€»è¾‘å±‚

### 3.1 å®Œæ•´ä»£ç 

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/session/todo.ts`

```typescript
import { BusEvent } from "@/bus/bus-event"
import { Bus } from "@/bus"
import z from "zod"
import { Storage } from "../storage/storage"

export namespace Todo {
  // ===== 1. æ•°æ®æ¨¡å‹å®šä¹‰ =====
  export const Info = z
    .object({
      content: z.string().describe("Brief description of the task"),
      status: z.string().describe("Current status of the task: pending, in_progress, completed, cancelled"),
      priority: z.string().describe("Priority level of the task: high, medium, low"),
      id: z.string().describe("Unique identifier for the todo item"),
    })
    .meta({ ref: "Todo" })

  export type Info = z.infer<typeof Info>

  // ===== 2. äº‹ä»¶å®šä¹‰ =====
  export const Event = {
    Updated: BusEvent.define(
      "todo.updated",
      z.object({
        sessionID: z.string(),
        todos: z.array(Info),
      }),
    ),
  }

  // ===== 3. ä¸šåŠ¡æ–¹æ³•ï¼šæ›´æ–° =====
  export async function update(input: { sessionID: string; todos: Info[] }) {
    // æ­¥éª¤ 1ï¼šæŒä¹…åŒ–åˆ°æ–‡ä»¶å­˜å‚¨
    await Storage.write(["todo", input.sessionID], input.todos)

    // æ­¥éª¤ 2ï¼šå‘å¸ƒäº‹ä»¶ï¼ˆé€šçŸ¥å‰ç«¯æ›´æ–°ï¼‰
    Bus.publish(Event.Updated, input)
  }

  // ===== 4. ä¸šåŠ¡æ–¹æ³•ï¼šè·å– =====
  export async function get(sessionID: string) {
    return Storage.read<Info[]>(["todo", sessionID])
      .then((x) => x || [])       // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºæ•°ç»„
      .catch(() => [])             // è¯»å–å¤±è´¥ï¼Œè¿”å›ç©ºæ•°ç»„
  }
}
```

### 3.2 è®¾è®¡åˆ†æ

#### 3.2.1 å‘½åç©ºé—´æ¨¡å¼

```typescript
export namespace Todo {
  export const Info = z.object({ ... })    // æ•°æ®æ¨¡å‹
  export const Event = { ... }             // äº‹ä»¶å®šä¹‰
  export function update() { ... }         // ä¸šåŠ¡æ–¹æ³•
  export function get() { ... }            // ä¸šåŠ¡æ–¹æ³•
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… é€»è¾‘èšåˆï¼šç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªå‘½åç©ºé—´
- âœ… ç±»å‹å®‰å…¨ï¼š`Todo.Info` æ—¢æ˜¯ç±»å‹åˆæ˜¯éªŒè¯å™¨
- âœ… æ˜“äºå¯¼å…¥ï¼š`import { Todo } from "./todo"`

#### 3.2.2 æ•°æ®æ¨¡å‹è®¾è®¡

```typescript
export const Info = z.object({
  content: z.string().describe("Brief description of the task"),
  status: z.string().describe("pending, in_progress, completed, cancelled"),
  priority: z.string().describe("high, medium, low"),
  id: z.string().describe("Unique identifier"),
})
```

**ä¸ºä»€ä¹ˆä¸ç”¨ enumï¼Ÿ**

```typescript
// æ²¡æœ‰ä½¿ç”¨ï¼š
status: z.enum(["pending", "in_progress", "completed", "cancelled"])

// è€Œæ˜¯ä½¿ç”¨ï¼š
status: z.string().describe("pending, in_progress, completed, cancelled")
```

**åŸå› **ï¼š
- LLM å¯èƒ½ç”Ÿæˆéæšä¸¾å€¼ï¼ˆå¦‚ "done", "finished"ï¼‰
- ä½¿ç”¨ `describe()` æä¾›æŒ‡å¯¼ï¼Œä½†ä¸å¼ºåˆ¶éªŒè¯
- æ›´å®½å®¹çš„è®¾è®¡ï¼Œå‡å°‘å·¥å…·è°ƒç”¨å¤±è´¥

#### 3.2.3 äº‹ä»¶é©±åŠ¨è®¾è®¡

```typescript
export async function update(input) {
  // 1. å…ˆæŒä¹…åŒ–ï¼ˆç¡®ä¿æ•°æ®å®‰å…¨ï¼‰
  await Storage.write(["todo", sessionID], todos)

  // 2. å†å‘å¸ƒäº‹ä»¶ï¼ˆé€šçŸ¥å‰ç«¯ï¼‰
  Bus.publish(Event.Updated, input)
}
```

**æ‰§è¡Œé¡ºåºçš„é‡è¦æ€§**ï¼š
1. âœ… **å…ˆå­˜å‚¨å†å‘å¸ƒ**ï¼šç¡®ä¿æ•°æ®å·²ä¿å­˜ï¼Œå³ä½¿äº‹ä»¶å¤±è´¥ä¹Ÿä¸ä¸¢å¤±
2. âŒ **å…ˆå‘å¸ƒå†å­˜å‚¨**ï¼šäº‹ä»¶å‘å‡ºä½†æ•°æ®æœªä¿å­˜ï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´

#### 3.2.4 å®¹é”™è®¾è®¡

```typescript
export async function get(sessionID: string) {
  return Storage.read<Info[]>(["todo", sessionID])
    .then((x) => x || [])       // æ–‡ä»¶å†…å®¹ä¸ºç©ºæ—¶ï¼Œè¿”å› []
    .catch(() => [])             // æ–‡ä»¶ä¸å­˜åœ¨æˆ–è¯»å–å¤±è´¥ï¼Œè¿”å› []
}
```

**è®¾è®¡æ€è·¯**ï¼š
- æ°¸è¿œä¸æŠ›å‡ºå¼‚å¸¸
- ç¡®ä¿è¿”å›å€¼ç±»å‹ä¸€è‡´ï¼ˆ`Todo[]`ï¼‰
- é¿å…è°ƒç”¨æ–¹éœ€è¦å¤„ç†å¼‚å¸¸

---

## å››ã€å­˜å‚¨å±‚å®ç°

### 4.1 æ ¸å¿ƒæ–¹æ³•

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/storage/storage.ts:168-197`

```typescript
export namespace Storage {
  // ===== è¯»å–æ•°æ® =====
  export async function read<T>(key: string[]) {
    const dir = await state().then((x) => x.dir)
    const target = path.join(dir, ...key) + ".json"

    return withErrorHandling(async () => {
      // ä½¿ç”¨è¯»é”ï¼Œé˜²æ­¢å¹¶å‘å†²çª
      using _ = await Lock.read(target)

      // è¯»å– JSON æ–‡ä»¶
      const result = await Bun.file(target).json()
      return result as T
    })
  }

  // ===== å†™å…¥æ•°æ® =====
  export async function write<T>(key: string[], content: T) {
    const dir = await state().then((x) => x.dir)
    const target = path.join(dir, ...key) + ".json"

    return withErrorHandling(async () => {
      // ä½¿ç”¨å†™é”ï¼Œé˜²æ­¢å¹¶å‘å†²çª
      using _ = await Lock.write(target)

      // å†™å…¥ JSON æ–‡ä»¶ï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•ï¼‰
      await Bun.write(target, JSON.stringify(content, null, 2))
    })
  }

  // ===== æ›´æ–°æ•°æ® =====
  export async function update<T>(key: string[], fn: (draft: T) => void) {
    const dir = await state().then((x) => x.dir)
    const target = path.join(dir, ...key) + ".json"

    return withErrorHandling(async () => {
      using _ = await Lock.write(target)

      // è¯»å–ç°æœ‰å†…å®¹
      const content = await Bun.file(target).json()

      // ä¿®æ”¹å†…å®¹
      fn(content)

      // å†™å›æ–‡ä»¶
      await Bun.write(target, JSON.stringify(content, null, 2))
      return content as T
    })
  }
}
```

### 4.2 å­˜å‚¨è·¯å¾„

```typescript
// è°ƒç”¨
Storage.write(["todo", sessionID], todos)

// å®é™…è·¯å¾„
~/.opencode/storage/todo/{sessionID}.json
```

**ç›®å½•ç»“æ„**ï¼š
```
~/.opencode/storage/
â”œâ”€â”€ todo/
â”‚   â”œâ”€â”€ session-abc123.json
â”‚   â”œâ”€â”€ session-def456.json
â”‚   â””â”€â”€ session-xyz789.json
â”œâ”€â”€ message/
â”œâ”€â”€ part/
â””â”€â”€ session/
```

### 4.3 é”æœºåˆ¶

```typescript
// ä½¿ç”¨ using å£°æ˜ï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰
using _ = await Lock.write(target)
```

**é”çš„ä½œç”¨**ï¼š
- é˜²æ­¢å¹¶å‘å†™å…¥å¯¼è‡´æ•°æ®æŸå
- è¯»é”ï¼šå…è®¸å¤šä¸ªè¯»å–ï¼Œé˜»æ­¢å†™å…¥
- å†™é”ï¼šç‹¬å è®¿é—®ï¼Œé˜»æ­¢è¯»å–å’Œå†™å…¥

**ä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ**

```
åœºæ™¯ï¼šåŒæ—¶ä¸¤ä¸ªå·¥å…·è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Call 1    â”‚    â”‚  Tool Call 2    â”‚
â”‚  è¯»å– todos     â”‚    â”‚  è¯»å– todos     â”‚
â”‚  [A, B]        â”‚    â”‚  [A, B]        â”‚
â”‚  æ·»åŠ  C        â”‚    â”‚  æ·»åŠ  D        â”‚
â”‚  å†™å…¥ [A,B,C]  â”‚    â”‚  å†™å…¥ [A,B,D]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                      â†“
    æœ€ç»ˆç»“æœï¼š[A, B, D]  â† ä¸¢å¤±äº† Cï¼
```

ä½¿ç”¨é”åï¼š
```
Tool Call 1 è·å–é” â†’ è¯»å– â†’ ä¿®æ”¹ â†’ å†™å…¥ â†’ é‡Šæ”¾é”
                                  â†“
                        Tool Call 2 ç­‰å¾… â†’ è·å–é” â†’ ...
```

---

## äº”ã€äº‹ä»¶æ€»çº¿å±‚

### 5.1 äº‹ä»¶å‘å¸ƒ

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/bus/index.ts:41-64`

```typescript
export namespace Bus {
  export async function publish<Definition extends BusEvent.Definition>(
    def: Definition,
    properties: z.output<Definition["properties"]>,
  ) {
    // æ„é€ äº‹ä»¶è½½è·
    const payload = {
      type: def.type,
      properties: def.properties.parse(properties),
    }

    // å‘å¸ƒåˆ°å…¨å±€äº‹ä»¶æ€»çº¿
    GlobalBus.emit("event", {
      directory: Global.Path.root,
      payload,
    })
  }
}
```

### 5.2 äº‹ä»¶è®¢é˜…

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/bus/index.ts:66-71`

```typescript
export function subscribe<Definition extends BusEvent.Definition>(
  def: Definition,
  callback: (event: {
    type: Definition["type"]
    properties: z.infer<Definition["properties"]>
  }) => void,
) {
  return raw(def.type, callback)
}
```

### 5.3 TUI è®¢é˜… TODO äº‹ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`packages/opencode/src/cli/cmd/tui/context/sync.tsx:135-137`

```typescript
// åœ¨ TUI å¯åŠ¨æ—¶è®¢é˜…äº‹ä»¶
case "todo.updated":
  // æ”¶åˆ°äº‹ä»¶åï¼Œæ›´æ–° SolidJS Store
  setStore("todo", event.properties.sessionID, event.properties.todos)
  break
```

### 5.4 äº‹ä»¶æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å·¥å…·æ‰§è¡Œ                                              â”‚
â”‚     TodoWriteTool.execute()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ä¸šåŠ¡é€»è¾‘                                              â”‚
â”‚     Todo.update()                                        â”‚
â”‚     - Storage.write()      // æŒä¹…åŒ–                     â”‚
â”‚     - Bus.publish()        // å‘å¸ƒäº‹ä»¶                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. äº‹ä»¶æ€»çº¿                                              â”‚
â”‚     GlobalBus.emit("event", { type: "todo.updated" })    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. TUI è®¢é˜…                                              â”‚
â”‚     case "todo.updated":                                 â”‚
â”‚       setStore("todo", sessionID, todos)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. UI é‡æ¸²æŸ“                                             â”‚
â”‚     SolidJS å“åº”å¼ç³»ç»Ÿè‡ªåŠ¨æ›´æ–°ç»„ä»¶                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€æ•°æ®æ¨¡å‹å®šä¹‰

### 6.1 Todo æ•°æ®ç»“æ„

```typescript
interface Todo {
  id: string           // å”¯ä¸€æ ‡è¯†ç¬¦
  content: string      // ä»»åŠ¡æè¿°
  status: string       // çŠ¶æ€ï¼špending | in_progress | completed | cancelled
  priority: string     // ä¼˜å…ˆçº§ï¼šhigh | medium | low
}
```

### 6.2 çŠ¶æ€æœº

```
pending (å¾…å¤„ç†)
    â†“
    â”‚ å¼€å§‹å·¥ä½œ
    â†“
in_progress (è¿›è¡Œä¸­)
    â†“
    â”‚ å®Œæˆ
    â†“
completed (å·²å®Œæˆ)

    æˆ–

pending â†’ cancelled (å–æ¶ˆ)
```

**çº¦æŸ**ï¼š
- åŒä¸€æ—¶é—´åªèƒ½æœ‰ **1 ä¸ª** `in_progress` çŠ¶æ€çš„ TODO
- å¿…é¡»å…ˆå®Œæˆå½“å‰ä»»åŠ¡ï¼Œå†å¼€å§‹ä¸‹ä¸€ä¸ª

### 6.3 æ•°æ®ç¤ºä¾‹

```json
[
  {
    "id": "task-1",
    "content": "è¯»å–ç°æœ‰è®¤è¯ä»£ç ",
    "status": "completed",
    "priority": "high"
  },
  {
    "id": "task-2",
    "content": "å®ç° JWT token ç”Ÿæˆ",
    "status": "in_progress",
    "priority": "high"
  },
  {
    "id": "task-3",
    "content": "æ·»åŠ ç™»å½•ç«¯ç‚¹æµ‹è¯•",
    "status": "pending",
    "priority": "medium"
  }
]
```

---

## ä¸ƒã€è°ƒç”¨ç¤ºä¾‹

### 7.1 LLM è°ƒç”¨ TodoWriteTool

```json
{
  "name": "todowrite",
  "input": {
    "todos": [
      {
        "id": "1",
        "content": "åˆ†æç°æœ‰ä»£ç ç»“æ„",
        "status": "completed",
        "priority": "high"
      },
      {
        "id": "2",
        "content": "è®¾è®¡æ–°åŠŸèƒ½æ¶æ„",
        "status": "in_progress",
        "priority": "high"
      },
      {
        "id": "3",
        "content": "å®ç°æ ¸å¿ƒåŠŸèƒ½",
        "status": "pending",
        "priority": "high"
      }
    ]
  }
}
```

### 7.2 å·¥å…·æ‰§è¡Œæµç¨‹

```typescript
// 1. å‚æ•°éªŒè¯
const validatedParams = parameters.parse(input)

// 2. è°ƒç”¨ä¸šåŠ¡é€»è¾‘
await Todo.update({
  sessionID: "session-abc123",
  todos: validatedParams.todos,
})

// 3. æŒä¹…åŒ–ï¼ˆåœ¨ Todo.update å†…éƒ¨ï¼‰
await Storage.write(
  ["todo", "session-abc123"],
  [
    { id: "1", content: "...", status: "completed", priority: "high" },
    { id: "2", content: "...", status: "in_progress", priority: "high" },
    { id: "3", content: "...", status: "pending", priority: "high" },
  ]
)

// 4. å‘å¸ƒäº‹ä»¶ï¼ˆåœ¨ Todo.update å†…éƒ¨ï¼‰
Bus.publish(Todo.Event.Updated, {
  sessionID: "session-abc123",
  todos: [...]
})

// 5. è¿”å›ç»“æœ
return {
  title: "2 todos",
  output: JSON.stringify([...], null, 2),
  metadata: { todos: [...] }
}
```

### 7.3 LLM è°ƒç”¨ TodoReadTool

```json
{
  "name": "todoread",
  "input": {}
}
```

**è¿”å›ç»“æœ**ï¼š

```json
{
  "title": "2 todos",
  "output": "[{\"id\":\"1\",\"content\":\"...\",\"status\":\"completed\",\"priority\":\"high\"}...]",
  "metadata": {
    "todos": [...]
  }
}
```

---

## å…«ã€æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 8.1 CQRSï¼ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰

```
Commandï¼ˆå†™ï¼‰          Queryï¼ˆè¯»ï¼‰
TodoWriteTool          TodoReadTool
    â†“                      â†“
Todo.update()          Todo.get()
    â†“                      â†“
ä¿®æ”¹çŠ¶æ€                åªè¯»çŠ¶æ€
å‘å¸ƒäº‹ä»¶                æ— å‰¯ä½œç”¨
```

### 8.2 äº‹ä»¶é©±åŠ¨æ¶æ„

```
å†™å…¥æ“ä½œ â†’ å‘å¸ƒäº‹ä»¶ â†’ è®¢é˜…è€…å“åº”
```

**ä¼˜åŠ¿**ï¼š
- è§£è€¦ï¼šå·¥å…·å±‚ä¸çŸ¥é“è°åœ¨ç›‘å¬
- å¯æ‰©å±•ï¼šå¯ä»¥æ·»åŠ æ›´å¤šè®¢é˜…è€…ï¼ˆæ—¥å¿—ã€åˆ†æç­‰ï¼‰
- å®æ—¶æ€§ï¼šäº‹ä»¶ç«‹å³è§¦å‘ï¼Œæ— éœ€è½®è¯¢

### 8.3 Repository æ¨¡å¼

```typescript
// Storage ä½œä¸ºæ•°æ®è®¿é—®å±‚
export namespace Storage {
  export function read<T>(key: string[]): Promise<T>
  export function write<T>(key: string[], content: T): Promise<void>
  export function update<T>(key: string[], fn: (draft: T) => void): Promise<T>
}
```

**ä¼˜åŠ¿**ï¼š
- æŠ½è±¡å­˜å‚¨å®ç°ï¼ˆå¯ä»¥ä» JSON åˆ‡æ¢åˆ°æ•°æ®åº“ï¼‰
- ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- ä¾¿äºæµ‹è¯•ï¼ˆå¯ä»¥ mock Storageï¼‰

---

## ä¹ã€æ€»ç»“

### 9.1 æ¶æ„äº®ç‚¹

| äº®ç‚¹ | å®ç° |
|------|------|
| **åˆ†å±‚æ¸…æ™°** | Tool â†’ Business â†’ Storage/Bus |
| **ç±»å‹å®‰å…¨** | å…¨ç¨‹ TypeScript + Zod éªŒè¯ |
| **äº‹ä»¶é©±åŠ¨** | å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œè§£è€¦å‰åç«¯ |
| **æ–‡ä»¶å­˜å‚¨** | JSON æ ¼å¼ï¼Œä¾¿äºè°ƒè¯•å’Œè¿ç§» |
| **å¹¶å‘å®‰å…¨** | æ–‡ä»¶é”æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®æŸå |
| **å®¹é”™è®¾è®¡** | æ°¸è¿œä¸æŠ›å¼‚å¸¸ï¼Œè¿”å›é»˜è®¤å€¼ |

### 9.2 ä»£ç è´¨é‡

- âœ… **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹
- âœ… **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- âœ… **ä¾èµ–å€’ç½®**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- âœ… **æ¥å£éš”ç¦»**ï¼šæœ€å°åŒ–æ¥å£ï¼Œåªæš´éœ²å¿…è¦æ–¹æ³•
- âœ… **é‡Œæ°æ›¿æ¢**ï¼šå­ç±»å‹å¯ä»¥æ›¿æ¢çˆ¶ç±»å‹

### 9.3 å¯æ‰©å±•æ€§

**å¯ä»¥è½»æ¾æ·»åŠ **ï¼š
- æ–°çš„äº‹ä»¶è®¢é˜…è€…ï¼ˆå¦‚æ—¥å¿—ã€åˆ†æï¼‰
- æ–°çš„å­˜å‚¨åç«¯ï¼ˆå¦‚ SQLiteã€PostgreSQLï¼‰
- æ–°çš„å·¥å…·ï¼ˆå¦‚ TodoDeleteã€TodoArchiveï¼‰
- æ–°çš„æ•°æ®å­—æ®µï¼ˆå¦‚ assigneeã€dueDateï¼‰

---

**è¿™æ˜¯ä¸€ä¸ªæ•™ç§‘ä¹¦çº§åˆ«çš„åˆ†å±‚æ¶æ„å®ç°ï¼** ğŸ‰
