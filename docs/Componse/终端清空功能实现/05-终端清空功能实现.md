# 终端清空功能实现

## 概述

在 CLI 应用启动时，我们需要清空终端屏幕，包括**滚动缓冲区**，以提供干净的界面体验。这是参考 Claude Code (Kode) 项目的实现方式。

## 核心代码

```typescript
// 清空终端（包括滚动缓冲区）
function clearTerminal(): Promise<void> {
  return new Promise((resolve) => {
    // \x1b[2J - 清空屏幕
    // \x1b[3J - 清空滚动缓冲区（这是关键！）
    // \x1b[H  - 移动光标到左上角
    process.stdout.write('\x1b[2J\x1b[3J\x1b[H', () => {
      resolve();
    });
  });
}

// 在 TUI 启动时调用
export async function startTUI(): Promise<void> {
  // 启动前清空终端（包括滚动缓冲区）
  await clearTerminal();

  return new Promise((resolve) => {
    const { waitUntilExit } = render(<Root />);
    waitUntilExit().then(resolve);
  });
}
```

## ANSI 转义序列详解

### 什么是 ANSI 转义序列？

ANSI 转义序列是一种控制终端行为的特殊字符序列。它们以 `ESC` 字符（`\x1b` 或 `\033`）开头，后跟特定的命令字符。

### 本功能使用的转义序列

| 序列      | 含义                  | 说明                       |
| --------- | --------------------- | -------------------------- |
| `\x1b[2J` | Erase in Display (ED) | 清空整个屏幕的可见内容     |
| `\x1b[3J` | Erase Saved Lines     | 清空滚动缓冲区（历史内容） |
| `\x1b[H`  | Cursor Position       | 将光标移动到左上角 (0,0)   |

### 序列格式解析

```
\x1b[2J
│  │││
│  ││└─ J = Erase in Display 命令
│  │└── 2 = 参数（0=光标到末尾, 1=开头到光标, 2=整个屏幕）
│  └─── [ = CSI (Control Sequence Introducer) 开始
└────── \x1b = ESC 字符（十六进制 1B，十进制 27）
```

### 为什么需要 `\x1b[3J`？

这是**关键的一步**！

- `\x1b[2J` 只清空当前屏幕的可见内容
- **但是**终端有一个"滚动缓冲区"，存储着之前滚动出去的内容
- 如果只用 `\x1b[2J`，用户仍然可以向上滚动看到之前的内容
- `\x1b[3J` 会清空这个滚动缓冲区，实现**真正的完全清空**

### 常见错误实现

❌ **错误方式**（不完整）：

```typescript
// 这样只清空屏幕，不清空滚动缓冲区
process.stdout.write('\x1b[2J');
process.stdout.write('\x1b[H');
```

✅ **正确方式**：

```typescript
// 清空屏幕 + 滚动缓冲区 + 移动光标
process.stdout.write('\x1b[2J\x1b[3J\x1b[H');
```

## 异步处理

### 为什么返回 Promise？

```typescript
function clearTerminal(): Promise<void> {
  return new Promise((resolve) => {
    process.stdout.write('\x1b[2J\x1b[3J\x1b[H', () => {
      resolve();
    });
  });
}
```

`process.stdout.write()` 的第二个参数是一个回调函数，在数据被写入后调用。通过 Promise 包装，我们可以确保：

1. **清空操作完成后**再继续执行后续代码
2. 使用 `await` 语法让代码更清晰
3. 避免在清空完成前就开始渲染 UI

## 其他相关的 ANSI 序列

### 常用的终端控制序列

| 序列        | 功能             |
| ----------- | ---------------- |
| `\x1b[?25h` | 显示光标         |
| `\x1b[?25l` | 隐藏光标         |
| `\x1b[?7l`  | 禁用自动换行     |
| `\x1b[?7h`  | 启用自动换行     |
| `\x1b[s`    | 保存光标位置     |
| `\x1b[u`    | 恢复光标位置     |
| `\x1b[K`    | 清除从光标到行尾 |
| `\x1b[1K`   | 清除从行首到光标 |
| `\x1b[2K`   | 清除整行         |

### Gemini CLI 的额外处理

Gemini CLI 在启动时还禁用了自动换行：

```typescript
// 禁用行换行，让 Ink 自己管理
process.stdout.write('\x1b[?7l');

// 退出时重新启用
registerCleanup(() => {
  process.stdout.write('\x1b[?7h');
});
```

这可以减少终端调整大小时的渲染问题。

## 参考资料

- [ANSI Escape Codes](https://en.wikipedia.org/wiki/ANSI_escape_code)
- [XTerm Control Sequences](https://invisible-island.net/xterm/ctlseqs/ctlseqs.html)
- Claude Code 源码: `src/utils/terminal.ts`
- Gemini CLI 源码: `src/gemini.tsx`, `src/ui/AppContainer.tsx`

## 文件位置

本功能实现在：`packages/cli/src/app.tsx`
