# 命令系统实现计划

## 目标

实现统一的命令交互系统，参考 Claude Code 的交互模式：

1. **命令补全**：输入 `/` 时，在输入框下方显示命令列表（模糊搜索）
2. **功能面板**：输入完整命令（如 `/model`）并回车后，显示功能选择面板

## 用户确认的设计决策

- ✅ 命令补全面板：输入框正下方（内联显示）
- ✅ 功能面板：替换输入框位置显示（输入框隐藏，底部显示执行的命令）
- ✅ 删除所有未使用的 Dialog 组件
- ✅ 移除快捷键（Ctrl+P, Ctrl+M 等），统一使用命令

## 核心交互流程

### 1. 命令补全模式

```
用户输入 "/"
    ↓
┌─────────────────────────────────────┐
│ Input: /                            │
├─────────────────────────────────────┤  ← 补全面板（内联显示）
│ ❯ /model - Select AI Model         │
│   /session - Session List           │
│   /theme - Select Theme             │
│   /new - New Session                │
│   /clear - Clear Screen             │
└─────────────────────────────────────┘

- 支持模糊搜索（输入 /m 显示匹配的命令）
- 上下键导航
- Tab/Enter 补全命令
- Esc 取消
```

### 2. 功能面板模式

```
用户输入 "/model" 并回车
    ↓
┌─────────────────────────────────────┐
│ Messages (history)                  │
│ User: Hello                         │
│ AI: Hi!                            │
├─────────────────────────────────────┤
│ Select Model                        │  ← 功能面板区域
│ ❯ Claude Sonnet 4                  │
│   GPT-4o                           │
│   Gemini Pro                       │
├─────────────────────────────────────┤
│ > /model                           │  ← 底部显示执行的命令
└─────────────────────────────────────┘

- 输入框隐藏
- 功能面板占据输入框位置
- 底部显示当前执行的命令
- Enter 确认选择，Esc 返回输入模式
```

## 实现阶段

### Phase 1: 基础架构（MVP）

#### 1.1 创建命令注册系统

**新建文件：** `packages/cli/src/component/command/command-registry.ts`

```typescript
export interface CommandDef {
  id: string;
  name: string; // 命令名（不含 /）
  label: string;
  description: string;
  category: string;

  // 命令类型
  type: 'instant' | 'panel';

  // Instant 命令的处理函数
  action?: () => void;

  // Panel 命令的面板组件
  panel?: ReactNode;
}

class CommandRegistry {
  private commands: Map<string, CommandDef> = new Map();

  register(command: CommandDef): void;
  get(name: string): CommandDef | undefined;
  search(query: string): CommandDef[];
  execute(name: string): void;
}

export const commandRegistry = new CommandRegistry();
```

#### 1.2 创建命令补全组件

**新建文件：** `packages/cli/src/component/command/command-complete.tsx`

```typescript
export interface CommandCompleteProps {
  query: string;
  commands: CommandDef[];
  selectedIndex: number;
  onSelect: (command: CommandDef) => void;
  onCancel: () => void;
}

// 在输入框正下方显示命令列表
// 支持上下键导航、Tab/Enter 补全
```

#### 1.3 创建功能面板容器

**新建文件：** `packages/cli/src/component/command/command-panel.tsx`

```typescript
export interface CommandPanelProps {
  command: string; // 执行的命令（如 "model"）
  panel: ReactNode; // 功能面板组件
  onClose: () => void;
}

// 显示功能面板，底部显示命令提示
// 处理 Esc 关闭
```

#### 1.4 定义核心命令

**新建文件：** `packages/cli/src/component/command/commands.tsx`

```typescript
import { DialogModel } from '../dialog-model.js';
import { DialogSessionList } from '../dialog-session-list.js';
// ... 其他导入

export function registerCommands() {
  // Panel 命令
  commandRegistry.register({
    id: 'model',
    name: 'model',
    label: 'Select Model',
    description: 'Change AI model',
    category: 'Model',
    type: 'panel',
    panel: <DialogModel />,
  });

  commandRegistry.register({
    id: 'session',
    name: 'session',
    label: 'Session List',
    description: 'View and switch sessions',
    category: 'Session',
    type: 'panel',
    panel: <DialogSessionList />,
  });

  // Instant 命令
  commandRegistry.register({
    id: 'new',
    name: 'new',
    label: 'New Session',
    description: 'Create a new chat session',
    category: 'Session',
    type: 'instant',
    action: () => { /* ... */ },
  });

  commandRegistry.register({
    id: 'clear',
    name: 'clear',
    label: 'Clear Screen',
    description: 'Clear terminal screen',
    category: 'System',
    type: 'instant',
    action: () => { /* ... */ },
  });
}
```

#### 1.5 修改 Prompt 组件

**修改文件：** `packages/cli/src/component/prompt/index.tsx`

关键改动：

1. **添加命令检测**（第 37 行附近）

```typescript
const isCommand = value.startsWith('/');
const commandQuery = isCommand ? value.slice(1) : '';
```

2. **添加状态管理**

```typescript
const [commandMode, setCommandMode] = useState<'autocomplete' | null>(null);
const [filteredCommands, setFilteredCommands] = useState<CommandDef[]>([]);
const [selectedCommandIndex, setSelectedCommandIndex] = useState(0);
```

3. **实时更新命令补全**

```typescript
useEffect(() => {
  if (isCommand) {
    setCommandMode('autocomplete');
    const commands = commandRegistry.search(commandQuery);
    setFilteredCommands(commands);
  } else {
    setCommandMode(null);
  }
}, [isCommand, commandQuery]);
```

4. **修改键盘处理**（第 58-96 行）

```typescript
useInput((input, key) => {
  // 命令补全模式下的特殊处理
  if (commandMode === 'autocomplete') {
    if (key.upArrow || key.downArrow) {
      // 导航命令列表（不触发历史记录）
      return;
    }
    if (key.tab) {
      // Tab 补全命令到输入框
      return;
    }
  }

  // 原有逻辑（历史记录等）
});
```

5. **修改提交逻辑**（第 47-55 行）

```typescript
const handleSubmit = () => {
  const trimmedValue = value.trim();

  // 检查是否是命令
  if (trimmedValue.startsWith('/')) {
    const commandName = trimmedValue.slice(1).split(' ')[0];
    onCommandExecute?.(commandName); // 新增回调
    setValue('');
    return;
  }

  // 普通消息
  onSubmit(trimmedValue);
  setValue('');
};
```

6. **渲染命令补全**（第 106 行后）

```typescript
return (
  <Box flexDirection="column">
    {/* 原有的输入框 */}
    <Box>...</Box>

    {/* 命令补全面板 */}
    {commandMode === 'autocomplete' && filteredCommands.length > 0 && (
      <CommandComplete
        query={commandQuery}
        commands={filteredCommands}
        selectedIndex={selectedCommandIndex}
        onSelect={(cmd) => {
          setValue(`/${cmd.name} `);
        }}
        onCancel={() => {
          setValue('');
          setCommandMode(null);
        }}
      />
    )}
  </Box>
);
```

#### 1.6 修改 InputArea 组件

**修改文件：** `packages/cli/src/routes/session/inputArea.tsx`

关键改动：

1. **添加命令面板状态**

```typescript
const [commandPanelState, setCommandPanelState] = useState<{
  command: string;
  panel: ReactNode;
} | null>(null);
```

2. **处理命令执行**

```typescript
const handleCommandExecute = (commandName: string) => {
  const command = commandRegistry.get(commandName);
  if (!command) return;

  if (command.type === 'instant') {
    command.action?.();
  } else if (command.type === 'panel') {
    setCommandPanelState({
      command: commandName,
      panel: command.panel,
    });
  }
};
```

3. **条件渲染**

```typescript
return (
  <Box flexDirection="column" flexShrink={0}>
    {commandPanelState ? (
      // 功能面板模式
      <CommandPanel
        command={commandPanelState.command}
        panel={commandPanelState.panel}
        onClose={() => setCommandPanelState(null)}
      />
    ) : (
      // 正常输入模式
      <Prompt
        onSubmit={handleSubmit}
        onCommandExecute={handleCommandExecute}
        placeholder="Type your message..."
      />
    )}
  </Box>
);
```

#### 1.7 修改 Session 布局

**修改文件：** `packages/cli/src/routes/session/index.tsx`

- 确保 InputArea 可以动态切换显示模式
- 调整布局使功能面板能正确显示

### Phase 2: 功能完善

#### 2.1 实现模糊搜索

- 使用 `fuzzysort` 库进行命令搜索
- 支持按 label、description、category 搜索
- 高亮匹配文本

#### 2.2 完善命令补全面板

- 添加分类显示（Session、Model、System 等）
- 显示快捷键提示（底部 hints）
- 添加滚动支持（超过可见高度时）
- 视觉优化（颜色、图标等）

#### 2.3 完善功能面板

- 调整 DialogModel、DialogSessionList 等组件
- 移除 DialogOverlay（不再需要覆盖层）
- 适配新的布局模式

#### 2.4 添加更多命令

```typescript
// 新增命令
/help     - 显示帮助信息
/history  - 显示历史记录
/theme    - 选择主题
/export   - 导出对话
/rename   - 重命名会话
```

### Phase 3: 清理和优化

#### 3.1 删除未使用组件

删除以下文件：

- ❌ `packages/cli/src/component/dialog-command.tsx`
- ❌ `packages/cli/src/component/dialog-message.tsx`
- ❌ `packages/cli/src/ui/dialog-prompt.tsx`
- ❌ `packages/cli/src/ui/dialog-confirm.tsx`

保留以下组件（复用）：

- ✅ `packages/cli/src/ui/dialog.tsx` - 基础 Dialog 组件
- ✅ `packages/cli/src/ui/dialog-select.tsx` - 选择组件
- ✅ `packages/cli/src/component/dialog-model.tsx` - 模型选择
- ✅ `packages/cli/src/component/dialog-session-list.tsx` - 会话列表
- ✅ `packages/cli/src/component/dialog-theme.tsx` - 主题选择

#### 3.2 移除快捷键

**修改文件：**

- 移除 Ctrl+P、Ctrl+M 等全局快捷键监听
- 更新 Footer 提示文本（移除快捷键提示）
- 更新 dialog-command.tsx 中的快捷键定义

#### 3.3 优化性能

- 命令搜索防抖
- 使用 useMemo 缓存过滤结果
- 避免不必要的重渲染

#### 3.4 添加命令历史

- 记录命令执行历史
- 支持上下键回溯命令历史（在命令模式下）

## 关键文件清单

### 新建文件

```
packages/cli/src/component/command/
├── command-registry.ts        # 命令注册表（核心）
├── command-complete.tsx       # 命令补全组件
├── command-panel.tsx          # 功能面板容器
├── commands.tsx               # 命令定义
└── index.ts                   # 导出
```

### 修改文件

1. **`packages/cli/src/component/prompt/index.tsx`**

   - 添加命令检测和补全逻辑
   - 修改键盘处理和提交逻辑
   - 渲染命令补全面板

2. **`packages/cli/src/routes/session/inputArea.tsx`**

   - 添加命令面板状态管理
   - 条件渲染（输入框 vs 功能面板）
   - 处理命令执行回调

3. **`packages/cli/src/routes/session/index.tsx`**

   - 调整布局以支持功能面板模式

4. **`packages/cli/src/app.tsx`**

   - 应用启动时注册所有命令

5. **`packages/cli/src/component/dialog-model.tsx`** 等
   - 适配新的布局模式（移除 DialogOverlay）

### 删除文件

- `packages/cli/src/component/dialog-command.tsx`
- `packages/cli/src/component/dialog-message.tsx`
- `packages/cli/src/ui/dialog-prompt.tsx`
- `packages/cli/src/ui/dialog-confirm.tsx`

## 数据流图

```
User Input: "/model"
    ↓
Prompt Component
    ↓
isCommand? → Yes
    ↓
commandQuery = "model"
    ↓
CommandRegistry.search("model")
    ↓
[显示命令补全]
    ↓
User presses Enter
    ↓
onCommandExecute("model")
    ↓
InputArea.handleCommandExecute
    ↓
commandRegistry.get("model")
    ↓
command.type === 'panel'
    ↓
setCommandPanelState({
  command: "model",
  panel: <DialogModel />
})
    ↓
[隐藏输入框，显示功能面板]
    ↓
User selects model
    ↓
DialogModel.onSelect
    ↓
setCommandPanelState(null)
    ↓
[恢复输入框]
```

## 测试计划

### 手动测试

1. **命令补全**

   - 输入 `/` 显示所有命令
   - 输入 `/m` 显示匹配的命令
   - 上下键导航
   - Tab 补全
   - Esc 取消

2. **功能面板**

   - `/model` 显示模型选择
   - `/session` 显示会话列表
   - Enter 确认选择
   - Esc 返回输入模式

3. **即时命令**

   - `/new` 创建新会话
   - `/clear` 清空屏幕

4. **边界情况**
   - 输入不存在的命令
   - 命令列表为空
   - 面板打开时的状态切换

## 成功标准

- ✅ 输入 `/` 时显示命令补全面板
- ✅ 支持模糊搜索和键盘导航
- ✅ 执行命令后正确显示功能面板
- ✅ 功能面板底部显示执行的命令
- ✅ Esc 能正确返回输入模式
- ✅ 所有未使用的 Dialog 组件已删除
- ✅ 快捷键已移除
- ✅ 性能良好，无明显卡顿

## 风险和注意事项

1. **布局复杂度**：功能面板模式需要完全隐藏输入框，确保布局切换流畅
2. **组件复用**：现有 DialogModel 等组件需要适配新布局（移除 DialogOverlay）
3. **状态管理**：命令面板状态和输入框状态需要正确切换
4. **性能**：命令搜索和补全需要优化，避免输入卡顿

## 实现顺序

1. ✅ Phase 1.1-1.4: 创建基础架构（命令注册、补全组件、命令定义）
2. ✅ Phase 1.5: 修改 Prompt 组件（命令检测和补全）
3. ✅ Phase 1.6-1.7: 修改 InputArea 和 Session（功能面板模式）
4. ✅ Phase 2.1-2.3: 完善补全和面板功能
5. ✅ Phase 3.1-3.2: 清理未使用组件和快捷键
6. ✅ Phase 3.3-3.4: 优化性能和用户体验
