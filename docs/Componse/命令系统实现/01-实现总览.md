# 命令系统实现总览

## 项目背景

原有的交互方式基于快捷键（Ctrl+P、Ctrl+M 等）和 Dialog 覆盖层，存在以下问题：
- 快捷键不够直观，用户需要记忆
- Dialog 覆盖层遮挡内容
- 多个 Dialog 组件未被使用，代码冗余

## 设计目标

参考 Claude Code 的命令交互模式，实现统一的命令系统：

1. **命令补全模式**：输入 `/` 时，在输入框下方显示命令列表
2. **功能面板模式**：执行命令后，功能面板替换输入框位置显示
3. **统一交互**：所有功能通过命令触发，移除快捷键

## 核心特性

### 1. 命令补全
- 输入 `/` 触发命令补全面板
- 支持模糊搜索（fuzzysort）
- 按分类显示命令
- 键盘导航（上下键、Tab、Enter、Esc）

### 2. 功能面板
- 执行命令后替换输入框位置
- 底部显示当前执行的命令
- Esc 返回输入模式
- 自动监听 Dialog 关闭事件

### 3. 命令类型
- **Instant 命令**：立即执行（如 `/clear`、`/new`）
- **Panel 命令**：显示选择面板（如 `/model`、`/session`）

## 实现阶段

### ✅ Phase 1: MVP 核心架构
- 命令注册系统
- 命令补全组件
- 功能面板容器
- 核心命令定义
- Prompt 和 InputArea 适配

### ✅ Phase 2: 功能完善
- 模糊搜索和高亮匹配
- 命令补全面板优化（分类、滚动）
- Dialog 组件适配
- 添加更多命令（/rename、/help）

### ✅ Phase 3: 清理和优化
- 删除未使用的 Dialog 组件
- 移除快捷键相关代码
- 更新文档和提示文本

## 技术栈

- **React + Ink**：终端 UI 框架
- **fuzzysort**：模糊搜索库
- **TypeScript**：类型安全
- **Zustand**：状态管理

## 已实现命令列表

| 命令 | 类型 | 分类 | 描述 |
|------|------|------|------|
| `/model` | Panel | Model | 选择 AI 模型 |
| `/session` | Panel | Session | 查看和切换会话 |
| `/new` | Instant | Session | 创建新会话 |
| `/rename` | Panel | Session | 重命名当前会话 |
| `/theme` | Panel | Appearance | 选择主题 |
| `/clear` | Instant | System | 清空终端 |
| `/help` | Panel | System | 显示所有命令 |

## 文件结构

```
packages/cli/src/
├── component/
│   ├── command/
│   │   ├── command-registry.ts      # 命令注册表
│   │   ├── command-complete.tsx     # 命令补全组件
│   │   ├── command-panel.tsx        # 功能面板容器
│   │   ├── commands.tsx             # 命令定义
│   │   └── index.ts                 # 导出
│   ├── dialog-model.tsx             # 模型选择（复用）
│   ├── dialog-session-list.tsx      # 会话列表（复用）
│   ├── dialog-session-rename.tsx    # 会话重命名（复用）
│   ├── dialog-theme.tsx             # 主题选择（复用）
│   ├── dialog-help.tsx              # 帮助信息（新增）
│   └── prompt/
│       └── index.tsx                # 输入框（已修改）
└── routes/
    └── session/
        ├── inputArea.tsx            # 输入区域（已修改）
        └── index.tsx                # 会话页面
```

## 实现亮点

### 1. 命令注册系统
- 使用单例模式，全局唯一的命令注册表
- 支持模糊搜索和按分类查询
- 类型安全的命令定义

### 2. 智能面板关闭
- CommandPanel 监听 `useDialog().isOpen` 状态
- 当内部 Dialog 调用 `pop()` 后，自动关闭 CommandPanel
- 无需修改现有 Dialog 组件

### 3. 命令补全交互
- 命令模式和历史记录模式分离
- Tab 键补全命令名称
- 上下键导航不触发历史记录

### 4. 灵活的命令系统
- 支持两种命令类型（Instant / Panel）
- 易于扩展新命令
- 统一的交互模式

## 遇到的问题和解决方案

### 问题 1: Dialog 组件关闭后如何通知 CommandPanel

**问题描述**：
现有 Dialog 组件（DialogModel、DialogSessionList 等）通过 `useDialog().pop()` 关闭自己，但这不会关闭外层的 CommandPanel。

**解决方案**：
在 CommandPanel 中监听 `useDialog().isOpen` 状态：
```typescript
const { isOpen } = useDialog();

useEffect(() => {
  if (!isOpen) {
    // Dialog stack 为空，关闭 CommandPanel
    onClose();
  }
}, [isOpen, onClose]);
```

### 问题 2: Instant 命令无法访问 React Hooks

**问题描述**：
命令在应用启动时注册，在 React 组件树之外，无法直接使用 `useRoute` 等 Hooks。

**解决方案**：
- 使用 Zustand 的 `getState()` 方法访问 store
- 路由访问留作 TODO，待后续改进命令系统架构

### 问题 3: 命令补全和历史记录的键盘冲突

**问题描述**：
输入框的上下键用于历史记录导航，但命令补全也需要上下键导航。

**解决方案**：
在 `useInput` 中添加条件判断：
```typescript
if (commandMode === 'autocomplete' && filteredCommands.length > 0) {
  if (key.upArrow) {
    // 导航命令列表
    setSelectedCommandIndex(...);
    return; // 不触发历史记录
  }
}
// 历史记录导航逻辑
```

## 性能优化

1. **useMemo 缓存搜索结果**
   ```typescript
   const filteredCommands = useMemo(
     () => commandRegistry.search(commandQuery),
     [isCommand, commandQuery]
   );
   ```

2. **条件渲染**
   - 只在命令模式下渲染 CommandComplete
   - 只在功能面板模式下渲染 CommandPanel

3. **模糊搜索优化**
   - 使用 fuzzysort 库，性能优异
   - 空查询直接返回所有命令

## 后续扩展建议

### 短期
1. 添加 `/history` 命令 - 显示消息历史
2. 添加 `/export` 命令 - 导出对话
3. 命令历史记录 - 记录执行过的命令

### 中期
1. 命令别名 - 支持命令简写（如 `/m` → `/model`）
2. 命令参数 - 支持命令携带参数（如 `/new "New Session"`）
3. 自定义命令 - 允许用户注册自定义命令

### 长期
1. 命令脚本 - 支持批量执行命令
2. 命令插件系统 - 通过插件扩展命令
3. 命令快捷键绑定 - 允许用户自定义快捷键

## 总结

命令系统的实现成功替代了原有的快捷键交互方式，提供了更直观、统一的用户体验。通过模块化的架构设计，系统易于扩展和维护。核心技术亮点包括：

- ✅ 统一的命令注册和执行机制
- ✅ 智能的面板关闭逻辑
- ✅ 良好的键盘交互体验
- ✅ 类型安全的命令定义
- ✅ 易于扩展的架构设计

整个实现过程遵循了渐进式开发原则，从 MVP 到功能完善再到优化清理，确保了代码质量和系统稳定性。
