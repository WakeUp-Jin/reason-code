# 使用指南

## 用户使用指南

### 基本操作

#### 1. 触发命令补全

在输入框中输入 `/`，即可触发命令补全：

```
输入框: /
    ↓
显示所有可用命令
```

#### 2. 搜索命令

继续输入关键词，进行模糊搜索：

```
输入框: /m
    ↓
显示匹配 "m" 的命令：
- /model - Select Model
- /theme - Select Theme (匹配 theme)
```

搜索范围包括：
- 命令名称（name）
- 显示标签（label）
- 描述文本（description）
- 分类名称（category）

#### 3. 导航命令列表

| 操作 | 快捷键 |
|------|--------|
| 向上选择 | ↑ 上箭头 |
| 向下选择 | ↓ 下箭头 |
| 补全命令 | Tab |
| 执行命令 | Enter |
| 取消 | Esc |

#### 4. 执行命令

- **Instant 命令**：按 Enter 立即执行
  - 例如：`/clear` - 清空终端
  - 例如：`/new` - 创建新会话

- **Panel 命令**：按 Enter 显示功能面板
  - 例如：`/model` - 显示模型选择面板
  - 例如：`/session` - 显示会话列表

#### 5. 功能面板操作

在功能面板中：
- 使用面板提供的交互方式（通常是上下键选择，Enter 确认）
- 按 Esc 返回输入模式

### 可用命令列表

#### Model 相关

- `/model` - 选择 AI 模型
  - 显示所有可用的 AI 模型
  - 支持搜索和选择
  - 立即切换模型

#### Session 相关

- `/session` - 查看会话列表
  - 显示所有会话
  - 支持搜索和切换
  - 显示会话统计信息

- `/new` - 创建新会话
  - 立即创建新会话
  - 自动切换到新会话

- `/rename` - 重命名当前会话
  - 显示输入框
  - 输入新名称
  - 支持验证（不能为空，最大 100 字符）

#### Appearance 相关

- `/theme` - 选择主题
  - 显示所有可用主题
  - 实时预览
  - 立即切换主题

#### System 相关

- `/clear` - 清空终端
  - 清空屏幕内容
  - 清空滚动缓冲区
  - 立即执行

- `/help` - 显示帮助
  - 列出所有命令
  - 按分类显示
  - 包含描述信息

### 使用技巧

#### 快速访问常用命令

1. 输入 `/` + 命令首字母
2. Tab 快速补全
3. Enter 执行

例如：
```
/m → Tab → /model → Enter
```

#### 模糊搜索技巧

- 输入部分字母即可匹配
- 不需要连续的字母
- 例如：`/ses` 可以匹配 `/session`

#### 命令面板快速关闭

- 在任何面板中按 Esc 立即返回
- 选择选项后自动关闭面板

## 开发者指南

### 添加新命令

#### 1. Instant 命令示例

在 `packages/cli/src/component/command/commands.tsx` 中添加：

```typescript
commandRegistry.register({
  id: 'example',
  name: 'example',
  label: 'Example Command',
  description: 'This is an example command',
  category: 'System',
  type: 'instant',
  action: () => {
    // 执行逻辑
    console.log('Example command executed!');

    // 访问 Zustand store
    const { someAction } = useAppStore.getState();
    someAction();
  },
});
```

#### 2. Panel 命令示例

首先创建面板组件：

```typescript
// packages/cli/src/component/dialog-example.tsx
import React from 'react';
import { Dialog } from '../ui/dialog.js';
import { DialogSelect } from '../ui/dialog-select.js';
import { useDialog } from '../context/dialog.js';

export function DialogExample() {
  const { pop } = useDialog();

  const options = [
    { value: 'option1', label: 'Option 1', description: 'First option' },
    { value: 'option2', label: 'Option 2', description: 'Second option' },
  ];

  const handleSelect = (value: string) => {
    console.log('Selected:', value);
    pop(); // 关闭 Dialog
  };

  return (
    <DialogSelect
      title="Example Dialog"
      options={options}
      onSelect={handleSelect}
      onCancel={pop}
    />
  );
}
```

然后注册命令：

```typescript
// packages/cli/src/component/command/commands.tsx
import { DialogExample } from '../dialog-example.js';

commandRegistry.register({
  id: 'example',
  name: 'example',
  label: 'Example Command',
  description: 'Show example dialog',
  category: 'System',
  type: 'panel',
  panel: <DialogExample />,
});
```

### 创建自定义面板

#### 使用 DialogSelect

最常用的面板类型，用于选择列表：

```typescript
import { DialogSelect } from '../ui/dialog-select.js';

interface Option {
  value: string;
  label: string;
  description?: string;
  badge?: string;
  badgeColor?: string;
  disabled?: boolean;
}

<DialogSelect
  title="Select an option"
  options={options}
  onSelect={(value) => {
    // 处理选择
  }}
  onCancel={() => {
    // 处理取消
  }}
  searchPlaceholder="Search options..."  // 可选
/>
```

#### 使用 DialogPrompt

用于输入文本：

```typescript
import { DialogPrompt } from '../ui/dialog-prompt.js';

<DialogPrompt
  title="Enter name"
  message="Please enter a new name"
  placeholder="Type here..."
  defaultValue=""
  onSubmit={(value) => {
    // 处理提交
  }}
  onCancel={() => {
    // 处理取消
  }}
  validate={(value) => {
    // 验证输入
    if (!value.trim()) {
      return 'Name cannot be empty';
    }
    return null; // 验证通过
  }}
/>
```

#### 使用基础 Dialog

用于自定义布局：

```typescript
import { Dialog } from '../ui/dialog.js';
import { Box, Text } from 'ink';

<Dialog title="Custom Dialog">
  <Box flexDirection="column">
    <Text>Custom content here</Text>
    {/* 自定义交互组件 */}
  </Box>
</Dialog>
```

### 命令分类指南

建议使用以下分类：

- **Model** - AI 模型相关
- **Session** - 会话管理
- **Appearance** - 外观和主题
- **System** - 系统功能
- **Advanced** - 高级功能
- **Plugin** - 插件命令

### 命令命名规范

1. **使用小写字母**
   - ✅ `model`, `session`, `clear`
   - ❌ `Model`, `SESSION`, `Clear`

2. **简短且描述性**
   - ✅ `new`, `rename`, `export`
   - ❌ `create-new-session`, `rename-current-session`

3. **避免特殊字符**
   - ✅ `model`, `session-list`
   - ❌ `model!`, `session_list`

4. **使用动词或名词**
   - 动词：`clear`, `export`, `rename`
   - 名词：`model`, `session`, `theme`

### 访问应用状态

#### 在 Instant 命令中

使用 `getState()` 访问 Zustand store：

```typescript
action: () => {
  const { createSession, currentSessionId } = useAppStore.getState();
  const session = createSession();
  console.log('Created session:', session.id);
}
```

#### 在 Panel 组件中

直接使用 React Hooks：

```typescript
export function DialogExample() {
  const currentSession = useAppStore((state) => state.currentSessionId);
  const { createSession } = useAppStore();

  // 使用状态和方法
}
```

### 错误处理

#### 命令执行错误

```typescript
action: () => {
  try {
    // 执行逻辑
    const result = doSomething();

    if (!result) {
      console.warn('Command failed: no result');
      return;
    }
  } catch (error) {
    console.error('Command error:', error);
  }
}
```

#### 面板交互错误

```typescript
const handleSelect = (value: string) => {
  try {
    // 处理选择
    processSelection(value);
    pop(); // 只有成功才关闭
  } catch (error) {
    console.error('Selection error:', error);
    // 不关闭面板，让用户重试
  }
};
```

### 测试命令

#### 手动测试清单

- [ ] 命令补全是否正确显示
- [ ] 搜索是否正常工作
- [ ] 键盘导航是否流畅
- [ ] 命令执行是否符合预期
- [ ] 错误情况是否有适当处理
- [ ] 面板关闭是否正常

#### 测试示例

```typescript
// 1. 注册测试命令
commandRegistry.register({
  id: 'test',
  name: 'test',
  label: 'Test Command',
  description: 'Test command execution',
  category: 'System',
  type: 'instant',
  action: () => {
    console.log('Test command works!');
  },
});

// 2. 测试执行
const result = commandRegistry.execute('test');
console.log('Execute result:', result); // should be true

// 3. 测试搜索
const results = commandRegistry.search('test');
console.log('Search results:', results); // should include test command
```

### 性能优化建议

#### 1. 避免在 action 中执行耗时操作

```typescript
// ❌ 不推荐
action: () => {
  // 耗时操作
  const largeData = processLargeDataset();
}

// ✅ 推荐
action: async () => {
  console.log('Starting...');
  setTimeout(() => {
    processLargeDataset();
  }, 0);
}
```

#### 2. 面板组件使用 useMemo

```typescript
export function DialogExample() {
  const options = useMemo(() => {
    return generateOptions(); // 计算密集的操作
  }, [dependencies]);

  // ...
}
```

#### 3. 避免重复注册

确保命令只注册一次：

```typescript
// app.tsx
const commandsRegistered = useRef(false);

useEffect(() => {
  if (!commandsRegistered.current) {
    commandsRegistered.current = true;
    registerCommands();
  }
}, []);
```

## 常见问题

### Q: 如何在命令中访问路由？

A: 目前 Instant 命令无法直接访问 React Hooks。解决方案：
1. 使用 Panel 命令，在组件中使用 `useRoute()`
2. 等待命令系统架构改进（计划中）

### Q: 命令面板关闭后如何清理状态？

A: 在面板组件中使用 `useEffect` cleanup：

```typescript
useEffect(() => {
  // 初始化
  return () => {
    // 清理逻辑
  };
}, []);
```

### Q: 如何禁用某个命令？

A: 命令注册表目前不支持禁用。可以：
1. 不注册该命令
2. 在 `action` 中添加条件判断

```typescript
action: () => {
  if (someCondition) {
    console.log('Command is disabled');
    return;
  }
  // 执行逻辑
}
```

### Q: 如何添加命令快捷键？

A: 当前版本专注于命令模式，不支持快捷键。如需快捷键，可以：
1. 在命令描述中说明建议的快捷键
2. 在 Session 组件中添加全局键盘监听

### Q: 命令可以带参数吗？

A: 当前版本不支持参数。计划在未来版本中添加。临时方案：
1. 使用多个命令（如 `/new-chat`, `/new-code`）
2. 使用面板让用户选择参数

## 贡献指南

### 提交新命令

1. 确保命令有明确的用途
2. 提供清晰的描述
3. 选择合适的分类
4. 测试所有交互路径
5. 更新文档

### 代码风格

遵循项目的 TypeScript 和 React 规范：
- 使用函数组件
- Props 使用接口定义
- 导出使用命名导出
- 文件使用 `.tsx` 扩展名

### 文档要求

添加新命令时，请更新：
1. `commands.tsx` 中的注释
2. 本使用指南的命令列表
3. 相关的分类说明
