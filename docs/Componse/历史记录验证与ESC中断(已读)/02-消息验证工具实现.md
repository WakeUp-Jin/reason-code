# 消息验证工具实现

## 文件位置

`packages/core/src/core/context/utils/messageSanitizer.ts`

## 核心函数

### 1. sanitizeMessages - 清理消息列表

```typescript
export function sanitizeMessages(messages: Message[]): SanitizeResult {
  // 返回清理后的消息列表
}
```

**输入**：原始消息列表

**输出**：
```typescript
interface SanitizeResult {
  messages: Message[];      // 清理后的消息
  sanitized: boolean;       // 是否进行了清理
  removedCount: number;     // 移除的消息数量
  removedMessages: Array<{  // 移除详情（用于调试）
    index: number;
    role: string;
    reason: string;
  }>;
}
```

### 2. validateMessages - 验证消息列表

```typescript
export function validateMessages(messages: Message[]): {
  valid: boolean;
  errors: string[];
}
```

只检查不修改，用于调试和测试。

## 清理算法

### 第一遍：找出不完整的 assistant 消息

```typescript
for (let i = 0; i < messages.length; i++) {
  const msg = messages[i];

  if (msg.role === 'assistant' && msg.tool_calls?.length > 0) {
    // 检查后续消息中是否有对应的 tool 响应
    const missingIds = findMissingToolResponses(msg, messages.slice(i + 1));

    if (missingIds.length > 0) {
      // 标记这个 assistant 消息需要移除
      indicesToRemove.add(i);

      // 同时移除关联的部分 tool 消息
      // ...
    }
  }
}
```

### 第二遍：找出孤立的 tool 消息

```typescript
// 收集所有有效的 tool_call_id
const validToolCallIds = new Set<string>();
for (const msg of messages) {
  if (msg.role === 'assistant' && msg.tool_calls) {
    for (const toolCall of msg.tool_calls) {
      validToolCallIds.add(toolCall.id);
    }
  }
}

// 检查每个 tool 消息
for (let i = 0; i < messages.length; i++) {
  const msg = messages[i];
  if (msg.role === 'tool') {
    if (!msg.tool_call_id || !validToolCallIds.has(msg.tool_call_id)) {
      indicesToRemove.add(i);  // 孤立的 tool 消息
    }
  }
}
```

## 集成位置

### ContextManager.buildMessages()

```typescript
private buildMessages(): Message[] {
  const messages: Message[] = [];

  // 1. 系统提示词
  messages.push(...this.systemPrompt.format());

  // 2. 历史消息
  messages.push(...this.history.format());

  // 3. 当前用户输入
  if (this.userInput) {
    messages.push({ role: 'user', content: this.userInput });
  }

  // 4. 当前轮次的工具调用
  messages.push(...this.currentTurn.format());

  // 5. 验证并清理消息 ← 新增
  const { messages: sanitizedMessages, sanitized, removedCount } = sanitizeMessages(messages);

  if (sanitized) {
    logger.warn(`消息列表已清理，移除了 ${removedCount} 条不完整的消息`);
  }

  return sanitizedMessages;
}
```

### CurrentTurnContext.sanitize()

```typescript
/**
 * 清理当前轮次的消息，保留已完成的部分
 */
sanitize(): SanitizeResult {
  const result = sanitizeMessages(this.items);

  if (result.sanitized) {
    this.replace(result.messages);
  }

  return result;
}
```

## 测试用例

测试文件：`packages/core/src/core/context/__tests__/messageSanitizer.test.ts`

### 测试场景

1. **正常消息**：不应该被修改
2. **空消息数组**：正常处理
3. **完整的 tool_calls 对**：保留
4. **不完整的 assistant 消息**：移除
5. **部分 tool 响应**：移除整个不完整的对
6. **保留早期完整的对**：只移除后面不完整的
7. **孤立的 tool 消息**：移除

## 日志输出

当发生清理时，会输出警告日志：

```
[WARN] Messages sanitized {
  removedCount: 2,
  details: [
    { index: 5, role: 'assistant', reason: 'Missing tool responses for: call_2' },
    { index: 6, role: 'tool', reason: 'Associated with incomplete assistant message at index 5' }
  ]
}
```

