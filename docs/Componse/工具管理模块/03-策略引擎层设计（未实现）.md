# ç­–ç•¥å¼•æ“å±‚è®¾è®¡ï¼ˆæœªå®ç°ï¼‰

## âš ï¸ é‡è¦è¯´æ˜

**æœ¬æ–‡æ¡£æè¿°çš„ç­–ç•¥å¼•æ“å±‚æš‚æœªå®ç°ï¼Œä»…ä½œä¸ºæœªæ¥æ‰©å±•çš„å‚è€ƒè®¾è®¡ã€‚**

å½“å‰ç³»ç»Ÿä½¿ç”¨å·¥å…·éªŒè¯å±‚ï¼ˆç¬¬äºŒå±‚ï¼‰å·²ç»æ»¡è¶³ 99% çš„éœ€æ±‚ã€‚åªæœ‰åœ¨å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œæ‰è€ƒè™‘å®ç°ç­–ç•¥å¼•æ“ï¼š

- âœ… ä¼ä¸šçº§æƒé™ç®¡ç†éœ€æ±‚
- âœ… éœ€è¦è·¨å›¢é˜Ÿç»Ÿä¸€è§„åˆ™
- âœ… éœ€è¦å®¡è®¡å’Œåˆè§„
- âœ… å·¥å…·æ•°é‡ > 50

---

## ğŸ“‹ ç›®å½•

- [è®¾è®¡æ¦‚è¿°](#è®¾è®¡æ¦‚è¿°)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [è§„åˆ™ä¼˜å…ˆçº§ç³»ç»Ÿ](#è§„åˆ™ä¼˜å…ˆçº§ç³»ç»Ÿ)
- [æ¨¡å¼åŒ¹é…è®¾è®¡](#æ¨¡å¼åŒ¹é…è®¾è®¡)
- [ä¸å·¥å…·éªŒè¯å±‚é›†æˆ](#ä¸å·¥å…·éªŒè¯å±‚é›†æˆ)
- [å®ç°ä»£ç ](#å®ç°ä»£ç )
- [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)

---

## è®¾è®¡æ¦‚è¿°

### ä¸ºä»€ä¹ˆéœ€è¦ç­–ç•¥å¼•æ“ï¼Ÿ

å½“å·¥å…·éªŒè¯å±‚æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼š

```
å·¥å…·éªŒè¯å±‚çš„å±€é™ï¼š
â”œâ”€ âŒ è§„åˆ™åˆ†æ•£åœ¨å„ä¸ªå·¥å…·ä¸­
â”œâ”€ âŒ éš¾ä»¥ç»Ÿä¸€ç®¡ç†
â”œâ”€ âŒ æ— æ³•åšå…¨å±€é»‘åå•
â”œâ”€ âŒ æ— æ³•åŸºäºå‚æ•°ç»†ç²’åº¦æ§åˆ¶
â””â”€ âŒ éš¾ä»¥å®¡è®¡

ç­–ç•¥å¼•æ“çš„ä¼˜åŠ¿ï¼š
â”œâ”€ âœ… é›†ä¸­ç®¡ç†æ‰€æœ‰è§„åˆ™
â”œâ”€ âœ… å£°æ˜å¼é…ç½®
â”œâ”€ âœ… æ”¯æŒä¼˜å…ˆçº§ç³»ç»Ÿ
â”œâ”€ âœ… æ”¯æŒæ­£åˆ™åŒ¹é…å‚æ•°
â””â”€ âœ… æ˜“äºå®¡è®¡å’Œåˆè§„
```

### æ¶æ„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ToolScheduler.schedule()                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚ for (const call of toolCalls) {                         â”‚
â”‚                                                          â”‚
â”‚   // ç¬¬ä¸€å±‚ï¼šç­–ç•¥å¼•æ“æ£€æŸ¥ï¼ˆå…¨å±€è§„åˆ™ï¼‰                    â”‚
â”‚   const decision = this.policyEngine.check(call);       â”‚
â”‚   if (decision === 'allow') return execute();           â”‚
â”‚   if (decision === 'deny') return reject();             â”‚
â”‚                                                          â”‚
â”‚   // ç¬¬äºŒå±‚ï¼šå·¥å…·è‡ªä¸»éªŒè¯ï¼ˆç²¾ç»†åŒ–é€»è¾‘ï¼‰                  â”‚
â”‚   const confirmDetails = await tool.shouldConfirm();    â”‚
â”‚   ...                                                    â”‚
â”‚ }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### PolicyEngine æ ¸å¿ƒèŒè´£

```typescript
èŒè´£ï¼š
â”œâ”€ æ£€æŸ¥å·¥å…·è°ƒç”¨æ˜¯å¦ç¬¦åˆå…¨å±€è§„åˆ™
â”œâ”€ è¿”å›å†³ç­–ï¼šALLOW / DENY / ASK_USER
â”œâ”€ ä¸å…³å¿ƒå·¥å…·çš„å…·ä½“é€»è¾‘
â””â”€ åªåŸºäºå·¥å…·åç§°å’Œå‚æ•°åšåˆ¤æ–­
```

### å…³é”®æ•°æ®ç»“æ„

```typescript
// ç­–ç•¥å†³ç­–
enum PolicyDecision {
  ALLOW = 'allow',       // å…è®¸æ‰§è¡Œ
  DENY = 'deny',         // æ‹’ç»æ‰§è¡Œ
  ASK_USER = 'ask_user'  // è¯¢é—®ç”¨æˆ·ï¼ˆäº¤ç»™å·¥å…·éªŒè¯å±‚ï¼‰
}

// ç­–ç•¥è§„åˆ™
interface PolicyRule {
  // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
  priority: number;

  // å·¥å…·åç§°åŒ¹é…
  toolName?: string;  // æ”¯æŒé€šé…ç¬¦ï¼š'github__*'

  // å‚æ•°æ¨¡å¼åŒ¹é…ï¼ˆæ­£åˆ™ï¼‰
  argsPattern?: RegExp;

  // å†³ç­–
  decision: PolicyDecision;
}

// ç­–ç•¥å¼•æ“é…ç½®
interface PolicyEngineConfig {
  rules: PolicyRule[];
  defaultDecision: PolicyDecision;  // é»˜è®¤å†³ç­–
  nonInteractive?: boolean;         // éäº¤äº’æ¨¡å¼
}
```

---

## è§„åˆ™ä¼˜å…ˆçº§ç³»ç»Ÿ

### ä¼˜å…ˆçº§è®¾è®¡

```
ä¼˜å…ˆçº§èŒƒå›´ï¼š0 - 200
æ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜
è§„åˆ™æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½åŒ¹é…ï¼Œå‘½ä¸­ç¬¬ä¸€ä¸ªè§„åˆ™åè¿”å›

ä¼˜å…ˆçº§åˆ†é…å»ºè®®ï¼š
200-180: é»‘åå•ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
180-160: å®‰å…¨è§„åˆ™
160-140: ä¼ä¸šè§„åˆ™
140-120: å›¢é˜Ÿè§„åˆ™
120-100: ç™½åå•
100-50:  è‡ªåŠ¨æ¥å—è§„åˆ™
50-10:   é»˜è®¤è§„åˆ™
10-0:    å…œåº•è§„åˆ™
```

### ç¤ºä¾‹è§„åˆ™é›†

```typescript
const rules: PolicyRule[] = [
  // ä¼˜å…ˆçº§ 200ï¼šé»‘åå•ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  {
    priority: 200,
    toolName: 'run_shell_command',
    argsPattern: /rm\s+-rf\s+\//,  // æ‹’ç» rm -rf /
    decision: PolicyDecision.DENY
  },

  // ä¼˜å…ˆçº§ 195ï¼šæ’é™¤å±é™© MCP æœåŠ¡å™¨
  {
    priority: 195,
    toolName: 'dangerous-server__*',  // é€šé…ç¬¦
    decision: PolicyDecision.DENY
  },

  // ä¼˜å…ˆçº§ 100ï¼šç™½åå•
  {
    priority: 100,
    toolName: 'run_shell_command',
    argsPattern: /^git\s+/,  // å…è®¸æ‰€æœ‰ git å‘½ä»¤
    decision: PolicyDecision.ALLOW
  },

  // ä¼˜å…ˆçº§ 90ï¼šä¿¡ä»»çš„ MCP æœåŠ¡å™¨
  {
    priority: 90,
    toolName: 'github__*',
    decision: PolicyDecision.ALLOW
  },

  // ä¼˜å…ˆçº§ 50ï¼šè‡ªåŠ¨æ¥å—è¯»å–å·¥å…·
  {
    priority: 50,
    toolName: 'read_file',
    decision: PolicyDecision.ALLOW
  },

  // ä¼˜å…ˆçº§ 10ï¼šå†™å…¥å·¥å…·éœ€è¦ç¡®è®¤
  {
    priority: 10,
    toolName: 'replace',
    decision: PolicyDecision.ASK_USER
  }
];
```

### è§„åˆ™åŒ¹é…é€»è¾‘

```typescript
class PolicyEngine {
  check(toolCall: ToolCall): PolicyDecision {
    // æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½éå†
    for (const rule of this.rules) {
      if (this.matches(rule, toolCall)) {
        return rule.decision;  // è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™
      }
    }

    // æ²¡æœ‰åŒ¹é…çš„è§„åˆ™ï¼Œè¿”å›é»˜è®¤å†³ç­–
    return this.defaultDecision;
  }

  private matches(rule: PolicyRule, toolCall: ToolCall): boolean {
    // 1. æ£€æŸ¥å·¥å…·åç§°
    if (rule.toolName) {
      if (!this.matchesToolName(rule.toolName, toolCall.name)) {
        return false;
      }
    }

    // 2. æ£€æŸ¥å‚æ•°æ¨¡å¼
    if (rule.argsPattern) {
      const argsStr = JSON.stringify(toolCall.args);
      if (!rule.argsPattern.test(argsStr)) {
        return false;
      }
    }

    return true;
  }

  private matchesToolName(pattern: string, toolName: string): boolean {
    // æ”¯æŒé€šé…ç¬¦
    if (pattern.endsWith('__*')) {
      const prefix = pattern.slice(0, -3);
      return toolName.startsWith(prefix + '__');
    }

    // ç²¾ç¡®åŒ¹é…
    return pattern === toolName;
  }
}
```

---

## æ¨¡å¼åŒ¹é…è®¾è®¡

### å·¥å…·åç§°åŒ¹é…

```typescript
// 1. ç²¾ç¡®åŒ¹é…
{
  toolName: 'replace',
  decision: PolicyDecision.ASK_USER
}
// åŒ¹é…ï¼šreplace
// ä¸åŒ¹é…ï¼šreplace_all

// 2. é€šé…ç¬¦åŒ¹é…ï¼ˆMCP å·¥å…·ï¼‰
{
  toolName: 'github__*',
  decision: PolicyDecision.ALLOW
}
// åŒ¹é…ï¼šgithub__search, github__create_issue
// ä¸åŒ¹é…ï¼šgitlab__search

// 3. æœªæŒ‡å®šï¼ˆåŒ¹é…æ‰€æœ‰ï¼‰
{
  decision: PolicyDecision.DENY
}
// åŒ¹é…æ‰€æœ‰å·¥å…·
```

### å‚æ•°æ¨¡å¼åŒ¹é…ï¼ˆæ­£åˆ™ï¼‰

```typescript
// 1. åŒ¹é…å±é™©å‘½ä»¤
{
  toolName: 'run_shell_command',
  argsPattern: /rm\s+-rf/,
  decision: PolicyDecision.DENY
}
// åŒ¹é…ï¼š{ command: 'rm -rf /tmp' }

// 2. åŒ¹é…æ–‡ä»¶è·¯å¾„
{
  toolName: 'replace',
  argsPattern: /file_path.*\.env/,
  decision: PolicyDecision.ASK_USER
}
// åŒ¹é…ï¼š{ file_path: '/app/.env', ... }

// 3. åŒ¹é… MCP å‚æ•°
{
  toolName: 'github__create_issue',
  argsPattern: /"repo":"private-repo"/,
  decision: PolicyDecision.DENY
}
// åŒ¹é…ï¼š{ repo: 'private-repo', ... }
```

### ç»„åˆåŒ¹é…

```typescript
// å·¥å…·åç§° + å‚æ•°ç»„åˆ
{
  priority: 150,
  toolName: 'run_shell_command',
  argsPattern: /git\s+push.*--force/,
  decision: PolicyDecision.ASK_USER  // å¼ºåˆ¶æ¨é€éœ€è¦ç¡®è®¤
}
```

---

## ä¸å·¥å…·éªŒè¯å±‚é›†æˆ

### é›†æˆæµç¨‹

```
ToolScheduler.schedule()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€å±‚ï¼šç­–ç•¥å¼•æ“                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚ const decision = policyEngine.check()   â”‚
â”‚                                         â”‚
â”‚ if (decision === 'allow')               â”‚
â”‚   â†’ ç›´æ¥æ‰§è¡Œï¼Œè·³è¿‡ç¬¬äºŒå±‚ âœ…              â”‚
â”‚                                         â”‚
â”‚ if (decision === 'deny')                â”‚
â”‚   â†’ æ‹’ç»æ‰§è¡Œï¼Œè·³è¿‡ç¬¬äºŒå±‚ âœ…              â”‚
â”‚                                         â”‚
â”‚ if (decision === 'ask_user')            â”‚
â”‚   â†’ è¿›å…¥ç¬¬äºŒå±‚ â¬‡ï¸                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ASK_USER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒå±‚ï¼šå·¥å…·éªŒè¯                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚ const details = await tool              â”‚
â”‚   .shouldConfirmExecute()               â”‚
â”‚                                         â”‚
â”‚ if (!details)                           â”‚
â”‚   â†’ ç›´æ¥æ‰§è¡Œ âœ…                          â”‚
â”‚                                         â”‚
â”‚ if (details)                            â”‚
â”‚   â†’ æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† â¬‡ï¸                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ToolScheduler é›†æˆä»£ç 

```typescript
class ToolScheduler {
  private policyEngine?: PolicyEngine;
  private approvalMode = ApprovalMode.DEFAULT;

  // æ³¨å…¥ç­–ç•¥å¼•æ“ï¼ˆå¯é€‰ï¼‰
  setPolicyEngine(engine: PolicyEngine): void {
    this.policyEngine = engine;
  }

  async schedule(toolCalls: ToolCall[]): Promise<void> {
    for (const call of toolCalls) {
      // ============================================
      // ç¬¬ä¸€å±‚ï¼šç­–ç•¥å¼•æ“æ£€æŸ¥
      // ============================================
      if (this.policyEngine) {
        const decision = this.policyEngine.check({
          name: call.name,
          args: call.params
        });

        // å¤„ç†ç­–ç•¥å†³ç­–
        if (decision === PolicyDecision.ALLOW) {
          // ç›´æ¥æ‰§è¡Œï¼Œè·³è¿‡å·¥å…·éªŒè¯
          await this.executeDirectly(call);
          continue;
        }

        if (decision === PolicyDecision.DENY) {
          // æ‹’ç»æ‰§è¡Œ
          this.rejectCall(call, 'Blocked by policy');
          continue;
        }

        // decision === PolicyDecision.ASK_USER
        // ç»§ç»­ä¸‹é¢çš„æµç¨‹
      }

      // ============================================
      // ç¬¬äºŒå±‚ï¼šå·¥å…·éªŒè¯
      // ============================================
      const invocation = call.tool.build(call.params);
      const confirmDetails = await invocation.shouldConfirmExecute(
        this.approvalMode
      );

      if (!confirmDetails) {
        await this.executeDirectly(call);
      } else {
        await this.handleConfirmation(call, confirmDetails);
      }
    }
  }

  private async executeDirectly(call: ToolCall): Promise<void> {
    // æ‰§è¡Œå·¥å…·
  }

  private rejectCall(call: ToolCall, reason: string): void {
    // æ‹’ç»æ‰§è¡Œ
  }

  private async handleConfirmation(
    call: ToolCall,
    details: ConfirmDetails
  ): Promise<void> {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  }
}
```

---

## å®ç°ä»£ç 

### PolicyEngine å®Œæ•´å®ç°

```typescript
/**
 * ç­–ç•¥å¼•æ“
 * åŸºäºè§„åˆ™ä¼˜å…ˆçº§ç³»ç»Ÿåšå…¨å±€æƒé™æ§åˆ¶
 */
class PolicyEngine {
  private rules: PolicyRule[];
  private readonly defaultDecision: PolicyDecision;
  private readonly nonInteractive: boolean;

  constructor(config: PolicyEngineConfig) {
    // æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åº
    this.rules = (config.rules || []).sort(
      (a, b) => (b.priority || 0) - (a.priority || 0)
    );
    this.defaultDecision = config.defaultDecision || PolicyDecision.ASK_USER;
    this.nonInteractive = config.nonInteractive || false;
  }

  /**
   * æ£€æŸ¥å·¥å…·è°ƒç”¨æ˜¯å¦å…è®¸
   */
  check(toolCall: { name: string; args: any }): PolicyDecision {
    // è®¡ç®—å‚æ•°å­—ç¬¦ä¸²ï¼ˆåªè®¡ç®—ä¸€æ¬¡ï¼‰
    let argsStr: string | undefined;
    if (this.rules.some(rule => rule.argsPattern)) {
      argsStr = this.stableStringify(toolCall.args);
    }

    // æŒ‰ä¼˜å…ˆçº§åŒ¹é…è§„åˆ™
    for (const rule of this.rules) {
      if (this.matches(rule, toolCall, argsStr)) {
        return this.applyNonInteractiveMode(rule.decision);
      }
    }

    // æ²¡æœ‰åŒ¹é…çš„è§„åˆ™ï¼Œè¿”å›é»˜è®¤å†³ç­–
    return this.applyNonInteractiveMode(this.defaultDecision);
  }

  /**
   * è§„åˆ™åŒ¹é…
   */
  private matches(
    rule: PolicyRule,
    toolCall: { name: string; args: any },
    argsStr?: string
  ): boolean {
    // æ£€æŸ¥å·¥å…·åç§°
    if (rule.toolName) {
      if (!this.matchesToolName(rule.toolName, toolCall.name)) {
        return false;
      }
    }

    // æ£€æŸ¥å‚æ•°æ¨¡å¼
    if (rule.argsPattern) {
      if (!argsStr || !rule.argsPattern.test(argsStr)) {
        return false;
      }
    }

    return true;
  }

  /**
   * å·¥å…·åç§°åŒ¹é…ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
   */
  private matchesToolName(pattern: string, toolName: string): boolean {
    // é€šé…ç¬¦åŒ¹é…ï¼š'github__*' åŒ¹é… 'github__search'
    if (pattern.endsWith('__*')) {
      const prefix = pattern.slice(0, -3);
      return toolName.startsWith(prefix + '__');
    }

    // ç²¾ç¡®åŒ¹é…
    return pattern === toolName;
  }

  /**
   * éäº¤äº’æ¨¡å¼å¤„ç†
   * åœ¨éäº¤äº’æ¨¡å¼ä¸‹ï¼ŒASK_USER è‡ªåŠ¨è½¬ä¸º DENY
   */
  private applyNonInteractiveMode(decision: PolicyDecision): PolicyDecision {
    if (this.nonInteractive && decision === PolicyDecision.ASK_USER) {
      return PolicyDecision.DENY;
    }
    return decision;
  }

  /**
   * ç¨³å®šçš„ JSON åºåˆ—åŒ–ï¼ˆé”®æ’åºï¼‰
   */
  private stableStringify(obj: any): string {
    if (obj === null || obj === undefined) return '';
    if (typeof obj !== 'object') return String(obj);

    if (Array.isArray(obj)) {
      return '[' + obj.map(item => this.stableStringify(item)).join(',') + ']';
    }

    const keys = Object.keys(obj).sort();
    const pairs = keys.map(key => {
      const value = this.stableStringify(obj[key]);
      return `"${key}":${value}`;
    });
    return '{' + pairs.join(',') + '}';
  }

  /**
   * åŠ¨æ€æ·»åŠ è§„åˆ™
   */
  addRule(rule: PolicyRule): void {
    this.rules.push(rule);
    // é‡æ–°æ’åº
    this.rules.sort((a, b) => (b.priority || 0) - (a.priority || 0));
  }

  /**
   * åˆ é™¤ç‰¹å®šå·¥å…·çš„è§„åˆ™
   */
  removeRulesForTool(toolName: string): void {
    this.rules = this.rules.filter(rule => rule.toolName !== toolName);
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰è§„åˆ™
   */
  clearRules(): void {
    this.rules = [];
  }
}
```

---

## é…ç½®ç¤ºä¾‹

### ä» settings.json ç”Ÿæˆè§„åˆ™

```typescript
/**
 * ä»é…ç½®æ–‡ä»¶ç”Ÿæˆç­–ç•¥å¼•æ“è§„åˆ™
 */
function createPolicyEngineConfig(
  settings: Settings,
  approvalMode: ApprovalMode
): PolicyEngineConfig {
  const rules: PolicyRule[] = [];

  // ============================================
  // é»‘åå•ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ 200ï¼‰
  // ============================================
  if (settings.tools?.exclude) {
    for (const tool of settings.tools.exclude) {
      rules.push({
        priority: 200,
        toolName: tool,
        decision: PolicyDecision.DENY
      });
    }
  }

  // ============================================
  // æ’é™¤çš„ MCP æœåŠ¡å™¨ï¼ˆä¼˜å…ˆçº§ 195ï¼‰
  // ============================================
  if (settings.mcp?.excluded) {
    for (const serverName of settings.mcp.excluded) {
      rules.push({
        priority: 195,
        toolName: `${serverName}__*`,
        decision: PolicyDecision.DENY
      });
    }
  }

  // ============================================
  // ç™½åå•ï¼ˆä¼˜å…ˆçº§ 100ï¼‰
  // ============================================
  if (settings.tools?.allowed) {
    for (const tool of settings.tools.allowed) {
      rules.push({
        priority: 100,
        toolName: tool,
        decision: PolicyDecision.ALLOW
      });
    }
  }

  // ============================================
  // ä¿¡ä»»çš„ MCP æœåŠ¡å™¨ï¼ˆä¼˜å…ˆçº§ 90ï¼‰
  // ============================================
  if (settings.mcpServers) {
    for (const [serverName, config] of Object.entries(settings.mcpServers)) {
      if (config.trust) {
        rules.push({
          priority: 90,
          toolName: `${serverName}__*`,
          decision: PolicyDecision.ALLOW
        });
      }
    }
  }

  // ============================================
  // è‡ªåŠ¨æ¥å—è¯»å–å·¥å…·ï¼ˆä¼˜å…ˆçº§ 50ï¼‰
  // ============================================
  if (settings.tools?.autoAccept) {
    const readOnlyTools = ['read_file', 'glob', 'grep'];
    for (const tool of readOnlyTools) {
      rules.push({
        priority: 50,
        toolName: tool,
        decision: PolicyDecision.ALLOW
      });
    }
  }

  // ============================================
  // AUTO_EDIT æ¨¡å¼ï¼ˆä¼˜å…ˆçº§ 15ï¼‰
  // ============================================
  if (approvalMode === ApprovalMode.AUTO_EDIT) {
    rules.push({
      priority: 15,
      toolName: 'replace',
      decision: PolicyDecision.ALLOW
    });
  }

  // ============================================
  // å†™å…¥å·¥å…·éœ€è¦ç¡®è®¤ï¼ˆä¼˜å…ˆçº§ 10ï¼‰
  // ============================================
  if (approvalMode !== ApprovalMode.YOLO) {
    const writeTools = ['replace', 'write_file', 'run_shell_command'];
    for (const tool of writeTools) {
      rules.push({
        priority: 10,
        toolName: tool,
        decision: PolicyDecision.ASK_USER
      });
    }
  }

  // ============================================
  // YOLO æ¨¡å¼ï¼ˆä¼˜å…ˆçº§ 0ï¼Œå…œåº•ï¼‰
  // ============================================
  if (approvalMode === ApprovalMode.YOLO) {
    rules.push({
      priority: 0,
      decision: PolicyDecision.ALLOW
    });
  }

  return {
    rules,
    defaultDecision: PolicyDecision.ASK_USER
  };
}
```

### settings.json ç¤ºä¾‹

```json
{
  "tools": {
    "allowed": [
      "run_shell_command(git)",
      "run_shell_command(npm)",
      "replace"
    ],
    "exclude": [
      "run_shell_command(rm -rf)",
      "run_shell_command(sudo)"
    ],
    "autoAccept": true
  },
  "mcp": {
    "allowed": ["github", "gitlab"],
    "excluded": ["dangerous-server"]
  },
  "mcpServers": {
    "github": {
      "command": "node",
      "args": ["server.js"],
      "trust": true
    }
  }
}
```

---

## æ€»ç»“

### ä½•æ—¶å®ç°ç­–ç•¥å¼•æ“ï¼Ÿ

å½“å‡ºç°ä»¥ä¸‹éœ€æ±‚æ—¶ï¼š

1. âœ… **ä¼ä¸šçº§æƒé™ç®¡ç†**ï¼ˆè·¨å›¢é˜Ÿç»Ÿä¸€è§„åˆ™ï¼‰
2. âœ… **å¤æ‚æƒé™ç­–ç•¥**ï¼ˆåŸºäºå‚æ•°ç»†ç²’åº¦æ§åˆ¶ï¼‰
3. âœ… **å¤§è§„æ¨¡å·¥å…·**ï¼ˆå·¥å…·æ•°é‡ > 50ï¼‰
4. âœ… **å®¡è®¡åˆè§„**ï¼ˆéœ€è¦è®°å½•å’Œå®¡è®¡ï¼‰

### å®æ–½æ­¥éª¤

```
ç¬¬ 1 å‘¨ï¼š
  â”œâ”€ å®ç° PolicyEngine æ ¸å¿ƒ
  â”œâ”€ å®ç°è§„åˆ™åŒ¹é…é€»è¾‘
  â””â”€ å•å…ƒæµ‹è¯•

ç¬¬ 2 å‘¨ï¼š
  â”œâ”€ é›†æˆåˆ° ToolScheduler
  â”œâ”€ å®ç°é…ç½®æ–‡ä»¶è§£æ
  â””â”€ é›†æˆæµ‹è¯•
```

### å½“å‰çŠ¶æ€

```
è®¾è®¡å®Œæˆåº¦ï¼šâœ… 100%
ä»£ç å®ç°åº¦ï¼šâŒ 0%
ä¼˜å…ˆçº§ï¼šâš ï¸ ä½ï¼ˆæš‚ä¸å®ç°ï¼‰
é¢„è®¡å·¥ä½œé‡ï¼š1-2 å‘¨
```

### å‚è€ƒèµ„æ–™

- gemini-cli æºç ï¼š`packages/core/src/policy/policy-engine.ts`
- å·¥å…·éªŒè¯å±‚ï¼š[02-å·¥å…·éªŒè¯å±‚å®ç°æŒ‡å—.md](./02-å·¥å…·éªŒè¯å±‚å®ç°æŒ‡å—.md)
