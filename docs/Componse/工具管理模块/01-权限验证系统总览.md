# 工具权限验证系统总览

## 📋 目录

- [系统概述](#系统概述)
- [架构设计](#架构设计)
- [实施优先级](#实施优先级)
- [设计决策](#设计决策)
- [相关文档](#相关文档)

---

## 系统概述

### 目标

构建一套**渐进式**的工具权限验证系统，平衡安全性、用户体验和开发成本。

### 核心原则

1. **渐进式实现**：先做 MVP（工具验证层），需要时再扩展策略引擎层
2. **YAGNI 原则**：不实现暂时用不到的功能
3. **数据驱动**：基于 gemini-cli 的实际使用数据做决策
4. **预留扩展**：保持架构弹性，方便未来升级

---

## 架构设计

### 双层验证架构

```
┌─────────────────────────────────────────────────────────┐
│                 第一层：策略引擎层                       │
│                    （未实现，预留）                      │
│ ─────────────────────────────────────────────────       │
│ 职责：全局规则管理                                       │
│ 特点：静态配置、声明式、基于配置文件                     │
│ 位置：ToolScheduler 调度器中                            │
│ 优先级：黑名单 > 白名单 > 默认规则                      │
└─────────────────────────────────────────────────────────┘
                         ↓ ASK_USER
┌─────────────────────────────────────────────────────────┐
│                 第二层：工具验证层                       │
│                    （优先实现）✅                        │
│ ─────────────────────────────────────────────────       │
│ 职责：工具特定逻辑                                       │
│ 特点：动态状态、运行时判断、allowlist 机制              │
│ 位置：每个工具的 shouldConfirmExecute() 方法            │
│ 核心：批准模式 + 会话级 allowlist                       │
└─────────────────────────────────────────────────────────┘
```

### 层次职责划分

| 层次 | 职责 | 数据来源 | 实施优先级 |
|------|------|----------|-----------|
| **第一层：策略引擎** | 全局规则管理 | settings.json | ⚠️ 暂不实现 |
| **第二层：工具验证** | 工具特定逻辑 | 运行时状态 | ✅ 优先实现 |

---

## 实施优先级

### 🥇 第一阶段：工具验证层（第 1-2 周）

**为什么优先实现？**

1. **数据支持**
   - gemini-cli 的策略引擎使用率 < 1%
   - 99% 的需求通过批准模式 + allowlist 满足

2. **开发成本**
   - 代码量：~300 行（vs 策略引擎 ~1000 行）
   - 开发时间：1-2 周（vs 策略引擎 3-4 周）
   - 测试难度：低

3. **用户体验**
   - 简单直观，学习曲线平缓
   - 三种批准模式覆盖所有场景
   - 会话级 allowlist 高效便捷

**实现内容：**

```typescript
// 核心功能
✅ 三种批准模式（DEFAULT, AUTO_EDIT, YOLO）
✅ 会话级 allowlist 机制
✅ 工具 shouldConfirmExecute() 方法
✅ 确认对话框 UI
✅ 快捷键切换（Ctrl+Y, Shift+Tab）
```

**详细文档：** [02-工具验证层实现指南.md](./02-工具验证层实现指南.md)

---

### 🥈 第二阶段：策略引擎层（未来扩展）

**什么时候实现？**

当出现以下需求时：

1. **企业级权限管理**
   - 需要跨团队统一规则
   - 需要审计和合规

2. **复杂权限策略**
   - 需要基于参数的细粒度控制
   - 需要优先级规则系统

3. **大规模工具管理**
   - 工具数量 > 50
   - 需要声明式配置

**当前状态：**

```
实现完成度：✅ 架构设计完成
代码完成度：❌ 未实现
接口预留：✅ 已预留扩展点
实施时间：1-2 周（需要时）
```

**详细文档：** [03-策略引擎层设计（未实现）.md](./03-策略引擎层设计（未实现）.md)

---

## 设计决策

### 为什么不先实现策略引擎？

#### ❌ gemini-cli 的教训

```
事实：
├─ 策略引擎实现完成 ✅
├─ 但 enableMessageBusIntegration 默认 false ❌
├─ 没有用户启用 ❌
├─ 没有配置文件使用 ❌
└─ 95% 的工具 override 了默认实现 ❌

结论：过度设计，资源浪费
```

#### ✅ 数据驱动决策

| 功能 | gemini-cli 使用率 | 是否实现 |
|------|------------------|----------|
| 批准模式切换 | ~80% | ✅ 是 |
| allowlist | ~60% | ✅ 是 |
| 策略引擎 | < 1% | ❌ 否 |

#### ✅ 渐进式架构

```
阶段1：工具验证层（1-2 周）
  ├─ 满足 99% 需求 ✅
  ├─ 快速上线 ✅
  └─ 收集用户反馈 ✅

阶段2：策略引擎层（需要时）
  ├─ 基于真实需求设计 ✅
  ├─ 有数据支持 ✅
  └─ 避免过度设计 ✅
```

### 架构解耦设计

#### 关键决策：策略层放在调度器中

```typescript
// ✅ 优雅的设计
class ToolScheduler {
  private policyEngine?: PolicyEngine;  // 预留接口

  async schedule(toolCalls) {
    // 第一层：策略引擎（未来扩展）
    // if (this.policyEngine) {
    //   const decision = this.policyEngine.check(call);
    //   if (decision === 'allow') return execute();
    //   if (decision === 'deny') return reject();
    // }

    // 第二层：工具验证（当前实现）
    const confirmDetails = await tool.shouldConfirmExecute(
      this.approvalMode
    );
  }
}

// ✅ 工具类简洁
class EditTool {
  constructor(config: Config) {}  // 不需要 policyEngine

  async shouldConfirmExecute(approvalMode) {
    // 只关心自己的逻辑
  }
}
```

**为什么这样设计？**

1. **单一职责**：调度器管全局，工具管自己
2. **解耦彻底**：工具不知道策略引擎存在
3. **易于测试**：可以独立测试每一层
4. **易于扩展**：未来添加策略引擎不影响工具代码

---

## 相关文档

### 核心文档

- [02-工具验证层实现指南.md](./02-工具验证层实现指南.md) - **优先阅读**
  - 批准模式设计
  - allowlist 机制
  - 工具实现示例
  - 完整代码示例

- [03-策略引擎层设计（未实现）.md](./03-策略引擎层设计（未实现）.md) - 未来参考
  - 规则优先级系统
  - 模式匹配设计
  - 与工具验证层集成

### 参考资料

- gemini-cli 源码分析
  - `packages/core/src/core/coreToolScheduler.ts`
  - `packages/core/src/tools/shell.ts`
  - `packages/core/src/policy/policy-engine.ts`

---

## 实施路线图

```
第 1 周：核心功能
  ├─ 批准模式实现（DEFAULT, AUTO_EDIT, YOLO）
  ├─ allowlist 机制
  └─ 基础工具实现（Edit, Shell）

第 2 周：UI 和完善
  ├─ 确认对话框 UI
  ├─ 快捷键支持
  └─ 测试和文档

未来（根据需求）：
  └─ 策略引擎扩展（1-2 周）
```

---

## 常见问题

### Q: 为什么不一步到位实现策略引擎？

**A:** 基于数据驱动决策：
- gemini-cli 实现了策略引擎但使用率 < 1%
- 工具验证层满足 99% 需求
- 避免过度设计和资源浪费

### Q: 未来如何扩展策略引擎？

**A:** 已预留扩展接口：
- ToolScheduler 中预留 `policyEngine?` 字段
- 调度流程中预留策略检查位置
- 工具代码不需要修改

### Q: 如何保证未来兼容性？

**A:** 接口设计稳定：
- 工具的 `shouldConfirmExecute(approvalMode)` 接口不变
- 调度器内部逻辑可自由扩展
- 向后兼容

---

## 总结

### 核心要点

1. ✅ **优先实现工具验证层**（1-2 周，满足 99% 需求）
2. ⚠️ **暂不实现策略引擎**（避免过度设计）
3. ✅ **预留扩展接口**（需要时 1-2 周完成）
4. ✅ **数据驱动决策**（基于 gemini-cli 实际数据）

### 下一步

阅读 [02-工具验证层实现指南.md](./02-工具验证层实现指南.md) 开始实现。
