# ä¾èµ–ç®¡ç†å’Œæºç æš´éœ²æœºåˆ¶

## æ ¸å¿ƒé—®é¢˜

åœ¨ Monorepo ä¸­ï¼Œæœ‰ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š
1. ä¾èµ–åŒ…å®‰è£…åœ¨å“ªé‡Œï¼Ÿ
2. CLI å¦‚ä½•ä½¿ç”¨ Core çš„æºç ï¼Ÿ
3. æ ¹ package.json çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

## ç›®å½•ç»“æ„è¯¦è§£

### å®Œæ•´çš„æ–‡ä»¶ç»“æ„

```
my-agent-project/
â”œâ”€â”€ package.json                    # æ ¹é…ç½®ï¼ˆå£°æ˜ workspacesï¼‰
â”œâ”€â”€ node_modules/                   # ğŸ¯ æ‰€æœ‰ä¾èµ–çš„å®‰è£…ä½ç½®
â”‚   â”œâ”€â”€ .bin/
â”‚   â”‚   â”œâ”€â”€ tsc -> ../typescript/bin/tsc
â”‚   â”‚   â””â”€â”€ turbo -> ../turbo/bin/turbo
â”‚   â”‚
â”‚   â”œâ”€â”€ @my-agent/                  # â­ å†…éƒ¨åŒ…çš„ç¬¦å·é“¾æ¥
â”‚   â”‚   â”œâ”€â”€ core -> ../../packages/core/     # é“¾æ¥åˆ°æºç ï¼
â”‚   â”‚   â””â”€â”€ cli -> ../../packages/cli/       # é“¾æ¥åˆ°æºç ï¼
â”‚   â”‚
â”‚   â”œâ”€â”€ zod/                        # å¤–éƒ¨ä¾èµ–
â”‚   â”‚   â””â”€â”€ 4.1.8/
â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â””â”€â”€ 4.0.0/
â”‚   â”œâ”€â”€ chalk/
â”‚   â”‚   â””â”€â”€ 5.0.0/
â”‚   â””â”€â”€ typescript/
â”‚       â””â”€â”€ 5.8.2/
â”‚
â””â”€â”€ packages/
    â”œâ”€â”€ core/
    â”‚   â”œâ”€â”€ package.json
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â””â”€â”€ index.ts           # â­ TypeScript æºç 
    â”‚   â””â”€â”€ node_modules/          # é€šå¸¸ä¸ºç©ºï¼ˆä¾èµ–æå‡äº†ï¼‰
    â”‚
    â””â”€â”€ cli/
        â”œâ”€â”€ package.json
        â”œâ”€â”€ src/
        â”‚   â””â”€â”€ index.ts
        â””â”€â”€ node_modules/          # é€šå¸¸ä¸ºç©º
```

## ä¾èµ–è§£ææœºåˆ¶

### 1. ç¬¦å·é“¾æ¥ï¼ˆSymlinkï¼‰

å½“è¿è¡Œ `bun install` æ—¶ï¼ŒWorkspace ä¼šåˆ›å»ºç¬¦å·é“¾æ¥ï¼š

```bash
# æŸ¥çœ‹ç¬¦å·é“¾æ¥
ls -la node_modules/@my-agent/

# è¾“å‡ºï¼š
core -> ../../packages/core    # æŒ‡å‘æºç ç›®å½•
cli -> ../../packages/cli      # æŒ‡å‘æºç ç›®å½•
```

**è¿™æ„å‘³ç€ï¼š**
```
node_modules/@my-agent/core
= packages/core  (å®Œå…¨ç›¸åŒï¼)
```

### 2. æ¨¡å—è§£ææµç¨‹

å½“ CLI å¯¼å…¥ Core æ—¶ï¼š

```typescript
// packages/cli/src/index.ts
import { Agent } from '@my-agent/core'
```

**Node.js è§£ææ­¥éª¤ï¼š**

```
æ­¥éª¤ 1: ä»å½“å‰æ–‡ä»¶ä½ç½®å¼€å§‹
packages/cli/src/index.ts

æ­¥éª¤ 2: æŸ¥æ‰¾ '@my-agent/core'
â”œâ”€ packages/cli/src/node_modules/@my-agent/core  âŒ ä¸å­˜åœ¨
â”œâ”€ packages/cli/node_modules/@my-agent/core      âŒ ä¸å­˜åœ¨
â”œâ”€ packages/node_modules/@my-agent/core          âŒ ä¸å­˜åœ¨
â””â”€ node_modules/@my-agent/core                   âœ… æ‰¾åˆ°ï¼

æ­¥éª¤ 3: å‘ç°æ˜¯ç¬¦å·é“¾æ¥
node_modules/@my-agent/core -> ../../packages/core

æ­¥éª¤ 4: è¯»å– packages/core/package.json
{
  "exports": {
    ".": "./src/index.ts"  // â­ æŒ‡å‘æºç 
  }
}

æ­¥éª¤ 5: æœ€ç»ˆå¯¼å…¥
packages/core/src/index.ts  âœ… TypeScript æºç ï¼
```

### 3. Exports å­—æ®µçš„ä½œç”¨

`exports` å­—æ®µå®šä¹‰äº†åŒ…çš„å…¥å£ç‚¹ï¼š

```json
// packages/core/package.json
{
  "name": "@my-agent/core",
  "exports": {
    ".": "./src/index.ts",           // ä¸»å…¥å£
    "./agent": "./src/agent.ts",     // å­è·¯å¾„
    "./llm": "./src/llm.ts",         // å­è·¯å¾„
    "./tools": "./src/tools.ts"      // å­è·¯å¾„
  }
}
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```typescript
// å¯¼å…¥ä¸»å…¥å£
import { Agent } from '@my-agent/core'
// å®é™…å¯¼å…¥ï¼špackages/core/src/index.ts

// å¯¼å…¥å­è·¯å¾„
import { OpenAILLM } from '@my-agent/core/llm'
// å®é™…å¯¼å…¥ï¼špackages/core/src/llm.ts

// å¯¼å…¥å·¥å…·
import { Tool } from '@my-agent/core/tools'
// å®é™…å¯¼å…¥ï¼špackages/core/src/tools.ts
```

## æºç æš´éœ²çš„æ„ä¹‰

### ä¸ºä»€ä¹ˆè¦æš´éœ²æºç è€Œä¸æ˜¯ç¼–è¯‘åçš„ä»£ç ï¼Ÿ

#### 1. å¼€å‘æ—¶çƒ­æ›´æ–°

```typescript
// åœºæ™¯ï¼šä¿®æ”¹ core æºç 
// packages/core/src/agent.ts
export class Agent {
  run() {
    return "Hello World"  // ä¿®æ”¹è¿™é‡Œ
  }
}

// packages/cli/src/index.ts
import { Agent } from '@my-agent/core'
const agent = new Agent()
console.log(agent.run())  // âœ… ç«‹å³çœ‹åˆ° "Hello World"

// æ— éœ€ï¼š
// âŒ é‡æ–°æ„å»º core
// âŒ é‡æ–°å®‰è£…ä¾èµ–
// âŒ é‡å¯ CLI

// å› ä¸ºé€šè¿‡ç¬¦å·é“¾æ¥ï¼ŒCLI ç›´æ¥ä½¿ç”¨æºç ï¼
```

#### 2. å®Œæ•´çš„ TypeScript ç±»å‹

```typescript
// packages/core/src/agent.ts
export class Agent {
  /**
   * è¿è¡Œ Agent
   * @param input - ç”¨æˆ·è¾“å…¥
   * @returns Promise<string> - Agent å“åº”
   */
  run(input: string): Promise<string> {
    return Promise.resolve(input)
  }
}

// packages/cli/src/index.ts
import { Agent } from '@my-agent/core'

const agent = new Agent()
agent.run(123)  // âŒ TypeScript æŠ¥é”™
//        ^^^^
// Argument of type 'number' is not assignable to parameter of type 'string'

// âœ… TypeScript ç›´æ¥è¯»å–æºç ï¼š
// - å®Œæ•´çš„ç±»å‹ä¿¡æ¯
// - JSDoc æ³¨é‡Š
// - æ³›å‹æ¨æ–­
// - ç±»å‹çº¦æŸ
```

å¯¹æ¯”ç¼–è¯‘åçš„ä»£ç ï¼š

```javascript
// dist/agent.js (ç¼–è¯‘å)
export class Agent {
  run(input) {  // âŒ ç±»å‹ä¸¢å¤±
    return Promise.resolve(input);
  }
}

// éœ€è¦å•ç‹¬çš„ .d.ts æ–‡ä»¶
// dist/agent.d.ts
export declare class Agent {
  run(input: string): Promise<string>;
}

// âš ï¸ å¯èƒ½ä¸¢å¤± JSDoc
// âš ï¸ å¯èƒ½ç±»å‹ä¸å®Œæ•´
```

#### 3. è°ƒè¯•ä½“éªŒæ›´å¥½

```typescript
// å½“å‡ºé”™æ—¶ï¼š

// æºç æ–¹å¼ï¼ˆâœ… å¥½ï¼‰ï¼š
Error: Invalid input
  at Agent.run (packages/core/src/agent.ts:42:10)
  at main (packages/cli/src/index.ts:10:15)

// æŒ‡å‘æºç æ–‡ä»¶ï¼Œè¡Œå·å‡†ç¡®
// å¯ä»¥ç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­è·³è½¬

// ç¼–è¯‘åæ–¹å¼ï¼ˆâŒ å·®ï¼‰ï¼š
Error: Invalid input
  at Agent.run (node_modules/@my-agent/core/dist/agent.js:65:20)
  at main (packages/cli/src/index.ts:10:15)

// æŒ‡å‘ç¼–è¯‘åçš„æ–‡ä»¶
// è¡Œå·å¯¹ä¸ä¸Šï¼ˆå› ä¸ºç¼–è¯‘å™¨å¯èƒ½æ’å…¥ä»£ç ï¼‰
// éœ€è¦ sourcemap æ‰èƒ½æ˜ å°„å›æºç 
```

#### 4. æ— éœ€æ„å»ºæ­¥éª¤

```bash
# æºç æ–¹å¼ï¼ˆâœ… å¿«é€Ÿå¼€å‘ï¼‰
vim packages/core/src/agent.ts    # ä¿®æ”¹ä»£ç 
bun run --cwd packages/cli dev     # ç«‹å³è¿è¡Œï¼Œçœ‹åˆ°æ›´æ”¹

# ç¼–è¯‘åæ–¹å¼ï¼ˆâŒ æ…¢é€Ÿå¼€å‘ï¼‰
vim packages/core/src/agent.ts    # ä¿®æ”¹ä»£ç 
cd packages/core
bun run build                      # å¿…é¡»å…ˆæ„å»º
cd ../cli
bun run dev                        # ç„¶åæ‰èƒ½çœ‹åˆ°æ›´æ”¹
```

## ä¾èµ–æå‡ï¼ˆHoistingï¼‰

### ç›¸åŒä¾èµ–ï¼Œç›¸åŒç‰ˆæœ¬

```json
// packages/core/package.json
{
  "dependencies": {
    "zod": "4.1.8"
  }
}

// packages/cli/package.json
{
  "dependencies": {
    "zod": "4.1.8"  // ç›¸åŒç‰ˆæœ¬
  }
}
```

**ç»“æœï¼š**
```
node_modules/
â””â”€â”€ zod/                          # âœ… æå‡åˆ°æ ¹ï¼Œåªå®‰è£…ä¸€æ¬¡
    â””â”€â”€ 4.1.8/

packages/core/node_modules/        # ç©º
packages/cli/node_modules/         # ç©º

ğŸ’¾ èŠ‚çœç£ç›˜ç©ºé—´
âš¡ åŠ å¿«å®‰è£…é€Ÿåº¦
```

### ç›¸åŒä¾èµ–ï¼Œä¸åŒç‰ˆæœ¬

```json
// packages/core/package.json
{
  "dependencies": {
    "lodash": "4.0.0"
  }
}

// packages/cli/package.json
{
  "dependencies": {
    "lodash": "5.0.0"  // ä¸åŒç‰ˆæœ¬
  }
}
```

**ç»“æœï¼š**
```
node_modules/
â””â”€â”€ lodash/                       # ä¸»ç‰ˆæœ¬ï¼ˆæ›´å¸¸ç”¨çš„ï¼‰
    â””â”€â”€ 5.0.0/

packages/core/node_modules/
â””â”€â”€ lodash/                       # ç‰¹æ®Šç‰ˆæœ¬
    â””â”€â”€ 4.0.0/

âš ï¸ Core ä¼šä½¿ç”¨è‡ªå·±çš„ 4.0.0 ç‰ˆæœ¬
âš ï¸ CLI ä¼šä½¿ç”¨æ ¹ç›®å½•çš„ 5.0.0 ç‰ˆæœ¬
```

### ä¾èµ–è§£æä¼˜å…ˆçº§

```
æŸ¥æ‰¾æ¨¡å— 'zod' æ—¶çš„é¡ºåºï¼š

1. å½“å‰ç›®å½•çš„ node_modules
   packages/cli/src/node_modules/zod  âŒ

2. çˆ¶ç›®å½•çš„ node_modules
   packages/cli/node_modules/zod      âŒ

3. å†ä¸Šä¸€çº§
   packages/node_modules/zod          âŒ

4. æ ¹ç›®å½•çš„ node_modules
   node_modules/zod                   âœ… æ‰¾åˆ°ï¼

5. å…¨å±€ node_modules
   ~/.bun/install/global/node_modules/zod
```

## Catalog ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†

### é…ç½®

```json
// æ ¹ package.json
{
  "workspaces": {
    "catalog": {
      "typescript": "5.8.2",
      "zod": "4.1.8",
      "@types/node": "22.13.9"
    }
  }
}
```

### ä½¿ç”¨

```json
// packages/core/package.json
{
  "dependencies": {
    "typescript": "catalog:",  // è‡ªåŠ¨æ›¿æ¢ä¸º "5.8.2"
    "zod": "catalog:"          // è‡ªåŠ¨æ›¿æ¢ä¸º "4.1.8"
  }
}

// packages/cli/package.json
{
  "dependencies": {
    "typescript": "catalog:",  // åŒæ ·æ˜¯ "5.8.2"
    "zod": "catalog:"          // åŒæ ·æ˜¯ "4.1.8"
  }
}
```

### å¥½å¤„

```bash
# åœºæ™¯ï¼šå‡çº§ TypeScript ç‰ˆæœ¬

# æ²¡æœ‰ Catalogï¼š
# éœ€è¦ä¿®æ”¹æ¯ä¸ª package.json
packages/core/package.json:    "typescript": "5.9.0"
packages/cli/package.json:     "typescript": "5.9.0"
packages/web/package.json:     "typescript": "5.9.0"
# ğŸ˜« å®¹æ˜“é—æ¼
# ğŸ˜« å®¹æ˜“ç‰ˆæœ¬ä¸ä¸€è‡´

# æœ‰äº† Catalogï¼š
# åªéœ€ä¿®æ”¹ä¸€å¤„
æ ¹ package.json:
"catalog": {
  "typescript": "5.9.0"  // åªæ”¹è¿™é‡Œ
}

# âœ… æ‰€æœ‰åŒ…è‡ªåŠ¨ä½¿ç”¨æ–°ç‰ˆæœ¬
# âœ… ä¿è¯ç‰ˆæœ¬ä¸€è‡´
```

## æ ¹ package.json çš„ä¸‰å¤§ä½œç”¨

### ä½œç”¨ 1ï¼šå£°æ˜ Workspacesï¼ˆæœ€é‡è¦ï¼‰

```json
{
  "workspaces": {
    "packages": ["packages/*"]
  }
}
```

**æ•ˆæœï¼š**
```bash
bun install

# Bun ä¼šï¼š
1. âœ… æ‰«æ packages/* ä¸‹çš„æ‰€æœ‰ package.json
2. âœ… åˆ†æä¾èµ–å…³ç³»
3. âœ… åˆ›å»ºç¬¦å·é“¾æ¥ï¼š
   node_modules/@my-agent/core -> packages/core
   node_modules/@my-agent/cli -> packages/cli
4. âœ… æå‡å…±åŒä¾èµ–åˆ°æ ¹ node_modules
5. âœ… å®‰è£…æ‰€æœ‰å¤–éƒ¨ä¾èµ–
```

### ä½œç”¨ 2ï¼šç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†ï¼ˆCatalogï¼‰

```json
{
  "workspaces": {
    "catalog": {
      "typescript": "5.8.2",
      "zod": "4.1.8"
    }
  }
}
```

**æ•ˆæœï¼š**
- âœ… é˜²æ­¢ç‰ˆæœ¬å†²çª
- âœ… ä¸€å¤„ä¿®æ”¹ï¼Œå…¨å±€ç”Ÿæ•ˆ
- âœ… ä¿è¯ç±»å‹å…¼å®¹æ€§

### ä½œç”¨ 3ï¼šå…¨å±€è„šæœ¬å’Œå·¥å…·

```json
{
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "typecheck": "turbo typecheck"
  },
  "devDependencies": {
    "turbo": "2.5.6",       // å…¨å±€æ„å»ºå·¥å…·
    "prettier": "3.6.2",    // å…¨å±€ä»£ç æ ¼å¼åŒ–
    "typescript": "5.8.2"   // å…¨å±€ TypeScript
  }
}
```

**ä½¿ç”¨ï¼š**
```bash
# åœ¨æ ¹ç›®å½•è¿è¡Œ
bun run build
# æ„å»ºæ‰€æœ‰åŒ…

bun run typecheck
# æ£€æŸ¥æ‰€æœ‰åŒ…çš„ç±»å‹

# æ‰€æœ‰åŒ…å…±äº«è¿™äº›å·¥å…·
```

## å¼€å‘ vs ç”Ÿäº§ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒï¼ˆMonorepoï¼‰

```
CLI å¯¼å…¥ Coreï¼š
  â†“
import '@my-agent/core'
  â†“
node_modules/@my-agent/core (ç¬¦å·é“¾æ¥)
  â†“
packages/core/src/index.ts  â­ TypeScript æºç 
  â†“
âœ… ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆ
âœ… å®Œæ•´ç±»å‹ä¿¡æ¯
âœ… æ— éœ€æ„å»º
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆnpm å‘å¸ƒï¼‰

```
ç”¨æˆ·å®‰è£…ï¼š
npm install @my-agent/cli
  â†“
ä¸‹è½½ç¼–è¯‘åçš„åŒ…
  â†“
node_modules/@my-agent/core/dist/index.js  â­ JavaScript ä»£ç 
  â†“
âœ… ç»è¿‡ä¼˜åŒ–å’Œå‹ç¼©
âœ… ç¨³å®šçš„å‘å¸ƒç‰ˆæœ¬
âœ… åŒ…å« .d.ts ç±»å‹æ–‡ä»¶
```

### å‘å¸ƒé…ç½®

```json
// packages/core/package.json
{
  "exports": {
    ".": "./src/index.ts"  // å¼€å‘æ—¶æŒ‡å‘æºç 
  },
  "files": [
    "dist"                  // å‘å¸ƒæ—¶åªåŒ…å« dist
  ],
  "publishConfig": {
    "directory": "dist"     // ä» dist ç›®å½•å‘å¸ƒ
  }
}
```

**å‘å¸ƒæ—¶ï¼š**
```bash
cd packages/core
bun run build              # ç¼–è¯‘æˆ dist/

npm publish
# å‘å¸ƒæ—¶ exports ä¼šè‡ªåŠ¨æ”¹ä¸ºï¼š
# "exports": { ".": "./index.js" }
```

## å®Œæ•´çš„å·¥ä½œæµç¨‹

```bash
# 1. åˆå§‹åŒ–é¡¹ç›®
mkdir my-agent-project && cd my-agent-project

# 2. åˆ›å»ºæ ¹ package.json
{
  "workspaces": {
    "packages": ["packages/*"]
  }
}

# 3. åˆ›å»ºåŒ…
mkdir -p packages/{core,cli}/src

# 4. é…ç½® Core
# packages/core/package.json
{
  "name": "@my-agent/core",
  "exports": { ".": "./src/index.ts" }
}

# 5. é…ç½® CLI
# packages/cli/package.json
{
  "name": "@my-agent/cli",
  "dependencies": {
    "@my-agent/core": "workspace:*"
  }
}

# 6. å®‰è£…ä¾èµ–
bun install
# âœ… åˆ›å»ºç¬¦å·é“¾æ¥
# âœ… å®‰è£…æ‰€æœ‰ä¾èµ–
# âœ… æå‡å…±åŒä¾èµ–

# 7. å¼€å‘
cd packages/cli
bun run src/index.ts
# âœ… CLI ç›´æ¥ä½¿ç”¨ Core æºç 
# âœ… ä¿®æ”¹ Coreï¼ŒCLI ç«‹å³çœ‹åˆ°

# 8. æ„å»ºï¼ˆå¯é€‰ï¼‰
bun turbo build
# âœ… ç¼–è¯‘æ‰€æœ‰åŒ…

# 9. å‘å¸ƒ
npm publish
# âœ… å‘å¸ƒç¼–è¯‘åçš„ä»£ç 
```

## æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **ä¾èµ–è£…åœ¨å“ªï¼Ÿ** | æ ¹ `node_modules`ï¼ˆä¾èµ–æå‡ï¼‰ |
| **CLI å¦‚ä½•ç”¨ Coreï¼Ÿ** | ç¬¦å·é“¾æ¥ + exports æŒ‡å‘æºç  |
| **æ ¹ package.json ä½œç”¨ï¼Ÿ** | 1. å£°æ˜ workspaces<br>2. ç»Ÿä¸€ç‰ˆæœ¬ï¼ˆcatalogï¼‰<br>3. å…¨å±€å·¥å…· |
| **ä¸ºä»€ä¹ˆæš´éœ²æºç ï¼Ÿ** | 1. å¼€å‘æ—¶çƒ­æ›´æ–°<br>2. å®Œæ•´ç±»å‹ä¿¡æ¯<br>3. è°ƒè¯•ä½“éªŒå¥½<br>4. æ— éœ€æ„å»º |

**æ ¸å¿ƒæœºåˆ¶ï¼š**
```
workspace:* + exports: "./src/index.ts" + ç¬¦å·é“¾æ¥
= CLI ç›´æ¥ä½¿ç”¨ Core çš„ TypeScript æºç ï¼
```
