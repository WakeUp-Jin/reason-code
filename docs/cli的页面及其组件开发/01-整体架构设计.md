# 01 - æ•´ä½“æ¶æ„è®¾è®¡ï¼ˆInk ç‰ˆæœ¬ï¼‰

> CLI ç»ˆç«¯åº”ç”¨çš„æ•´ä½“æ¶æ„è®¾è®¡æ–‡æ¡£
>
> æ—¥æœŸï¼š2025-12-23
> æŠ€æœ¯æ ˆï¼šBun + Ink + React + Zustand + TypeScript

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
3. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
4. [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
5. [æ¨¡å—åˆ’åˆ†](#æ¨¡å—åˆ’åˆ†)
6. [ä¾èµ–å…³ç³»](#ä¾èµ–å…³ç³»)
7. [å¯åŠ¨æµç¨‹](#å¯åŠ¨æµç¨‹)
8. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#æ ¸å¿ƒè®¾è®¡åŸåˆ™)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

ä¸€ä¸ª**åŸºäº Ink çš„ç»ˆç«¯ AI å¯¹è¯åº”ç”¨**ï¼Œç±»ä¼¼ gemini-cliï¼Œæä¾›ï¼š
- ä¼˜é›…çš„ç»ˆç«¯ UI
- æµç•…çš„ AI å¯¹è¯ä½“éªŒ
- å®Œæ•´çš„ Session ç®¡ç†
- å¼ºå¤§çš„å‘½ä»¤é¢æ¿
- ä¸°å¯Œçš„ä¸»é¢˜ç³»ç»Ÿ

### 1.2 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| ğŸ¨ **ä¸»é¢˜ç³»ç»Ÿ** | 6 ä¸ªç²¾é€‰ä¸»é¢˜ï¼ŒDark/Light åˆ‡æ¢ |
| ğŸ’¬ **AI å¯¹è¯** | æµå¼è¾“å‡ºï¼Œå®æ—¶åé¦ˆ |
| ğŸ“ **Session ç®¡ç†** | å¤šä¼šè¯ã€åˆ†æ”¯ã€é‡å‘½å |
| ğŸ¯ **å‘½ä»¤é¢æ¿** | æ¨¡ç³Šæœç´¢ï¼Œå¿«é€Ÿæ“ä½œ |
| ğŸ“Š **çŠ¶æ€ç›‘æ§** | TODOã€Permissionã€å·¥å…·è°ƒç”¨ |
| ğŸ”§ **ç³»ç»Ÿé›†æˆ** | å‰ªè´´æ¿ã€å¤–éƒ¨ç¼–è¾‘å™¨ |

### 1.3 æŠ€æœ¯äº®ç‚¹

- âœ… **å•è¿›ç¨‹æ¶æ„** - æç®€éƒ¨ç½²ï¼Œå¿«é€Ÿå¯åŠ¨
- âœ… **äº‹ä»¶é©±åŠ¨** - Bus ç³»ç»Ÿï¼Œå®æ—¶åé¦ˆ
- âœ… **JSON æŒä¹…åŒ–** - æ— éœ€æ•°æ®åº“
- âœ… **å¯æ‰©å±•æ€§** - é¢„ç•™ WebSocket/HTTP æ¥å£

---

## äºŒã€æŠ€æœ¯é€‰å‹

### 2.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | ç†ç”± |
|------|------|------|------|
| **Bun** | ^1.0.0 | è¿è¡Œæ—¶ | å¿«é€Ÿã€å…¼å®¹ Node.js |
| **Ink** | ^4.4.1 | ç»ˆç«¯ UI | React for Terminal |
| **React** | ^18.2.0 | UI æ¡†æ¶ | ç»„ä»¶åŒ–ã€ç”Ÿæ€ä¸°å¯Œ |
| **Zustand** | ^4.4.7 | çŠ¶æ€ç®¡ç† | è½»é‡ã€ç®€å• |
| **TypeScript** | ^5.3.0 | ç±»å‹ç³»ç»Ÿ | ç±»å‹å®‰å…¨ |
| **fuzzysort** | ^3.1.0 | æ¨¡ç³Šæœç´¢ | é«˜æ€§èƒ½ |
| **chalk** | ^5.3.0 | é¢œè‰²å·¥å…· | ç»ˆç«¯ç€è‰² |

### 2.2 å¯é€‰ä¾èµ–

| åº“ | ç”¨é€” |
|------|------|
| **diff** | Diff å¯¹æ¯” |
| **highlight.js** | ä»£ç é«˜äº® |
| **ink-text-input** | æ–‡æœ¬è¾“å…¥ |
| **ink-select-input** | é€‰æ‹©è¾“å…¥ |
| **ink-spinner** | åŠ è½½åŠ¨ç”» |

### 2.3 ä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›æŠ€æœ¯ï¼Ÿ

#### Bun vs Node.js
- âœ… å¯åŠ¨é€Ÿåº¦å¿« 3-4 å€
- âœ… å†…ç½® TypeScript æ”¯æŒ
- âœ… å…¼å®¹ Node.js ç”Ÿæ€
- âœ… å†…ç½®æ‰“åŒ…å·¥å…·

#### Ink vs blessed/blessed-contrib
- âœ… React ç»„ä»¶æ¨¡å‹ï¼Œæ˜“äºç†è§£
- âœ… ä¸°å¯Œçš„ç¤¾åŒºç»„ä»¶
- âœ… å£°æ˜å¼ UIï¼Œå¯ç»´æŠ¤æ€§é«˜
- âœ… ç±»å‹æ”¯æŒå®Œå–„

#### Zustand vs Redux/MobX
- âœ… API æç®€ï¼ˆæ—  reducer/actionï¼‰
- âœ… ä½“ç§¯å°ï¼ˆ~1KBï¼‰
- âœ… æ— éœ€ Provider åµŒå¥—
- âœ… TypeScript å‹å¥½

---

## ä¸‰ã€æ•´ä½“æ¶æ„

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLI åº”ç”¨ï¼ˆå•è¿›ç¨‹ï¼‰                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              UI å±‚ï¼ˆInk + Reactï¼‰                   â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚  Routes  â”‚  â”‚Componentsâ”‚  â”‚   Dialogs    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Home    â”‚  â”‚  Prompt  â”‚  â”‚DialogSelect  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Session â”‚  â”‚  Logo    â”‚  â”‚DialogCommand â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                 â”‚
â”‚                        â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Context Providersï¼ˆçŠ¶æ€ç®¡ç†ï¼‰              â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  ThemeProvider  StoreProvider  DialogProvider      â”‚ â”‚
â”‚  â”‚  ToastProvider  RouteProvider  CommandProvider     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                 â”‚
â”‚                        â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆAgent + Storageï¼‰             â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Agent å±‚    â”‚  â”‚  Storage å±‚  â”‚  â”‚  Bus    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  äº‹ä»¶   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - chat()     â”‚  â”‚ - Session    â”‚  â”‚  æ€»çº¿   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - stream()   â”‚  â”‚ - Message    â”‚  â”‚         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - tools()    â”‚  â”‚ - Config     â”‚  â”‚         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                 â”‚
â”‚                        â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              å·¥å…·å±‚ï¼ˆUtilsï¼‰                        â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  terminal.ts  clipboard.ts  editor.ts              â”‚ â”‚
â”‚  â”‚  highlight.ts  diff.ts                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                    AI Provider API
                  (Claude/OpenAI/etc)
```

### 3.2 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥    â”‚
â”‚  (Prompt)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RouteContext    â”‚  â† è·¯ç”±çŠ¶æ€
â”‚  StoreContext    â”‚  â† å…¨å±€çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent.chat()    â”‚  â† è°ƒç”¨ AI
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bus.publish()   â”‚  â† å‘å¸ƒäº‹ä»¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store.update()  â”‚  â† æ›´æ–°çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Re-render    â”‚  â† ç•Œé¢æ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 äº‹ä»¶æµè½¬

```
Agent æµå¼è¾“å‡º
       â†“
Bus.publish(PartUpdated)
       â†“
Store ç›‘å¬äº‹ä»¶
       â†“
updateMessage({ delta })
       â†“
Zustand è§¦å‘æ›´æ–°
       â†“
React ç»„ä»¶ re-render
       â†“
Ink æ¸²æŸ“åˆ°ç»ˆç«¯
```

---

## å››ã€ç›®å½•ç»“æ„

### 4.1 å®Œæ•´ç›®å½•æ ‘

```
my-cli-app/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ bun.lockb
â”œâ”€â”€ .gitignore
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                      # å…¥å£æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/
â”‚   â”‚   â””â”€â”€ main.tsx                  # CLI ä¸»å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                       # è·¯ç”±é¡µé¢ï¼ˆ2ä¸ªï¼‰
â”‚   â”‚   â”œâ”€â”€ app.tsx                   # æ ¹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ home.tsx                  # ä¸»é¡µ
â”‚   â”‚   â””â”€â”€ session/                  # ä¼šè¯é¡µé¢
â”‚   â”‚       â”œâ”€â”€ index.tsx             # ä¸»é¡µé¢
â”‚   â”‚       â”œâ”€â”€ header.tsx            # å¤´éƒ¨
â”‚   â”‚       â”œâ”€â”€ footer.tsx            # åº•éƒ¨
â”‚   â”‚       â””â”€â”€ sidebar.tsx           # ä¾§è¾¹æ 
â”‚   â”‚
â”‚   â”œâ”€â”€ ui/                           # åŸºç¡€ UI ç»„ä»¶ï¼ˆ5ä¸ªï¼‰
â”‚   â”‚   â”œâ”€â”€ dialog.tsx                # å¯¹è¯æ¡†åŸºç¡€
â”‚   â”‚   â”œâ”€â”€ dialog-select.tsx         # é€‰æ‹©å¯¹è¯æ¡† â­
â”‚   â”‚   â”œâ”€â”€ dialog-confirm.tsx        # ç¡®è®¤å¯¹è¯æ¡†
â”‚   â”‚   â”œâ”€â”€ dialog-prompt.tsx         # è¾“å…¥å¯¹è¯æ¡†
â”‚   â”‚   â””â”€â”€ toast.tsx                 # é€šçŸ¥
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                   # ä¸šåŠ¡ç»„ä»¶ï¼ˆ20+ä¸ªï¼‰
â”‚   â”‚   â”œâ”€â”€ prompt/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx            # è¾“å…¥æ¡†
â”‚   â”‚   â”‚   â””â”€â”€ history.tsx          # å†å²è®°å½•
â”‚   â”‚   â”œâ”€â”€ dialog-command.tsx       # å‘½ä»¤é¢æ¿
â”‚   â”‚   â”œâ”€â”€ dialog-status.tsx        # çŠ¶æ€æŸ¥çœ‹
â”‚   â”‚   â”œâ”€â”€ dialog-model.tsx         # æ¨¡å‹é€‰æ‹©
â”‚   â”‚   â”œâ”€â”€ dialog-agent.tsx         # Agent é€‰æ‹©
â”‚   â”‚   â”œâ”€â”€ dialog-provider.tsx      # Provider é…ç½®
â”‚   â”‚   â”œâ”€â”€ dialog-theme.tsx         # ä¸»é¢˜é€‰æ‹©
â”‚   â”‚   â”œâ”€â”€ dialog-session-list.tsx  # ä¼šè¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ dialog-session-rename.tsx # ä¼šè¯é‡å‘½å
â”‚   â”‚   â”œâ”€â”€ dialog-message.tsx       # æ¶ˆæ¯è¯¦æƒ…
â”‚   â”‚   â”œâ”€â”€ dialog-timeline.tsx      # æ—¶é—´çº¿
â”‚   â”‚   â”œâ”€â”€ dialog-fork.tsx          # åˆ†æ”¯å¯¹è¯
â”‚   â”‚   â”œâ”€â”€ todo-list.tsx            # TODO åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ permission-prompt.tsx    # Permission ç¡®è®¤
â”‚   â”‚   â”œâ”€â”€ code-block.tsx           # ä»£ç å—
â”‚   â”‚   â”œâ”€â”€ diff-view.tsx            # Diff æ˜¾ç¤º
â”‚   â”‚   â”œâ”€â”€ logo.tsx                 # Logo
â”‚   â”‚   â””â”€â”€ border.tsx               # è¾¹æ¡†
â”‚   â”‚
â”‚   â”œâ”€â”€ contexts/                     # Context Providersï¼ˆ7ä¸ªï¼‰
â”‚   â”‚   â”œâ”€â”€ theme.tsx                # ä¸»é¢˜ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ store.tsx                # Zustand çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ dialog.tsx               # å¯¹è¯æ¡†ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ toast.tsx                # Toast ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ route.tsx                # è·¯ç”±ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ agent.tsx                # Agent ç®¡ç†
â”‚   â”‚   â””â”€â”€ command.tsx              # å‘½ä»¤é¢æ¿
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/                        # Agent å±‚
â”‚   â”‚   â”œâ”€â”€ index.ts                 # Agent å…¥å£
â”‚   â”‚   â”œâ”€â”€ chat.ts                  # å¯¹è¯é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ stream.ts                # æµå¼å¤„ç†
â”‚   â”‚   â””â”€â”€ tools.ts                 # Tool å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                      # æŒä¹…åŒ–å±‚
â”‚   â”‚   â”œâ”€â”€ index.ts                 # å­˜å‚¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ session.ts               # Session å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ message.ts               # Message å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ todo.ts                  # TODO å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ permission.ts            # Permission å­˜å‚¨
â”‚   â”‚   â””â”€â”€ config.ts                # é…ç½®å­˜å‚¨
â”‚   â”‚
â”‚   â”œâ”€â”€ bus/                          # äº‹ä»¶æ€»çº¿
â”‚   â”‚   â””â”€â”€ index.ts                 # Bus å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ themes/                       # ä¸»é¢˜æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ index.ts                 # ä¸»é¢˜å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ kanagawa.json
â”‚   â”‚   â”œâ”€â”€ github.json
â”‚   â”‚   â”œâ”€â”€ solarized.json
â”‚   â”‚   â”œâ”€â”€ dracula.json
â”‚   â”‚   â”œâ”€â”€ nord.json
â”‚   â”‚   â””â”€â”€ catppuccin.json
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                        # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ terminal.ts              # ç»ˆç«¯å·¥å…·
â”‚   â”‚   â”œâ”€â”€ clipboard.ts             # å‰ªè´´æ¿
â”‚   â”‚   â”œâ”€â”€ editor.ts                # å¤–éƒ¨ç¼–è¾‘å™¨
â”‚   â”‚   â”œâ”€â”€ highlight.ts             # ä»£ç é«˜äº®
â”‚   â”‚   â””â”€â”€ diff.ts                  # Diff è§£æ
â”‚   â”‚
â”‚   â””â”€â”€ types/                        # ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ session.ts               # Session ç±»å‹
â”‚       â”œâ”€â”€ message.ts               # Message ç±»å‹
â”‚       â”œâ”€â”€ agent.ts                 # Agent ç±»å‹
â”‚       â”œâ”€â”€ theme.ts                 # Theme ç±»å‹
â”‚       â””â”€â”€ index.ts                 # ç±»å‹å¯¼å‡º
â”‚
â”œâ”€â”€ data/                             # æ•°æ®ç›®å½•ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ sessions/                    # Session æ•°æ®
â”‚   â”œâ”€â”€ messages/                    # Message æ•°æ®
â”‚   â””â”€â”€ config.json                  # é…ç½®æ–‡ä»¶
â”‚
â””â”€â”€ docs/                             # æ–‡æ¡£
    â””â”€â”€ ...
```

### 4.2 æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | ä»£ç é‡ | èŒè´£ |
|------|--------|------|
| `index.ts` | ~50 è¡Œ | å…¥å£ï¼Œå¯åŠ¨ CLI |
| `cli/main.tsx` | ~100 è¡Œ | CLI ä¸»é€»è¾‘ï¼Œæ¸²æŸ“æ ¹ç»„ä»¶ |
| `routes/app.tsx` | ~200 è¡Œ | æ ¹ç»„ä»¶ï¼ŒProvider åµŒå¥— |
| `routes/session/index.tsx` | ~500 è¡Œ | ä¼šè¯ä¸»ç•Œé¢ |
| `ui/dialog-select.tsx` | ~300 è¡Œ | é€‰æ‹©å¯¹è¯æ¡†ï¼ˆæœ€å¤æ‚ï¼‰ |
| `components/prompt/index.tsx` | ~400 è¡Œ | è¾“å…¥æ¡† |
| `contexts/store.tsx` | ~200 è¡Œ | Zustand çŠ¶æ€ç®¡ç† |
| `agent/chat.ts` | ~300 è¡Œ | AI å¯¹è¯é€»è¾‘ |

**é¢„è®¡æ€»ä»£ç é‡**ï¼š~6,000-8,000 è¡Œ

---

## äº”ã€æ¨¡å—åˆ’åˆ†

### 5.1 æŒ‰åŠŸèƒ½åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å±•ç¤ºå±‚ï¼ˆUIï¼‰              â”‚
â”‚                                     â”‚
â”‚  Routes  Components  Dialogs        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         çŠ¶æ€ç®¡ç†å±‚ï¼ˆContextsï¼‰       â”‚
â”‚                                     â”‚
â”‚  Theme  Store  Dialog  Toast        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆAgentï¼‰          â”‚
â”‚                                     â”‚
â”‚  Chat  Stream  Tools                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®å±‚ï¼ˆStorageï¼‰            â”‚
â”‚                                     â”‚
â”‚  Session  Message  Config           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åŸºç¡€è®¾æ–½å±‚ï¼ˆUtilsï¼‰          â”‚
â”‚                                     â”‚
â”‚  Terminal  Clipboard  Highlight     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æŒ‰èŒè´£åˆ’åˆ†

#### æ ¸å¿ƒæ¨¡å—ï¼ˆå¿…é¡»ï¼‰
- âœ… **UI å±‚** - ç•Œé¢æ¸²æŸ“
- âœ… **çŠ¶æ€ç®¡ç†** - Zustand Store
- âœ… **Agent å±‚** - AI å¯¹è¯
- âœ… **Storage å±‚** - æŒä¹…åŒ–
- âœ… **Bus å±‚** - äº‹ä»¶æ€»çº¿

#### å¢å¼ºæ¨¡å—ï¼ˆé‡è¦ï¼‰
- âš ï¸ **Theme ç³»ç»Ÿ** - ä¸»é¢˜ç®¡ç†
- âš ï¸ **Dialog ç³»ç»Ÿ** - å¯¹è¯æ¡†
- âš ï¸ **Command ç³»ç»Ÿ** - å‘½ä»¤é¢æ¿

#### è¾…åŠ©æ¨¡å—ï¼ˆå¯é€‰ï¼‰
- âš ï¸ **Clipboard** - å‰ªè´´æ¿
- âš ï¸ **Editor** - å¤–éƒ¨ç¼–è¾‘å™¨
- âš ï¸ **Highlight** - ä»£ç é«˜äº®

---

## å…­ã€ä¾èµ–å…³ç³»

### 6.1 æ¨¡å—ä¾èµ–å›¾

```
index.ts
   â†“
cli/main.tsx
   â†“
routes/app.tsx
   â”œâ†’ contexts/*  (æ‰€æœ‰ Provider)
   â””â†’ routes/home.tsx | routes/session/index.tsx
         â†“
      components/*
         â†“
      ui/dialog-select.tsx (æ ¸å¿ƒ)
```

### 6.2 å±‚çº§ä¾èµ–

```
UI å±‚
  â†“ ä¾èµ–
Context å±‚
  â†“ ä¾èµ–
Agent å±‚ + Storage å±‚ + Bus å±‚
  â†“ ä¾èµ–
Utils å±‚
```

**è§„åˆ™**ï¼š
1. âœ… ä¸Šå±‚å¯ä»¥ä¾èµ–ä¸‹å±‚
2. âŒ ä¸‹å±‚ä¸èƒ½ä¾èµ–ä¸Šå±‚
3. âœ… åŒå±‚ä¹‹é—´é€šè¿‡æ¥å£ä¾èµ–

### 6.3 æ ¸å¿ƒä¾èµ–

```typescript
// routes/app.tsx
import { ThemeProvider } from '@/contexts/theme'
import { StoreProvider } from '@/contexts/store'
import { Home } from '@/routes/home'

// components/dialog-command.tsx
import { DialogSelect } from '@/ui/dialog-select'
import { useStore } from '@/contexts/store'

// agent/chat.ts
import { Bus } from '@/bus'
import { Storage } from '@/storage'
```

---

## ä¸ƒã€å¯åŠ¨æµç¨‹

### 7.1 å¯åŠ¨æ—¶åºå›¾

```
ç”¨æˆ·æ‰§è¡Œ bun run start
        â†“
  index.ts (å…¥å£)
        â†“
  cli/main.tsx
        â”œâ†’ åˆå§‹åŒ–é…ç½®
        â”œâ†’ åŠ è½½ä¸»é¢˜
        â””â†’ æ¸²æŸ“ <App />
               â†“
        routes/app.tsx
               â”œâ†’ åµŒå¥— Providers
               â”œâ†’ åˆå§‹åŒ– Store
               â”œâ†’ åŠ è½½ Sessions
               â””â†’ æ¸²æŸ“ <Home /> æˆ– <Session />
                      â†“
               Home/Session é¡µé¢
                      â†“
               ç­‰å¾…ç”¨æˆ·è¾“å…¥
```

### 7.2 å¯åŠ¨ä»£ç 

#### index.ts
```typescript
#!/usr/bin/env bun
import { cli } from './cli/main'

// å¯åŠ¨ CLI
await cli({
  // å‘½ä»¤è¡Œå‚æ•°
  prompt: process.argv[2],
  agent: process.argv[3],
})
```

#### cli/main.tsx
```typescript
import { render } from 'ink'
import { App } from '@/routes/app'

export async function cli(options: CliOptions) {
  // æ¸²æŸ“åº”ç”¨
  render(<App {...options} />)
}
```

#### routes/app.tsx
```typescript
import { ThemeProvider } from '@/contexts/theme'
import { StoreProvider } from '@/contexts/store'
// ... å…¶ä»– Providers

export function App(props: AppProps) {
  return (
    <ThemeProvider>
      <StoreProvider>
        <DialogProvider>
          <ToastProvider>
            <RouteProvider>
              <CommandProvider>
                <Router />
              </CommandProvider>
            </RouteProvider>
          </ToastProvider>
        </DialogProvider>
      </StoreProvider>
    </ThemeProvider>
  )
}
```

### 7.3 åˆå§‹åŒ–æµç¨‹

```
1. åŠ è½½é…ç½®
   â”œâ†’ ~/.myapp/config.json
   â””â†’ é»˜è®¤é…ç½®

2. åˆå§‹åŒ– Store
   â”œâ†’ Sessions
   â”œâ†’ Messages
   â””â†’ Config

3. åŠ è½½ä¸»é¢˜
   â”œâ†’ æ£€æµ‹ç»ˆç«¯é¢œè‰²
   â””â†’ åº”ç”¨ä¸»é¢˜

4. æŒ‚è½½ UI
   â””â†’ æ¸²æŸ“é¦–é¡µ
```

---

## å…«ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 8.1 å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰

æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹ï¼š
- âœ… **UI ç»„ä»¶** - åªè´Ÿè´£æ¸²æŸ“
- âœ… **Context** - åªè´Ÿè´£çŠ¶æ€
- âœ… **Agent** - åªè´Ÿè´£ AI è°ƒç”¨
- âœ… **Storage** - åªè´Ÿè´£æŒä¹…åŒ–

### 8.2 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰

ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“ï¼š
```typescript
// âœ… å¥½çš„è®¾è®¡
interface IStorage {
  save(data: any): Promise<void>
  load(): Promise<any>
}

class JSONStorage implements IStorage { }
class SQLiteStorage implements IStorage { }

// Agent ä¾èµ–æ¥å£
class Agent {
  constructor(private storage: IStorage) {}
}
```

### 8.3 å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰

å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š
```typescript
// âœ… å¯ä»¥æ·»åŠ æ–°çš„ Dialogï¼Œæ— éœ€ä¿®æ”¹ DialogProvider
<DialogProvider>
  {/* å¯ä»¥åŠ¨æ€æ·»åŠ ä»»æ„ Dialog */}
  {stack.map(dialog => dialog)}
</DialogProvider>
```

### 8.4 æœ€å°æƒŠè®¶åŸåˆ™

API è®¾è®¡ç¬¦åˆç›´è§‰ï¼š
```typescript
// âœ… ç¬¦åˆç›´è§‰
useStore() // è·å– Store
useTheme() // è·å–ä¸»é¢˜
useDialog() // è·å– Dialog ç®¡ç†å™¨

// âŒ åç›´è§‰
getStoreInstance()
themeManager()
dialogStackController()
```

### 8.5 å…³æ³¨ç‚¹åˆ†ç¦»

```
UI å±‚      â†’ å…³æ³¨æ¸²æŸ“
Context å±‚ â†’ å…³æ³¨çŠ¶æ€
Agent å±‚   â†’ å…³æ³¨ä¸šåŠ¡é€»è¾‘
Storage å±‚ â†’ å…³æ³¨æ•°æ®
Utils å±‚   â†’ å…³æ³¨å·¥å…·
```

### 8.6 Convention over Configuration

```typescript
// é»˜è®¤é…ç½®è¦†ç›–å¤§éƒ¨åˆ†åœºæ™¯
const defaultConfig = {
  theme: 'kanagawa',
  mode: 'dark',
  dataDir: '~/.myapp',
}

// åªåœ¨éœ€è¦æ—¶è‡ªå®šä¹‰
const config = {
  ...defaultConfig,
  theme: 'github', // è‡ªå®šä¹‰ä¸»é¢˜
}
```

---

## ä¹ã€æ€§èƒ½è€ƒè™‘

### 9.1 å¯åŠ¨æ€§èƒ½

| é˜¶æ®µ | ç›®æ ‡æ—¶é—´ |
|------|---------|
| Bun å¯åŠ¨ | < 10ms |
| åŠ è½½é…ç½® | < 20ms |
| åˆå§‹åŒ– Store | < 30ms |
| æ¸²æŸ“ UI | < 40ms |
| **æ€»å¯åŠ¨æ—¶é—´** | **< 100ms** |

### 9.2 è¿è¡Œæ—¶æ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| å†…å­˜å ç”¨ | < 150MB |
| CPU ç©ºé—² | < 5% |
| UI æ¸²æŸ“ | 60 FPS |
| äº‹ä»¶å»¶è¿Ÿ | < 5ms |

### 9.3 ä¼˜åŒ–ç­–ç•¥

#### React å±‚é¢
```typescript
// ä½¿ç”¨ memo é¿å…ä¸å¿…è¦çš„ re-render
const MemoizedComponent = React.memo(Component)

// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—
const filtered = useMemo(() =>
  items.filter(item => item.visible),
  [items]
)
```

#### Zustand å±‚é¢
```typescript
// åªè®¢é˜…éœ€è¦çš„ slice
const sessions = useStore(state => state.sessions)

// é¿å…è®¢é˜…æ•´ä¸ª store
// âŒ const store = useStore()
```

#### Ink å±‚é¢
```typescript
// å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“
<Static items={items}>{/* ä¸ä¼š re-render */}</Static>

// è™šæ‹ŸåŒ–é•¿åˆ—è¡¨
<Box height={10} overflow="hidden">
  {/* åªæ¸²æŸ“å¯è§é¡¹ */}
</Box>
```

---

## åã€æ‰©å±•æ€§è®¾è®¡

### 10.1 é€šä¿¡å±‚æŠ½è±¡

å½“å‰ä½¿ç”¨ç›´æ¥è°ƒç”¨ï¼Œä½†é¢„ç•™äº†æ¥å£ï¼š
```typescript
// å½“å‰å®ç°
class DirectAgent implements IAgent {
  async chat() { /* ç›´æ¥è°ƒç”¨ */ }
}

// æœªæ¥å¯ä»¥æ‰©å±•
class WebSocketAgent implements IAgent {
  async chat() { /* WebSocket è°ƒç”¨ */ }
}

class HTTPAgent implements IAgent {
  async chat() { /* HTTP è°ƒç”¨ */ }
}
```

### 10.2 æ’ä»¶ç³»ç»Ÿï¼ˆæœªæ¥ï¼‰

```typescript
// é¢„ç•™æ’ä»¶æ¥å£
interface IPlugin {
  name: string
  onInit(): Promise<void>
  onCommand(cmd: string): Promise<void>
}

// æ’ä»¶æ³¨å†Œ
PluginManager.register(myPlugin)
```

### 10.3 ä¸»é¢˜æ‰©å±•

```typescript
// ç”¨æˆ·å¯ä»¥æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜
~/.myapp/themes/my-theme.json

// è‡ªåŠ¨åŠ è½½
ThemeManager.loadUserThemes()
```

---

## åä¸€ã€å¼€å‘è§„èŒƒ

### 11.1 å‘½åè§„èŒƒ

```typescript
// ç»„ä»¶ï¼šPascalCase
export function DialogSelect() {}

// å‡½æ•°/å˜é‡ï¼šcamelCase
const userName = 'Alice'
function getUserName() {}

// å¸¸é‡ï¼šUPPER_SNAKE_CASE
const MAX_RETRIES = 3

// ç±»å‹/æ¥å£ï¼šPascalCase + Iå‰ç¼€ï¼ˆæ¥å£ï¼‰
interface IStorage {}
type Session = {}
```

### 11.2 æ–‡ä»¶ç»„ç»‡

```
æ¯ä¸ªç»„ä»¶ä¸€ä¸ªæ–‡ä»¶
åŒç±»å‹ç»„ä»¶æ”¾åŒä¸€ç›®å½•
ç›¸å…³æ–‡ä»¶å°±è¿‘æ”¾ç½®

âœ… å¥½çš„
components/
â”œâ”€â”€ prompt/
â”‚   â”œâ”€â”€ index.tsx      # ä¸»ç»„ä»¶
â”‚   â”œâ”€â”€ history.tsx    # å­ç»„ä»¶
â”‚   â””â”€â”€ types.ts       # ç±»å‹å®šä¹‰

âŒ å·®çš„
components/
â”œâ”€â”€ prompt.tsx
â”œâ”€â”€ prompt-history.tsx
types/
â””â”€â”€ prompt.ts
```

### 11.3 å¯¼å…¥é¡ºåº

```typescript
// 1. å¤–éƒ¨åº“
import React from 'react'
import { Box, Text } from 'ink'

// 2. å†…éƒ¨æ¨¡å—ï¼ˆç»å¯¹è·¯å¾„ï¼‰
import { useStore } from '@/contexts/store'
import { useTheme } from '@/contexts/theme'

// 3. ç›¸å¯¹è·¯å¾„
import { Button } from './button'

// 4. ç±»å‹å¯¼å…¥
import type { Session } from '@/types'
```

---

## åäºŒã€æ€»ç»“

### 12.1 æ¶æ„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **ç®€å•** | å•è¿›ç¨‹ï¼Œæ— ç½‘ç»œå±‚ |
| âœ… **å¿«é€Ÿ** | å¯åŠ¨ < 100ms |
| âœ… **å¯é ** | TypeScript ç±»å‹å®‰å…¨ |
| âœ… **å¯ç»´æŠ¤** | æ¸…æ™°çš„åˆ†å±‚æ¶æ„ |
| âœ… **å¯æ‰©å±•** | é¢„ç•™æ‰©å±•æ¥å£ |

### 12.2 æŠ€æœ¯é€‰å‹åˆç†æ€§

| æŠ€æœ¯ | ä¼˜åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| Bun | å¿«é€Ÿã€å…¼å®¹ | âœ… CLI åº”ç”¨ |
| Ink | React for Terminal | âœ… ç»ˆç«¯ UI |
| Zustand | è½»é‡çŠ¶æ€ç®¡ç† | âœ… ä¸­å°å‹åº”ç”¨ |

### 12.3 ä¸‹ä¸€æ­¥

1. âœ… é˜…è¯» [æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†](./02-æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†.md)
2. âœ… é˜…è¯» [æ ¸å¿ƒUIç»„ä»¶å®ç°æŒ‡å—](./03-æ ¸å¿ƒUIç»„ä»¶å®ç°æŒ‡å—.md)
3. âœ… é˜…è¯» [ä¸»é¢˜ç³»ç»Ÿè®¾è®¡](./04-ä¸»é¢˜ç³»ç»Ÿè®¾è®¡.md)
4. âœ… å¼€å§‹ç¼–ç å®ç°

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-12-23
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
