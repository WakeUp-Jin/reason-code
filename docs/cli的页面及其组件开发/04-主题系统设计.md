# 04 - ä¸»é¢˜ç³»ç»Ÿè®¾è®¡

> ç²¾ç¾ã€çµæ´»ã€é«˜æ€§èƒ½çš„ç»ˆç«¯ä¸»é¢˜ç³»ç»Ÿ
>
> æ—¥æœŸï¼š2025-12-23

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ä¸»é¢˜æ¶æ„](#ä¸»é¢˜æ¶æ„)
3. [ä¸»é¢˜ JSON æ ¼å¼](#ä¸»é¢˜-json-æ ¼å¼)
4. [è¯­ä¹‰åŒ–é¢œè‰²ç³»ç»Ÿ](#è¯­ä¹‰åŒ–é¢œè‰²ç³»ç»Ÿ)
5. [Dark/Light æ¨¡å¼](#darklight-æ¨¡å¼)
6. [ç»ˆç«¯æ£€æµ‹](#ç»ˆç«¯æ£€æµ‹)
7. [ä¸»é¢˜å®ç°](#ä¸»é¢˜å®ç°)
8. [6 ä¸ªç²¾é€‰ä¸»é¢˜](#6-ä¸ªç²¾é€‰ä¸»é¢˜)
9. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
10. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| ğŸ¨ **ç¾è§‚** | ç²¾é€‰ 6 ä¸ªä¼˜è´¨ä¸»é¢˜ï¼Œè¦†ç›– Dark/Light æ¨¡å¼ |
| ğŸ”§ **çµæ´»** | 46 ä¸ªè¯­ä¹‰åŒ–é¢œè‰²ï¼Œæ”¯æŒç²¾ç»†è°ƒæ•´ |
| ğŸš€ **é«˜æ€§èƒ½** | ä¸»é¢˜ç¼“å­˜ï¼Œå³æ—¶åˆ‡æ¢ |
| ğŸŒˆ **æ‰©å±•æ€§** | JSON é…ç½®ï¼Œæ˜“äºæ·»åŠ æ–°ä¸»é¢˜ |
| ğŸ“± **è‡ªé€‚åº”** | è‡ªåŠ¨æ£€æµ‹ç»ˆç«¯èƒŒæ™¯è‰² |

### 1.2 ä¸»é¢˜é¢„è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kanagawa (é»˜è®¤) - æ—¥å¼ä¼˜é›…                  â”‚
â”‚  èƒŒæ™¯: #1F1F28 (å¢¨é»‘) ä¸»è‰²: #7E9CD8 (æ°´æ™¶è“)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GitHub - GitHub é£æ ¼                        â”‚
â”‚  èƒŒæ™¯: #ffffff (çº¯ç™½) ä¸»è‰²: #0969da (è“)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Solarized - ç»å…¸æŠ¤çœ¼                        â”‚
â”‚  èƒŒæ™¯: #002b36 (æ·±è“) ä¸»è‰²: #268bd2 (è“)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Dracula - æ·±ç´«è‰²è°ƒ                          â”‚
â”‚  èƒŒæ™¯: #282a36 ä¸»è‰²: #bd93f9 (ç´«)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Nord - åŒ—æ¬§æç®€                             â”‚
â”‚  èƒŒæ™¯: #2e3440 ä¸»è‰²: #88c0d0 (å†°è“)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Catppuccin - æŸ”å’Œæµ…è‰²                       â”‚
â”‚  èƒŒæ™¯: #eff1f5 ä¸»è‰²: #1e66f5 (è“)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ä¸»é¢˜æ¶æ„

### 2.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ThemeProvider                    â”‚
â”‚  ç®¡ç†ä¸»é¢˜çŠ¶æ€ã€åŠ è½½ã€åˆ‡æ¢                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Theme   â”‚     â”‚ Terminal â”‚
â”‚ Loader  â”‚     â”‚ Detector â”‚
â”‚ JSON    â”‚     â”‚ OSC 11   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Color Resolver â”‚
    â”‚  è§£æé¢œè‰²å¼•ç”¨    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  useTheme()     â”‚
    â”‚  React Hook     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Ink Components â”‚
    â”‚  ä½¿ç”¨ä¸»é¢˜é¢œè‰²    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

```
åŠ è½½ä¸»é¢˜
   â†“
è¯»å– JSON æ–‡ä»¶
   â†“
è§£æ defs (é¢œè‰²å®šä¹‰)
   â†“
è§£æ theme (è¯­ä¹‰æ˜ å°„)
   â†“
æ£€æµ‹ç»ˆç«¯æ¨¡å¼ (dark/light)
   â†“
é€‰æ‹©å¯¹åº”é¢œè‰²
   â†“
ç¼“å­˜åˆ°å†…å­˜
   â†“
æä¾›ç»™ç»„ä»¶ä½¿ç”¨
```

---

## ä¸‰ã€ä¸»é¢˜ JSON æ ¼å¼

### 3.1 å®Œæ•´ç»“æ„

```json
{
  "$schema": "https://opencode.ai/theme.json",

  "defs": {
    // é¢œè‰²å®šä¹‰ï¼šå…·ä½“çš„ HEX é¢œè‰²å€¼
    "primary100": "#1F1F28",
    "primary200": "#2A2A37",
    "accent100": "#7E9CD8",
    // ... æ›´å¤šé¢œè‰²
  },

  "theme": {
    // è¯­ä¹‰é¢œè‰²æ˜ å°„ï¼šæ¯ä¸ªé”®éƒ½æœ‰ dark å’Œ light ä¸¤ç§æ¨¡å¼
    "primary": {
      "dark": "accent100",    // å¼•ç”¨ defs ä¸­çš„é¢œè‰²
      "light": "primary200"
    },
    "text": {
      "dark": "#DCD7BA",      // ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ HEX
      "light": "#54433A"
    },
    // ... æ›´å¤šè¯­ä¹‰é¢œè‰²
  }
}
```

### 3.2 defs éƒ¨åˆ†

**ä½œç”¨**ï¼šå®šä¹‰å…·ä½“é¢œè‰²å€¼ï¼Œæ–¹ä¾¿å¤ç”¨å’Œç»´æŠ¤ã€‚

```json
{
  "defs": {
    // èƒŒæ™¯è‰²ç³»
    "bg0": "#1F1F28",
    "bg1": "#2A2A37",
    "bg2": "#363646",
    "bg3": "#54546D",

    // å‰æ™¯è‰²ç³»
    "fg0": "#DCD7BA",
    "fg1": "#C8C093",
    "fg2": "#727169",

    // å¼ºè°ƒè‰²
    "blue": "#7E9CD8",
    "purple": "#957FB8",
    "pink": "#D27E99",
    "yellow": "#C38D9D",
    "green": "#76946A",
    "red": "#E82424"
  }
}
```

### 3.3 theme éƒ¨åˆ†

**ä½œç”¨**ï¼šè¯­ä¹‰åŒ–é¢œè‰²æ˜ å°„ï¼Œæ”¯æŒ Dark/Light æ¨¡å¼ã€‚

```json
{
  "theme": {
    // åŸºç¡€é¢œè‰²
    "primary": { "dark": "blue", "light": "darkBlue" },
    "secondary": { "dark": "purple", "light": "purple" },
    "accent": { "dark": "pink", "light": "pink" },

    // çŠ¶æ€é¢œè‰²
    "error": { "dark": "red", "light": "red" },
    "warning": { "dark": "yellow", "light": "yellow" },
    "success": { "dark": "green", "light": "green" },
    "info": { "dark": "blue", "light": "blue" },

    // æ–‡æœ¬é¢œè‰²
    "text": { "dark": "fg0", "light": "#54433A" },
    "textMuted": { "dark": "fg2", "light": "#9E9389" },

    // èƒŒæ™¯é¢œè‰²
    "background": { "dark": "bg0", "light": "#F2E9DE" },
    "backgroundPanel": { "dark": "bg1", "light": "#EAE4D7" },
    "backgroundElement": { "dark": "bg2", "light": "#E3DCD2" },

    // è¾¹æ¡†é¢œè‰²
    "border": { "dark": "bg3", "light": "#D4CBBF" },
    "borderActive": { "dark": "yellow", "light": "yellow" },
    "borderSubtle": { "dark": "bg2", "light": "#DCD4C9" }
  }
}
```

---

## å››ã€è¯­ä¹‰åŒ–é¢œè‰²ç³»ç»Ÿ

### 4.1 å®Œæ•´é¢œè‰²åˆ—è¡¨ï¼ˆ46 ä¸ªï¼‰

#### åŸºç¡€é¢œè‰²ï¼ˆ10 ä¸ªï¼‰

| é¢œè‰²é”® | ç”¨é€” | Dark ç¤ºä¾‹ | Light ç¤ºä¾‹ |
|--------|------|-----------|------------|
| `primary` | ä¸»è‰² | #7E9CD8 | #2D4F67 |
| `secondary` | è¾…åŠ©è‰² | #957FB8 | #957FB8 |
| `accent` | å¼ºè°ƒè‰² | #D27E99 | #D27E99 |
| `error` | é”™è¯¯ | #E82424 | #E82424 |
| `warning` | è­¦å‘Š | #D7A657 | #D7A657 |
| `success` | æˆåŠŸ | #98BB6C | #98BB6C |
| `info` | ä¿¡æ¯ | #76946A | #76946A |
| `text` | æ–‡æœ¬ | #DCD7BA | #54433A |
| `textMuted` | å¼±åŒ–æ–‡æœ¬ | #727169 | #9E9389 |
| `background` | èƒŒæ™¯ | #1F1F28 | #F2E9DE |

#### é¢æ¿å’Œå…ƒç´ ï¼ˆ3 ä¸ªï¼‰

| é¢œè‰²é”® | ç”¨é€” |
|--------|------|
| `backgroundPanel` | é¢æ¿èƒŒæ™¯ |
| `backgroundElement` | å…ƒç´ èƒŒæ™¯ |
| `border` | è¾¹æ¡† |

#### è¾¹æ¡†ï¼ˆ3 ä¸ªï¼‰

| é¢œè‰²é”® | ç”¨é€” |
|--------|------|
| `borderActive` | æ¿€æ´»è¾¹æ¡† |
| `borderSubtle` | å¾®å¦™è¾¹æ¡† |
| `border` | é»˜è®¤è¾¹æ¡† |

#### Diff æ˜¾ç¤ºï¼ˆ10 ä¸ªï¼‰

| é¢œè‰²é”® | ç”¨é€” |
|--------|------|
| `diffAdded` | æ·»åŠ æ–‡æœ¬ |
| `diffRemoved` | åˆ é™¤æ–‡æœ¬ |
| `diffContext` | ä¸Šä¸‹æ–‡ |
| `diffHunkHeader` | åŒºå—å¤´ |
| `diffHighlightAdded` | é«˜äº®æ·»åŠ  |
| `diffHighlightRemoved` | é«˜äº®åˆ é™¤ |
| `diffAddedBg` | æ·»åŠ èƒŒæ™¯ |
| `diffRemovedBg` | åˆ é™¤èƒŒæ™¯ |
| `diffContextBg` | ä¸Šä¸‹æ–‡èƒŒæ™¯ |
| `diffLineNumber` | è¡Œå· |

#### Markdown æ¸²æŸ“ï¼ˆ12 ä¸ªï¼‰

| é¢œè‰²é”® | ç”¨é€” |
|--------|------|
| `markdownText` | æ­£æ–‡ |
| `markdownHeading` | æ ‡é¢˜ |
| `markdownLink` | é“¾æ¥ |
| `markdownLinkText` | é“¾æ¥æ–‡æœ¬ |
| `markdownCode` | è¡Œå†…ä»£ç  |
| `markdownBlockQuote` | å¼•ç”¨å— |
| `markdownEmph` | æ–œä½“ |
| `markdownStrong` | ç²—ä½“ |
| `markdownHorizontalRule` | åˆ†éš”çº¿ |
| `markdownListItem` | åˆ—è¡¨é¡¹ |
| `markdownListEnumeration` | åˆ—è¡¨ç¼–å· |
| `markdownCodeBlock` | ä»£ç å— |

#### è¯­æ³•é«˜äº®ï¼ˆ8 ä¸ªï¼‰

| é¢œè‰²é”® | ç”¨é€” |
|--------|------|
| `syntaxComment` | æ³¨é‡Š |
| `syntaxKeyword` | å…³é”®å­— |
| `syntaxFunction` | å‡½æ•° |
| `syntaxVariable` | å˜é‡ |
| `syntaxString` | å­—ç¬¦ä¸² |
| `syntaxNumber` | æ•°å­— |
| `syntaxType` | ç±»å‹ |
| `syntaxOperator` | è¿ç®—ç¬¦ |

### 4.2 é¢œè‰²ä½¿ç”¨åŸåˆ™

```typescript
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨è¯­ä¹‰åŒ–é¢œè‰²
<Text color={theme.primary}>Primary Text</Text>
<Box borderColor={theme.border}>Content</Box>

// âŒ å·®çš„åšæ³•ï¼šç¡¬ç¼–ç é¢œè‰²
<Text color="#7E9CD8">Primary Text</Text>
<Box borderColor="#54546D">Content</Box>
```

---

## äº”ã€Dark/Light æ¨¡å¼

### 5.1 æ¨¡å¼åˆ‡æ¢

```typescript
// src/contexts/theme.tsx
interface ThemeMode {
  mode: 'dark' | 'light'
  setMode: (mode: 'dark' | 'light') => void
  toggleMode: () => void
}

export function ThemeProvider({ children }: { children: ReactNode }) {
  const [mode, setMode] = useState<'dark' | 'light'>('dark')
  const [themeName, setThemeName] = useState('kanagawa')

  // åŠ è½½ä¸»é¢˜
  const theme = useMemo(() => {
    const themeData = loadTheme(themeName)
    return resolveTheme(themeData, mode)
  }, [themeName, mode])

  const toggleMode = () => {
    setMode(prev => prev === 'dark' ? 'light' : 'dark')
  }

  return (
    <ThemeContext.Provider value={{ theme, mode, setMode, toggleMode, themeName, setThemeName }}>
      {children}
    </ThemeContext.Provider>
  )
}
```

### 5.2 é¢œè‰²è§£æ

```typescript
// src/themes/resolver.ts
interface ThemeData {
  defs: Record<string, string>
  theme: Record<string, { dark: string, light: string }>
}

export function resolveTheme(
  themeData: ThemeData,
  mode: 'dark' | 'light'
): Record<string, string> {
  const { defs, theme } = themeData
  const resolved: Record<string, string> = {}

  for (const [key, value] of Object.entries(theme)) {
    // è·å–å¯¹åº”æ¨¡å¼çš„é¢œè‰²å¼•ç”¨
    const colorRef = value[mode]

    // è§£æé¢œè‰²å¼•ç”¨
    if (colorRef.startsWith('#')) {
      // ç›´æ¥ä½¿ç”¨ HEX é¢œè‰²
      resolved[key] = colorRef
    } else if (defs[colorRef]) {
      // ä» defs ä¸­æŸ¥æ‰¾
      resolved[key] = defs[colorRef]
    } else {
      console.warn(`Color reference not found: ${colorRef}`)
      resolved[key] = '#FF00FF' // é”™è¯¯é¢œè‰²ï¼ˆæ´‹çº¢ï¼‰
    }
  }

  return resolved
}
```

### 5.3 è‡ªåŠ¨æ£€æµ‹ç»ˆç«¯æ¨¡å¼

```typescript
// src/utils/terminal.ts
import { spawn } from 'child_process'

/**
 * ä½¿ç”¨ OSC 11 æ£€æµ‹ç»ˆç«¯èƒŒæ™¯è‰²
 */
export async function detectTerminalBackground(): Promise<'dark' | 'light'> {
  return new Promise((resolve) => {
    // å‘é€ OSC 11 æŸ¥è¯¢ï¼ˆæŸ¥è¯¢èƒŒæ™¯è‰²ï¼‰
    process.stdout.write('\x1b]11;?\x1b\\')

    const timeout = setTimeout(() => {
      // è¶…æ—¶é»˜è®¤ä¸º dark
      resolve('dark')
    }, 100)

    // ç›‘å¬å“åº”
    process.stdin.setRawMode(true)
    process.stdin.once('data', (data) => {
      clearTimeout(timeout)
      process.stdin.setRawMode(false)

      const response = data.toString()

      // è§£æ RGB å€¼
      // æ ¼å¼: \x1b]11;rgb:RRRR/GGGG/BBBB\x1b\\
      const match = response.match(/rgb:([0-9a-f]+)\/([0-9a-f]+)\/([0-9a-f]+)/i)

      if (match) {
        const [_, r, g, b] = match
        const red = parseInt(r.slice(0, 2), 16)
        const green = parseInt(g.slice(0, 2), 16)
        const blue = parseInt(b.slice(0, 2), 16)

        // è®¡ç®—äº®åº¦ (æ ‡å‡†å…¬å¼)
        const brightness = (red * 299 + green * 587 + blue * 114) / 1000

        // äº®åº¦ > 128 è§†ä¸ºæµ…è‰²èƒŒæ™¯
        resolve(brightness > 128 ? 'light' : 'dark')
      } else {
        resolve('dark')
      }
    })
  })
}
```

---

## å…­ã€ç»ˆç«¯æ£€æµ‹

### 6.1 OSC 11 é€ƒé€¸åºåˆ—

```
OSC 11: æŸ¥è¯¢/è®¾ç½®ç»ˆç«¯èƒŒæ™¯è‰²

å‘é€: \x1b]11;?\x1b\\
å“åº”: \x1b]11;rgb:RRRR/GGGG/BBBB\x1b\\

ç¤ºä¾‹:
- Dark èƒŒæ™¯: rgb:1f1f/1f1f/2828 (äº®åº¦çº¦ 30)
- Light èƒŒæ™¯: rgb:ffff/ffff/ffff (äº®åº¦ 255)
```

### 6.2 å…¼å®¹æ€§å¤„ç†

```typescript
// æ£€æµ‹ç»ˆç«¯æ˜¯å¦æ”¯æŒ OSC 11
export function supportsOSC11(): boolean {
  const term = process.env.TERM || ''

  // æ”¯æŒçš„ç»ˆç«¯
  const supported = [
    'xterm',
    'xterm-256color',
    'screen',
    'tmux',
    'alacritty',
    'kitty',
    'wezterm',
  ]

  return supported.some(t => term.includes(t))
}

// å®Œæ•´çš„æ£€æµ‹æµç¨‹
export async function getTerminalMode(): Promise<'dark' | 'light'> {
  // 1. æ£€æŸ¥ç”¨æˆ·é…ç½®
  const userConfig = await loadConfig()
  if (userConfig.mode) {
    return userConfig.mode
  }

  // 2. æ£€æŸ¥ç¯å¢ƒå˜é‡
  if (process.env.THEME_MODE) {
    return process.env.THEME_MODE === 'light' ? 'light' : 'dark'
  }

  // 3. å°è¯• OSC 11 æ£€æµ‹
  if (supportsOSC11()) {
    try {
      return await detectTerminalBackground()
    } catch {
      // æ£€æµ‹å¤±è´¥ï¼Œç»§ç»­
    }
  }

  // 4. é»˜è®¤ dark
  return 'dark'
}
```

---

## ä¸ƒã€ä¸»é¢˜å®ç°

### 7.1 ä¸»é¢˜åŠ è½½å™¨

```typescript
// src/themes/loader.ts
import fs from 'fs/promises'
import path from 'path'

const THEMES_DIR = path.join(__dirname, '../themes')

export async function loadTheme(name: string): Promise<ThemeData> {
  const filePath = path.join(THEMES_DIR, `${name}.json`)

  try {
    const content = await fs.readFile(filePath, 'utf-8')
    return JSON.parse(content)
  } catch (error) {
    console.error(`Failed to load theme: ${name}`, error)
    // å›é€€åˆ°é»˜è®¤ä¸»é¢˜
    return loadTheme('kanagawa')
  }
}

export async function loadAllThemes(): Promise<string[]> {
  const files = await fs.readdir(THEMES_DIR)
  return files
    .filter(f => f.endsWith('.json'))
    .map(f => f.replace('.json', ''))
}
```

### 7.2 ThemeProvider å®ç°

```typescript
// src/contexts/theme.tsx
import { createContext, useContext, useState, useEffect, ReactNode, useMemo } from 'react'
import { loadTheme, loadAllThemes } from '@/themes/loader'
import { resolveTheme } from '@/themes/resolver'
import { getTerminalMode } from '@/utils/terminal'
import { Storage } from '@/storage'

interface ThemeContextValue {
  // å½“å‰ä¸»é¢˜
  theme: Record<string, string>

  // ä¸»é¢˜åç§°
  themeName: string
  setThemeName: (name: string) => void

  // æ¨¡å¼
  mode: 'dark' | 'light'
  setMode: (mode: 'dark' | 'light') => void
  toggleMode: () => void

  // å¯ç”¨ä¸»é¢˜åˆ—è¡¨
  availableThemes: string[]
}

const ThemeContext = createContext<ThemeContextValue | null>(null)

export function ThemeProvider({ children }: { children: ReactNode }) {
  const [themeName, setThemeName] = useState('kanagawa')
  const [mode, setMode] = useState<'dark' | 'light'>('dark')
  const [availableThemes, setAvailableThemes] = useState<string[]>([])
  const [themeData, setThemeData] = useState<any>(null)

  // åˆå§‹åŒ–
  useEffect(() => {
    async function init() {
      // åŠ è½½å¯ç”¨ä¸»é¢˜åˆ—è¡¨
      const themes = await loadAllThemes()
      setAvailableThemes(themes)

      // åŠ è½½ç”¨æˆ·é…ç½®
      const config = await Storage.loadConfig()
      if (config.theme) setThemeName(config.theme)

      // æ£€æµ‹ç»ˆç«¯æ¨¡å¼
      const detectedMode = await getTerminalMode()
      setMode(config.mode || detectedMode)
    }

    init()
  }, [])

  // åŠ è½½ä¸»é¢˜æ•°æ®
  useEffect(() => {
    loadTheme(themeName).then(setThemeData)
  }, [themeName])

  // è§£æä¸»é¢˜
  const theme = useMemo(() => {
    if (!themeData) return {}
    return resolveTheme(themeData, mode)
  }, [themeData, mode])

  // åˆ‡æ¢æ¨¡å¼
  const toggleMode = () => {
    const newMode = mode === 'dark' ? 'light' : 'dark'
    setMode(newMode)
    Storage.saveConfig({ mode: newMode })
  }

  // åˆ‡æ¢ä¸»é¢˜
  const handleSetThemeName = (name: string) => {
    setThemeName(name)
    Storage.saveConfig({ theme: name })
  }

  return (
    <ThemeContext.Provider
      value={{
        theme,
        themeName,
        setThemeName: handleSetThemeName,
        mode,
        setMode,
        toggleMode,
        availableThemes,
      }}
    >
      {children}
    </ThemeContext.Provider>
  )
}

export function useTheme() {
  const context = useContext(ThemeContext)
  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider')
  }
  return context
}
```

### 7.3 åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```typescript
// åŸºç¡€ç”¨æ³•
import { useTheme } from '@/contexts/theme'

function MyComponent() {
  const { theme } = useTheme()

  return (
    <Box borderColor={theme.border}>
      <Text color={theme.primary}>Hello World</Text>
      <Text color={theme.textMuted}>Subtitle</Text>
    </Box>
  )
}

// åˆ‡æ¢ä¸»é¢˜
function ThemeSwitcher() {
  const { themeName, setThemeName, availableThemes } = useTheme()

  return (
    <DialogSelect
      title="Select Theme"
      options={availableThemes.map(t => ({ label: t, value: t }))}
      current={themeName}
      onSelect={(option) => setThemeName(option.value)}
    />
  )
}

// åˆ‡æ¢ Dark/Light
function ModeToggle() {
  const { mode, toggleMode } = useTheme()

  return (
    <Box>
      <Text>Mode: {mode}</Text>
      <Button onPress={toggleMode}>Toggle</Button>
    </Box>
  )
}
```

---

## å…«ã€6 ä¸ªç²¾é€‰ä¸»é¢˜

### 8.1 Kanagawaï¼ˆé»˜è®¤ï¼‰

**ç‰¹ç‚¹**ï¼šæ—¥å¼ä¼˜é›…ï¼ŒæŠ¤çœ¼é…è‰²

```json
{
  "name": "Kanagawa",
  "description": "æ—¥å¼ä¼˜é›…ä¸»é¢˜ï¼Œçµæ„Ÿæ¥è‡ªç¥å¥ˆå·å†²æµªé‡Œ",
  "colors": {
    "dark": {
      "background": "#1F1F28",  // å¢¨é»‘
      "primary": "#7E9CD8",      // æ°´æ™¶è“
      "accent": "#D27E99"        // æ¨±èŠ±ç²‰
    },
    "light": {
      "background": "#F2E9DE",  // è²èŠ±ç™½
      "primary": "#2D4F67",      // æ³¢æµªè“
      "accent": "#D27E99"        // æ¨±èŠ±ç²‰
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šé•¿æ—¶é—´ç¼–ç ã€å¤œé—´ä½¿ç”¨

### 8.2 GitHub

**ç‰¹ç‚¹**ï¼šçº¯ç™½/æ·±é»‘ï¼Œæ¸…æ™°ç®€æ´

```json
{
  "name": "GitHub",
  "description": "GitHub å®˜æ–¹é…è‰²",
  "colors": {
    "dark": {
      "background": "#0d1117",
      "primary": "#58a6ff"
    },
    "light": {
      "background": "#ffffff",
      "primary": "#0969da"
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šç™½å¤©å·¥ä½œã€æ¼”ç¤º

### 8.3 Solarized

**ç‰¹ç‚¹**ï¼šç»å…¸æŠ¤çœ¼ï¼Œç§‘å­¦è°ƒè‰²

```json
{
  "name": "Solarized",
  "description": "Ethan Schoonover è®¾è®¡çš„ç»å…¸ä¸»é¢˜",
  "colors": {
    "dark": {
      "background": "#002b36",
      "primary": "#268bd2",
      "warning": "#b58900"  // ç‰¹è‰²é»„è‰²
    },
    "light": {
      "background": "#fdf6e3",
      "primary": "#268bd2"
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šå‡å°‘çœ¼ç–²åŠ³ã€é•¿æ—¶é—´é˜…è¯»

### 8.4 Dracula

**ç‰¹ç‚¹**ï¼šæ·±ç´«è‰²è°ƒï¼Œç¥ç§˜æ„Ÿ

```json
{
  "name": "Dracula",
  "description": "æ·±ç´«è‰²å¸è¡€é¬¼ä¸»é¢˜",
  "colors": {
    "dark": {
      "background": "#282a36",
      "primary": "#bd93f9",
      "accent": "#ff79c6"
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šä¸ªæ€§åŒ–ã€å¤œé—´ç¼–ç 

### 8.5 Nord

**ç‰¹ç‚¹**ï¼šåŒ—æ¬§æç®€ï¼Œå†°è“è‰²è°ƒ

```json
{
  "name": "Nord",
  "description": "åŒ—æ¬§é£æ ¼æç®€ä¸»é¢˜",
  "colors": {
    "dark": {
      "background": "#2e3440",
      "primary": "#88c0d0",
      "accent": "#81a1c1"
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šæ¸…çˆ½ç®€æ´ã€æ³¨é‡å¯¹æ¯”åº¦

### 8.6 Catppuccin

**ç‰¹ç‚¹**ï¼šæŸ”å’Œæµ…è‰²ï¼Œæ¸©æš–æ„Ÿ

```json
{
  "name": "Catppuccin",
  "description": "æŸ”å’Œæµ…è‰²ç³»ä¸»é¢˜",
  "colors": {
    "light": {
      "background": "#eff1f5",
      "primary": "#1e66f5",
      "accent": "#e64553"
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**ï¼šç™½å¤©ä½¿ç”¨ã€æŸ”å’Œè§†è§‰

### 8.7 ä¸»é¢˜å¯¹æ¯”è¡¨

| ä¸»é¢˜ | Dark | Light | ç‰¹è‰² | æ¨èåœºæ™¯ |
|------|------|-------|------|----------|
| Kanagawa | âœ… | âœ… | æ—¥å¼ä¼˜é›… | å…¨å¤©å€™ |
| GitHub | âœ… | âœ… | å®˜æ–¹é£æ ¼ | å·¥ä½œ/æ¼”ç¤º |
| Solarized | âœ… | âœ… | æŠ¤çœ¼ç»å…¸ | é•¿æ—¶é—´ä½¿ç”¨ |
| Dracula | âœ… | âŒ | æ·±ç´«ç¥ç§˜ | å¤œé—´ç¼–ç  |
| Nord | âœ… | âŒ | åŒ—æ¬§æç®€ | æ¸…çˆ½ç®€æ´ |
| Catppuccin | âŒ | âœ… | æŸ”å’Œæ¸©æš– | ç™½å¤©ä½¿ç”¨ |

---

## ä¹ã€ä½¿ç”¨æŒ‡å—

### 9.1 å¿«é€Ÿå¼€å§‹

```typescript
// 1. åœ¨ App æ ¹ç»„ä»¶ä¸­ä½¿ç”¨ ThemeProvider
import { ThemeProvider } from '@/contexts/theme'

function App() {
  return (
    <ThemeProvider>
      <YourApp />
    </ThemeProvider>
  )
}

// 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ä¸»é¢˜
import { useTheme } from '@/contexts/theme'
import { Box, Text } from 'ink'

function MyComponent() {
  const { theme } = useTheme()

  return (
    <Box borderStyle="single" borderColor={theme.border}>
      <Text color={theme.primary} bold>
        Primary Text
      </Text>
      <Text color={theme.textMuted}>
        Muted text
      </Text>
    </Box>
  )
}
```

### 9.2 ä¸»é¢˜åˆ‡æ¢å¯¹è¯æ¡†

```typescript
// components/dialog-theme.tsx
import { useTheme } from '@/contexts/theme'
import { DialogSelect } from '@/ui/dialog-select'

export function DialogTheme({ onClose }: { onClose: () => void }) {
  const { themeName, setThemeName, availableThemes } = useTheme()

  const options = availableThemes.map(name => ({
    label: name,
    value: name,
    category: name === 'kanagawa' || name === 'github' || name === 'solarized'
      ? 'Popular'
      : 'More Themes',
  }))

  return (
    <DialogSelect
      title="Select Theme"
      placeholder="Search themes..."
      options={options}
      current={themeName}
      onSelect={(option) => {
        setThemeName(option.value)
        onClose()
      }}
      onClose={onClose}
    />
  )
}
```

### 9.3 Dark/Light åˆ‡æ¢

```typescript
// routes/app.tsx
import { useTheme } from '@/contexts/theme'
import { useInput } from 'ink'

function App() {
  const { toggleMode } = useTheme()

  useInput((input, key) => {
    // Ctrl+D åˆ‡æ¢ Dark/Light
    if (key.ctrl && input === 'd') {
      toggleMode()
    }
  })

  return <YourApp />
}
```

### 9.4 Diff æ˜¾ç¤º

```typescript
// components/diff-view.tsx
import { useTheme } from '@/contexts/theme'
import { Box, Text } from 'ink'

interface DiffLine {
  type: 'added' | 'removed' | 'context'
  content: string
  lineNumber: number
}

export function DiffView({ lines }: { lines: DiffLine[] }) {
  const { theme } = useTheme()

  return (
    <Box flexDirection="column">
      {lines.map((line, index) => {
        const colors = {
          added: {
            text: theme.diffAdded,
            bg: theme.diffAddedBg,
          },
          removed: {
            text: theme.diffRemoved,
            bg: theme.diffRemovedBg,
          },
          context: {
            text: theme.diffContext,
            bg: theme.diffContextBg,
          },
        }

        const { text, bg } = colors[line.type]

        return (
          <Box key={index} backgroundColor={bg}>
            <Text color={theme.diffLineNumber} dimColor>
              {line.lineNumber.toString().padStart(4, ' ')}
            </Text>
            <Text color={text}>
              {line.type === 'added' ? '+' : line.type === 'removed' ? '-' : ' '}
              {line.content}
            </Text>
          </Box>
        )
      })}
    </Box>
  )
}
```

### 9.5 ä»£ç é«˜äº®

```typescript
// components/code-block.tsx
import { useTheme } from '@/contexts/theme'
import { Box, Text } from 'ink'
import highlight from 'highlight.js'

export function CodeBlock({ code, language }: { code: string, language: string }) {
  const { theme } = useTheme()

  const highlighted = highlight.highlight(code, { language }).value

  // è§£æé«˜äº®ç»“æœ
  const tokens = parseHighlight(highlighted)

  const syntaxColors: Record<string, string> = {
    'hljs-comment': theme.syntaxComment,
    'hljs-keyword': theme.syntaxKeyword,
    'hljs-function': theme.syntaxFunction,
    'hljs-string': theme.syntaxString,
    'hljs-number': theme.syntaxNumber,
    'hljs-type': theme.syntaxType,
    'hljs-operator': theme.syntaxOperator,
  }

  return (
    <Box
      flexDirection="column"
      padding={1}
      borderStyle="round"
      borderColor={theme.border}
      backgroundColor={theme.backgroundPanel}
    >
      {tokens.map((line, i) => (
        <Box key={i}>
          {line.map((token, j) => (
            <Text key={j} color={syntaxColors[token.class] || theme.text}>
              {token.text}
            </Text>
          ))}
        </Box>
      ))}
    </Box>
  )
}
```

---

## åã€æœ€ä½³å®è·µ

### 10.1 é¢œè‰²ä½¿ç”¨

```typescript
// âœ… å¥½çš„åšæ³•
function GoodExample() {
  const { theme } = useTheme()

  return (
    <Box>
      {/* ä½¿ç”¨è¯­ä¹‰åŒ–é¢œè‰² */}
      <Text color={theme.primary}>Primary</Text>
      <Text color={theme.error}>Error</Text>
      <Text color={theme.success}>Success</Text>
    </Box>
  )
}

// âŒ å·®çš„åšæ³•
function BadExample() {
  return (
    <Box>
      {/* ç¡¬ç¼–ç é¢œè‰² */}
      <Text color="#7E9CD8">Primary</Text>
      <Text color="red">Error</Text>
      <Text color="green">Success</Text>
    </Box>
  )
}
```

### 10.2 æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… ç¼“å­˜ä¸»é¢˜å¯¹è±¡
function OptimizedComponent() {
  const { theme } = useTheme()

  // theme å¯¹è±¡å·²ç»è¢« useMemo ç¼“å­˜
  // ç›´æ¥ä½¿ç”¨å³å¯

  return <Box borderColor={theme.border}>Content</Box>
}

// âŒ ä¸è¦é‡å¤è§£æ
function UnoptimizedComponent() {
  const { theme } = useTheme()

  // ä¸è¦åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°è®¡ç®—
  const myColor = theme.primary // âŒ

  return <Text color={myColor}>Text</Text>
}
```

### 10.3 è‡ªå®šä¹‰ä¸»é¢˜

```json
// themes/my-theme.json
{
  "$schema": "https://opencode.ai/theme.json",
  "defs": {
    "customBg": "#1a1b26",
    "customBlue": "#7aa2f7"
  },
  "theme": {
    "primary": {
      "dark": "customBlue",
      "light": "#0969da"
    },
    "background": {
      "dark": "customBg",
      "light": "#ffffff"
    }
    // ... å…¶ä»– 44 ä¸ªé¢œè‰²é”®
  }
}
```

### 10.4 ä¸»é¢˜æµ‹è¯•

```typescript
// æµ‹è¯•æ‰€æœ‰é¢œè‰²
function ThemeTestView() {
  const { theme } = useTheme()

  return (
    <Box flexDirection="column">
      {Object.entries(theme).map(([key, color]) => (
        <Box key={key}>
          <Text color={color}>
            {key}: {color}
          </Text>
        </Box>
      ))}
    </Box>
  )
}
```

### 10.5 é”™è¯¯å¤„ç†

```typescript
// ä¸»é¢˜åŠ è½½å¤±è´¥æ—¶çš„å›é€€
export async function loadTheme(name: string): Promise<ThemeData> {
  try {
    const filePath = path.join(THEMES_DIR, `${name}.json`)
    const content = await fs.readFile(filePath, 'utf-8')
    const data = JSON.parse(content)

    // éªŒè¯ä¸»é¢˜æ•°æ®
    if (!validateThemeData(data)) {
      throw new Error('Invalid theme data')
    }

    return data
  } catch (error) {
    console.error(`Failed to load theme: ${name}`, error)

    // å›é€€åˆ°é»˜è®¤ä¸»é¢˜
    if (name !== 'kanagawa') {
      return loadTheme('kanagawa')
    }

    // å¦‚æœé»˜è®¤ä¸»é¢˜ä¹ŸåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®ä¸»é¢˜
    return getBuiltinTheme()
  }
}
```

---

## åä¸€ã€æ€»ç»“

### 11.1 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| âœ… **46 ä¸ªè¯­ä¹‰é¢œè‰²** | è¦†ç›–æ‰€æœ‰ UI åœºæ™¯ |
| âœ… **Dark/Light æ¨¡å¼** | è‡ªåŠ¨åˆ‡æ¢ï¼Œæ— ç¼ä½“éªŒ |
| âœ… **6 ä¸ªç²¾é€‰ä¸»é¢˜** | æ»¡è¶³ä¸åŒå®¡ç¾éœ€æ±‚ |
| âœ… **JSON é…ç½®** | æ˜“äºæ‰©å±•å’Œè‡ªå®šä¹‰ |
| âœ… **ç»ˆç«¯æ£€æµ‹** | OSC 11 è‡ªåŠ¨æ£€æµ‹èƒŒæ™¯è‰² |
| âœ… **é«˜æ€§èƒ½** | ä¸»é¢˜ç¼“å­˜ï¼Œå³æ—¶åˆ‡æ¢ |

### 11.2 é¢œè‰²åˆ†ç±»

```
åŸºç¡€é¢œè‰²: 10 ä¸ª
é¢æ¿å’Œå…ƒç´ : 3 ä¸ª
è¾¹æ¡†: 3 ä¸ª
Diff æ˜¾ç¤º: 10 ä¸ª
Markdown æ¸²æŸ“: 12 ä¸ª
è¯­æ³•é«˜äº®: 8 ä¸ª
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡: 46 ä¸ª
```

### 11.3 ä¸‹ä¸€æ­¥

1. âœ… å®Œæˆæ‰€æœ‰å¼€å‘æ–‡æ¡£
2. âœ… åˆ›å»º README ç´¢å¼•
3. âœ… å¼€å§‹ç¼–ç å®ç°

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-12-23
