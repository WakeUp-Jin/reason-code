/**
 * 历史压缩提示词模板
 * 用于生成对话历史的详细摘要
 */

/**
 * 压缩系统提示词
 * 指导 LLM 生成结构化的对话摘要
 */
export const COMPRESSION_SYSTEM_PROMPT = `你的任务是创建一个迄今为止对话的详细摘要，密切关注用户的明确请求和你之前的操作。
该摘要应全面捕获技术细节、代码模式和架构决策，这些对于在不丢失上下文的情况下继续开发工作至关重要。

## 分析流程
在提供最终摘要之前，请将你的分析包装在 <analysis> 标签中，以组织你的思路并确保涵盖所有必要的要点。在分析过程中：
按时间顺序分析对话中的每条消息和每个部分。对每个部分深入识别：
- 用户的明确请求和意图
- 你处理用户请求的方法
- 关键决策、技术概念和代码模式
- 具体细节，例如：
  - 文件名
  - 完整的代码片段
  - 函数签名
  - 文件编辑
  - 你遇到的错误以及如何修复它们

特别关注你收到的具体用户反馈，尤其是用户告诉你以不同方式做某事的时候。
仔细检查技术准确性和完整性，全面处理每个必需的元素。

## 摘要结构
你的摘要应包括以下部分：

### 1. 主要请求和意图
详细捕获用户的所有明确请求和意图

### 2. 关键技术概念
列出讨论的所有重要技术概念、技术和框架。

### 3. 文件和代码部分
列举检查、修改或创建的具体文件和代码部分。特别关注最近的消息，在适用的情况下包含完整的代码片段，并总结为什么这个文件的读取或编辑很重要。

### 4. 错误和修复
列出你遇到的所有错误，以及如何修复它们。特别关注你收到的具体用户反馈，尤其是用户告诉你以不同方式做某事的时候。

### 5. 问题解决
记录已解决的问题和任何正在进行的故障排除工作。

### 6. 所有用户消息
列出所有不是工具结果的用户消息。这些对于理解用户的反馈和意图变化至关重要。

### 7. 待处理任务
概述你被明确要求处理的任何待处理任务。

### 8. 当前工作
详细描述在此摘要请求之前正在进行的具体工作，特别关注用户和助手的最近消息。在适用的情况下包含文件名和代码片段。

### 9. 可选的下一步
列出与你最近正在做的工作相关的下一步。

**重要提示：** 确保此步骤与用户的明确请求以及你在此摘要请求之前正在进行的任务直接一致。如果你的上一个任务已结束，那么只有在明确符合用户请求的情况下才列出下一步。在未经用户确认的情况下，不要开始处理无关的请求。

如果有下一步，请包含最近对话中的直接引用，准确显示你正在处理的任务以及你停止的位置。这应该是逐字逐句的，以确保任务解释没有偏差。

## 输出格式

<analysis>
  [你的思考过程，确保全面准确地涵盖所有要点]
</analysis>

<summary>
  1. 主要请求和意图：[详细描述]
  2. 关键技术概念：[概念列表]
  3. 文件和代码部分：[文件名、重要性摘要、更改摘要、代码片段]
  4. 错误和修复：[错误描述、修复方法、用户反馈]
  5. 问题解决：[已解决问题和正在进行的故障排除]
  6. 所有用户消息：[详细的非工具使用用户消息]
  7. 待处理任务：[任务列表]
  8. 当前工作：[当前工作的精确描述]
  9. 可选的下一步：[下一步操作]
</summary>

请根据迄今为止的对话提供摘要，遵循此结构并确保回复的精确性和全面性。`;

/**
 * 从 LLM 响应中提取摘要内容
 *
 * @param response - LLM 响应文本
 * @returns 提取的摘要内容，如果未找到则返回 null
 */
export function extractSummaryContent(response: string): string | null {
  const summaryMatch = response.match(/<summary>([\s\S]*?)<\/summary>/);
  return summaryMatch ? summaryMatch[1].trim() : null;
}

/**
 * 从 LLM 响应中提取分析内容
 *
 * @param response - LLM 响应文本
 * @returns 提取的分析内容，如果未找到则返回 null
 */
export function extractAnalysisContent(response: string): string | null {
  const analysisMatch = response.match(/<analysis>([\s\S]*?)<\/analysis>/);
  return analysisMatch ? analysisMatch[1].trim() : null;
}
